<!-- TABS -->
<div class="p-6">
  <div class="flex flex-wrap justify-between bg-white/50 rounded-xl border border-amber-50 shadow-sm p-2 gap-2">
    <div class="flex flex-wrap justify-start gap-2">
      <button type="button" id="tab-batch" class="px-4 py-2 rounded-md bg-yellow-400 text-grey hover:bg-blue-600">
        Batch Upload
      </button>
    </div>
    <div class="flex flex-wrap justify-end gap-2">
      <button id="tab-personnel" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-600">Personnel</button>
      <button id="tab-nok" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">NOK</button>
      <button id="tab-spouse" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">Spouse</button>
      <button id="tab-children" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">Children</button>
    </div>
  </div>
</div>

<!-- BATCH UPLOAD SECTION -->
<div id="section-batch" class="p-6 flex justify-center">
  <div class="w-full max-w-lg rounded-2xl p-6">
    <h3 class="text-2xl font-bold text-blue-800 mb-4">Batch Upload</h3>
    
    <form id="batchUploadForm" class="space-y-6">
      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
        <input type="file" id="batchFile" 
               class="mt-1 block w-full border border-blue-500 bg-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
        <p class="text-xs text-gray-500 mt-2">
          Only .xlsx or .csv files allowed. 
          <a href="sample.csv" download 
             class="text-blue-600 hover:underline ml-2">Download Sample</a>
        </p>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancelBatchBtn"
          class="px-6 py-2 bg-gray-400 hover:bg-gray-500 rounded-lg text-white">Cancel</button>
        <button type="button" id="uploadBatchBtn"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="uploadSuccessPopup" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-96 text-center">
    <h4 class="text-xl font-semibold text-green-600 mb-2">Upload Successful!</h4>
    <p class="text-gray-600 mb-4">Your batch file has been uploaded successfully.</p>
    <button id="closePopupBtn" 
      class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Close</button>
  </div>
</div>

<!-- PERSONNEL SECTION -->
<div id="section-personnel" class="px-6 mb-4">
  <!-- Title -->
  <h3 id="formTitle" class="hidden text-2xl font-bold text-blue-800 mb-4"></h3>

  <!-- Step Buttons + Current Personnel -->
  <div class="flex flex-wrap items-center gap-2 justify-between mb-4">
    <div class=" flex flex-wrap gap-2 items-center">
      <button id="btnStep1" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-blue-600 hover:bg-blue-600 text-white transition-all overflow-hidden group">
        <span class="relative z-10">Step 1: Basic Details</span>
      </button>
      <button id="btnStep2" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600 transition-all overflow-hidden group">
        <span class="relative z-10">Step 2: Official Info</span>
      </button>
      <button id="btnStep3" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600 transition-all overflow-hidden group">
        <span class="relative z-10">Step 3: Additional Info</span>
      </button>
    </div>

    <button onclick="window.navigation?.navigateToSection ? window.navigation.navigateToSection('current-personnel','Current Personnel') : alert('Hook your navigation here.')"
      class="px-4 text-sm lg:text-lg py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
      Current Personnel
    </button>
  </div>

  <!-- Form -->
  <form id="personnelForm" class="space-y-6">
    <!-- Step 1 (dynamic, with labels) -->
    <div id="step1" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- Step 2 (static, with labels) -->
    <div id="step2" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Joined</label>
        <input type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Commissioned</label>
        <input type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Entry Mode</label>
        <input type="text" placeholder="Entry Mode" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Left</label>
        <input type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Exit Mode</label>
        <select id="exittype" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Exit Mode</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Taxed ?</label>
        <select class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">TaxID No(TIN)</label>
        <input type="text" placeholder="TaxID N0" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Tax State</label>
        <select id="state" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Tax State</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">RSA(Pension) Code</label>
        <input type="text" placeholder="RSA(Pension) Code" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Pension Fund Administrator</label>
        <select id="pfa" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Administrator</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Payroll Process Category</label>
        <select id="payrollProcess" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Payroll Process</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Salary Group</label>
        <select id="salarygroup" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Salary Group</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Salary Grade</label>
        <select id="salarygrade" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Salary Grade</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Bank Branch</label>
        <select id="bankbranch" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Bank Branch</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Account Number</label>
        <input type="text" placeholder="Account Number" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
    </div>

    <!-- Step 3 (static, with labels) -->
    <div id="step3" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Senority Date</label>
        <input type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Ship/Establishment</label>
        <select class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>select</option>
          <option value="SHIP">Ship</option>
          <option value="ESTABLISHMENT">Establishment</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Branch</label>
        <select id="branch" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Branch</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Command</label>
        <select id="command" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Command</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Specialisation</label>
        <select id="specialisation" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Specialisation</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Present Appointment</label>
        <input type="text" placeholder="Present Appointment" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Award/Decoration</label>
        <input type="text" placeholder="Award/Decoration" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Emolument Form Received?</label>
        <select class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">NHF Code</label>
        <input type="text" placeholder="NHF Code" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Bank Code</label>
        <select id="bankcode" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Bank Code</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">IPPIS NO</label>
        <input type="text" placeholder="IPPIS NO" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Country</label>
        <select id="country" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Country</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Accommodation Type</label>
        <select  class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Accommodation Type</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Rent Subsidy</label>
        <select class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
        </select>
      </div>
    </div>

    <!-- Actions -->
    <div class="col-span-full flex justify-end space-x-4 pt-4">
      <button type="button" id="cancelBtn" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 rounded-lg text-white">Cancel</button>
      <button type="button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Submit</button>
    </div>
  </form>
</div>

<!-- NOK SECTION -->
<div id="section-nok" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Next of Kin</h3>
    <button id="nokToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <!-- Form -->
  <div id="nokFormWrap" class="hidden">
    <form id="nokForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
        <input id="nokFirst" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
        <input id="nokLast" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
        <input id="nokDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Address <span class="text-red-500">*</span></label>
        <input id="nokAddress" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Relationship <span class="text-red-500">*</span></label>
        <select id="nokRelationship" required class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="">Select</option>
          <option>Spouse</option><option>Father</option><option>Mother</option>
          <option>Son</option><option>Daughter</option><option>Brother</option>
          <option>Sister</option><option>Uncle</option><option>Aunt</option><option>Friend</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Mobile Number <span class="text-red-500">*</span></label>
        <input id="nokMobile" required type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Home Number</label>
        <input id="nokHome" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
        <input id="nokEmail" required type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Place Of Work</label>
        <input id="nokWork" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Next Of Kin Type</label>
        <select id="nokType" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Main</option><option>Alternate</option>
        </select>
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="nokCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="nokSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <!-- List -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Name</th>
          <th class="py-2 px-3 border">Relationship</th>
          <th class="py-2 px-3 border">Mobile</th>
          <th class="py-2 px-3 border">Email</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="nokList" class="text-center">
        <tr id="nokEmpty"><td colspan="4" class="py-4 text-gray-500">No NOKs yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- SPOUSE SECTION -->
<div id="section-spouse" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Spouse</h3>
    <button id="spouseToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <div id="spouseFormWrap" class="hidden">
    <form id="spouseForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name <span class="text-red-500">*</span></label>
        <input id="spouseName" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Of Birth</label>
        <input id="spouseDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Married</label>
        <input id="spouseDom" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Street</label>
        <input id="spouseStreet" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Town</label>
        <input id="spouseTown" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">State</label>
        <input id="spouseState" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Local Government</label>
        <input id="spouseLga" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input id="spousePhone" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="spouseEmail" type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">P.O Box</label>
        <input id="spousePoBox" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="spouseCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="spouseSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Full Name</th>
          <th class="py-2 px-3 border">Phone</th>
          <th class="py-2 px-3 border">Email</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="spouseList" class="text-center">
        <tr id="spouseEmpty"><td colspan="3" class="py-4 text-gray-500">No spouse records yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CHILDREN SECTION -->
<div id="section-children" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Children</h3>
    <button id="childToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <div id="childFormWrap" class="hidden">
    <form id="childForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name <span class="text-red-500">*</span></label>
        <input id="childName" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Street</label>
        <input id="childStreet" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Town</label>
        <input id="childTown" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">State</label>
        <input id="childState" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Local Government</label>
        <input id="childLga" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input id="childPhone" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="childEmail" type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">P.O Box</label>
        <input id="childPoBox" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Sex</label>
        <select id="childSex" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select</option><option>Male</option><option>Female</option><option>Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
        <input id="childDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">School</label>
        <input id="childSchool" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Office Address</label>
        <input id="childOffice" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div >
        <label class="block text-sm font-medium text-gray-700">Occupation</label>
        <input id="childOccupation" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="childCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="childSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Full Name</th>
          <th class="py-2 px-3 border">Sex</th>
          <th class="py-2 px-3 border">DOB</th>
          <th class="py-2 px-3 border">Phone</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="childList" class="text-center">
        <tr id="childEmpty"><td colspan="4" class="py-4 text-gray-500">No children yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Action Popup -->
<div id="actionPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-64">
    <div id="popupIcon" class="mx-auto h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
    <p id="popupText" class="mt-4 text-lg font-semibold text-gray-700">Processing...</p>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-xl w-96 p-6">
    <h3 class="text-xl font-semibold text-red-600 mb-4">Confirm Delete</h3>
    <p class="text-gray-700 mb-6">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-3">
      <button id="deleteCancelBtn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="deleteConfirmBtn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
// API Configuration
const API_BASE = '/personnel';
const API_HEADERS = {
  'Content-Type': 'application/json',
  'Authorization': `Bearer ${localStorage.getItem('token')}`
};

//dropdown helper step1
const dropdownConfig = {
  "Sex": { endpoint: "sex", value: "sex_code", text: "sex_desc" },
  "Marital Status": { endpoint: "marital", value: "MaritalCode", text: "MaritalStatus" },
  "State Of Origin": { endpoint: "state", value: "Statecode", text: "Statename" },
  "Local Government": { endpoint: "lga", value: "Lgcode", text: "Lgname" },
  "Rank": { endpoint: "title", value: "Titlecode", text: "Description" },
  "Religion": { endpoint: "religion", value: "ReligionCode", text: "ReligionName" }
};

async function loadDropdown(endpoint, elementId, valueField, textField, placeholder) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/reference/${endpoint}` ,{   
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }
    });
    const data = await response.json();

    const dropdown = document.getElementById(elementId);
    if (!dropdown) return;

    dropdown.innerHTML = `<option value="">${placeholder}</option>`;

    data.forEach(item => {
      const option = document.createElement("option");
      option.value = item[valueField];
      option.textContent = item[textField];
      dropdown.appendChild(option);
    });
  } catch (err) {
    console.error(`Failed to load ${endpoint}:`, err);
  }
}

function initializeDropdowns() {
  Object.keys(dropdownConfig).forEach(field => {
    const cfg = dropdownConfig[field];
    const elementId = `field-${field.replace(/\s+/g, '-').toLowerCase()}`;
    loadDropdown(cfg.endpoint, elementId, cfg.value, cfg.text, `Select ${field}`);
  });
}

window.addEventListener("DOMContentLoaded", initializeDropdowns);

//dropdown helper 2&3
async function loadDropdown(endpoint, elementId, valueField, textField) {
  try {
    const token = localStorage.getItem('token');

    const response = await fetch(`/reference/${endpoint}`, {   
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }
    });
    const data = await response.json();

    const dropdown = document.getElementById(elementId);
    dropdown.innerHTML = "<option value=''>-- Select --</option>";

    data.forEach(item => {
      const option = document.createElement("option");
      option.value = item[valueField];
      option.textContent = item[textField];
      dropdown.appendChild(option);
    });
  } catch (err) {
    console.error(`Failed to load ${endpoint}:`, err);
  }
}

/**
 * Bundle all dropdowns
 */
function loadAllDropdowns() {
  loadDropdown("bankbranch", "bankbranch", "bankcode", "branchname");
  loadDropdown("bankcode", "bankcode", "bankcode", "bankcode");
  loadDropdown("state", "state", "Statecode", "Statename");
  //loadDropdown("status", "status", "StatusCode", "StatusDescrip");
  loadDropdown("country", "country", "countrycode", "Countryname");
  loadDropdown("command", "command", "navalcmd", "name");
  loadDropdown("pfa", "pfa", "pfacode", "pfadesc");
  loadDropdown("salarygroup", "salarygroup", "groupcode", "grpdesc");
  loadDropdown("salarygrade", "salarygrade", "grade_no", "grade_desc");
  //loadDropdown("title", "title", "Titlecode", "Description");
  loadDropdown("exittype", "exittype", "Name", "Description");
  loadDropdown("specialisation", "specialisation", "sp_desc", "sp_desc");
}

// Load everything once page is ready
window.addEventListener("DOMContentLoaded", loadAllDropdowns);


// Global variables and helper functions
let nokCounter = 0;
let spouseCounter = 0;
let childCounter = 0;
let currentEmployeeId = null; // Set this when editing an existing employee
const editState = { type: null, id: null, row: null, data: null };

// Helper functions
function val(id) { 
  return (document.getElementById(id)?.value || '').trim(); 
}

function escapeHtml(s) { 
  return String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }[m])); 
}

function toggleBlock(el, btn) {
  const isHidden = el.classList.contains('hidden');
  el.classList.toggle('hidden');
  btn.textContent = isHidden ? '−' : '+ Add';
}

function showPopup(message) {
  const popup = document.getElementById('actionPopup');
  const icon = document.getElementById('popupIcon');
  const text = document.getElementById('popupText');

  // Reset to spinner
  icon.className = "mx-auto h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin";
  text.textContent = message;
  popup.classList.remove('hidden');

  setTimeout(() => {
    icon.className = "mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-green-500 text-white";
    icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                      </svg>`;
    text.textContent = "Success!";
    setTimeout(() => {
      popup.classList.add('hidden');
      icon.innerHTML = "";
    }, 1000);
  }, 1500);
}

function showError(message) {
  alert(`Error: ${message}`);
}

// API Helper Functions
async function apiRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      ...options,
      headers: { ...API_HEADERS, ...options.headers }
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || `HTTP ${response.status}`);
    }
    
    return data;
  } catch (error) {
    console.error('API Request failed:', error);
    showError(error.message);
    throw error;
  }
}

function actionBtns(type, id) {
  return `
    <button onclick="viewRow('${type}', ${id})" class="px-2 text-blue-600 hover:underline">View</button>
    <button onclick="editRow('${type}', ${id})" class="px-2 text-green-600 hover:underline">Edit</button>
    <button onclick="deleteRow(this, '${type}', ${id})" class="px-2 text-red-600 hover:underline">Delete</button>
  `;
}

// Global functions for row actions
window.viewRow = (t,i)=>showPopup(`Viewing ${t} #${i}`);

let deleteTargetRow = null;
let deleteTargetType = null;
let deleteTargetId = null;

window.deleteRow = function(btn, type, id){
  deleteTargetRow = btn.closest('tr');
  deleteTargetType = type;
  deleteTargetId = id;
  document.getElementById('deleteModal').classList.remove('hidden');
};

// Modal button events
document.getElementById('deleteCancelBtn').onclick = () => {
  deleteTargetRow = null;
  deleteTargetType = null;
  deleteTargetId = null;
  document.getElementById('deleteModal').classList.add('hidden');
};

document.getElementById('deleteConfirmBtn').onclick = async () => {
  if(deleteTargetRow && deleteTargetType && deleteTargetId){
    try {
      await deleteRecord(deleteTargetType, deleteTargetId);
      deleteTargetRow.remove();
      showPopup("Record deleted successfully");
    } catch (error) {
      // Error already handled in deleteRecord
    }
    
    deleteTargetRow = null;
    deleteTargetType = null;
    deleteTargetId = null;
  }
  document.getElementById('deleteModal').classList.add('hidden');
};

// Delete API Functions
async function deleteRecord(type, id) {
  let url;
  switch(type) {
    case 'NOK':
      url = `${API_BASE}/nextofkin/${id}`;
      break;
    case 'Spouse':
      url = `${API_BASE}/spouse/${id}`;
      break;
    case 'Child':
      url = `${API_BASE}/children/${id}`;
      break;
    default:
      throw new Error('Invalid record type');
  }
  
  return await apiRequest(url, { method: 'DELETE' });
}

window.editRow = function(type, id) {
  const row = document.querySelector(`tr[data-type="${type}"][data-id="${id}"]`);
  if (!row) {
    console.error("Row not found:", type, id);
    return;
  }
  
  editState.type = type;
  editState.id = id;
  editState.row = row;
  const cells = row.querySelectorAll('td');

  if(type==="NOK"){
    const [first,last=""] = cells[0].textContent.split(" ");
    document.getElementById('nokFirst').value = first;
    document.getElementById('nokLast').value  = last;
    document.getElementById('nokRelationship').value = cells[1].textContent;
    document.getElementById('nokMobile').value = cells[2].textContent;
    document.getElementById('nokEmail').value  = cells[3].textContent;

    // Show form
    const wrap = document.getElementById('nokFormWrap');
    const btn = document.getElementById('nokToggleBtn');
    wrap.classList.remove('hidden');
    btn.textContent = "−";
  }

  if(type==="Spouse"){
    document.getElementById('spouseName').value   = cells[0].textContent;
    document.getElementById('spousePhone').value  = cells[1].textContent;
    document.getElementById('spouseEmail').value  = cells[2].textContent;

    // Show form
    const wrap = document.getElementById('spouseFormWrap');
    const btn = document.getElementById('spouseToggleBtn');
    wrap.classList.remove('hidden');
    btn.textContent = "−";
  }

  if (type === "Child") {
    document.getElementById('childName').value   = cells[0].textContent;
    document.getElementById('childSex').value    = cells[1].textContent;
    document.getElementById('childDob').value    = cells[2].textContent;
    document.getElementById('childPhone').value  = cells[3].textContent;
    
    // Show form
    const wrap = document.getElementById('childFormWrap');
    const btn = document.getElementById('childToggleBtn');
    wrap.classList.remove('hidden');
    btn.textContent = '−';
  }
};

// Batch Upload functionality
const uploadBtn = document.getElementById("uploadBatchBtn");
const popup = document.getElementById("uploadSuccessPopup");
const closePopupBtn = document.getElementById("closePopupBtn");
const cancelBtn = document.getElementById("cancelBatchBtn");

uploadBtn.addEventListener("click", async () => {
  const fileInput = document.getElementById("batchFile");
  if (!fileInput.files.length) {
    alert("Please select a file to upload!");
    return;
  }

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);

  uploadBtn.innerText = "Uploading...";
  uploadBtn.disabled = true;
  
  try {
    // Note: You'll need to add a batch upload endpoint to your API
    const response = await fetch(`${API_BASE}/batch-upload`, {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Upload failed');
    }
    
    popup.classList.remove("hidden");
  } catch (error) {
    showError(error.message);
  } finally {
    uploadBtn.innerText = "Upload";
    uploadBtn.disabled = false;
  }
});

closePopupBtn.addEventListener("click", () => {
  popup.classList.add("hidden");
  document.getElementById("batchUploadForm").reset();
});

cancelBtn.addEventListener("click", () => {
  document.getElementById("batchUploadForm").reset();
});

// Tab functionality
const tabs = ['personnel', 'nok', 'spouse', 'children', 'batch'];

function showTab(name) {
  tabs.forEach(t => {
    const tabBtn = document.getElementById('tab-' + t);
    const section = document.getElementById('section-' + t);
    
    if (tabBtn && section) {
      tabBtn.classList.remove('bg-blue-600', 'text-white');
      tabBtn.classList.add('bg-yellow-400', 'text-gray-900');
      section.classList.add('hidden');
    }
  });
  
  const activeTab = document.getElementById('tab-' + name);
  const activeSection = document.getElementById('section-' + name);
  
  if (activeTab && activeSection) {
    activeTab.classList.add('bg-blue-600', 'text-white');
    activeTab.classList.remove('bg-yellow-400', 'text-gray-900');
    activeSection.classList.remove('hidden');
  }
}

// Set up tab click handlers
document.getElementById('tab-personnel')?.addEventListener('click', () => showTab('personnel'));
document.getElementById('tab-nok')?.addEventListener('click', () => showTab('nok'));
document.getElementById('tab-spouse')?.addEventListener('click', () => showTab('spouse'));
document.getElementById('tab-children')?.addEventListener('click', () => showTab('children'));
document.getElementById('tab-batch')?.addEventListener('click', () => showTab('batch'));

// Default to personnel tab
showTab('personnel');

// Personnel form functionality
const formTitle = "Add New Personnel";
const fieldsStep1 = [
  "Service Number", "Rank", "Surname", "Other Names", "Date of Birth", "State Of Origin", "Local Government", "Town", "Residential Address", "Email Address", "GSM Number", "Sex", "Marital Status", "Religion", "Passport Photograph"
];

const step1Container = document.getElementById("step1");
const step2Container = document.getElementById("step2");
const step3Container = document.getElementById("step3");
const btnStep1 = document.getElementById("btnStep1");
const btnStep2 = document.getElementById("btnStep2");
const btnStep3 = document.getElementById("btnStep3");
const formTitleEl = document.getElementById("formTitle");
const personnelCancelBtn = document.getElementById("cancelBtn");

function controlWrap(label, control) {
  return `<div><label class="block text-sm font-medium text-gray-700">${label}</label>${control}</div>`;
}

function renderStep1() {
  if (!step1Container) return;
  
  step1Container.innerHTML = fieldsStep1.map(field => {
    if (["Rank", "Religion", "State Of Origin", "Local Government", "Sex", "Marital Status"].includes(field)) {
      return controlWrap(field,
        `<select id="field-${field.replace(/\s+/g, '-').toLowerCase()}" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
           <option value="">Select ${field}</option>
         </select>`);
    }
    if (field === "Passport Photograph") {
      return controlWrap(field,
        `<input id="field-${field.replace(/\s+/g, '-').toLowerCase()}" type="file" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
    }
    if (field === "Date of Birth") {
      return controlWrap(field,
        `<input id="field-${field.replace(/\s+/g, '-').toLowerCase()}" type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
    }
    return controlWrap(field,
      `<input id="field-${field.replace(/\s+/g, '-').toLowerCase()}" type="text" placeholder="${field}" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
  }).join("");
}

function toggleStep(step) {
  const containers = [step1Container, step2Container, step3Container];
  const buttons = [btnStep1, btnStep2, btnStep3];
  
  containers.forEach((container, i) => {
    if (container) {
      if (i === step - 1) {
        container.classList.remove("hidden");
      } else {
        container.classList.add("hidden");
      }
    }
  });
  
  buttons.forEach((button, i) => {
    if (button) {
      if (i === step - 1) {
        button.classList.add("bg-blue-600", "text-white");
        button.classList.remove("bg-yellow-400", "text-gray-900");
      } else {
        button.classList.add("bg-yellow-400", "text-gray-900");
        button.classList.remove("bg-blue-600", "text-white");
      }
    }
  });
}

// Personnel form submission
async function submitPersonnelForm() {
  const formData = new FormData(document.getElementById('personnelForm'));
  const personnelData = {};
  
  // Collect all form data
  for (let [key, value] of formData.entries()) {
    if (value.trim()) {
      personnelData[key] = value.trim();
    }
  }
  
  try {
    let result;
    if (currentEmployeeId) {
      // Update existing employee
      result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`, {
        method: 'PUT',
        body: JSON.stringify(personnelData)
      });
    } else {
      // Create new employee
      // Generate Empl_ID if not provided
      if (!personnelData.Empl_ID) {
        personnelData.Empl_ID = 'EMP' + 1; // Simple ID generation
      }
      
      result = await apiRequest(`${API_BASE}/employees`, {
        method: 'POST',
        body: JSON.stringify(personnelData)
      });
      
      // Set current employee ID for adding family members
      currentEmployeeId = personnelData.Empl_ID;
    }
    
    showPopup(currentEmployeeId ? "Personnel updated successfully" : "Personnel created successfully");
    
    // Don't reset form to allow adding family members
    if (!currentEmployeeId) {
      document.getElementById("personnelForm").reset();
      toggleStep(1);
    }
    
  } catch (error) {
    // Error already handled in apiRequest
  }
}

function cancelPersonnelForm() {
  document.getElementById("personnelForm").reset();
  currentEmployeeId = null;
  toggleStep(1);
}

// Initialize personnel form
if (formTitleEl) formTitleEl.textContent = formTitle;
renderStep1();
initializeDropdowns();
loadAllDropdowns();
toggleStep(1);

btnStep1?.addEventListener("click", () => toggleStep(1));
btnStep2?.addEventListener("click", () => toggleStep(2));
btnStep3?.addEventListener("click", () => toggleStep(3));
personnelCancelBtn?.addEventListener("click", cancelPersonnelForm);

// Add submit button handler
document.querySelector('#personnelForm button[type="button"]:last-child')?.addEventListener('click', submitPersonnelForm);

// NOK functionality
const nokFormWrap = document.getElementById('nokFormWrap');
const nokToggleBtn = document.getElementById('nokToggleBtn');
const nokSaveBtn = document.getElementById('nokSave');
const nokCancelBtn = document.getElementById('nokCancel');

nokToggleBtn?.addEventListener('click', () => toggleBlock(nokFormWrap, nokToggleBtn));

nokCancelBtn?.addEventListener('click', () => {
  document.getElementById('nokForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(nokFormWrap, nokToggleBtn);
});

nokSaveBtn?.addEventListener('click', async () => {
  const first = val('nokFirst');
  const last = val('nokLast');
  const rel = val('nokRelationship');
  const mobile = val('nokMobile');
  const email = val('nokEmail');
  const dob = val('nokDob');
  const address = val('nokAddress');
  const home = val('nokHome');
  const work = val('nokWork');
  const type = val('nokType');

  if (!first || !last || !rel || !mobile || !email || !address) {
    alert('Please fill all required fields');
    return;
  }

  if (!currentEmployeeId) {
    alert('Please create/select an employee first');
    return;
  }

  const nokData = {
    FirstName: first,
    LastName: last,
    NextofkinType: type || 'Main',
    Relationship: rel,
    MobileNumber: mobile,
    HomeNumber: home,
    EmailAddress: email,
    DateOfBirth: dob,
    FullAddress: address,
    PlaceOfWork: work
  };

  try {
    const list = document.getElementById('nokList');
    const empty = document.getElementById('nokEmpty');

    if (editState.type === "NOK" && editState.row && editState.id) {
      // Update existing NOK
      const result = await apiRequest(`${API_BASE}/nextofkin/${editState.id}`, {
        method: 'PUT',
        body: JSON.stringify(nokData)
      });

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = `${first} ${last}`;
      cells[1].textContent = rel;
      cells[2].textContent = mobile;
      cells[3].textContent = email;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("NOK updated successfully");
    } else {
      // Create new NOK
      const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/nextofkin`, {
        method: 'POST',
        body: JSON.stringify(nokData)
      });

      if (empty) empty.remove();
      
      nokCounter++;
      list.insertAdjacentHTML('beforeend', `
        <tr data-type="NOK" data-id="${result.nokId}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(first)} ${escapeHtml(last)}</td>
          <td class="border px-3 py-2">${escapeHtml(rel)}</td>
          <td class="border px-3 py-2">${escapeHtml(mobile)}</td>
          <td class="border px-3 py-2">${escapeHtml(email)}</td>
          <td class="border px-3 py-2">${actionBtns('NOK', result.nokId)}</td>
        </tr>`);
      showPopup("NOK saved successfully");
    }

    document.getElementById('nokForm')?.reset();
    toggleBlock(nokFormWrap, nokToggleBtn);
  } catch (error) {
    // Error already handled in apiRequest
  }
});

// Spouse functionality
const spouseFormWrap = document.getElementById('spouseFormWrap');
const spouseToggleBtn = document.getElementById('spouseToggleBtn');
const spouseSaveBtn = document.getElementById('spouseSave');
const spouseCancelBtn = document.getElementById('spouseCancel');

spouseToggleBtn?.addEventListener('click', () => toggleBlock(spouseFormWrap, spouseToggleBtn));

spouseCancelBtn?.addEventListener('click', () => {
  document.getElementById('spouseForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(spouseFormWrap, spouseToggleBtn);
});

spouseSaveBtn?.addEventListener('click', async () => {
  const name = val('spouseName');
  const phone = val('spousePhone');
  const email = val('spouseEmail');
  const dob = val('spouseDob');
  const dom = val('spouseDom');
  const street = val('spouseStreet');
  const town = val('spouseTown');
  const state = val('spouseState');
  const lga = val('spouseLga');
  const poBox = val('spousePoBox');

  if (!name) {
    alert('Full Name is required');
    return;
  }

  if (!currentEmployeeId) {
    alert('Please create/select an employee first');
    return;
  }

  const spouseData = {
    FullName: name,
    Phone: phone,
    Email: email,
    DateOfBirth: dob,
    marrieddate: dom,
    Street: street,
    Town: town,
    State: state,
    LocalGovernment: lga,
    POBox: poBox
  };

  try {
    const list = document.getElementById('spouseList');
    const empty = document.getElementById('spouseEmpty');

    if (editState.type === "Spouse" && editState.row && editState.id) {
      // Update existing spouse
      const result = await apiRequest(`${API_BASE}/spouse/${editState.id}`, {
        method: 'PUT',
        body: JSON.stringify(spouseData)
      });

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = name;
      cells[1].textContent = phone;
      cells[2].textContent = email;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("Spouse updated successfully");
    } else {
      // Create new spouse
      const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/spouse`, {
        method: 'POST',
        body: JSON.stringify(spouseData)
      });

      if (empty) empty.remove();
      
      spouseCounter++;
      list.insertAdjacentHTML('beforeend', `
        <tr data-type="Spouse" data-id="${result.spouseId}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(name)}</td>
          <td class="border px-3 py-2">${escapeHtml(phone)}</td>
          <td class="border px-3 py-2">${escapeHtml(email)}</td>
          <td class="border px-3 py-2">${actionBtns('Spouse', result.spouseId)}</td>
        </tr>`);
      showPopup("Spouse saved successfully");
    }

    document.getElementById('spouseForm')?.reset();
    toggleBlock(spouseFormWrap, spouseToggleBtn);
  } catch (error) {
    // Error already handled in apiRequest
  }
});

// Children functionality
const childFormWrap = document.getElementById('childFormWrap');
const childToggleBtn = document.getElementById('childToggleBtn');
const childSaveBtn = document.getElementById('childSave');
const childCancelBtn = document.getElementById('childCancel');

childToggleBtn?.addEventListener('click', () => toggleBlock(childFormWrap, childToggleBtn));

childCancelBtn?.addEventListener('click', () => {
  document.getElementById('childForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(childFormWrap, childToggleBtn);
});

childSaveBtn?.addEventListener('click', async () => {
  const name = val('childName');
  const sex = val('childSex');
  const dob = val('childDob');
  const phone = val('childPhone');
  const email = val('childEmail');
  const street = val('childStreet');
  const town = val('childTown');
  const state = val('childState');
  const lga = val('childLga');
  const poBox = val('childPoBox');
  const school = val('childSchool');
  const office = val('childOffice');
  const occupation = val('childOccupation');

  if (!name) {
    alert('Full Name is required');
    return;
  }

  if (!currentEmployeeId) {
    alert('Please create/select an employee first');
    return;
  }

  const childData = {
    FullName: name,
    Sex: sex,
    dateofbirth: dob,
    Phone: phone,
    Email: email,
    Street: street,
    Town: town,
    State: state,
    LocalGovernment: lga,
    POBox: poBox,
    School: school,
    OfficeAddress: office,
    Occupation: occupation
  };

  try {
    const list = document.getElementById('childList');
    const empty = document.getElementById('childEmpty');

    if (editState.type === "Child" && editState.row && editState.id) {
      // Update existing child
      const result = await apiRequest(`${API_BASE}/children/${editState.id}`, {
        method: 'PUT',
        body: JSON.stringify(childData)
      });

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = name;
      cells[1].textContent = sex;
      cells[2].textContent = dob;
      cells[3].textContent = phone;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("Child updated successfully");
    } else {
      // Create new child
      const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/children`, {
        method: 'POST',
        body: JSON.stringify(childData)
      });

      if (empty) empty.remove();
      
      childCounter++;
      list.insertAdjacentHTML('beforeend', `
        <tr data-type="Child" data-id="${result.childId}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(name)}</td>
          <td class="border px-3 py-2">${escapeHtml(sex)}</td>
          <td class="border px-3 py-2">${escapeHtml(dob)}</td>
          <td class="border px-3 py-2">${escapeHtml(phone)}</td>
          <td class="border px-3 py-2">${actionBtns('Child', result.childId)}</td>
        </tr>`);
      showPopup("Child saved successfully");
    }

    document.getElementById('childForm')?.reset();
    toggleBlock(childFormWrap, childToggleBtn);
  } catch (error) {
    // Error already handled in apiRequest
  }
});

// Load existing employee data function
async function loadEmployeeData(employeeId) {
  try {
    const result = await apiRequest(`${API_BASE}/employees/${employeeId}`);
    const { employee, children, nextOfKin, spouse } = result.data;
    
    currentEmployeeId = employeeId;
    
    // Populate employee form (you'll need to map fields to your form inputs)
    
    // Load NOK data
    const nokList = document.getElementById('nokList');
    nokList.innerHTML = '';
    if (nextOfKin.length === 0) {
      nokList.innerHTML = '<tr id="nokEmpty"><td colspan="5" class="py-4 text-gray-500">No NOKs yet.</td></tr>';
    } else {
      nextOfKin.forEach(nok => {
        nokList.insertAdjacentHTML('beforeend', `
          <tr data-type="NOK" data-id="${nok.nok_id}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(nok.FirstName)} ${escapeHtml(nok.LastName)}</td>
            <td class="border px-3 py-2">${escapeHtml(nok.Relationship)}</td>
            <td class="border px-3 py-2">${escapeHtml(nok.MobileNumber)}</td>
            <td class="border px-3 py-2">${escapeHtml(nok.EmailAddress)}</td>
            <td class="border px-3 py-2">${actionBtns('NOK', nok.nok_id)}</td>
          </tr>`);
      });
    }
    
    // Load spouse data
    const spouseList = document.getElementById('spouseList');
    spouseList.innerHTML = '';
    if (spouse.length === 0) {
      spouseList.innerHTML = '<tr id="spouseEmpty"><td colspan="4" class="py-4 text-gray-500">No spouse records yet.</td></tr>';
    } else {
      spouse.forEach(sp => {
        spouseList.insertAdjacentHTML('beforeend', `
          <tr data-type="Spouse" data-id="${sp.spouse_id}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(sp.FullName)}</td>
            <td class="border px-3 py-2">${escapeHtml(sp.Phone)}</td>
            <td class="border px-3 py-2">${escapeHtml(sp.Email)}</td>
            <td class="border px-3 py-2">${actionBtns('Spouse', sp.spouse_id)}</td>
          </tr>`);
      });
    }
    
    // Load children data
    const childList = document.getElementById('childList');
    childList.innerHTML = '';
    if (children.length === 0) {
      childList.innerHTML = '<tr id="childEmpty"><td colspan="5" class="py-4 text-gray-500">No children yet.</td></tr>';
    } else {
      children.forEach(child => {
        childList.insertAdjacentHTML('beforeend', `
          <tr data-type="Child" data-id="${child.child_id}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(child.FullName)}</td>
            <td class="border px-3 py-2">${escapeHtml(child.Sex)}</td>
            <td class="border px-3 py-2">${escapeHtml(child.dateofbirth)}</td>
            <td class="border px-3 py-2">${escapeHtml(child.Phone)}</td>
            <td class="border px-3 py-2">${actionBtns('Child', child.child_id)}</td>
          </tr>`);
      });
    }
    
    showPopup("Employee data loaded successfully");
  } catch (error) {
    // Error already handled in apiRequest
  }
}

// Utility function to populate form fields from employee data
function populateEmployeeForm(employee) {
  // Map API field names to form field IDs
  const fieldMappings = {
    'Service Number': 'field-service-number',
    'Rank': 'field-rank',
    'Surname': 'field-surname',
    'Other Names': 'field-other-names',
    'Date of Birth': 'field-date-of-birth',
    'State Of Origin': 'field-state-of-origin',
    'Local Government': 'field-local-government',
    'Town': 'field-town',
    'Residential Address': 'field-residential-address',
    'Email Address': 'field-email-address',
    'GSM Number': 'field-gsm-number',
    'Sex': 'field-sex',
    'Marital Status': 'field-marital-status',
    'Religion': 'field-religion'
  };

  // Populate form fields
  Object.entries(fieldMappings).forEach(([label, fieldId]) => {
    const element = document.getElementById(fieldId);
    if (element && employee[label]) {
      element.value = employee[label];
    }
  });
}

// Search and load employee functionality
async function searchEmployee(query) {
  try {
    const result = await apiRequest(`${API_BASE}/employees?search=${encodeURIComponent(query)}`);
    return result.data;
  } catch (error) {
    return [];
  }
}

// Initialize employee search if needed
function initializeEmployeeSearch() {
  const searchInput = document.getElementById('employeeSearch');
  const searchResults = document.getElementById('searchResults');
  
  if (searchInput && searchResults) {
    let searchTimeout;
    
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        searchResults.innerHTML = '';
        searchResults.classList.add('hidden');
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const employees = await searchEmployee(query);
          displaySearchResults(employees, searchResults);
        } catch (error) {
          console.error('Search failed:', error);
        }
      }, 300);
    });
  }
}

function displaySearchResults(employees, container) {
  if (employees.length === 0) {
    container.innerHTML = '<div class="p-2 text-gray-500">No employees found</div>';
    container.classList.remove('hidden');
    return;
  }
  
  container.innerHTML = employees.map(emp => `
    <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" 
         onclick="selectEmployee('${emp.Empl_ID}')">
      <div class="font-medium">${escapeHtml(emp.Surname)} ${escapeHtml(emp.OtherName)}</div>
      <div class="text-sm text-gray-500">${escapeHtml(emp.Empl_ID)} - ${escapeHtml(emp.Rank)}</div>
    </div>
  `).join('');
  
  container.classList.remove('hidden');
}

window.selectEmployee = async function(employeeId) {
  const searchResults = document.getElementById('searchResults');
  if (searchResults) {
    searchResults.classList.add('hidden');
  }
  
  await loadEmployeeData(employeeId);
  
  // Switch to personnel tab to show loaded data
  showTab('personnel');
};

// Enhanced form validation
function validatePersonnelForm() {
  const requiredFields = [
    'field-service-number',
    'field-rank', 
    'field-surname',
    'field-other-names',
    'field-date-of-birth'
  ];
  
  const missingFields = [];
  
  requiredFields.forEach(fieldId => {
    const element = document.getElementById(fieldId);
    if (element && !element.value.trim()) {
      missingFields.push(element.placeholder || fieldId);
    }
  });
  
  if (missingFields.length > 0) {
    alert(`Please fill in the following required fields:\n${missingFields.join('\n')}`);
    return false;
  }
  
  return true;
}

// Enhanced personnel form submission with validation
async function submitPersonnelFormWithValidation() {
  if (!validatePersonnelForm()) {
    return;
  }
  
  await submitPersonnelForm();
}

// Get all employees for listing
async function loadAllEmployees() {
  try {
    const result = await apiRequest(`${API_BASE}/employees`);
    return result.data;
  } catch (error) {
    return [];
  }
}

// Export functions for external use
window.PersonnelAPI = {
  loadEmployeeData,
  loadAllEmployees,
  searchEmployee,
  selectEmployee,
  deleteRecord,
  setCurrentEmployee: (id) => { currentEmployeeId = id; },
  getCurrentEmployee: () => currentEmployeeId,
  validateForm: validatePersonnelForm
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  initializeEmployeeSearch();
  
  // Set up form validation on submit
  const submitButton = document.querySelector('#personnelForm button[type="button"]:last-child');
  if (submitButton) {
    submitButton.removeEventListener('click', submitPersonnelForm);
    submitButton.addEventListener('click', submitPersonnelFormWithValidation);
  }
});

// Additional utility functions for data management
function resetAllForms() {
  const forms = ['personnelForm', 'nokForm', 'spouseForm', 'childForm'];
  forms.forEach(formId => {
    const form = document.getElementById(formId);
    if (form) form.reset();
  });
  
  currentEmployeeId = null;
  editState.type = null;
  editState.row = null;
  editState.id = null;
}

function clearAllTables() {
  const tables = [
    { listId: 'nokList', emptyId: 'nokEmpty', colspan: '5', message: 'No NOKs yet.' },
    { listId: 'spouseList', emptyId: 'spouseEmpty', colspan: '4', message: 'No spouse records yet.' },
    { listId: 'childList', emptyId: 'childEmpty', colspan: '5', message: 'No children yet.' }
  ];
  
  tables.forEach(({ listId, emptyId, colspan, message }) => {
    const list = document.getElementById(listId);
    if (list) {
      list.innerHTML = `<tr id="${emptyId}"><td colspan="${colspan}" class="py-4 text-gray-500">${message}</td></tr>`;
    }
  });
}

// Export additional utilities
window.PersonnelUtils = {
  resetAllForms,
  clearAllTables,
  escapeHtml,
  showPopup,
  showError
};
</script>