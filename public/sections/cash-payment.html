<div class="p-6">
  <!-- Add New Button -->
  <div class="flex justify-end mb-4">
    <button
      id="addNewBtn"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      + Add New
    </button>
  </div>

  
  <!-- Add/Edit Form (hidden initially) -->
  <div
    id="salaryForm"
    class="hidden items mb-4 border rounded-lg p-4 max-w-lg mx-auto">
    <h4 class="text-lg font-bold text-blue-600 mb-3">Add/Edit Overpayment Percentage</h4>
    <form class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Basic Salary</label>
        <select
          id="salaryInput"
          class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Enter Basic Salary">
          <option value=""></option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Percentage</label>
        <input
          type="number"
          id="percentageInput"
          step="0.1"
          class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Enter Overpayment Percentage"/>
      </div>
      <div class="flex justify-end space-x-3">
        <button
          type="button"
          id="saveBtn"
          class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
          Save
        </button>
        <button
          type="button"
          id="cancelBtn"
          class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border text-sm">
      <thead class="bg-blue-100">
        <tr>
          <th class="border px-3 py-2 text-left">Basic Salary Record</th>
          <th class="border px-3 py-2 text-left">Overpayment Percentage (%)</th>
          <th class="border px-3 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="salaryTable">
        <!-- Dummy data -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-xl text-center">
    <p class="text-lg font-semibold text-green-600">âœ… Saved Successfully!</p>
  </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
    <h3 id="alertTitle" class="text-lg font-semibold text-gray-800 mb-2">Alert!</h3>
    <p id="alertMessage" class="text-gray-600 mb-4"></p>
    <button id="alertOkBtn" 
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      OK
    </button>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Confirm</h3>
    <p id="confirmMessage" class="text-gray-700 mb-6"></p>
    <div class="flex justify-end gap-3">
      <button id="confirmNoBtn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">No</button>
      <button id="confirmYesBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Yes</button>
    </div>
  </div>
</div>


<script>
(function () {
  const apiUrl = "/overpayment"; 
  let bt04 = null; // holds BT04 record
  let lookupMaps = {};

  // Load dropdown
  async function loadDropdown(endpoint, elementId, valueField, textField, placeholder) {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/reference/${endpoint}`, {   
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}` 
        }
      });
      const data = await response.json();
      const dropdown = document.getElementById(elementId);
      if (!dropdown) return;
      dropdown.innerHTML = `<option value="">${placeholder}</option>`;
      data.forEach(item => {
        const option = document.createElement("option");
        option.value = item[valueField];
        option.textContent = item[textField];
        dropdown.appendChild(option);

        lookupMaps[endpoint] = Object.fromEntries(
          data.map(item => [item[valueField], item[textField]])
        );
      });
      return data;
    } catch (err) {
      console.error(`Failed to load ${endpoint}:`, err);
      return [];
    }
  }

  async function loadAllDropdowns() {
    const promises = [
      await loadDropdown("elementtype", "salaryInput", "PaymentType", "elmDesc", "Select Type")
    ]
    await Promise.all(promises);
  }

  function getValueField(endpoint) {
    const fieldMap = {
      'elementtype': 'PaymentType'
    };
    return fieldMap[endpoint] || 'code';
  }

  function getTextField(endpoint) {
    const fieldMap = {
      'elementtype': 'elmDesc'
    }
    return fieldMap[endpoint] || 'name';
  }

  function resolveName(code, endpoint) {
    if (!code) return 'N/A';
    return lookupMaps[endpoint]?.[code] || code;
  }

  function showModal() { 
    const modal = document.getElementById('successModal'); 
    modal.classList.remove("hidden"); 
    setTimeout(() => modal.classList.add("hidden"), 1000); 
  }

  function showAlert(message, title = "Alert") {
    const modal = document.getElementById("alertModal");
    const msg = document.getElementById("alertMessage");
    const ttl = document.getElementById("alertTitle");
    const okBtn = document.getElementById("alertOkBtn");

    ttl.textContent = title;
    msg.textContent = message;

    modal.classList.remove("hidden");
    okBtn.onclick = () => modal.classList.add("hidden");
  }

  function showConfirm(message, title = "Confirm", onConfirm) {
    const modal = document.getElementById("confirmModal");
    const msg = document.getElementById("confirmMessage");
    const ttl = document.getElementById("confirmTitle");
    const yesBtn = document.getElementById("confirmYesBtn");
    const noBtn = document.getElementById("confirmNoBtn");

    ttl.textContent = title;
    msg.textContent = message;
    modal.classList.remove("hidden");

    yesBtn.onclick = () => {
      modal.classList.add("hidden");
      if (onConfirm) onConfirm();
    };
    noBtn.onclick = () => modal.classList.add("hidden");
  }

  async function loadOverpayment() {
    const res = await fetch(apiUrl, { 
      headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
    });
    bt04 = await res.json();
    renderTable();
  }

  // Render table
  function renderTable() {
    salaryTable.innerHTML = "";
    if (bt04 && bt04.basicpay) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="border px-3 py-2">${resolveName(bt04.basicpay, "elementtype")} (${bt04.basicpay})</td>
        <td class="border px-3 py-2">${bt04.ord || 0}%</td>
        <td class="border px-3 py-2 text-center">
          <button class="text-blue-500 editBtn mr-2">Edit</button>
          <button class="text-red-500 deleteBtn">Delete</button>
        </td>
      `;
      salaryTable.appendChild(row);
    }
  }

  // Show form
  addNewBtn.addEventListener("click", () => {
    // Prevent multiple record creation
    if (bt04 && bt04.basicpay) {
      showAlert("A record already exists. Please edit the existing record instead of adding a new one.", "Cannot Add New Record");
      return;
    }
    salaryInput.value = "";
    percentageInput.value = ""; 
    salaryForm.classList.remove("hidden");
    salaryInput.disabled = false; // allow editing
  });

  // Save
  saveBtn.addEventListener("click", async () => {
    const salary = salaryInput.value.trim();
    const percentage = parseFloat(percentageInput.value);

    if (!salary || isNaN(percentage)) {
      showAlert("Please enter salary and percentage");
      return;
    }

    const body = JSON.stringify({ 
      basicpay: salary,
      ord: percentage
    });
    const headers = { 
      "Content-Type": "application/json", 
      "Authorization": `Bearer ${localStorage.getItem("token")}` 
    };

    try {
      if (bt04 && bt04.basicpay) {
        // Update existing record
        const res = await fetch(apiUrl, { method: "PUT", headers, body });
        if (!res.ok) throw new Error("Failed to update");
        showModal();
      } else {
        // Create new record
        const res = await fetch(apiUrl, { method: "POST", headers, body });
        if (!res.ok) throw new Error("Failed to create");
        showModal();
      }

      salaryForm.classList.add("hidden");
      await loadOverpayment();
    } catch (err) {
      showAlert(err.message || "Error saving record");
    }
  });

  // Delete
  async function deleteRecord() {
    try {
      const headers = { "Authorization": `Bearer ${localStorage.getItem("token")}` };
      const res = await fetch(apiUrl, { method: "DELETE", headers });
      if (!res.ok) throw new Error("Failed to delete");
      showAlert("Record deleted successfully");
      bt04 = null;
      renderTable();
    } catch (error) {
      showAlert("Failed to delete record. Please try again.", "Error");
    }
  }

  // Edit and Delete handlers
  salaryTable.addEventListener("click", (e) => {
    if (e.target.classList.contains("editBtn")) {
      salaryInput.value = bt04.basicpay;
      percentageInput.value = bt04.ord || 0;
      salaryInput.disabled = false; // allow editing both fields
      salaryForm.classList.remove("hidden");
    }

    if (e.target.classList.contains("deleteBtn")) {
      showConfirm(
        "Are you sure you want to delete this record? This action cannot be undone.",
        "Confirm Delete",
        deleteRecord
      );
    }
  });

  cancelBtn.addEventListener("click", () => {
    salaryForm.classList.add("hidden");
  });

(async function init() {
  await loadAllDropdowns();
  await loadOverpayment();
})();
})();
</script>
