<div class="p-6">
  <div class="flex flex-wrap justify-between">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">
      Tax Table Configuration
    </h2>
    <div class="mb-4 flex justify-end gap-2">
      <button
        id="showFormBtn"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        + Add New
      </button>
      <button
        id="configureMfpBtn"
        class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
      >
        Configure Minimum Free Pay
      </button>
      <button
        id="generateReportBtn"
        class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
      >
        <i class="fas fa-file-alt mr-2"></i>Generate Report
      </button>
    </div>
  </div>

  <!-- Band Form -->
  <form id="bandForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 hidden">
    <div>
      <label class="block text-sm font-medium text-gray-700">Interval</label>
      <input
        type="text"
        id="interval"
        class="w-full border border-blue-500 rounded-md px-3 py-2"
        placeholder="e.g., 1"
      />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Value</label>
      <input
        type="number"
        id="value"
        class="w-full border border-blue-500 rounded-md px-3 py-2"
        placeholder="Enter value"
      />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Percentage</label>
      <input
        type="number"
        id="percentage"
        step="0.01"
        class="w-full border border-blue-500 rounded-md px-3 py-2"
        placeholder="Enter percentage"
      />
    </div>
    <div class="col-span-1 md:col-span-3 flex justify-end gap-2">
      <button
        type="button"
        id="saveBandBtn"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        Save
      </button>
      <button
        type="button"
        id="cancelBandBtn"
        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
      >
        Cancel
      </button>
    </div>
  </form>

  <!-- Minimum Free Pay Form -->
  <form id="mfpForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
    <div>
      <label class="block text-sm font-medium text-gray-700"
        >Free Pay Value</label
      >
      <input
        type="number"
        id="mfpValue"
        class="w-full border border-purple-500 rounded-md px-3 py-2"
        placeholder="e.g., 800000"
      />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Percentage</label>
      <input
        type="number"
        id="mfpPerc"
        class="w-full border border-purple-500 rounded-md px-3 py-2"
        placeholder="e.g., 0"
      />
    </div>
    <div class="col-span-1 md:col-span-2 flex justify-end gap-2">
      <button
        type="button"
        id="saveMfpBtn"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        Save
      </button>
      <button
        type="button"
        id="cancelMfpBtn"
        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
      >
        Cancel
      </button>
    </div>
  </form>

  <!-- Data Display Table -->
  <div class="p-6 overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="border px-2 py-3 text-left">Interval</th>
          <th class="border px-2 py-3 text-left">Value</th>
          <th class="border px-2 py-3 text-left">Percentage</th>
          <th class="border px-2 py-3 text-left">Cumulative</th>
          <th class="border px-2 py-3 text-left">Lower Bound</th>
          <th class="border px-2 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="bandTableBody">
        <!-- Data will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Success Modal -->
<div
  id="successModal"
  class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-2 text-green-600">Success!</h3>
    <p class="mb-4 text-gray-700">Action completed successfully!</p>
    <button
      id="closeSuccessModal"
      class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
    >
      OK
    </button>
  </div>
</div>

<!-- Alert Modal -->
<div
  id="alertModal"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50"
>
  <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
    <h3 id="alertTitle" class="text-lg font-semibold text-gray-800 mb-2">
      Alert!
    </h3>
    <p id="alertMessage" class="text-gray-600 mb-4"></p>
    <button
      id="alertOkBtn"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      OK
    </button>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div
  id="confirmModal"
  class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="confirmMessage" class="mb-4 text-gray-700">
      Are you sure you want to delete this record?
    </p>
    <div class="flex justify-end gap-2">
      <button
        id="cancelDeleteBtn"
        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
      >
        Cancel
      </button>
      <button
        id="confirmDeleteBtn"
        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<script>
  const auth = window.authService;
  const API_URL = "/api/tax";
  const token = localStorage.getItem("token");
  let bandData = [];
  let editingIndex = null;

  const bandForm = document.getElementById("bandForm");
  const mfpForm = document.getElementById("mfpForm");
  const bandTableBody = document.getElementById("bandTableBody");

  // Load all bands (INTER<>999)
  async function loadBands() {
    try {
      const res = await auth.fetchWithAuth(API_URL, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) throw new Error("Failed to load bands");
      bandData = await res.json();
      renderBandTable();
    } catch (err) {
      console.error(err);
      showAlert("Error loading bands.");
    }
  }

  function renderBandTable() {
    bandTableBody.innerHTML = bandData
      .map(
        (item, index) => `
      <tr class="hover:bg-yellow-50">
        <td class="border px-2 py-3">${item.INTER}</td>
        <td class="border px-2 py-3">${item.val}</td>
        <td class="border px-2 py-3">${item.perc}%</td>
        <td class="border px-2 py-3">${item.cumval ?? "N/A"}</td>
        <td class="border px-2 py-3">${item.lowbound ?? "N/A"}</td>
        <td class="border px-2 py-3 text-sm">
          <button onclick="editBand(${index})" class="text-green-600 hover:text-green-900 mr-2">Edit</button>
          <button onclick="deleteBand(${index})" class="text-red-600 hover:text-red-900">Delete</button>
        </td>
      </tr>
    `
      )
      .join("");
  }

  // --- Band CRUD ---
  document.getElementById("showFormBtn").addEventListener("click", () => {
    bandForm.classList.remove("hidden");
    editingIndex = null;
    resetBandForm();
  });

  document.getElementById("cancelBandBtn").addEventListener("click", () => {
    bandForm.classList.add("hidden");
    resetBandForm();
  });

  document.getElementById("saveBandBtn").addEventListener("click", async () => {
    const payload = {
      INTER: document.getElementById("interval").value.trim(),
      val: parseInt(document.getElementById("value").value.trim()),
      perc: parseFloat(document.getElementById("percentage").value.trim()),
    };

    const requiredFields = ["INTER", "val", "perc"];

    let missingFields = requiredFields.filter(
      (field) => !payload[field] && payload[field] !== 0
    );

    if (missingFields.length) {
      return showAlert(
        `Please fill in all required fields: ${missingFields.join(", ")}`
      );
    }

    try {
      let response;
      if (editingIndex !== null) {
        response = await auth.fetchWithAuth(`${API_URL}/${payload.INTER}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
      } else {
        response = await auth.fetchWithAuth(`${API_URL}/create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
      }
      if (!response.ok) throw new Error("Save failed");
      await loadBands();
      bandForm.classList.add("hidden");
      showSuccessModal();
    } catch (err) {
      showAlert(err.message);
    }
  });

  window.editBand = function (index) {
    const item = bandData[index];
    document.getElementById("interval").value = item.INTER;
    document.getElementById("value").value = item.val;
    document.getElementById("percentage").value = item.perc;
    editingIndex = index;
    bandForm.classList.remove("hidden");
  };

  window.deleteBand = async function (index) {
    const item = bandData[index];
    if (await confirmModal("Delete this band?")) {
      await auth.fetchWithAuth(`${API_URL}/${item.INTER}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });
      await loadBands();
      showSuccessModal();
    }
  };

  function resetBandForm() {
    ["interval", "value", "percentage"].forEach(
      (id) => (document.getElementById(id).value = "")
    );
  }

  // --- Minimum Free Pay ---
  document
    .getElementById("configureMfpBtn")
    .addEventListener("click", async () => {
      try {
        const res = await auth.fetchWithAuth(`${API_URL}/999`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) {
          const mfp = await res.json();
          document.getElementById("mfpValue").value = mfp.val || "";
          document.getElementById("mfpPerc").value = mfp.perc || "";
        }
      } catch {}
      mfpForm.classList.remove("hidden");
    });

  document.getElementById("cancelMfpBtn").addEventListener("click", () => {
    mfpForm.classList.add("hidden");
  });

  document.getElementById("saveMfpBtn").addEventListener("click", async () => {
    const val = document.getElementById("mfpValue").value.trim();
    const perc = document.getElementById("mfpPerc").value.trim();
    const payload = {
      INTER: 999,
      val: parseInt(val),
      perc: parseFloat(perc) || 0,
    };
    try {
      const res = await auth.fetchWithAuth(`${API_URL}/999`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      let response;
      if (res.ok) {
        response = await auth.fetchWithAuth(`${API_URL}/999`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
      } else {
        response = await auth.fetchWithAuth(`${API_URL}/create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
      }
      if (!response.ok) throw new Error("Save failed");
      showSuccessModal();
      mfpForm.classList.add("hidden");
    } catch {
      showAlert("Error saving Minimum Free Pay");
    }
  });

  // --- Modals ---
  function showSuccessModal() {
    document.getElementById("successModal").classList.remove("hidden");
  }
  document
    .getElementById("closeSuccessModal")
    .addEventListener("click", () =>
      document.getElementById("successModal").classList.add("hidden")
    );

  function showAlert(message, title = "Alert") {
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertMessage").textContent = message;
    document.getElementById("alertModal").classList.remove("hidden");
    document.getElementById("alertOkBtn").onclick = () =>
      document.getElementById("alertModal").classList.add("hidden");
  }

  function confirmModal(message = "Are you sure?") {
    return new Promise((resolve) => {
      const modal = document.getElementById("confirmModal");
      document.getElementById("confirmMessage").textContent = message;
      modal.classList.remove("hidden");
      document.getElementById("cancelDeleteBtn").onclick = () => {
        modal.classList.add("hidden");
        resolve(false);
      };
      document.getElementById("confirmDeleteBtn").onclick = () => {
        modal.classList.add("hidden");
        resolve(true);
      };
    });
  }

  async function generateReport() {
    const now = new Date();
    const dateStr = `${String(now.getDate()).padStart(2, "0")}-${String(
      now.getMonth() + 1
    ).padStart(2, "0")}-${now.getFullYear()}`;
    const timeStr = `${String(now.getHours()).padStart(2, "0")}:${String(
      now.getMinutes()
    ).padStart(2, "0")}`;

    // Fetch MFP separately
    let mfpData = null;
    try {
      const res = await auth.fetchWithAuth(`${API_URL}/999`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (res.ok) mfpData = await res.json();
    } catch (err) {
      console.warn("MFP not found");
    }

    const printWindow = window.open("", "_blank");

    const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Tax Table Configuration Report</title>
      <style>
        body { 
          font-family: Arial, sans-serif;
          margin: 20px;
          color: #333;
        }
        .report-header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #1a56db;
        }
        .report-title {
          font-size: 24px;
          color: #1a56db;
          margin: 10px 0;
        }
        .date-time {
          font-size: 14px;
          color: #666;
          margin: 10px 0;
        }
        .section-title {
          font-size: 16px;
          color: #1a56db;
          margin: 20px 0 10px 0;
          padding-bottom: 5px;
          border-bottom: 1px solid #e5e7eb;
        }
        .tax-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
          font-size: 12px;
        }
        .tax-table th {
          background-color: #f3f4f6;
          padding: 8px;
          text-align: left;
          border: 1px solid #e5e7eb;
          font-weight: bold;
        }
        .tax-table td {
          padding: 8px;
          border: 1px solid #e5e7eb;
        }
        .tax-table tr:nth-child(even) {
          background-color: #fafafa;
        }
        .amount {
          text-align: right;
          font-family: monospace;
        }
        .mfp-section {
          background: #f9fafb;
          padding: 15px;
          border: 1px solid #e5e7eb;
          border-radius: 5px;
          margin: 20px 0;
        }
        .report-footer {
          margin-top: 20px;
          text-align: center;
          font-size: 12px;
          color: #666;
          border-top: 1px solid #e5e7eb;
          padding-top: 15px;
        }
      </style>
    </head>
    <body>
      <div class="report-header">
        <div class="report-title">Tax Table Configuration Report</div>
        <div class="date-time">Generated on: ${dateStr} at ${timeStr}</div>
      </div>

      <!-- Bands -->
      <div class="section-title">Tax Bands Configuration</div>
      <table class="tax-table">
        <thead>
          <tr>
            <th>S/N</th>
            <th>Interval</th>
            <th>Value (₦)</th>
            <th>Percentage (%)</th>
            <th>Cumulative (₦)</th>
            <th>Lower Bound (₦)</th>
          </tr>
        </thead>
        <tbody>
          ${bandData
            .map(
              (item, index) => `
            <tr>
              <td style="text-align:center">${index + 1}</td>
              <td>${item.INTER}</td>
              <td class="amount">${
                item.val?.toLocaleString("en-NG") || "-"
              }</td>
              <td style="text-align:center">${item.perc}%</td>
              <td class="amount">${
                item.cumval?.toLocaleString("en-NG") || "-"
              }</td>
              <td class="amount">${
                item.lowbound?.toLocaleString("en-NG") || "-"
              }</td>
            </tr>`
            )
            .join("")}
        </tbody>
      </table>

      <!-- MFP -->
      <div class="mfp-section">
        <div class="section-title">Minimum Free Pay Configuration</div>
        <table class="tax-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Value (₦)</th>
              <th>Percentage (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Minimum Free Pay</td>
              <td class="amount">${
                mfpData?.val?.toLocaleString("en-NG") || "0"
              }</td>
              <td style="text-align:center">${mfpData?.perc || 0}%</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="report-footer">
        <p>Total Tax Bands: ${bandData.length}</p>
        <p>Generated by: ${
          localStorage.getItem("full_name") || "System User"
        }</p>
        <p>*** End of Report ***</p>
      </div>
    </body>
    </html>
  `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
  }

  // Add event listener to generate report button
  document
    .getElementById("generateReportBtn")
    .addEventListener("click", generateReport);

  // Init
  loadBands();
</script>
