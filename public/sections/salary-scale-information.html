<div class="p-6">

  <!-- Toggle Navigation -->
  <div class="w-fit flex gap-4 p-2 mb-6 bg-white/50 rounded-xl border border-amber-50 shadow-sm">
    <button id="btnGroups" class="px-4 py-2 rounded-md text-gray-900 hover:bg-blue-600">Salary Groups</button>
    <button id="btnScales" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">Salary Scale</button>
  </div>

  <!-- Salary Groups -->
  <div id="groupSection">
    <div class="flex justify-between mb-4">
      <h2 class="text-xl lg:text-2xl text-blue-600 font-bold">Salary Groups</h2>
      <div class="flex flex-wrap gap-2">
        <button id="addNewGroupBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add New Group</button>
        <!--<button id="generateReportBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
        <i class="fas fa-file-alt mr-2"></i>Generate Report</button>      -->
      </div>
    </div>

    <form id="groupForm" class="hidden grid grid-cols-2 gap-4">
      <label>Group Code</label>
      <input type="text" maxlength="6" id="groupCode" class="border p-2 rounded">
      <label>Description</label>
      <input type="text" id="groupDesc" class="border p-2 rounded">
      <label>Effective Date</label>
      <input type="date" id="groupEff" class="border p-2 rounded">
      <label>Last Date</label>
      <input type="date" id="groupLast" class="border p-2 rounded">
      <div class="col-span-2 flex justify-end gap-2">
        <button type="button" id="saveGroupBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
        <button type="button" id="cancelGroupBtn" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
      </div>
    </form>

    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-blue-100 text-blue-900">
          <tr>
            <th class="border px-2 py-3 text-left">Code</th>
            <th class="border px-2 py-3 text-left">Description</th>
            <th class="border px-2 py-3 text-left">Effective Date</th>
            <th class="border px-2 py-3 text-left">Last Date</th>
            <th class="border px-2 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="groupTable">
           <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Salary Scales -->
  <div id="scaleSection" class="hidden">
    <div class="flex flex-wrap gap-4 justify-between mb-4">
      <div>
        <h2 class="text-xl lg:text-2xl text-blue-600 font-bold">Salary Scale</h2>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="addNewScaleBtn" type="button"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          + Add New Scale
        </button>
        <button id="tabBatchBtn" type="button"
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Batch Upload
        </button>
         <button id="generateReportBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
        <i class="fas fa-file-alt mr-2"></i>Generate Report</button>
      </div>
    </div>

    <!-- Add New Scale Form -->
    <form id="scaleForm"
          class="hidden grid grid-cols-2 gap-4 p-4">
      <label>Salary Group</label>
      <select id="scaleGroup" class="border p-2 rounded">
        <option value="">Select Group</option>
      </select>
      <label>Element Type</label>
      <select id="scaleElement" class="border p-2 rounded">
        <option value="">Select Element</option>
      </select>
      <label>Grade Level</label>
      <select id="scaleGrade" class="border p-2 rounded">
        <option value="">Select Grade</option>
      </select>

      <div id="stepFields"
          class="col-span-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mt-4 hidden"></div>

      <div class="col-span-2 flex justify-end mt-6 gap-2">
        <button type="submit"
          class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Save
        </button>
        <button type="button" id="cancelScaleBtn"
          class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
          Cancel
        </button>
      </div>
    </form>

    <!-- Batch Upload Form -->
    <div class="flex justify-end">
      <form id="batchUploadForm"
            class="hidden w-full max-w-lg rounded-2xl pt-6 p-2">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
          <input type="file" id="batchFile"
            class="mt-1 block w-full border border-blue-500 bg-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
          <p class="text-xs text-gray-500 mt-2">
            Only .xlsx or .csv files allowed.
            <button type="button" id="downloadSampleBtn" class="text-blue-600 hover:underline ml-2 bg-none border-none cursor-pointer">
              Download Sample Template
            </button>
          </p>
        </div>

        <div class="flex justify-end space-x-4 mt-4">
          <button type="button" id="uploadBatchBtn"
            class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded text-white">
            Upload
          </button>

          <button type="button" id="cancelBatchBtn"
            class="px-6 py-2 bg-gray-400 hover:bg-gray-500 rounded text-white">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-blue-100 text-blue-900">
          <tr>
            <th class="border px-2 py-3 text-left">Salary Code</th>
            <th class="border px-2 py-3 text-left">Paycode</th>
            <th class="border px-2 py-3 text-left">Grade</th>
            <th class="border px-2 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="scaleTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- View Modal -->
<div id="scaleViewModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gradient-to-br from-blue-50 to-yellow-50 p-6 rounded-2xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto border border-blue-100">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-3">
      <h3 class="text-xl font-bold text-blue-700 flex items-center gap-2">
        Salary Scale Details
      </h3>
      <button id="closeScaleView" class="text-red-500 hover:text-red-600 transition transform hover:scale-110">
        âœ–
      </button>
    </div>

    <!-- Content -->
    <div id="scaleViewContent" class="space-y-6"></div>
  </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
    <h3 id="alertTitle" class="text-lg font-semibold text-gray-800 mb-2">Alert!</h3>
    <p id="alertMessage" class="text-gray-600 mb-4"></p>
    <button id="alertOkBtn" 
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      OK
    </button>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-2 text-green-600">Success!</h3>
    <p class="mb-4 text-gray-700">Configuration saved successfully!</p>
    <button id="closeModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="sectionConfirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="confirmMessage" class="mb-4 text-gray-700">Are you sure you want to delete this section command?</p>
    <div class="flex justify-end gap-2">
      <button id="cancelSectionDelete" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      <button id="sectionConfirmAction" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>


<script>
// API Configuration
const isLocal = window.location.hostname === "localhost";
const API_BASE_URL = isLocal 
  ? "http://localhost:5500/api/v1"   // local backend
  : "https://hicad.ng/api/v1";       // prod backend


// Global variables
let groups = [];
let elementTypes = [];
let gradeLevels = [];
let scales = [];
let editingScaleIndex = null;
let editingGroupIndex = null;

function showAlert(message, title = "Alert") {
  const modal = document.getElementById("alertModal");
  const msg = document.getElementById("alertMessage");
  const ttl = document.getElementById("alertTitle");
  const okBtn = document.getElementById("alertOkBtn");

  ttl.textContent = title;
  msg.textContent = message;

  modal.classList.remove("hidden");

  okBtn.onclick = () => {
    modal.classList.add("hidden");
  };
}

function showSuccess(message = "Configuration saved successfully!") {
  const modal = document.getElementById("successModal");
  const msg = modal.querySelector("p");

  // update message dynamically
  msg.textContent = message;

  modal.classList.remove("hidden");
}

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("successModal").classList.add("hidden");
});

// Optional: close on clicking outside modal
document.getElementById("successModal").addEventListener("click", (e) => {
  if (e.target.id === "successModal") {
    e.target.classList.add("hidden");
  }
});

function showConfirmModal(message = "Are you sure?") {
  return new Promise((resolve) => {
    const modal = document.getElementById("sectionConfirmModal");
    const msg = document.getElementById("confirmMessage");
    const cancelBtn = document.getElementById("cancelSectionDelete");
    const confirmBtn = document.getElementById("sectionConfirmAction");

    msg.textContent = message;
    modal.classList.remove("hidden");

    // Remove old listeners
    cancelBtn.onclick = () => {
      modal.classList.add("hidden");
      resolve(false);
    };

    confirmBtn.onclick = () => {
      modal.classList.add("hidden");
      resolve(true);
    };

    modal.onclick = (e) => {
      if (e.target.id === "sectionConfirmModal") {
        modal.classList.add("hidden");
        resolve(false);
      }
    };
  });
}
  

// API Helper Functions
class ApiService {
  static async request(endpoint, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    const config = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
        ...options.headers,
      },
      ...options,
    };

    try {
      const response = await fetch(url, config);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'API request failed');
      }
      
      return data;
    } catch (error) {
      console.error('API Error:', error);
      showAlert(`Error: ${error.message}`);
      throw error;
    }
  }

  // Salary Scale API calls
  static async getAllScales(page = 1, limit = 100) {
    return await this.request(`/salary-scales?page=${page}&limit=${limit}`);
  }

  static async getScale(salcode, saltype, grade) {
    return await this.request(`/salary-scales/${salcode}/${saltype}/${grade}`);
  }

  static async createScale(scaleData) {
    return await this.request('/salary-scales', {
      method: 'POST',
      body: JSON.stringify(scaleData),
    });
  }

  static async updateScale(salcode, saltype, grade, scaleData) {
    return await this.request(`/salary-scales/${salcode}/${saltype}/${grade}`, {
      method: 'PUT',
      body: JSON.stringify(scaleData),
    });
  }

  static async deleteScale(salcode, saltype, grade) {
    return await this.request(`/salary-scales/${salcode}/${saltype}/${grade}`, {
      method: 'DELETE',
    });
  }

  static async searchScales(filters) {
    const params = new URLSearchParams(filters);
    return await this.request(`/salary-scales/search?${params}`);
  }

  static async getProgressionSteps(salcode, saltype, grade) {
    return await this.request(`/salary-scales/${salcode}/${saltype}/${grade}/progression-steps`);
  }

  static async validateProgression(progressionData) {
    return await this.request('/salary-scales/validate-progression', {
      method: 'POST',
      body: JSON.stringify(progressionData),
    });
  }

  // Salary Group API calls
  static async getAllGroups(page = 1, limit = 100) {
    return await this.request(`/salary-groups?page=${page}&limit=${limit}`);
  }

  static async getGroup(groupcode) {
    return await this.request(`/salary-groups/${groupcode}`);
  }

  static async createGroup(groupData) {
    return await this.request('/salary-groups', {
      method: 'POST',
      body: JSON.stringify(groupData),
    });
  }

  static async updateGroup(groupcode, groupData) {
    return await this.request(`/salary-groups/${groupcode}`, {
      method: 'PUT',
      body: JSON.stringify(groupData),
    });
  }

  static async deleteGroup(groupcode) {
    return await this.request(`/salary-groups/${groupcode}`, {
      method: 'DELETE',
    });
  }

  static async searchGroups(filters) {
    const params = new URLSearchParams(filters);
    return await this.request(`/salary-groups/search?${params}`);
  }

  static async getActiveGroups() {
    return await this.request('/salary-groups/active/list');
  }

  // Element Types API call
  static async getElementTypes() {
    return await this.request('/elementtypes');
  }

  // Grade Levels API call
  static async getGradeLevels() {
    return await this.request('/gradelevels');
  }

  
  // Batch upload API calls
  static async batchUpload(formData) {
    const url = `${API_BASE_URL}/salary-scales/batch-upload`;
    
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
          // Don't set Content-Type for FormData - browser will set it automatically with boundary
        },
        body: formData,
      });
      
      // Check content type before parsing
      const contentType = response.headers.get('content-type') || '';
      
      if (!response.ok) {
        let errorMessage = `Upload failed: ${response.status} ${response.statusText}`;
        
        try {
          if (contentType.includes('application/json')) {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
          } else {
            const errorText = await response.text();
            // Don't try to show multipart boundary data as error
            if (!errorText.startsWith('------') && errorText.length < 500) {
              errorMessage = errorText;
            }
          }
        } catch (parseError) {
          console.log('Could not parse error response');
        }
        
        throw new Error(errorMessage);
      }
      
      // Only try to parse as JSON if content-type indicates JSON
      if (contentType.includes('application/json')) {
        const data = await response.json();
        return data;
      } else {
        // If not JSON response, return a success indicator
        return { 
          success: true, 
          message: 'Upload completed',
          summary: {
            totalRecords: 'Unknown',
            successful: 'Processing',
            failed: 0,
            errors: []
          }
        };
      }
      
    } catch (error) {
      console.error('Batch upload error:', error);
      throw error;
    }
  }

  static async downloadSampleTemplate() {
    const url = `${API_BASE_URL}/salary-scales/sample-template`;
    const token = localStorage.getItem('token');
    
    if (!token) {
      throw new Error('Authentication token not found. Please login again.');
    }
    
    try {
      console.log('Making download request with token:', token ? 'Token present' : 'No token');
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/octet-stream, text/csv, */*',
        },
      });
      
      console.log('Download response status:', response.status);
      console.log('Download response headers:', Object.fromEntries(response.headers.entries()));
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Download error response:', errorText);
        throw new Error(`Failed to download sample template: ${response.status} ${response.statusText}`);
      }
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = 'salary_scale_sample.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(downloadUrl);
      
      return { success: true };
    } catch (error) {
      console.error('Download failed:', error);
      throw error;
    }
  }
}


// Initialize data from API
async function initializeData() {
  try {
    // Load groups from API
    await loadGroups();
    
    // Load element types from API
    await loadElementTypes();
    
    // Load grade levels from API 
    await loadGradeLevels();
    
    loadDropdowns();
  } catch (error) {
    console.error('Failed to initialize data:', error);
  }
}

// Load groups from backend
async function loadGroups() {
  try {
    const response = await ApiService.getAllGroups();
    groups = response.data || [];
    renderGroupTable();
  } catch (error) {
    console.error('Failed to load groups:', error);
    groups = [];
  }
}

// Load element types from backend
async function loadElementTypes() {
  try {
    const response = await ApiService.getElementTypes();
    elementTypes = response || [];   // no .data here
  } catch (error) {
    console.error('Failed to load element types:', error);
    elementTypes = [];
  }
}

// Load element types from backend
async function loadGradeLevels() {
  try {
    const response = await ApiService.getGradeLevels();
    gradeLevels = response || [];   // no .data here
  } catch (error) {
    console.error('Failed to load grade levels:', error);
    gradeLevels = [];
  }
}



// Generate step fields dynamically
function generateStepFields() {
  const stepFieldsContainer = document.getElementById("stepFields");
  let stepHTML = '';
  for(let i = 1; i <= 20; i++) {
    const label = i === 20 ? 'Max Step' : `Step ${i}`;
    const placeholder = i === 20 ? 'Max progression step (1-19)' : 'Enter salary amount';
    stepHTML += `
      <div>
        <label class="block text-sm font-medium">${label}</label>
        <input type="text" id="step${i}" class="border p-2 rounded w-full" placeholder="${placeholder}">
      </div>`;
  }
  stepFieldsContainer.innerHTML = stepHTML;
}

// Load salary scales from backend
async function loadScales() {
  try {
    const response = await ApiService.getAllScales();
    scales = response.data.map(scale => ({
      salcode: scale.salcode,
      saltype: scale.saltype,
      grade: scale.grade,
      group: scale.salcode, // Using salcode as group for compatibility
      element: scale.saltype, // Using saltype as element for compatibility
      steps: [
        scale.step1, scale.step2, scale.step3, scale.step4, scale.step5,
        scale.step6, scale.step7, scale.step8, scale.step9, scale.step10,
        scale.step11, scale.step12, scale.step13, scale.step14, scale.step15,
        scale.step16, scale.step17, scale.step18, scale.step19, scale.step20
      ].map(step => step || ''),
      user: scale.user
    }));
    renderScaleTable();
  } catch (error) {
    console.error('Failed to load scales:', error);
  }
}

// Define all functions at the top level
window.viewScale = async function(index) {
  const s = scales[index];
  
  try {
    // Get progression steps for this scale
    const progressionData = await ApiService.getProgressionSteps(s.salcode, s.saltype, s.grade);
    const maxStep = progressionData.data.maxProgressionStep;
    
    let html = `
      <div class="p-6 border rounded-2xl shadow-lg bg-gradient-to-br from-blue-50 to-white">
        <div class="flex items-center flex-wrap gap-6 mb-4">
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-[14px] font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Salary Code:</span> ${s.salcode}
          </p>
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-[14px] font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Salary Type:</span> ${s.saltype}
          </p>
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-[14px] font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Grade:</span> ${s.grade}
          </p>
          <p class="border rounded rounded-lg p-2 bg-green-50 text-[14px] font-semibold text-gray-800">
            <span class="text-red-600 font-bold">Max Progression:</span> Step ${maxStep}
          </p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm" mt-6">
    `;

    function formatToNGN(amount) {
      if (amount == null || amount === "-") return "-";
      return new Intl.NumberFormat('en-NG', {
        style: 'currency',
        currency: 'NGN',
        minimumFractionDigits: 2,
      }).format(amount);
    }

    for (let i = 0; i < 19; i++) {
      const isAvailable = (i + 1) <= maxStep;
      const bgColor = isAvailable ? 'bg-white' : 'bg-gray-100';
      const textColor = isAvailable ? 'text-blue-600' : 'text-gray-400';

      html += `
        <div class="flex justify-between ${bgColor} p-2 rounded border hover:shadow-md transition ${!isAvailable ? 'opacity-50' : ''}">
          <span class="text-base font-medium text-gray-600">Step ${i + 1}:</span>
          <span class="text-base font-semibold ${textColor}">
            ${s.steps[i] ? formatToNGN(s.steps[i]) : "-"}
          </span>
        </div>`;
    }

    html += `
        </div>
        <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
          <p class="text-sm font-medium text-yellow-800">
            <span class="font-bold">Max Progression Limit:</span> Employees can progress up to Step ${maxStep} only
          </p>
        </div>
      </div>
    `;

    document.getElementById("scaleViewContent").innerHTML = html;
    document.getElementById("scaleViewModal").classList.remove("hidden");
  } catch (error) {
    console.error('Failed to get progression steps:', error);
    // Fallback to simple view without progression info
    let html = `
      <div class="p-6 border rounded-2xl shadow-lg bg-gradient-to-br from-blue-50 to-white">
        <div class="flex flex-wrap justify-between mb-4">
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-lg font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Salary Code:</span> ${s.salcode}
          </p>
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-lg font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Salary Type:</span> ${s.saltype}
          </p>
          <p class="border rounded rounded-lg p-2 bg-yellow-50 text-lg font-semibold text-gray-800">
            <span class="text-blue-800 font-bold">Grade:</span> ${s.grade}
          </p>
        </div>
        <div class="grid grid-cols-5 gap-3 mt-6">`;

    for (let i = 0; i < 20; i++) {
      html += `
        <div class="flex justify-between bg-white p-2 rounded border hover:shadow-md transition">
          <span class="text-base font-medium text-gray-600">${i === 19 ? 'Max Step' : 'Step ' + (i+1)}:</span>
          <span class="text-base font-semibold text-blue-600">${s.steps[i] || "-"}</span>
        </div>`;
    }

    html += `</div></div>`;
    document.getElementById("scaleViewContent").innerHTML = html;
    document.getElementById("scaleViewModal").classList.remove("hidden");
  }
};

window.editScale = function(index) {
  const s = scales[index];
  document.getElementById("scaleGroup").value = s.salcode;
  document.getElementById("scaleElement").value = s.saltype;
  document.getElementById("scaleGrade").value = s.grade;
  
  // Populate step values
  for(let i = 0; i < 20; i++) {
    document.getElementById("step" + (i+1)).value = s.steps[i] || "";
  }

  //disable edit for main fields
  document.getElementById("scaleGroup").disabled = true;
  document.getElementById("scaleElement").disabled = true;
  document.getElementById("scaleGrade").disabled = true;

  editingScaleIndex = index;
  document.getElementById("stepFields").classList.remove("hidden");
  document.getElementById("scaleForm").classList.remove("hidden");
  showSection("scaleSection","btnScales");
};

window.deleteScale = async function(index) {
  const confirmed = await showConfirmModal("Are you sure you want to delete this configuration?");

  if(confirmed) {
    const s = scales[index];
    try {
      await ApiService.deleteScale(s.salcode, s.saltype, s.grade);
      await loadScales(); // Reload scales after deletion
      showSuccess('Scale deleted successfully!');
    } catch (error) {
      console.error('Failed to delete scale:', error);
      showAlert("Error deleting record.");
    }
  }
};


window.editGroup = function(index) {
  const g = groups[index];
  document.getElementById("groupCode").value = g.groupcode;
  document.getElementById("groupDesc").value = g.grpdesc;
  document.getElementById("groupEff").value = g.effdate;
  document.getElementById("groupLast").value = g.lastdate;
  
  editingGroupIndex = index;
  document.getElementById("groupCode").disabled = true;
  document.getElementById("groupForm").classList.remove("hidden");
};

window.deleteGroup = async function(index) {

  const confirmed = await showConfirmModal("Are you sure you want to delete this group?");

  if(confirmed) {
    const g = groups[index];
    try {
      await ApiService.deleteGroup(g.groupcode);
      await loadGroups(); // Reload groups after deletion
      loadDropdowns(); // Refresh dropdowns

      showSuccess('Group deleted successfully!');
    } catch (error) {
      console.error('Failed to delete group:', error);
      showAlert("Error deleting record.");
    }
  }
};

// Initialize step fields on page load
generateStepFields();

// GROUP form show/hide
document.getElementById("addNewGroupBtn").addEventListener("click", () => {
  document.getElementById("groupForm").classList.remove("hidden");
  editingGroupIndex = null;
  document.getElementById("groupCode").disabled = false;
  document.getElementById("groupForm").reset();
});

document.getElementById("cancelGroupBtn").addEventListener("click", () => {
  document.getElementById("groupForm").classList.add("hidden");
  document.getElementById("groupForm").reset();
  editingGroupIndex = null;
});

const scaleForm = document.getElementById("scaleForm");
const batchForm = document.getElementById("batchUploadForm");

// Add New Scale toggle
document.getElementById("addNewScaleBtn").addEventListener("click", () => {
  editingScaleIndex = null;
  document.getElementById("scaleForm").reset();
  batchForm.classList.add("hidden");
  scaleForm.classList.toggle("hidden");
  document.getElementById("scaleGroup").disabled = false;
  document.getElementById("scaleElement").disabled = false;
  document.getElementById("scaleGrade").disabled = false;
  document.getElementById("stepFields").classList.add("hidden");
});

// Batch Upload toggle
document.getElementById("tabBatchBtn").addEventListener("click", () => {
  scaleForm.classList.add("hidden");
  batchForm.classList.toggle("hidden");
});

// Cancel buttons
document.getElementById("cancelScaleBtn").addEventListener("click", () => {
  scaleForm.classList.add("hidden");
  document.getElementById("stepFields").classList.add("hidden");
  document.getElementById("scaleForm").reset();
  editingScaleIndex = null;
});

document.getElementById("cancelBatchBtn").addEventListener("click", () => {
  batchForm.classList.add("hidden");
});

// Toggle Section
function showSection(sectionId, btnId) {
  ["groupSection","scaleSection"].forEach(id => {
    document.getElementById(id).classList.add("hidden");
  });
  ["btnGroups","btnScales"].forEach(id => {
    document.getElementById(id).classList.remove("bg-blue-600","text-white");
    document.getElementById(id).classList.add("bg-yellow-400","text-gray-900");
  });
  document.getElementById(sectionId).classList.remove("hidden");
  const btn = document.getElementById(btnId);
  btn.classList.remove("bg-yellow-400","text-gray-900");
  btn.classList.add("bg-blue-600","text-white");
}

document.getElementById("btnGroups").addEventListener("click", () => showSection("groupSection","btnGroups"));
document.getElementById("btnScales").addEventListener("click", () => {
  showSection("scaleSection","btnScales");
  loadScales(); // Load scales when switching to scales section
});

// Initialize with groups section visible
showSection("groupSection","btnGroups");

// Populate dropdowns
function loadDropdowns() {
  const gSel = document.getElementById("scaleGroup");
  const eSel = document.getElementById("scaleElement");
  const grSel = document.getElementById("scaleGrade");
  
  // Load groups (salary codes)
  gSel.innerHTML = '<option value="">Select Salary Group</option>' + 
    groups.map(g => `<option value="${g.groupcode}">${g.grpdesc}</option>`).join("");
  
  // Load element types
  eSel.innerHTML = '<option value="">Select Element Type</option>' + 
    elementTypes.map(e => `<option value="${e.PaymentType}">${e.elmDesc}</option>`).join("");
  
  // Load gradeLevels
  grSel.innerHTML = '<option value="">Select Grade</option>' + 
    gradeLevels.map(gr => `<option value="${gr.grade_no}">${gr.grade_desc}</option>`).join("");
}

// Show step fields when all 3 dropdowns selected
function checkDropdownSelections() {
  const g = document.getElementById("scaleGroup").value;
  const e = document.getElementById("scaleElement").value;
  const gr = document.getElementById("scaleGrade").value;
  
  if(g && e && gr) {
    document.getElementById("stepFields").classList.remove("hidden");
  } else {
    document.getElementById("stepFields").classList.add("hidden");
  }
}

["scaleGroup","scaleElement","scaleGrade"].forEach(id => {
  document.getElementById(id).addEventListener("change", checkDropdownSelections);
});

// Save Group - Modified for backend integration
document.getElementById("saveGroupBtn").addEventListener("click", async () => {

  const groupData = {
    groupcode: document.getElementById("groupCode").value,
    grpdesc: document.getElementById("groupDesc").value,
    effdate: document.getElementById("groupEff").value,
    lastdate: document.getElementById("groupLast").value
  };

  const requiredFields = ['groupcode', 'grpdesc'];

  let missingFields = requiredFields.filter(field => !groupData[field]);

  if (missingFields.length > 0) {
    showAlert(`Please fill in all required fields: ${missingFields.join(', ')}`);
    return;
  }

  if(groupData.groupcode && groupData.grpdesc) {
    try {
      
      if(editingGroupIndex !== null) {
        // Update existing group
        await ApiService.updateGroup(groupData.groupcode, groupData);
        showSuccess('Group updated successfully!');
      } else {
        // Create new group
        await ApiService.createGroup(groupData);
        showSuccess('Group created successfully!');
      }
      
      // Reset form and reload data
      document.getElementById("groupForm").reset();
      document.getElementById("groupForm").classList.add("hidden");
      editingGroupIndex = null;
      
      await loadGroups();
      loadDropdowns(); // Refresh dropdowns

      
    } catch (error) {

      console.error('Failed to save group:', error);
    }
  } else {
    showAlert("Please fill in all required fields");
  }
});

// Save Scale - Modified for backend integration
document.getElementById("scaleForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const salcode = document.getElementById("scaleGroup").value;
  const saltype = document.getElementById("scaleElement").value;
  const grade = document.getElementById("scaleGrade").value;
  
  // Collect step values
  const scaleData = {
    salcode: salcode,
    saltype: saltype,
    grade: grade
  };
  
  // Add step values to scaleData
  for(let i = 1; i <= 20; i++) {
    const stepValue = document.getElementById("step" + i).value;
    scaleData["step" + i] = stepValue || null;
  }
  
  // Validate step20 (max progression step)
  const maxStep = parseInt(scaleData.step20);
  if (maxStep && (maxStep < 1 || maxStep > 19)) {
    showAlert('Max progression step must be between 1 and 19');
    return;
  }
  
  try {

    const requiredFields = ['salcode', 'saltype', 'grade'];

    let missingFields = requiredFields.filter(field => !scaleData[field]);

    if (missingFields.length > 0) {
      showAlert(`Please fill in all required fields: ${missingFields.join(', ')}`);
      return;
    }

    if(editingScaleIndex !== null) {
      // Update existing scale
      await ApiService.updateScale(salcode, saltype, grade, scaleData);
      showSuccess('Scale updated successfully!');
    } else {
      // Create new scale
      await ApiService.createScale(scaleData);
      showSuccess('Scale created successfully!');
    }
    
    // Reset form and reload data
    document.getElementById("scaleForm").reset();
    document.getElementById("stepFields").classList.add("hidden");
    document.getElementById("scaleForm").classList.add("hidden");
    editingScaleIndex = null;
    
    await loadScales();
    
  } catch (error) {
    console.error('Failed to save scale:', error);
  }
});

function renderScaleTable() {
  const table = document.getElementById("scaleTable");
  table.innerHTML = scales.map((s, i) => `
    <tr>
      <td class="border px-2 py-3 text-left">${s.salcode}</td>
      <td class="border px-2 py-3 text-left">${s.saltype}</td>
      <td class="border px-2 py-3 text-left">${s.grade}</td>
      <td class="border px-2 py-3 text-left">
        <button class="text-blue-600 hover:underline mr-2" onclick="viewScale(${i})">View</button>
        <button class="text-green-600 hover:underline mr-2" onclick="editScale(${i})">Edit</button>
        <button class="text-red-600 hover:underline" onclick="deleteScale(${i})">Delete</button>
      </td>
    </tr>
  `).join("");
}

document.getElementById("closeScaleView").addEventListener("click", () => {
  document.getElementById("scaleViewModal").classList.add("hidden");
});

// Add group view modal close handler
if (document.getElementById("closeGroupView")) {
  document.getElementById("closeGroupView").addEventListener("click", () => {
    document.getElementById("groupViewModal").classList.add("hidden");
  });
}

// Render group table with backend data
function renderGroupTable() {
  const table = document.getElementById("groupTable");
  table.innerHTML = groups.map((g, i) => `
    <tr>
      <td class="border px-2 py-3 text-left">${g.groupcode}</td>
      <td class="border px-2 py-3 text-left">${g.grpdesc}</td>
      <td class="border px-2 py-3 text-left">${g.effdate || 'N/A'}</td>
      <td class="border px-2 py-3 text-left">${g.lastdate || 'N/A'}</td>
      <td class="border px-2 py-3 text-left">
        <button class="text-green-600 hover:underline mr-2" onclick="editGroup(${i})">Edit</button>
        <button class="text-red-600 hover:underline" onclick="deleteGroup(${i})">Delete</button>
      </td>
    </tr>`).join("");
}

// Search functionality for scales
async function searchScales() {
  const searchTerm = document.getElementById('searchInput').value;
  const searchType = document.getElementById('searchType').value;
  
  if (!searchTerm.trim()) {
    await loadScales(); // Load all scales if search is empty
    return;
  }
  
  try {
    const filters = {};
    filters[searchType] = searchTerm;
    
    const response = await ApiService.searchScales(filters);
    scales = response.data.map(scale => ({
      salcode: scale.salcode,
      saltype: scale.saltype,
      grade: scale.grade,
      group: scale.salcode,
      element: scale.saltype,
      steps: [
        scale.step1, scale.step2, scale.step3, scale.step4, scale.step5,
        scale.step6, scale.step7, scale.step8, scale.step9, scale.step10,
        scale.step11, scale.step12, scale.step13, scale.step14, scale.step15,
        scale.step16, scale.step17, scale.step18, scale.step19, scale.step20
      ].map(step => step || ''),
      user: scale.user
    }));
    
    renderScaleTable();
  } catch (error) {
    console.error('Search failed:', error);
  }
}

// Search functionality for groups
async function searchGroups() {
  const searchTerm = document.getElementById('groupSearchInput').value;
  const searchType = document.getElementById('groupSearchType').value;
  
  if (!searchTerm.trim()) {
    await loadGroups(); // Load all groups if search is empty
    return;
  }
  
  try {
    const filters = {};
    filters[searchType] = searchTerm;
    
    const response = await ApiService.searchGroups(filters);
    groups = response.data || [];
    
    renderGroupTable();
  } catch (error) {
    console.error('Group search failed:', error);
  }
}

// Add search event listeners for scales
if (document.getElementById('searchBtn')) {
  document.getElementById('searchBtn').addEventListener('click', searchScales);
}

if (document.getElementById('searchInput')) {
  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchScales();
    }
  });
}

// Add search event listeners for groups
if (document.getElementById('groupSearchBtn')) {
  document.getElementById('groupSearchBtn').addEventListener('click', searchGroups);
}

if (document.getElementById('groupSearchInput')) {
  document.getElementById('groupSearchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchGroups();
    }
  });
}

// Batch upload functionality
document.getElementById("uploadBatchBtn").addEventListener("click", async () => {
  const fileInput = document.getElementById("batchFile");
  const file = fileInput.files[0];
  
  if (!file) {
    showAlert('Please select a file to upload');
    return;
  }
  
  // Validate file type
  const allowedTypes = ['text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
  const fileExtension = file.name.toLowerCase();
  
  if (!allowedTypes.includes(file.type) && 
      !fileExtension.endsWith('.csv') && 
      !fileExtension.endsWith('.xlsx') && 
      !fileExtension.endsWith('.xls')) {
    showAlert('Please upload only CSV or Excel files');
    return;
  }
  
  // Validate file size (5MB limit)
  if (file.size > 5 * 1024 * 1024) {
    showAlert('File size must be less than 5MB');
    return;
  }
  
  try {
    console.log('Starting upload for file:', file.name);
    
    const formData = new FormData();
    formData.append('file', file);
    
    const result = await ApiService.batchUpload(formData);
    
    console.log('Upload result:', result);
    
    // Show results
    if (result.summary) {
      const summary = result.summary;
      let message = `Batch upload completed!\n\n`;
      message += `Total records: ${summary.totalRecords}\n`;
      message += `Successful: ${summary.successful}\n`;
      message += `Failed: ${summary.failed}\n`;
      
      if (summary.failed > 0 && summary.errors) {
        message += `\nErrors:\n`;
        summary.errors.slice(0, 5).forEach(error => {
          message += `Row ${error.row}: ${error.error}\n`;
        });
        
        if (summary.errors.length > 5) {
          message += `... and ${summary.errors.length - 5} more errors`;
        }
      }
      
      showAlert(message);
      
      // Reset form and reload data if there were successful uploads
      if (summary.successful > 0 || summary.successful === 'Processing') {
        document.getElementById("batchUploadForm").reset();
        document.getElementById("batchUploadForm").classList.add("hidden");
        await loadScales();
      }
    } else {
      showSuccess('Upload completed successfully!');
      document.getElementById("batchUploadForm").reset();
      document.getElementById("batchUploadForm").classList.add("hidden");
      await loadScales();
    }
    
  } catch (error) {
    console.error('Batch upload failed:', error);
    showAlert(`Upload failed: ${error.message}`);
  }
});
  

document.getElementById("downloadSampleBtn").addEventListener("click", (e) => {
  e.preventDefault();
  downloadSampleTemplate();
});

// Download sample template
async function downloadSampleTemplate() {
  try {
    await ApiService.downloadSampleTemplate();
  } catch (error) {
    console.error('Failed to download sample:', error);
    showAlert('Failed to download sample template');
  }
}

// Add event listener for download sample link
document.addEventListener('DOMContentLoaded', () => {
  // File input change handler to show file info
  const batchFileInput = document.getElementById("batchFile");
  if (batchFileInput) {
    batchFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileInfo = document.createElement('div');
        fileInfo.className = 'mt-2 text-sm text-gray-600';
        fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        
        // Remove any existing file info
        const existingInfo = e.target.parentNode.querySelector('.file-info');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        fileInfo.className += ' file-info';
        e.target.parentNode.appendChild(fileInfo);
      }
    });
  }
});

// File input change handler to show file info
document.getElementById("batchFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const fileInfo = document.createElement('div');
    fileInfo.className = 'mt-2 text-sm text-gray-600';
    fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    
    // Remove any existing file info
    const existingInfo = e.target.parentNode.querySelector('.file-info');
    if (existingInfo) {
      existingInfo.remove();
    }
    
    fileInfo.className += ' file-info';
    e.target.parentNode.appendChild(fileInfo);
  }
});

// Capitalize first letter, keep the rest lower
function capitalizeWords(str) {
  return str
    ? str
        .toLowerCase()
        .split(" ")
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ")
    : "";
}

["groupDesc"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("input", () => {
    el.value = capitalizeWords(el.value);
  });
});

// Force uppercase as user types
["groupCode"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("input", () => {
    el.value = el.value.toUpperCase();
  });
});

function generateReport() {
  const activeSection = document.getElementById('groupSection').classList.contains('hidden') ? 'scale' : 'group';
  const now = new Date();
  const dateStr = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
  const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  
  const printWindow = window.open('', '_blank');
  
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>${activeSection === 'scale' ? 'Salary Scale' : 'Salary Group'} Report</title>
      <style>
        @page { margin: 1in; }
        body { 
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          color: #333;
        }
        .report-header {
          text-align: center;
          margin-bottom: 30px;
          padding-bottom: 10px;
          border-bottom: 2px solid #1a56db;
        }
        .logo {
          width: 100px;
          height: auto;
          margin-bottom: 10px;
        }
        .date-time {
          font-size: 14px;
          color: #666;
          margin: 10px 0;
        }
        .report-title {
          font-size: 24px;
          color: #1a56db;
          margin: 10px 0;
        }
        .report-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
          font-size: 12px;
        }
        .report-table th {
          background-color: #f3f4f6;
          padding: 12px 8px;
          text-align: left;
          border: 1px solid #e5e7eb;
          font-weight: bold;
        }
        .report-table td {
          padding: 8px;
          border: 1px solid #e5e7eb;
        }
        .report-table tr:nth-child(even) {
          background-color: #f9fafb;
        }
        .step-value {
          text-align: right;
          font-family: monospace;
        }
        .report-footer {
          margin-top: 30px;
          text-align: center;
          font-size: 12px;
          color: #666;
          border-top: 1px solid #e5e7eb;
          padding-top: 20px;
        }
        .group-info {
          margin: 20px 0;
          padding: 15px;
          background-color: #f9fafb;
          border-radius: 8px;
        }
        @media print {
          .report-table th {
            background-color: #f3f4f6 !important;
            -webkit-print-color-adjust: exact;
          }
          .report-table tr:nth-child(even) {
            background-color: #f9fafb !important;
            -webkit-print-color-adjust: exact;
          }
        }
      </style>
    </head>
    <body>
      <div class="report-header">
        <div class="report-title">
          ${activeSection === 'scale' ? 'Salary Scale Configuration' : 'Salary Group Configuration'} Report
        </div>
        <div class="date-time">Generated on: ${dateStr} at ${timeStr}</div>
      </div>
      
      ${activeSection === 'scale' ? generateScaleReport() : generateGroupReport()}
      
      <div class="report-footer">
        <p>Total Records: ${activeSection === 'scale' ? scales.length : groups.length}</p>
        <p>*** End of Report ***</p>
        <p>Generated by: ${localStorage.getItem('full_name') || 'System User'}</p>
      </div>
    </body>
    </html>
  `;
  
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  printWindow.onload = function() {
    printWindow.print();
  };
}

function generateScaleReport() {
  const formatCurrency = (amount) => {
    if (!amount) return '-';
    return new Intl.NumberFormat('en-NG', {
      style: 'currency',
      currency: 'NGN',
      minimumFractionDigits: 2
    }).format(amount);
  };

  let html = '';
  const groupedScales = {};
  scales.forEach(scale => {
    if (!groupedScales[scale.salcode]) {
      groupedScales[scale.salcode] = [];
    }
    groupedScales[scale.salcode].push(scale);
  });

  Object.keys(groupedScales).sort().forEach(salcode => {
    const groupScales = groupedScales[salcode];
    const group = groups.find(g => g.groupcode === salcode);
    
    html += `
      <div class="group-info" style="page-break-inside: avoid; margin-bottom: 20px;">
        <h3>Salary Group: ${salcode} - ${group?.grpdesc || 'N/A'}</h3>
        <p>Effective Date: ${group?.effdate || 'N/A'} | Last Date: ${group?.lastdate || 'N/A'}</p>
      </div>

      ${groupScales.map(scale => `
        <div style="page-break-inside: avoid; margin-bottom: 30px;">
          <h4 style="margin-bottom: 10px;">Grade: ${scale.grade} - Element: ${scale.saltype}</h4>
          
          <!-- Steps 1-10 -->
          <table class="report-table" style="margin-bottom: 5px;">
            <tr>
              <th>Step</th>
              ${Array.from({length: 10}, (_, i) => `<th>Step ${i + 1}</th>`).join('')}
            </tr>
            <tr>
              <td><strong>Amount</strong></td>
              ${scale.steps.slice(0, 10).map(step => `
                <td class="step-value">${formatCurrency(step)}</td>
              `).join('')}
            </tr>
          </table>

          <!-- Steps 11-20 -->
          <table class="report-table">
            <tr>
              <th>Step</th>
              ${Array.from({length: 9}, (_, i) => `<th>Step ${i + 11}</th>`).join('')}
              <th>Max Step</th>
            </tr>
            <tr>
              <td><strong>Amount</strong></td>
              ${scale.steps.slice(10).map(step => `
                <td class="step-value">${formatCurrency(step)}</td>
              `).join('')}
            </tr>
          </table>
        </div>
      `).join('')}
    `;
  });

  return `
    <style>
      @media print {
        .group-info {
          background-color: #f9fafb !important;
          -webkit-print-color-adjust: exact;
          padding: 15px;
          margin: 20px 0;
          border: 1px solid #e5e7eb;
        }
        .report-table {
          font-size: 11px;
          width: 100%;
          border-collapse: collapse;
        }
        .report-table th,
        .report-table td {
          padding: 6px 4px;
          border: 1px solid #e5e7eb;
          text-align: center;
        }
        .report-table th {
          background-color: #f3f4f6 !important;
          -webkit-print-color-adjust: exact;
        }
        .step-value {
          white-space: nowrap;
          text-align: right;
        }
        h4 {
          color: #1a56db;
          margin: 15px 0 5px 0;
        }
      }
    </style>
    ${html}
  `;
}

function generateGroupReport() {
  return `
    <table class="report-table">
      <thead>
        <tr>
          <th>Group Code</th>
          <th>Description</th>
          <th>Effective Date</th>
          <th>Last Date</th>
        </tr>
      </thead>
      <tbody>
        ${groups.map(group => `
          <tr>
            <td>${group.groupcode}</td>
            <td>${group.grpdesc}</td>
            <td>${group.effdate || 'N/A'}</td>
            <td>${group.lastdate || 'N/A'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// Add event listener to generate report button
document.getElementById('generateReportBtn').addEventListener('click', generateReport);

// Initialize
initializeData();
loadElementTypes();
loadGradeLevels();
loadGroups();
loadScales();
renderGroupTable();
loadDropdowns();
</script>