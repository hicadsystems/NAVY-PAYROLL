<div class="p-6 ">
  <div class="mb-6">
    <h3 class="text-lg font-semibold text-gray-900">Create New User</h3>
  </div>

  <form id="create-user-form" class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
        <input type="text" name="employeeId" 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
        <input type="text" name="fullName" required 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Payroll Class *</label>
        <select id="payroll-class" name="payroll_class" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option selected>Select Payroll Class</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">User Role *</label>
        <select name="role" id="role" required 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option selected>Select Role...</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
        <input type="email" name="email" required 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
        <input type="tel" name="phone" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div id="formPasswordGroup" class="relative">
        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
        <input type="password" id="password" name="password" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        
        <!-- Eye Toggle Button -->
        <span id="togglePassword" style="position: absolute; top: 36px; right: 10px; cursor: pointer;">

          <!-- Eye Open SVG -->
          <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          
          <!-- Eye Closed SVG -->
          <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
            <path d="M17.94 17.94A10.94 10.94 0 0112 20c-7 0-11-8-11-8a21.7 21.7 0 014.6-5.94M1 1l22 22"/>
            <path d="M9.5 9.5a3 3 0 004 4"/>
          </svg>
        </span>
      </div>

      <div id="formPasswordGroup" class="relative">
        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
        <input type="password" id="confirmPassword" name="confirmPassword" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">

        <!-- Eye Toggle Button -->
        <span id="togglePassword" style="position: absolute; top: 36px; right: 10px; cursor: pointer;">

          <!-- Eye Open SVG -->
          <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          
          <!-- Eye Closed SVG -->
          <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
            <path d="M17.94 17.94A10.94 10.94 0 0112 20c-7 0-11-8-11-8a21.7 21.7 0 014.6-5.94M1 1l22 22"/>
            <path d="M9.5 9.5a3 3 0 004 4"/>
          </svg>
        </span>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        <select name="status" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">Select Status...</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="suspended">Suspended</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
        <input type="date" name="expiryDate" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
    </div>

    <!--<div class="border-t pt-6">
      <h4 class="text-md font-medium text-gray-900 mb-4">Permissions</h4>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="create" class="mr-2">
          <span class="text-sm">Create Records</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="edit" class="mr-2">
          <span class="text-sm">Edit Records</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="delete" class="mr-2">
          <span class="text-sm">Delete Records</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="reports" class="mr-2">
          <span class="text-sm">Generate Reports</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="payroll" class="mr-2">
          <span class="text-sm">Payroll Processing</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="permissions" value="admin" class="mr-2">
          <span class="text-sm">System Administration</span>
        </label>
      </div>
    </div>-->

    <div class="flex flex-wrap justify-end gap-4 pt-6">
      <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
        Create User
      </button>
      <button type="reset" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
        Reset Form
      </button>
      <button type="button" onclick="window.navigation.navigateToSection('control-user', 'Control User')" 
              class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
        View All Users
      </button>
    </div>
  </form>
</div>

<!-- Success Popup -->
<div id="successPopup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">
  <div class="bg-white p-6 rounded shadow flex items-center space-x-3">
    <div id="successSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
    <span id="successMessage" class="text-gray-700">Processing...</span>
  </div>
</div>

<script>
const isLocal = window.location.hostname === 'localhost';
const BASE_URL = isLocal ? 'http://localhost:5500' : 'https://hicad.ng';

function showSuccess(message) {
  const popup = document.getElementById('successPopup');
  const spinner = document.getElementById('successSpinner');
  const text = document.getElementById('successMessage');
  if (!popup || !text) return;
  text.textContent = message || 'Success';
  spinner?.classList.remove('hidden');
  popup.classList.remove('hidden');
  setTimeout(() => {
    spinner?.classList.add('hidden');
    text.innerHTML = `<span class="text-green-600 font-semibold">✔ User Created Successfully!</span>`;
  }, 2000);
  setTimeout(() => {
    popup.classList.add('hidden');
    spinner?.classList.remove('hidden');
    text.textContent = 'Processing...';
  }, 4000);
}

//roles dropdown
async function fetchRoles() {
  try {
    const token = localStorage.getItem('token');

    const res = await fetch("/roles", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}` 
        }                 
    });

    const roles = await res.json();
    const select = document.getElementById("role");
    
    // Clear existing options first
    select.innerHTML = "";
    
    // Add default option
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "Select a role";
    defaultOption.disabled = true;
    defaultOption.selected = true;
    select.appendChild(defaultOption);

    // Add role options
    roles.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.name;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("❌ Failed to fetch roles:", err);
  }
}

//payrollclass dropdown
async function loadPayrollClasses() {
  try {
    const token = localStorage.getItem('token');

    const res = await fetch("/db_classes", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      }
    });

    if (!res.ok) {
      throw new Error(`HTTP error! Status: ${res.status}`);
    }

    const classes = await res.json();
    const select = document.getElementById("payroll-class");

    if (!select) {
      console.error("⚠️ Element with id 'payroll-class' not found.");
      return;
    }

    // Clear existing options
    select.innerHTML = "";

    // Add default option
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "Select a class";
    defaultOption.disabled = true;
    defaultOption.selected = true;
    select.appendChild(defaultOption);

    // Populate with DB data
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.db_name;            // backend value
      opt.textContent = cls.display_name; // human-readable label
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("❌ Failed to load payroll classes:", err);
  }
}

if (document.readyState === 'loading') {
  document.addEventListener("DOMContentLoaded", fetchRoles, loadPayrollClasses);
} else {
  fetchRoles();
  loadPayrollClasses();
}


document.getElementById('create-user-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const userData = Object.fromEntries(formData.entries());

  // 
  if (userData.employeeId) {
    userData.user_id = userData.employeeId;
    delete userData.employeeId;
  }

  // Collect selected permissions
  /*const role = Array.from(document.querySelectorAll('input[name="role"]:checked'))
    .map(cb => cb.value);
  userData.role = role;*/

  console.log('Creating user:', userData);

  try {
    const token = localStorage.getItem("token");

    const response = await fetch(`${BASE_URL}/api/users`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        "Authorization": `Bearer ${token}`},
      body: JSON.stringify(userData)
    });

    if (response.ok) {
      const result = await response.json();
      showSuccess('Creating User...\nID: ' + result.user_id);
      this.reset();

      // 🔄 Refresh personnel table after create
      if (window.personnelManager) {
        if (typeof window.personnelManager.load === 'function') {
          await window.personnelManager.load();
        } else if (typeof window.personnelManager.loadPersonnelData === 'function') {
          await window.personnelManager.loadPersonnelData();
        } else if (typeof window.personnelManager.refresh === 'function') {
          await window.personnelManager.refresh();
        }
      }
    } else {
      const error = await response.json();
      alert('❌ Error: ' + (error.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Fetch error:', err);
    alert('❌ Failed to connect to server');
  }
});

const passwordFields = [
  document.getElementById("password"),
  document.getElementById("confirmPassword")
];

passwordFields.forEach(input => {
  const toggle = input.nextElementSibling; 
  
  toggle.addEventListener("click", () => {
    const isPassword = input.type === "password";
    input.type = isPassword ? "text" : "password";

    const eyeOpen = toggle.querySelector("#eyeOpen");
    const eyeClosed = toggle.querySelector("#eyeClosed");

    eyeOpen.style.display = isPassword ? "none" : "inline";
    eyeClosed.style.display = isPassword ? "inline" : "none";
  });
});
</script>

