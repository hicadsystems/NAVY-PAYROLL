<section class="p-6">
<div id="profile-card" class="max-w-3xl mx-auto rounded-2xl p-6 border">
  <div class="flex justify-between items-center">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-user-circle text-blue-600 mr-2"></i>Profile Details
    </h2>

    <!--<div class="flex items-center gap-4 mb-6">
        <span class="text-sm font-bold text-gray-700">Theme</span>
        
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="themeToggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 
                        peer-checked:after:translate-x-5 
                        after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                        after:bg-white after:border-gray-300 after:border after:rounded-full 
                        after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
            </div>
        </label>
    </div>-->
  </div>

<div id="payrollClass" 
     class="inline-block p-2 my-6 rounded-lg text-navy text-sm font-black">
</div>


  <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- User ID -->
    <div>
      <label class="block text-sm font-medium text-gray-600">User ID</label>
      <input type="text" name="user_id" id="user_id" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Full Name -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Full Name</label>
      <input type="text" name="full_name" id="full_name" readonly
        class="w-full px-3 py-2 border rounded-lg cursor-not-allowed">
    </div>

    <!-- Email -->
    <div>
      <label class="block text-sm font-medium readOnly">Email</label>
      <input type="email" name="email" id="email" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Phone -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Phone</label>
      <input type="tel" name="phone_number" id="phone_number" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Role (readonly) -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Role</label>
      <input type="text" name="user_role" id="user_role" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Status (readonly) -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Status</label>
      <input type="text" name="status" id="status" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Expiry Date (readonly) -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Expiry Date</label>
      <input type="date" name="expiry_date" id="expiry_date" readonly
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>

    <!-- Password (masked) -->
    <div>
      <label class="block text-sm font-medium text-gray-600">Password</label>
      <input type="text" name="password" readonly id="password"
        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed">
    </div>
  </form>

  <div class="flex justify-end mt-6 gap-3">
    <button id="edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Edit</button>
<button id="save-btn" type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hidden">Save</button>

    <button id="cancel-btn" class="px-4 py-2 bg-gray-400 text-white rounded-lg hidden">Cancel</button>
  </div>
</div>
</section>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
        <div id="loadingSpinner" class="flex justify-center mb-4">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
        </div>
        <div id="successTick" class="hidden flex justify-center mb-4">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>
        <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
    </div>
</div>

<script>
 (function() {
    console.log("‚úÖ Profile inline script loaded");

    setTimeout(() => {
      const userId = localStorage.getItem("user_id");
      console.log("üëâ userId from localStorage:", userId);

      if (!userId) {
        console.error("‚ùå No user_id found, redirecting...");
        window.location.href = "/login.html";
        return;
      }

      loadUser(userId);
    }, 0); // let DOM render first

    let originalUser = null;

    async function loadUser(userId) {
      const viewContainer = document.getElementById("payrollClass");

      if (!viewContainer || !viewContainer.offsetParent) {
        return; // Don't fetch if container is hidden
      }

      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/api/users/${userId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
        });

        if (!res.ok) throw new Error("Failed to fetch user");

        const user = await res.json();
        console.log("‚úÖ User data:", user);

        originalUser = user; // keep copy

        populateForm(user);

        // Insert mapped class name into container
        viewContainer.textContent =
          user.class_display_name || user.primary_class || '';

      } catch (err) {
        console.error("‚ùå Error loading user:", err);
        viewContainer.textContent = "Error loading payroll class";
      }
    }

    function populateForm(user) {
      document.getElementById("user_id").value = user.user_id;
      document.getElementById("full_name").value = user.full_name;
      document.getElementById("email").value = user.email;
      document.getElementById("phone_number").value = user.phone_number || "";
      document.getElementById("user_role").value = user.user_role;
      document.getElementById("status").value = user.status;
      document.getElementById("expiry_date").value = user.expiry_date ? new Date(user.expiry_date).toISOString().split('T')[0] : "";

      if (user.password) {
          const pwd = user.password;
          const masked =
          pwd.length > 4
              ? pwd.substring(0, 2) + "****" + pwd.substring(pwd.length - 2)
              : "****";
          document.getElementById("password").value = masked;
      }
    }


// üîπ Edit / Save / Cancel toggle
const editBtn = document.getElementById("edit-btn");
const saveBtn = document.getElementById("save-btn");
const cancelBtn = document.getElementById("cancel-btn");
const profileForm = document.getElementById("profile-form");

editBtn.addEventListener("click", () => {
  // Unlock all except those always readonly (user_id, role, status, expiry_date, password)
  profileForm.querySelectorAll("input").forEach(input => {
    if (!["user_id","user_role","status","expiry_date","password"].includes(input.id)) {
      input.removeAttribute("readonly");
      input.classList.remove("bg-gray-100", "cursor-not-allowed");
    }
  });

  editBtn.classList.add("hidden");
  saveBtn.classList.remove("hidden");
  cancelBtn.classList.remove("hidden");
});

cancelBtn.addEventListener("click", () => {
  if (originalUser) {
    populateForm(originalUser);
  }

  // Lock them back
  profileForm.querySelectorAll("input").forEach(input => {
    input.setAttribute("readonly", true);
    input.classList.add("bg-gray-100");
    input.classList.add("cursor-not-allowed");
  });

  saveBtn.classList.add("hidden");
  cancelBtn.classList.add("hidden");
  editBtn.classList.remove("hidden");
});

saveBtn.addEventListener("click", async () => {
  const formData = new FormData(profileForm);
  const payload = Object.fromEntries(formData.entries());

  if (payload.password.includes("****")) {
    payload.password = originalUser.password;
  }

  console.log(">>> Saving user payload:", payload);

  try {
    const token = localStorage.getItem("token");
    const res = await fetch(`/api/users/${payload.user_id}`, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(payload),
    });

    if (!res.ok) throw new Error("Failed to update user");

    const data = await res.json();
    console.log("Update response:", data);

    showSuccessModal("Profile updated successfully!");

    // Lock back and refresh form data
    loadUser(payload.user_id);

    profileForm.querySelectorAll("input").forEach(input => {
      input.setAttribute("readonly", true);
      input.classList.add("bg-gray-100");
      input.classList.add("cursor-not-allowed");
    });

    saveBtn.classList.add("hidden");
    cancelBtn.classList.add("hidden");
    editBtn.classList.remove("hidden");

  } catch (err) {
    console.error("‚ùå Update error:", err);
    alert("‚ùå Could not save changes");
  }
});

// Modals
const successModal = document.getElementById("successModal");
const loadingSpinner = document.getElementById("loadingSpinner");
const successTick = document.getElementById("successTick");
const successMessage = document.getElementById("successMessage");

function showSuccessModal(message) {
    successMessage.textContent = "Processing...";
    loadingSpinner.classList.remove("hidden");
    successTick.classList.add("hidden");
    successModal.classList.remove("hidden");

    // Show spinner for 1 second
    setTimeout(() => {
        loadingSpinner.classList.add("hidden");
        successTick.classList.remove("hidden");
        successMessage.textContent = message;
        
        // Hide modal after 2 seconds
        setTimeout(() => {
            successModal.classList.add("hidden");
        }, 2000);
    }, 1000);
}
})();

/*(function() {
  const themeToggle = document.getElementById("themeToggle");
  const root = document.documentElement;

  // Load saved preference
  if (localStorage.getItem("theme") === "dark" ||
      (!localStorage.getItem("theme") && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
    root.classList.add("dark");
    themeToggle.checked = true;
  }

  // Toggle handler
  themeToggle.addEventListener("change", () => {
    if (themeToggle.checked) {
      root.classList.add("dark");
      localStorage.setItem("theme", "dark");
    } else {
      root.classList.remove("dark");
      localStorage.setItem("theme", "light");
    }
  });
})();*/
</script>
