<div class="p-6">
<div>
<!-- Header -->
<div class="px-6 py-2 flex items-center justify-between">
    <div class="flex items-center gap-2">
        <h1 class="text-xl font-bold">Fixed Amount By Rank Management</h1>
    </div>
        <!-- Add Button -->
    <div class="mb-2 flex justify-end gap-2">
        <button id="showFormBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add New</button>
    </div>
</div>

<div class="p-6">
    <!-- Hidden Form -->
    <div id="rankAmountForm" class="hidden mb-2">
        <!-- Description Section -->
        <div class="mb-2">
            <label class="block text-md font-bold text-gray-700 mb-2">Description or Type</label>
            <input type="text" maxlength="6" id="description" class="w-full lg:w-1/2 md:w-2/3 border-2 border-blue-500 bg-transparent rounded px-3 py-2 text-sm focus:border-blue-600 focus:outline-none" placeholder="Enter type">
        </div>

        <!-- Rank Grid -->
        <div class="mb-4">
            <h3 class="text-sm lg:text-lg font-bold text-blue-700 mb-2">Set Fixed Amounts by Rank</h3>
            
            <!-- First Row -->
            <div class="grid grid-cols-6 gap-4 mb-4">
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Trainee</label>
                    <input type="number" id="trainee" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">OS</label>
                    <input type="number" id="os" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">SM</label>
                    <input type="number" id="sm" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">AB</label>
                    <input type="number" id="ab" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">LS</label>
                    <input type="number" id="ls" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">PO</label>
                    <input type="number" id="po" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
            </div>

            <!-- Second Row -->
            <div class="grid grid-cols-6 gap-4 border-b-2 pb-4">
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">WO</label>
                    <input type="number" id="wo" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">MWO</label>
                    <input type="number" id="mwo" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">CADET</label>
                    <input type="number" id="cadet" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">NWO</label>
                    <input type="number" id="nwo" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1"></label>
                    <div class="border border-transparent rounded px-2 py-1 text-xs"></div>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1"></label>
                    <div class="border border-transparent rounded px-2 py-1 text-xs"></div>
                </div>
            </div>

            <!-- Third Row -->
            <div class="grid grid-cols-6 gap-4 pt-2 mb-4">
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">MIDSHIPMAN</label>
                    <input type="number" id="midshipman" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">S/Lt</label>
                    <input type="number" id="slt" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Lt</label>
                    <input type="number" id="lt" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Lt/Cdr</label>
                    <input type="number" id="ltcdr" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Cdr</label>
                    <input type="number" id="cdr" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Capt</label>
                    <input type="number" id="capt" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
            </div>

            <!-- Fourth Row -->
            <div class="grid grid-cols-6 gap-4">
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Cdre</label>
                    <input type="number" id="cdre" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">R/Adm</label>
                    <input type="number" id="radm" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">V/Adm</label>
                    <input type="number" id="vadm" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Adm</label>
                    <input type="number" id="adm" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Contract</label>
                    <input type="number" id="contract" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-700 mb-1">Rtd Officers</label>
                    <input type="number" id="rtdofficers" class="border border-gray-300 rounded px-2 py-1 text-xs focus:border-blue-500 focus:outline-none" placeholder="0">
                </div>
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="flex justify-end gap-2">
            <button id="saveBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Save</button>
            <button id="cancelBtn" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">Cancel</button>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-lg text-sm">
            <thead class="bg-blue-100 text-blue-900">
                <tr>
                    <th class="border px-4 py-3 text-left">Description</th>
                    <th class="border px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="rankAmountTable" class="text-center"></tbody>
        </table>
    </div>
</div>
</div>
</div>

<!-- Success Modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
<div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
<h3 class="text-lg font-semibold mb-2 text-green-600">Success!</h3>
<p class="mb-4 text-gray-700">Your changes have been saved successfully!</p>
<button id="closeSuccessModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
</div>
</div>

<!-- View Modal -->
<div id="viewModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
<div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
<div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-blue-600">Fixed Amount by Rank Details</h3>
    <button id="closeViewModal" class="text-gray-400 hover:text-gray-600">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
</div>
<div id="viewContent"></div>
</div>
</div>

<script>
let editingIndex = null;
let data = [];
let originalData = null;

const form = document.getElementById("rankAmountForm");
const showFormBtn = document.getElementById("showFormBtn");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const tableBody = document.getElementById("rankAmountTable");

const rankFields = [
  'trainee', 'os', 'sm', 'ab', 'ls', 'po', 'wo', 'mwo', 'cadet', 'nwo',
  'midshipman', 'slt', 'lt', 'ltcdr', 'cdr', 'capt', 'cdre', 'radm', 'vadm', 'adm', 'contract', 'rtdofficers'
];

// Map frontend rank fields -> backend DB columns
const rankFieldMap = {
  trainee: "one_amount01",
  os: "one_amount02",
  sm: "one_amount03",
  ab: "one_amount04",
  ls: "one_amount05",
  po: "one_amount06",
  wo: "one_amount07",
  mwo: "one_amount08",
  cadet: "one_amount09",
  nwo: "one_amount10",
  midshipman: "one_amount11",
  slt: "one_amount12",
  lt: "one_amount13",
  ltcdr: "one_amount14",
  cdr: "one_amount15",
  capt: "one_amount16",
  cdre: "one_amount17",
  radm: "one_amount18",
  vadm: "one_amount19",
  adm: "one_amount20",
  contract: "one_amount21",
  rtdofficers: "one_amount22"
};

// Transform DB → frontend
function transformFromBackend(item) {
  const ranks = {};
  rankFields.forEach(rank => {
    ranks[rank] = item[rankFieldMap[rank]] || 0;
  });
  return {
    one_type: item.one_type,
    createdby: item.createdby,
    datecreated: item.datecreated,
    ranks
  };
}

// Transform frontend → DB
function transformToBackend(item) {
  const payload = {
    one_type: item.one_type,
  };
  rankFields.forEach(rank => {
    payload[rankFieldMap[rank]] = item.ranks[rank] || 0;
  });
  return payload;
}

// Add new
showFormBtn.addEventListener("click", () => {
    form.classList.remove("hidden");
    editingIndex = null;
    clearForm();
});

//validations
async function checkDuplicate(input, field, excludeType = null) {
  const value = input.value.trim();
  if (!value) {
    input.setCustomValidity("");
    input.reportValidity();
    return;
  }

  // If editing, check if this field value has actually changed
  if (originalData && originalData[field] === value) {
    input.setCustomValidity(""); // Clear any existing validation message
    input.reportValidity();
    return; // Skip duplicate check if value hasn't changed
  }

  try {
    const token = localStorage.getItem("token");
    
    // Build URL with optional excludeType parameter
    let url = `/rank/check/${field}/${encodeURIComponent(value)}`;
    if (excludeType) {
      url += `?exclude=${excludeType}`;
    }
    
    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (!res.ok) {
      console.error(`HTTP ${res.status}: ${res.statusText}`);
      return;
    }

    const data = await res.json();
    if (data.exists) {
      input.setCustomValidity(`⚠️ This ${field} already exists.`);
    } else {
      input.setCustomValidity("");
    }
    input.reportValidity();
  } catch (err) {
    console.error(`Error checking ${field}:`, err);
    input.setCustomValidity("");
    input.reportValidity();
  }
}

document.getElementById("description")?.addEventListener("blur", function () {
    checkDuplicate(this, "one_type");
});


//  helper: get token
function getToken() {
  return localStorage.getItem("token");
}

//  Load from API
async function loadData() {
  try {
    const res = await fetch("/rank", {
      headers: { "Authorization": `Bearer ${getToken()}`}
    });
     const result = await res.json();
     data = result.map(transformFromBackend);
    renderTable();
  } catch (err) {
    console.error("Error loading:", err);
  }
}

// View row
window.viewRow = function(index) {
  const item = data[index];
  let html = `
    <div class="mb-4">
      <h4 class="text-lg font-semibold">Type: ${item.one_type}</h4>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
  `;
  for (let rank in item.ranks) {
    const displayRank = rank.charAt(0).toUpperCase() + rank.slice(1);
    const amount = new Intl.NumberFormat("en-NG", { style: "currency", currency: "NGN" }).format(item.ranks[rank]);
    html += `
      <div class="flex justify-between bg-white p-2 rounded border">
        <span class="font-medium">${displayRank}</span>
        <span class="text-blue-600 font-semibold">${amount}</span>
      </div>
    `;
  }
  html += `</div>`;
  document.getElementById("viewContent").innerHTML = html;
  openModal("viewModal");
};

// Edit row
window.editRow = function(index) {
  const item = data[index];

  //store original values for comparison
  originalData = {
    one_type: item.one_type
  };

  document.getElementById("description").value = item.one_type;
  rankFields.forEach(rank => {
    document.getElementById(rank).value = item.ranks[rank] || 0;
  });

  //clear any validation messages
  document.getElementById('description').setCustomValidity("");

  editingIndex = index;
  form.classList.remove("hidden");
};

//  Delete
window.deleteRow = async function(index) {
  if (!confirm("Are you sure you want to delete this record?")) return;
  const item = data[index];

  try {
    await fetch(`/rank/${item.one_type}`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${getToken()}` }
    });
    data.splice(index, 1);
    renderTable();
  } catch (err) {
    console.error("Delete failed", err);
  }
};

saveBtn.addEventListener("click", async () => {
  const one_type = document.getElementById("description").value.trim();
  if (!one_type) {
    alert("Please enter a description / type");
    return;
  }

  // check for duplicates
  const one_typeInput = document.getElementById("description");

  // Get current one_type for editing
  const currentOne_type = editingIndex;

  //perform duplicate checks only for changed fields
  await checkDuplicate(one_typeInput, 'one_type', currentOne_type);

  //check if any validation error exists
  if(!one_typeInput.checkValidity()){
    alert("Please fix the validation errors before saving.");
    return;
  }

  const ranks = {};
  rankFields.forEach(rank => {
    ranks[rank] = parseFloat(document.getElementById(rank).value) || 0;
  });

  const item = { one_type, ranks };
  const payload = transformToBackend(item);

  try {
    if (editingIndex !== null) {
      //UPDATE
      const current = data[editingIndex];
      const res = await fetch(`/rank/${current.one_type}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${getToken()}`
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Update failed");

      // keep frontend copy
      data[editingIndex] = { one_type, ranks, createdDate: current.createdDate };

    } else {
      // CREATE
      const res = await fetch("/rank/payrank", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${getToken()}`
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Create failed");

      //add to frontend list
      data.push({
        one_type,
        ranks,
        createdDate: new Date().toISOString().split("T")[0]
      });
    }

    renderTable();
    await loadData();
    form.classList.add("hidden");
    clearForm();
    openModal("successModal");
    editingIndex = null;
    originalData =null;

  } catch (err) {
    console.error("Save failed:", err);
    alert("Save failed, check console.");
  }
});

// UI helpers
function renderTable() {
  tableBody.innerHTML = data.map((item, index) => `
    <tr class="hover:bg-gray-50">
      <td class="border px-4 py-2 text-left">${item.one_type}</td>
      <td class="border px-4 py-2 text-center">
        <button onclick="viewRow(${index})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
        <button onclick="editRow(${index})" class="text-green-600 hover:text-green-800 mr-2">Edit</button>
        <button onclick="deleteRow(${index})" class="text-red-600 hover:text-red-800">Delete</button>
      </td>
    </tr>
  `).join("");
}

// cancel button
cancelBtn.addEventListener("click", () => {
  form.classList.add("hidden");
  editingIndex = null;
  clearForm();
});

// Helpers
function clearForm() {
  document.getElementById("description").value = "";
  rankFields.forEach(rank => {
    document.getElementById(rank).value = "";
  });
}

function openModal(id) {
  document.getElementById(id).classList.remove("hidden");
}
function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
}
document.getElementById("closeSuccessModal").addEventListener("click", () => closeModal("successModal"));
document.getElementById("closeViewModal").addEventListener("click", () => closeModal("viewModal"));


// load on page ready
loadData();
</script>