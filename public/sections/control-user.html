<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h3 class="text-lg font-semibold text-gray-900">Current Users</h3>
    </div>
    <button onclick="window.navigation.navigateToSection('create-user', 'Create User')" 
      class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
      Add New User
    </button>
  </div>

  <!-- Search and Filter -->
  <div class="mb-6 flex flex-col md:flex-row gap-4">
    <div class="flex-1">
      <input type="text" id="personnel-search" placeholder="Search by name, ID, or department..." 
             class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="flex gap-2">
      <select id="department-filter" class="px-3 py-2 border border-gray-300 rounded-md">
        <option value="">All Departments</option>
        <option value="HR">Human Resources</option>
        <option value="IT">Information Technology</option>
        <option value="Finance">Finance</option>
        <option value="Operations">Operations</option>
      </select>
      <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="suspended">Suspended</option>
      </select>
    </div>
  </div>

  <!-- Personnel Table -->
  <div class="overflow-x-auto">
    <table class="w-full border-collapse border border-gray-300">
      <thead class="bg-gray-50">
        <tr>
          <th class="border border-gray-300 px-4 py-3 text-left font-medium">User ID</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-medium">Full Name</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-medium">Role</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-medium">Status</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-medium">Actions</th>
        </tr>
      </thead>
      <tbody id="personnel-table-body">
        <!-- Table content will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex justify-between items-center">
    <div class="text-sm text-gray-600">
      Showing <span id="showing-start">1</span>-<span id="showing-end">10</span> of <span id="total-records">0</span> records
    </div>
    <div class="flex gap-2">
      <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">Previous</button>
      <span id="page-numbers" class="flex gap-1">
        <!-- Page numbers will be inserted here -->
      </span>
      <button id="next-page" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">Next</button>
    </div>
  </div>

  <!-- View Employee Modal -->
  <div id="viewEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4 text-gray-800">User Details</h3>
      <div id="viewEmployeeContent" class="space-y-2 text-gray-700"></div>
      <div class="flex justify-end mt-6">
        <button onclick="window.personnelManager.closeViewEmployee()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Close</button>
      </div>
    </div>
  </div>

<!-- Edit user -->



  <!-- Delete Employee Modal -->
  <div id="deleteEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4 text-gray-800">Confirm Delete</h3>
      <p class="text-gray-600 mb-6">Are you sure you want to delete this employee?</p>
      <div class="flex justify-end space-x-3">
        <button onclick="window.personnelManager.closeDeleteEmployee()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button id="confirmDeleteEmployeeBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="successPopup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center space-x-3">
      <div id="successSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
      <span id="successMessage" class="text-gray-700">Processing...</span>
    </div>
  </div>
</div>

<script>
class PersonnelManager {
  constructor() {
    this.currentPage = 1;
    this.recordsPerPage = 10;
    this.personnel = [];
    this.filteredPersonnel = [];
    this.isEditMode = false;
    this.editingUserId = null;
    this.init();
  }

  init() {
    this.loadPersonnelData();
    this.setupEventListeners();
  }

  async loadPersonnelData() {
    try {
      const res = await fetch('/api/users');
      this.personnel = await res.json();
      this.filteredPersonnel = [...this.personnel];
      this.renderTable();
    } catch (err) {
      console.error('❌ Failed to load personnel:', err);
    }
  }

  setupEventListeners() {
    const searchInput = document.getElementById('personnel-search');
    const departmentFilter = document.getElementById('department-filter');
    const statusFilter = document.getElementById('status-filter');

    if (searchInput) searchInput.addEventListener('input', () => this.filterPersonnel());
    if (departmentFilter) departmentFilter.addEventListener('change', () => this.filterPersonnel());
    if (statusFilter) statusFilter.addEventListener('change', () => this.filterPersonnel());
  }

  filterPersonnel() {
    const searchInput = document.getElementById('personnel-search');
    const departmentFilter = document.getElementById('department-filter');
    const statusFilter = document.getElementById('status-filter');

    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const department = departmentFilter ? departmentFilter.value : '';
    const status = statusFilter ? statusFilter.value : '';

    this.filteredPersonnel = this.personnel.filter(person => {
      const matchesSearch = person.full_name.toLowerCase().includes(search) ||
                            person.user_id.toLowerCase().includes(search) ||
                            (person.department ? person.department.toLowerCase().includes(search) : false);
      const matchesDepartment = !department || (person.department === department);
      const matchesStatus = !status || (person.status === status);

      return matchesSearch && matchesDepartment && matchesStatus;
    });

    this.currentPage = 1;
    this.renderTable();
  }

  renderTable() {
    const tbody = document.getElementById('personnel-table-body');
    if (!tbody) return;

    const startIndex = (this.currentPage - 1) * this.recordsPerPage;
    const endIndex = startIndex + this.recordsPerPage;
    const pageData = this.filteredPersonnel.slice(startIndex, endIndex);

    tbody.innerHTML = pageData.map(person => `
      <tr class="hover:bg-gray-50">
        <td class="border border-gray-300 px-4 py-2">${person.user_id}</td>
        <td class="border border-gray-300 px-4 py-2 font-medium">${person.full_name}</td>
        <td class="border border-gray-300 px-4 py-2">${person.user_role}</td>
        <td class="border border-gray-300 px-4 py-2">
          <span class="px-2 py-1 rounded-full text-xs ${this.getStatusClass(person.status)}">
            ${person.status.charAt(0).toUpperCase() + person.status.slice(1)}
          </span>
        </td>
        <td class="border border-gray-300 px-4 py-2 text-center">
          <button onclick="window.personnelManager.viewEmployee('${person.user_id}')" 
                  class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 mr-1">View</button>
          <button onclick="window.personnelManager.editEmployee('${person.user_id}')" 
                  class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 mr-1">Edit</button>
          <button onclick="window.personnelManager.deleteEmployee('${person.user_id}')" 
                  class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Delete</button>
        </td>
      </tr>
    `).join('');

    this.updatePaginationInfo();
  }

  getStatusClass(status) {
    switch(status) {
      case 'active': return 'bg-green-100 text-green-800';
      case 'inactive': return 'bg-red-100 text-red-800';
      case 'suspended': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }

  // ✅ View user
  viewEmployee(user_id) {
    const employee = this.personnel.find(p => p.user_id === user_id);
    if (employee) {
      document.getElementById("viewEmployeeContent").innerHTML = `
        <p><strong>User ID:</strong> ${employee.user_id}</p>
        <p><strong>Name:</strong> ${employee.full_name}</p>
        <p><strong>Role:</strong> ${employee.user_role}</p>
        <p><strong>Status:</strong> ${employee.status}</p>
        <p><strong>Email:</strong> ${employee.email}</p>
        <p><strong>Phone:</strong> ${employee.phone_number || ''}</p>
        <p><strong>Expiry Date:</strong> ${this.formatDateForInput(employee.expiry_date) || ''}</p>
      `;
      document.getElementById("viewEmployeeModal").classList.remove("hidden");
    }
  }

  closeViewEmployee() { document.getElementById("viewEmployeeModal").classList.add("hidden"); }

  formatDateForInput(dateValue) {
    if (!dateValue) return "";

    const d = new Date(dateValue);
    if (isNaN(d)) return "";

    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");

    return `${year}-${month}-${day}`;
  }


  // ✅ Edit user - redirect to create form
  editEmployee(user_id) {
    const employee = this.personnel.find(p => p.user_id === user_id);
    if (employee) {

      // Force global reference
      window.personnelManager.isEditMode = true;
      window.personnelManager.editingUserId = user_id;

      // Navigate to create personnel page/section
      this.navigateToCreateForm();

      // Wait for navigation to complete before updating UI elements and prefilling
      setTimeout(() => {
      // Pre-fill the create form with employee data
      this.prefillCreateForm(employee);

      // Hide/disable password fields and exit date
      this.configureFormForEdit();
      }, 50); // The same delay as the navigation logic
    }
  }

  navigateToCreateForm() {
    // Navigate to create user section using the existing navigation
    if (window.navigation) {
      window.navigation.navigateToSection('create-user', 'Edit User');
    }
    
    // Wait for navigation to complete before updating UI elements
    setTimeout(() => {
      // Update form title to indicate edit mode
      const formTitle = document.querySelector('h3.text-lg.font-semibold');
      if (formTitle) formTitle.textContent = 'Edit User';
      
      // Update submit button text
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.textContent = 'Update User';
    }, 50);
  }

  prefillCreateForm(employee) {
    // Pre-fill form fields with employee data using form structure position
    console.log('Prefilling form with:', employee); // Debug log
    
    const form = document.getElementById('create-user-form');
    if (!form) {
      console.warn('Create user form not found');
      return;
    }

    // Get form inputs by their order in the form
    const inputs = form.querySelectorAll('input, select');
    
    // Based on your HTML structure:
    // 0: User ID (employeeId)
    // 1: Full Name
    // 2: Email 
    // 3: Role (select)
    // 4: Status (select)
    // 5: Phone
    // 6: Password
    // 7: Confirm Password
    // 8: Expiry Date
    
    if (inputs[0]) { // User ID
      inputs[0].value = employee.user_id;
      inputs[0].readOnly = true;
      inputs[0].style.backgroundColor = '#f3f4f6';
      console.log('Set User ID to:', employee.user_id);
    }
    
    if (inputs[1]) { // Full Name
      inputs[1].value = employee.full_name;
      console.log('Set Full Name to:', employee.full_name);
    }
    
    if (inputs[2]) { // Email
      inputs[2].value = employee.email;
      console.log('Set Email to:', employee.email);
    }
    
    if (inputs[3]) { // Role (select)
      inputs[3].value = employee.user_role;
      console.log('Set Role to:', employee.user_role);
    }
    
    if (inputs[4]) { // Status (select)
      inputs[4].value = employee.status;
      console.log('Set Status to:', employee.status);
    }
    
    if (inputs[5]) { // Phone
      inputs[5].value = employee.phone_number || '';
      console.log('Set Phone to:', employee.phone_number);
    }

    if (inputs[6]) { // Password
      inputs[6].value = employee.password || '';
      console.log('Set Password to:', employee.password);
    }

    if (inputs[7]) { // Confirm Password
      inputs[7].value = employee.password || '';
      console.log('Set Confirm Password to:', employee.password);
    }

    if (inputs[8]) { // Expiry Date
      inputs[8].value = this.formatDateForInput(employee.expiry_date) || '';
      inputs[0].readOnly = true;
      console.log('Set Expiry Date to:', this.formatDateForInput(employee.expiry_date));
    }
  }

  configureFormForEdit() {
    const form = document.getElementById('create-user-form');
    if (!form) return;

    const inputs = form.querySelectorAll('input, select');
    
    // Hide password fields (inputs[6] and inputs[7])
    if (inputs[6]) { // Password field
      const passwordContainer = inputs[6].closest('div');
      if (passwordContainer) passwordContainer.style.display = 'none';
    }
    
    if (inputs[7]) { // Confirm Password field
      const confirmPasswordContainer = inputs[7].closest('div');
      if (confirmPasswordContainer) confirmPasswordContainer.style.display = 'none';
    }

    // Add cancel button if it doesn't exist
    this.addCancelButton();
  }

  addCancelButton() {
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn && !document.getElementById('cancel-edit-btn')) {
      const cancelBtn = document.createElement('button');
      cancelBtn.id = 'cancel-edit-btn';
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500';
      cancelBtn.onclick = () => this.cancelEdit();
      
      submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
    }
  }

  cancelEdit() {
    this.isEditMode = false;
    this.editingUserId = null;
    this.editingEmployeeData = null;
    
    // Reset form
    const form = document.getElementById('create-user-form');
    if (form) form.reset();
    
    // Show password fields and expiry date again
    this.showHiddenFields();
    
    // Remove readonly from user ID
    const inputs = form.querySelectorAll('input, select');
    if (inputs[0]) {
      inputs[0].readOnly = false;
      inputs[0].style.backgroundColor = '';
    }
    
    // Remove cancel button
    const cancelBtn = document.getElementById('cancel-edit-btn');
    if (cancelBtn) cancelBtn.remove();
    
    // Reset form title and button text
    const formTitle = document.querySelector('h3.text-lg.font-semibold');
    if (formTitle) formTitle.textContent = 'Create New User';
    
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Create User';
    
    // Navigate back to personnel list
    this.navigateToPersonnelList();
  }

  showHiddenFields() {
    const form = document.getElementById('create-user-form');
    if (!form) return;

    const inputs = form.querySelectorAll('input, select');
    
    // Show password fields (inputs[6] and inputs[7])
    if (inputs[6]) { // Password field
      const passwordContainer = inputs[6].closest('div');
      if (passwordContainer) passwordContainer.style.display = '';
    }
    
    if (inputs[7]) { // Confirm Password field
      const confirmPasswordContainer = inputs[7].closest('div');
      if (confirmPasswordContainer) confirmPasswordContainer.style.display = '';
    }

    // Show expiry date field (inputs[8])
    if (inputs[8]) { // Expiry Date field
      const expiryContainer = inputs[8].closest('div');
      if (expiryContainer) expiryContainer.style.display = '';
    }
  }

  navigateToPersonnelList() {
    // Use existing navigation to go back to control user (personnel list)
    if (window.navigation) {
      window.navigation.navigateToSection('control-user', 'Control User');
    }
  }

  // ✅ Delete user
  async deleteEmployee(user_id) {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
      const res = await fetch(`/api/users/${user_id}`, { method: 'DELETE' });
      if (res.ok) {
        this.personnel = this.personnel.filter(p => p.user_id !== user_id);
        this.filterPersonnel();
        this.showSuccess("User deleted successfully!");
      } else {
        alert("❌ Failed to delete user");
      }
    } catch (err) {
      console.error("❌ Delete error:", err);
    }
  }

  // ✅ Save edits (modified to handle both create and edit)


  resetCreateForm() {
    const form = document.getElementById('create-user-form');
    if (form) form.reset();
    
    // Make sure all fields are visible and enabled again
    this.showHiddenFields();
    
    const inputs = form.querySelectorAll('input, select');
    if (inputs[0]) {
      inputs[0].readOnly = false;
      inputs[0].style.backgroundColor = '';
    }
  }

  showSuccess(message) {
    const popup = document.getElementById("successPopup");
    const spinner = document.getElementById("successSpinner");
    const text = document.getElementById("successMessage");

    if (popup && spinner && text) {
      text.innerText = "Processing...";
      spinner.classList.remove("hidden");
      popup.classList.remove("hidden");

      setTimeout(() => {
        spinner.classList.add("hidden");
        text.innerHTML = `<span class="text-green-600 font-semibold">✔ ${message}</span>`;
      }, 1000);

      setTimeout(() => { popup.classList.add("hidden"); }, 2500);
    }
  }

  updatePaginationInfo() {
    const total = this.filteredPersonnel.length;
    const start = (this.currentPage - 1) * this.recordsPerPage + 1;
    const end = Math.min(start + this.recordsPerPage - 1, total);

    const showingStart = document.getElementById('showing-start');
    const showingEnd = document.getElementById('showing-end');
    const totalRecords = document.getElementById('total-records');

    if (showingStart) showingStart.textContent = total > 0 ? start : 0;
    if (showingEnd) showingEnd.textContent = end;
    if (totalRecords) totalRecords.textContent = total;
  }
}

// ✅ Unified form handler for both Create and Edit
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById("create-user-form");
  if (!form) return;

  // Remove old handler if exists
  if (form._personnelHandler) {
    form.removeEventListener("submit", form._personnelHandler);
  }

form._personnelHandler = async (e) => {
  e.preventDefault();

  console.log(">>> SUBMIT:", {
    isEditMode: window.personnelManager?.isEditMode,
    editingUserId: window.personnelManager?.editingUserId
  });

  const inputs = form.querySelectorAll('input, select');

  const userData = {
    full_name: inputs[1]?.value || '',
    email: inputs[2]?.value || '',
    user_role: inputs[3]?.value || '',
    status: inputs[4]?.value || '',
    phone_number: inputs[5]?.value || ''
  };

  try {
    let res;

      if (window.personnelManager?.isEditMode) {
        console.log(">>> PUT called with ID:", window.personnelManager.editingUserId);
        res = await fetch(`/api/users/${window.personnelManager.editingUserId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
      } else {
        console.log(">>> POST called");
        const user_id = inputs[0]?.value || '';
        res = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...userData, user_id })
        });
      }

      if (res.ok) {
        const data = await res.json();

        if (window.personnelManager?.isEditMode) {
          // Update local state
          const existingUser = window.personnelManager.personnel.find(
            u => u.user_id === window.personnelManager.editingUserId
          );
          if (existingUser) {
            Object.assign(existingUser, { ...userData });
          }
          window.personnelManager.filterPersonnel();
          window.personnelManager.showSuccess("User updated successfully!");
          window.personnelManager.cancelEdit();
        } else {
          window.personnelManager.showSuccess("User created successfully!");
          form.reset();
        }
      } else {
        const err = await res.json();
        alert(`❌ ${err.error || 'Request failed'}`);
      }
    } catch (error) {
      console.error("❌ Error:", error);
      alert('❌ Server error');
    }
  };

  form.addEventListener("submit", form._personnelHandler);
});

// Initialize
window.personnelManager = new PersonnelManager();
</script>
