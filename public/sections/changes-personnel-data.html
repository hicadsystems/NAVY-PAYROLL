<div class="p-6">
  <!-- Top Action Bar (Hidden after first load, shown only on recall or when stage < 666) -->
  <div id="topActionBar" class="hidden mb-6 w-full flex justify-between items-center border-b-2 pb-4 no-print">
    <h2 class="text-blue-600 font-semibold lg:text-lg">
      <i class="fas fa-info-circle mr-2"></i>First ensure you have saved payroll files
    </h2>
    <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('save-payroll-files', 'Save Payroll Files')" 
            class="px-6 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
      <i class="fas fa-save mr-2"></i>Save Payroll Files
    </button>
  </div>

  <!-- Filter Tabs (Hidden until data is loaded, then permanent) -->
  <div id="filterTabs" class="hidden bg-blue-100/25 border-2 border-blue-100 flex flex-wrap gap-2 p-2 mb-4 rounded-lg no-print">
    <button id="allToggle" class="flex-1 px-2 py-2 text-sm lg:text-lg font-medium rounded-lg bg-yellow-50 text-gray-900 shadow transition-colors duration-200">
      <i class="fas fa-list mr-2"></i>All Changes
    </button>
    <button id="personnelToggle" class="flex-1 px-2 py-2 text-sm lg:text-lg font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
      <i class="fas fa-user mr-2"></i>By Personnel
    </button>
    <button id="highRiskToggle" class="flex-1 px-2 py-2 text-sm lg:text-lg font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
      <i class="fas fa-exclamation-triangle mr-2"></i>High Risk
    </button>
    <button id="newEmpToggle" class="flex-1 px-2 py-2 text-sm lg:text-lg font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
      <i class="fas fa-user-plus mr-2"></i>New Employees
    </button>
    <button id="byDateToggle" class="flex-1 px-2 py-2 text-sm lg:text-lg font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
      <i class="fas fa-calendar mr-2"></i>By Date Range
    </button>
  </div>

  <!-- Filter Form Container (shown for personnel and date tabs only) -->
  <div id="filterFormContainer" class="hidden p-2 rounded-lg mb-4 no-print">
    <div id="filterFormContent" class="flex flex-col md:flex-row md:items-end md:gap-6">            
      <div id="personnelSelectWrapperFilter" class="hidden flex-1">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 lg:text-lg">
            <i class="fas fa-search mr-2"></i>Select Personnel
          </label>              
          <div class="md:flex md:items-start md:space-x-4">                   
            <div class="relative col-span-1 flex-1 mb-3 md:mb-0">
              <div class="relative">
                <input 
                  type="text" 
                  id="searchInputFilter"
                  class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2 pr-10"
                  placeholder="Search Name or Number..."
                  autocomplete="off">
                <i class="fas fa-chevron-down absolute right-3 top-4 text-gray-400"></i>
              </div>
              <div id="dropdownListFilter" class="absolute z-10 w-full mt-1 bg-yellow-50 border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                <div class="py-1" id="employeeDropdownItemsFilter"></div>
              </div>
            </div>
              
            <button 
              type="button" 
              id="applyFilterBtn" 
              class="px-3 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg whitespace-nowrap w-full md:w-auto">
              Apply Filter
            </button>
          </div>
        </div>
      </div>

      <div id="dateRangeWrapperFilter" class="hidden flex-1">          
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">              
          <div>
            <label for="startPeriodFilter" class="block text-sm font-medium text-gray-700 mb-2 lg:text-lg">
              Start Date
            </label>
            <input id="startPeriodFilter" type="date" class="w-full border-2 border-gray-300 rounded-lg shadow-sm px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
          </div>
          
          <div>
            <label for="endPeriodFilter" class="block text-sm font-medium text-gray-700 mb-2 lg:text-lg">
              End Date
            </label>
            <input id="endPeriodFilter" type="date" class="w-full border-2 border-gray-300 rounded-lg shadow-sm px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
          </div>
          
          <div class="md:self-end mt-4 md:mt-0 flex md:justify-end">
            <button 
              type="button" 
              id="applyFilterBtn2" 
              class="px-3 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg w-full md:w-auto">
              Apply Filter
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form (Shown initially, hidden after first successful POST load or when stage >= 775 and data loaded) -->
  <form id="changesForm" class="space-y-6 p-6 no-print">
    <div class="p-6">
      <h2 class="text-2xl font-semibold text-navy">
        <i class="fas fa-sync-alt text-navy mr-2"></i>Load personnel changes data and generate printable reports.
      </h2>
    </div>

    <div class="flex justify-end space-x-4 pt-4">
      <!--<button type="button" id="cancelBtn" class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all shadow">
        <i class="fas fa-times mr-2"></i>Cancel
      </button>-->
      <button type="button" id="loadChangesBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg">
        <i class="fas fa-sync-alt mr-2"></i>Load Data
      </button>
    </div>
  </form>

  <!-- Progress Modal (only used for POST/process calls) -->
  <div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
      <div class="text-center">
        <div class="flex justify-center mb-4">
          <div class="w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Processing...</h3>
        <p id="progressMessage" class="text-gray-600 mb-4">Processing personnel changes...</p>
        <div id="logContainer" class="bg-gray-50 rounded-lg p-3 max-h-48 overflow-y-auto text-left text-sm">
          <!-- Backend logs will appear here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal (for errors and notifications) -->
  <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
      <div class="text-center">
        <div id="alertIcon" class="flex justify-center mb-4">
          <i class="fas fa-exclamation-circle text-red-500 text-6xl"></i>
        </div>
        <h3 id="alertTitle" class="text-xl font-semibold text-gray-900 mb-2">Error</h3>
        <p id="alertMessage" class="text-gray-600 mb-6">An error occurred</p>
        <button id="alertCloseBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Changes Table (Permanent after first load) -->
  <div id="changesTable" class="hidden mb-4 rounded-lg overflow-hidden">
    <div class="pb-4 flex justify-between items-center no-print">
      <h3 class="text-xl text-navy font-bold">Personnel Changes Report</h3>
      <div class="flex gap-2">
        <button id="exportExcelBtn" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition shadow">
          <i class="fas fa-file-excel mr-2"></i>Excel
        </button>
        <button id="exportPdfBtn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition shadow">
          <i class="fas fa-file-pdf mr-2"></i>PDF
        </button>
        <button id="printBtn" class="px-4 py-2 bg-gray-700 text-white text-sm rounded-lg hover:bg-gray-800 transition shadow">
          <i class="fas fa-print mr-2"></i>Print
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-blue-100 text-blue-900">
          <tr>
            <th class="border px-2 py-3 text-left"><i class="fas fa-user-circle mr-1"></i> Service No</th>
            <th class="border px-2 py-3 text-left"><i class="fas fa-user mr-1"></i>Full Name</th>
            <th class="border px-2 py-3 text-left"><i class="fas fa-map-marker-alt mr-1"></i>Location</th>
            <th class="border px-2 py-3 text-left"><i class="fas fa-shield-alt mr-1"></i>Risk</th>
            <th class="border px-2 py-3 text-left no-print"><i class="fas fa-cog mr-1"></i>Action</th>
          </tr>
        </thead>
        <tbody id="changesTableBody" class="divide-y divide-gray-200">
          <!-- Rows populated dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div id="paginationControls" class="flex justify-between items-center mt-4 no-print">
      <div class="text-sm text-gray-600">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalRecords">0</span> records
      </div>
      <div class="flex gap-2">
        <button id="firstPageBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button id="prevPageBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-angle-left"></i> Prev
        </button>
        <span id="pageInfo" class="px-4 py-2 bg-blue-50 text-blue-900 rounded-lg font-medium">Page 1 of 1</span>
        <button id="nextPageBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
          Next <i class="fas fa-angle-right"></i>
        </button>
        <button id="lastPageBtn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Cancel Filter Button (shown after applying personnel or date filter) -->
  <div id="cancelFilterContainer" class="hidden mb-4 flex justify-end no-print">
    <button id="cancelFilterBtn" class="px-3 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all shadow-lg">
      Cancel
    </button>
  </div>

  <!-- Summary Cards (Hidden until loaded, then permanent) -->
  <div id="summaryCards" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
    <div class="p-4 rounded-lg border-2 transform hover:scale-105 transition">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-gray-500 text-sm font-medium">Total Changes</div>
          <div id="totalChanges" class="text-3xl font-bold text-gray-900">0</div>
        </div>
        <i class="fas fa-exchange-alt text-blue-500 text-3xl"></i>
      </div>
    </div>
    <div class="p-4 rounded-lg border-2 transform hover:scale-105 transition">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-gray-500 text-sm font-medium">High Risk</div>
          <div id="highRiskCount" class="text-3xl font-bold text-red-600">0</div>
        </div>
        <i class="fas fa-exclamation-circle text-red-500 text-3xl"></i>
      </div>
    </div>
    <div class="p-4 rounded-lg border-2 transform hover:scale-105 transition">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-gray-500 text-sm font-medium">Medium Risk</div>
          <div id="mediumRiskCount" class="text-3xl font-bold text-yellow-600">0</div>
        </div>
        <i class="fas fa-exclamation text-yellow-500 text-3xl"></i>
      </div>
    </div>
    <div class="p-4 rounded-lg border-2 transform hover:scale-105 transition">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-gray-500 text-sm font-medium">Bank Changes</div>
          <div id="bankChangesCount" class="text-3xl font-bold text-green-600">0</div>
        </div>
        <i class="fas fa-university text-green-500 text-3xl"></i>
      </div>
    </div>
  </div>

  <!-- Change Details Modal -->
  <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-gray-100 rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto hide-scrollbar-">
        <div class="p-6 sticky top-0 z-20 bg-navy text-white">
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-bold"><i class="fas fa-info-circle mr-2"></i>Change Details</h3>
              <button id="closeModal" class="text-white hover:text-gray-200 transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
        </div>
      <div id="modalContent" class="p-6"></div>
    </div>
  </div>

  <!-- Success/Next Step Banner (Permanent after successful load) -->
  <div id="nextStepBanner" class="hidden mt-6 p-6 no-print">
    <div class="flex items-start">
      <i class="fas fa-check-circle text-green-500 text-3xl mr-4"></i>
      <div class="flex-1">
        <h4 class="text-green-800 font-bold text-lg mb-2">Changes Loaded Successfully!</h4>
        <p class="text-green-700 mb-4">Review the changes above, filter as needed, and export reports. Ready to proceed?</p>
        <button onclick="window.navigation && window.navigation.navigateToSection && window.navigation.navigateToSection('input-variable-report', 'Input Variable Report')" 
                class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition font-medium">
          <i class="fas fa-arrow-right mr-2"></i>Go to Input Variable Report
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // API base
  const API_BASE = '/personneldata';

  // BT05 stages
  const STAGE_DATA_ENTRY_OPEN = 0;
  const STAGE_CLOSED = 666;
  const STAGE_CHANGES_READY = 775;
  const STAGE_INPUT_VAR_READY = 777;
  const STAGE_UPDATE_COMPLETED = 888;
  const STAGE_CALC_COMPLETED = 999;

  // Pagination
  const RECORDS_PER_PAGE = 5;
  let currentPage = 1;
  let filteredData = [];

  // State
  let currentPayrollStage = STAGE_DATA_ENTRY_OPEN;
  let allChangesData = null;
  let allEmployees = [];
  let hasLoadedOnce = false;
  let currentMode = 'all';
  let selectedEmployee = null;
  let filterApplied = false;

  // DOM
  const topActionBar = document.getElementById('topActionBar');
  const filterTabs = document.getElementById('filterTabs');
  const allToggle = document.getElementById('allToggle');
  const personnelToggle = document.getElementById('personnelToggle');
  const highRiskToggle = document.getElementById('highRiskToggle');
  const newEmpToggle = document.getElementById('newEmpToggle');
  const byDateToggle = document.getElementById('byDateToggle');
  const filterFormContainer = document.getElementById('filterFormContainer');
  const filterFormContent = document.getElementById('filterFormContent');
  const personnelSelectWrapperFilter = document.getElementById('personnelSelectWrapperFilter');
  const dateRangeWrapperFilter = document.getElementById('dateRangeWrapperFilter');
  const searchInputFilter = document.getElementById('searchInputFilter');
  const dropdownListFilter = document.getElementById('dropdownListFilter');
  const employeeDropdownItemsFilter = document.getElementById('employeeDropdownItemsFilter');
  const startPeriodFilter = document.getElementById('startPeriodFilter');
  const endPeriodFilter = document.getElementById('endPeriodFilter');
  const applyFilterBtn = document.getElementById('applyFilterBtn');
  const applyFilterBtn2 = document.getElementById('applyFilterBtn2');
  const cancelFilterContainer = document.getElementById('cancelFilterContainer');
  const cancelFilterBtn = document.getElementById('cancelFilterBtn');
  const personnelSelectWrapper = document.getElementById('personnelSelectWrapper');
  const dateRangeWrapper = document.getElementById('dateRangeWrapper');
  const searchInput = document.getElementById('searchInput');
  const dropdownList = document.getElementById('dropdownList');
  const loadBtn = document.getElementById('loadChangesBtn');
  const progressModal = document.getElementById('progressModal');
  const alertModal = document.getElementById('alertModal');
  const alertTitle = document.getElementById('alertTitle');
  const alertMessage = document.getElementById('alertMessage');
  const alertIcon = document.getElementById('alertIcon');
  const alertCloseBtn = document.getElementById('alertCloseBtn');
  const progressMessage = document.getElementById('progressMessage');
  const logContainer = document.getElementById('logContainer');
  const changesForm = document.getElementById('changesForm');
  const changesTable = document.getElementById('changesTable');
  const changesTableBody = document.getElementById('changesTableBody');
  const summaryCards = document.getElementById('summaryCards');
  const nextStepBanner = document.getElementById('nextStepBanner');
  const detailsModal = document.getElementById('detailsModal');
  const modalContent = document.getElementById('modalContent');
  const closeModal = document.getElementById('closeModal');
  const startPeriod = document.getElementById('startPeriod');
  const endPeriod = document.getElementById('endPeriod');
  const exportExcelBtn = document.getElementById('exportExcelBtn');
  const exportPdfBtn = document.getElementById('exportPdfBtn');
  const printBtn = document.getElementById('printBtn');

  // Pagination DOM
  const firstPageBtn = document.getElementById('firstPageBtn');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const lastPageBtn = document.getElementById('lastPageBtn');
  const pageInfo = document.getElementById('pageInfo');
  const showingStart = document.getElementById('showingStart');
  const showingEnd = document.getElementById('showingEnd');
  const totalRecords = document.getElementById('totalRecords');

  // Helpers
  function addLog(message, type = 'info') {
    const log = document.createElement('div');
    log.className = `py-1 text-xs ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-gray-600'}`;
    log.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'circle'} mr-2"></i>${message}`;
    logContainer.appendChild(log);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  function showAlert(title, message, type = 'error') {
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    const iconClass = type === 'success' ? 'fa-check-circle text-green-500' : type === 'warning' ? 'fa-exclamation-triangle text-yellow-500' : 'fa-exclamation-circle text-red-500';
    alertIcon.innerHTML = `<i class="fas ${iconClass} text-6xl"></i>`;
    alertModal.classList.remove('hidden');
  }

  // Update UI visibility based on stage & loaded state
  function updateUIVisibility() {
    const isStageReadyToView = currentPayrollStage >= STAGE_CHANGES_READY;

    if (hasLoadedOnce || (isStageReadyToView && allChangesData)) {
      topActionBar.classList.add('hidden');
      changesForm.classList.add('hidden');
      filterTabs.classList.remove('hidden');
      summaryCards.classList.remove('hidden');
      changesTable.classList.remove('hidden');
      nextStepBanner.classList.remove('hidden');
      
      // Show/hide filter form based on mode and filterApplied state
      if (currentMode === 'personnel' || currentMode === 'byDate') {
        if (filterApplied) {
          filterFormContainer.classList.add('hidden');
          cancelFilterContainer.classList.remove('hidden');
          summaryCards.classList.add('hidden');
          nextStepBanner.classList.add('hidden');
        } else {
          filterFormContainer.classList.remove('hidden');
          cancelFilterContainer.classList.add('hidden');
        }
      } else {
        filterFormContainer.classList.add('hidden');
        cancelFilterContainer.classList.add('hidden');
      }
      return;
    }

    if (currentPayrollStage === STAGE_DATA_ENTRY_OPEN) {
      topActionBar.classList.remove('hidden');
      changesForm.classList.remove('hidden');
      filterTabs.classList.add('hidden');
      filterFormContainer.classList.add('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.add('hidden');
      changesTable.classList.add('hidden');
      nextStepBanner.classList.add('hidden');
      return;
    }

    if (currentPayrollStage === STAGE_CLOSED) {
      topActionBar.classList.add('hidden');
      changesForm.classList.remove('hidden');
      loadBtn.textContent = 'Process & Load Changes';
      loadBtn.classList.remove('bg-blue-600','hover:bg-blue-700');
      loadBtn.classList.add('bg-green-600','hover:bg-green-700');
      filterTabs.classList.add('hidden');
      filterFormContainer.classList.add('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.add('hidden');
      changesTable.classList.add('hidden');
      nextStepBanner.classList.add('hidden');
      return;
    }

    if (currentPayrollStage > STAGE_CLOSED && currentPayrollStage < STAGE_CHANGES_READY) {
      topActionBar.classList.add('hidden');
      changesForm.classList.remove('hidden');
      loadBtn.textContent = 'View (waiting for processing)';
      filterTabs.classList.add('hidden');
      filterFormContainer.classList.add('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.add('hidden');
      changesTable.classList.add('hidden');
      nextStepBanner.classList.add('hidden');
      return;
    }

    topActionBar.classList.remove('hidden');
    changesForm.classList.remove('hidden');
    filterTabs.classList.add('hidden');
    filterFormContainer.classList.add('hidden');
    cancelFilterContainer.classList.add('hidden');
    summaryCards.classList.add('hidden');
    changesTable.classList.add('hidden');
    nextStepBanner.classList.add('hidden');
  }

  // Switch filter mode
  function switchMode(mode) {
    currentMode = mode;
    currentPage = 1;
    filterApplied = false;
    
    [allToggle, personnelToggle, highRiskToggle, newEmpToggle, byDateToggle].forEach(btn => {
      btn.classList.remove('bg-yellow-50','text-gray-900','shadow');
      btn.classList.add('text-gray-500');
    });
    const activeBtn = mode === 'all' ? allToggle : mode === 'personnel' ? personnelToggle : mode === 'highRisk' ? highRiskToggle : mode === 'newEmployee' ? newEmpToggle : byDateToggle;
    if (activeBtn) {
      activeBtn.classList.add('bg-yellow-50','text-gray-900','shadow');
      activeBtn.classList.remove('text-gray-500');
    }

    // Handle different modes
    if (mode === 'all') {
      filterFormContainer.classList.add('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.remove('hidden');
      nextStepBanner.classList.remove('hidden');
      if (allChangesData) {
        filterAndRenderData();
      }
    } else if (mode === 'highRisk' || mode === 'newEmployee') {
      // Auto-filter for high risk and new employees
      filterFormContainer.classList.add('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.add('hidden');
      nextStepBanner.classList.add('hidden');
      if (allChangesData) {
        filterAndRenderData();
      }
    } else if (mode === 'personnel' || mode === 'byDate') {
      // Show filter form for personnel and date
      filterFormContainer.classList.remove('hidden');
      cancelFilterContainer.classList.add('hidden');
      summaryCards.classList.add('hidden');
      nextStepBanner.classList.add('hidden');
      
      // Show appropriate filter controls
      personnelSelectWrapperFilter.classList.toggle('hidden', mode !== 'personnel');
      dateRangeWrapperFilter.classList.toggle('hidden', mode !== 'byDate');
      
      // Clear table until filter is applied
      if (!allChangesData) return;
      changesTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-12 text-center text-gray-500">
            <span class="text-lg font-medium">Please apply filter to view results</span>
          </td>
        </tr>`;
    }
  }

  // Populate employee dropdown for filter form
  function populateEmployeeDropdown() {
    if (!allChangesData || !Array.isArray(allChangesData.changes)) return;
    const unique = new Map();
    allChangesData.changes.forEach(c => {
      const id = String(c.Empl_ID || c.EmplID || '').trim();
      const name = c.full_name || c.FullName || '';
      if (!id) return;
      if (!unique.has(id)) unique.set(id, { id, name });
    });
    allEmployees = Array.from(unique.values());
    
    employeeDropdownItemsFilter.innerHTML = allEmployees.map(emp => `
      <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.id}">
        <span class="font-semibold text-blue-600">${emp.name}</span>
        (<span class="text-xs font-semibold  text-gray-500">${emp.id}</span>)
      </div>`).join('');

    // Attach handlers for filter dropdown
    employeeDropdownItemsFilter.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        selectedEmployee = item.getAttribute('data-id');
        searchInputFilter.value = item.querySelector('.font-semibold').textContent;
        dropdownListFilter.classList.add('hidden');
      });
    });
  }

  // Search handler for filter
  searchInputFilter.addEventListener('input', () => {
    const q = searchInputFilter.value.trim().toLowerCase();
    if (!q) { 
      dropdownListFilter.classList.add('hidden'); 
      selectedEmployee = null; 
      return; 
    }
    const filtered = allEmployees.filter(emp => (emp.name||'').toLowerCase().includes(q) || (emp.id||'').toLowerCase().includes(q));
    employeeDropdownItemsFilter.innerHTML = filtered.map(emp => `
      <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.id}">
        <span class="font-semibold text-blue-600">${emp.name}</span>
        (<span class="text-xs font-semibold text-gray-500">${emp.id}</span>)
      </div>`).join('');
    dropdownListFilter.classList.remove('hidden');
    
    employeeDropdownItemsFilter.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        selectedEmployee = item.getAttribute('data-id');
        searchInputFilter.value = item.querySelector('.font-semibold').textContent;
        dropdownListFilter.classList.add('hidden');
      });
    });
  });

  // Apply filter button for personnel
  applyFilterBtn.addEventListener('click', () => {
    if (currentMode === 'personnel' && !selectedEmployee) {
      return showAlert('Validation Error', 'Please select a personnel', 'warning');
    }
    filterApplied = true;
    filterAndRenderData();
    updateUIVisibility();
  });

  // Apply filter button for date range
  applyFilterBtn2.addEventListener('click', () => {
    if (currentMode === 'byDate' && !startPeriodFilter.value && !endPeriodFilter.value) {
      return showAlert('Validation Error', 'Please select at least one date', 'warning');
    }
    filterApplied = true;
    filterAndRenderData();
    updateUIVisibility();
  });

  // Cancel filter button
  cancelFilterBtn.addEventListener('click', () => {
    filterApplied = false;
    selectedEmployee = null;
    searchInputFilter.value = '';
    startPeriodFilter.value = '';
    endPeriodFilter.value = '';
    dropdownListFilter.classList.add('hidden');
    
    // Show the form again
    filterFormContainer.classList.remove('hidden');
    cancelFilterContainer.classList.add('hidden');
    
    // Clear table
    changesTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
          <span class="text-lg font-medium">Please apply filter to view results</span>
        </td>
      </tr>`;
  });

  // Pagination functions
  function updatePaginationControls() {
    const totalPages = Math.ceil(filteredData.length / RECORDS_PER_PAGE);
    const start = (currentPage - 1) * RECORDS_PER_PAGE + 1;
    const end = Math.min(currentPage * RECORDS_PER_PAGE, filteredData.length);

    showingStart.textContent = filteredData.length > 0 ? start : 0;
    showingEnd.textContent = end;
    totalRecords.textContent = filteredData.length;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;

    firstPageBtn.disabled = currentPage === 1;
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage >= totalPages;
    lastPageBtn.disabled = currentPage >= totalPages;
  }

  function goToPage(page) {
    const totalPages = Math.ceil(filteredData.length / RECORDS_PER_PAGE);
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    currentPage = page;
    renderTable(getPaginatedData());
    updatePaginationControls();
  }

  function getPaginatedData() {
    const start = (currentPage - 1) * RECORDS_PER_PAGE;
    const end = start + RECORDS_PER_PAGE;
    return filteredData.slice(start, end);
  }

  // Pagination event listeners
  firstPageBtn.addEventListener('click', () => goToPage(1));
  prevPageBtn.addEventListener('click', () => goToPage(currentPage - 1));
  nextPageBtn.addEventListener('click', () => goToPage(currentPage + 1));
  lastPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredData.length / RECORDS_PER_PAGE);
    goToPage(totalPages);
  });

  // Render Table
  function renderTable(changes) {
    changesTableBody.innerHTML = '';
    if (!changes || changes.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
      <td colspan="5" class="px-6 py-8 text-center text-gray-500">
        <i class="fas fa-inbox text-4xl mb-2"></i>
        <br>No changes found for the selected filter
      </td>`;
      changesTableBody.appendChild(row);
      return;
    }

    changes.forEach(change => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-blue-50 transition';
      const risk = (change.risk_level || '').toUpperCase();
      const riskColor = risk === 'HIGH' ? 'red' : risk === 'MEDIUM' ? 'yellow' : 'green';
      const riskIcon = risk === 'HIGH' ? 'exclamation-triangle' : risk === 'MEDIUM' ? 'exclamation-circle' : 'check-circle';
      row.innerHTML = `
      <td class="border px-2 py-3 text-left">${change.Empl_ID}</td>
      <td class="border px-2 py-3 text-left">${change.full_name || change.FullName || 'N/A'}</td>
      <td class="border px-2 py-3 text-left">${change.Location || 'N/A'}</td>
      <td class="border px-2 py-3 text-left">
        <span class="inline-flex items-center px-3 py-1 text-xs font-bold rounded-full bg-${riskColor}-100 text-${riskColor}-800">
          <i class="fas fa-${riskIcon} mr-1"></i>${risk || 'N/A'}
        </span>
      </td>
      <td class="border px-2 py-3 text-left text-sm no-print">
        <button class="text-blue-600 hover:text-blue-800 font-semibold transition" data-id="${change.Empl_ID}">
          <i class="fas fa-eye mr-1"></i>View
        </button>
      </td>`;
      changesTableBody.appendChild(row);
      const btn = row.querySelector('button[data-id]');
      if (btn) btn.addEventListener('click', () => showDetails(String(change.Empl_ID)));
    });
    
    updatePaginationControls();
  }

  // Filter and Render
  function filterAndRenderData() {
    if (!allChangesData) return;
    let filtered = (allChangesData.changes || []).slice();

    if (currentMode === 'highRisk') {
      filtered = filtered.filter(c => (c.risk_level||'').toUpperCase() === 'HIGH');
    } else if (currentMode === 'newEmployee') {
      filtered = filtered.filter(c => (c.change_category||'').toUpperCase() === 'NEW_EMPLOYEE');
    } else if (currentMode === 'personnel' && selectedEmployee) {
      filtered = filtered.filter(c => String(c.Empl_ID) === String(selectedEmployee));
    } else if (currentMode === 'byDate') {
      const start = startPeriodFilter.value ? new Date(startPeriodFilter.value) : null;
      const end = endPeriodFilter.value ? new Date(endPeriodFilter.value) : null;
      if (start || end) {
        filtered = filtered.filter(c => {
          const d = c.detected_at ? new Date(c.detected_at) : null;
          if (!d) return false;
          if (start && end) return d >= start && d <= end;
          if (start) return d >= start;
          if (end) return d <= end;
          return true;
        });
      }
    }

    filteredData = filtered;
    currentPage = 1;
    renderTable(getPaginatedData());
  }

  // Show Details modal
  window.showDetails = function (emplId) {
      if (!allChangesData) return;

      const change = (allChangesData.changes || []).find(
          (c) => String(c.Empl_ID) === String(emplId)
      );

      if (!change) return;

      const current = change.current_values || {};
      const previous = change.previous_values || {};

      modalContent.innerHTML = `
        <div class="space-y-8 p-6">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-b border-gray-200 pb-6">
            
            <div class="p-0">
              <h4 class="font-extrabold text-xl text-gray-800 mb-4 flex items-center">
                <i class="fas fa-id-card mr-2 text-blue-600"></i>Employee Record
              </h4>
              <div class="text-sm space-y-2 text-gray-700 p-4 rounded-lg border border-gray-200 shadow-sm">
                  <p class="font-bold"><span class="font-semibold w-20 inline-block">ID:</span> ${change.Empl_ID}</p>
                  <p class="font-bold"><span class="font-semibold w-20 inline-block">Name:</span> ${change.full_name}</p>
                  <p class="font-bold"><span class="font-semibold w-20 inline-block">Location:</span> ${change.Location || 'N/A'}</p>
              </div>
            </div>

            <div class="p-0">
              <h4 class="font-extrabold text-xl text-gray-800 mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-indigo-600"></i>Change Summary
              </h4>
              <div class="text-sm space-y-2 text-gray-700 p-4 rounded-lg border border-gray-200 shadow-sm">
                  <p class="font-bold"><span class="font-semibold w-24 inline-block">Category:</span> ${change.change_category}</p>
                  <p class="font-bold"><span class="font-semibold w-24 inline-block">Risk Level:</span> <span class="font-bold text-red-600">${change.risk_level}</span></p>
                  <p class="font-bold"><span class="font-semibold w-24 inline-block">Description:</span> ${change.change_summary || 'N/A'}</p>
              </div>
            </div>
          </div>

          <div class="pt-2">
            <h4 class="font-extrabold text-gray-800 mb-5 text-xl flex items-center border-b pb-2">
              <i class="fas fa-exchange-alt mr-2 text-gray-600"></i>Field-by-Field Changes
            </h4>
            <div class="space-y-3">
              ${Object.keys(current)
                .map((key) => {
                  if (String(current[key]) !== String(previous[key])) {
                    return `
                    <div class="grid grid-cols-2 items-start py-1 border-b border-gray-200 hover:bg-white transition-colors">
                      <span class="font-bold text-sm text-gray-700 uppercase p-2">
                        ${key.replace(/_/g, ' ')}:
                      </span>
                      <div class="text-sm flex items-center justify-end space-x-4 p-2">
                        <span class="text-red-600 line-through font-medium whitespace-nowrap">
                          ${previous[key] || 'N/A'}
                        </span>                        
                        <i class="fas fa-arrow-right text-gray-400"></i>                        
                        <span class="text-green-600 font-bold whitespace-nowrap">
                          ${current[key] || 'N/A'}
                        </span>
                      </div>
                    </div>
                  `;
                  }
                  return '';
                })
                .join('')}
            </div>
          </div>
        </div>`;

      detailsModal.classList.remove('hidden');
  };
  
  // Export handlers - exports based on current filter
  exportExcelBtn.addEventListener('click', async () => {
    if (!allChangesData) return showAlert('Export Failed', 'No data to export', 'error');
    try {
      const token = localStorage.getItem('token');
      const dataToExport = currentMode === 'all' ? allChangesData : { ...allChangesData, changes: filteredData };
      const res = await fetch(`${API_BASE}/excel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(dataToExport)
      });
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `personnel_changes_${currentMode}_${new Date().toISOString().split('T')[0]}.xlsx`; 
      a.click();
      showAlert('Success!', 'Excel file downloaded successfully', 'success');
    } catch (err) {
      showAlert('Export Failed', 'Excel export failed: ' + err.message, 'error');
    }
  });

  exportPdfBtn.addEventListener('click', async () => {
    if (!allChangesData) return showAlert('Export Failed', 'No data to export', 'error');
    try {
      const token = localStorage.getItem('token');
      const dataToExport = currentMode === 'all' ? allChangesData : { ...allChangesData, changes: filteredData };
      const res = await fetch(`${API_BASE}/pdf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(dataToExport)
      });
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `personnel_changes_${currentMode}_${new Date().toISOString().split('T')[0]}.pdf`; 
      a.click();
      showAlert('Success!', 'PDF file downloaded successfully', 'success');
    } catch (err) {
      showAlert('Export Failed', 'PDF export failed: ' + err.message, 'error');
    }
  });

  printBtn.addEventListener('click', () => window.print());

  // Main: loadChanges
  async function loadChanges(isAutoLoad = false, isManualProcess = false) {
    let endpoint = `${API_BASE}`;
    let method = 'GET';
    let showProgress = false;
    let progressLabel = 'Fetching personnel changes...';

    if (currentPayrollStage === STAGE_CLOSED && isManualProcess) {
      endpoint = `${API_BASE}/process`;
      method = 'POST';
      showProgress = true;
      progressLabel = 'Processing personnel changes...';
    }

    if (currentPayrollStage >= STAGE_CHANGES_READY) {
      endpoint = `${API_BASE}`;
      method = 'GET';
      showProgress = false;
      progressLabel = 'Loading processed personnel changes...';
    }

    if (!isAutoLoad && !showProgress && currentPayrollStage < STAGE_CHANGES_READY && currentPayrollStage !== STAGE_CLOSED) {
      return showAlert('Not Ready', 'Please ensure payroll files are saved and wait for processing.', 'warning');
    }

    try {
      const token = localStorage.getItem('token');

      if (showProgress) {
        progressModal.classList.remove('hidden');
        logContainer.innerHTML = '';
        progressMessage.textContent = progressLabel;
        addLog('Starting processing (POST) ...');
      }

      const res = await fetch(endpoint, {
        method,
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        const errJson = await res.json().catch(() => ({}));
        const msg = errJson.error || `HTTP ${res.status}`;
        if (showProgress) addLog(msg, 'error');
        throw new Error(msg);
      }

      const data = await res.json();

      if (showProgress && Array.isArray(data.logs)) {
        data.logs.forEach(l => addLog(l));
      }

      if (data.status === 'SUCCESS' || data.success === true) {
        allChangesData = data;
        hasLoadedOnce = true;

        updateSummaryCards(data.summary || data.meta || {});
        populateEmployeeDropdown();
        
        // Set filteredData to all changes initially
        filteredData = (data.changes || []).slice();
        currentPage = 1;
        renderTable(getPaginatedData());

        if (method === 'POST') {
          setTimeout(() => {
            progressModal.classList.add('hidden');
            showAlert('Success', 'Personnel changes processed and loaded.', 'success');
            updateUIVisibility();
          }, 800);
        } else {
          if (showProgress) progressModal.classList.add('hidden');
          updateUIVisibility();
          //showAlert('Success', 'Personnel changes loaded successfully', 'success');
        }
      } else {
        const message = data.error || data.message || 'Failed to load/process changes';
        if (showProgress) addLog(message, 'error');
        throw new Error(message);
      }
    } catch (err) {
      if (showProgress) addLog(err.message || 'Unknown error', 'error');
      setTimeout(() => {
        progressModal.classList.add('hidden');
        showAlert('Error', err.message || 'Unknown error', 'error');
      }, 400);
    }
  }

  // Update summary cards
  function updateSummaryCards(summary) {
    document.getElementById('totalChanges').textContent = (summary.totalChanges || summary.total || 0);
    document.getElementById('highRiskCount').textContent = (summary.byRisk && summary.byRisk.high) || (summary.highRisk || 0);
    document.getElementById('mediumRiskCount').textContent = (summary.byRisk && summary.byRisk.medium) || (summary.mediumRisk || 0);
    document.getElementById('bankChangesCount').textContent = (summary.byCategory && summary.byCategory.bankChanged) || (summary.bankChanges || 0);
  }

  // Event listeners
  loadBtn.addEventListener('click', () => {
    if (currentPayrollStage === STAGE_CLOSED) {
      loadChanges(false, true);
    } else {
      loadChanges(false, false);
    }
  });

  allToggle.addEventListener('click', () => switchMode('all'));
  personnelToggle.addEventListener('click', () => switchMode('personnel'));
  highRiskToggle.addEventListener('click', () => switchMode('highRisk'));
  newEmpToggle.addEventListener('click', () => switchMode('newEmployee'));
  byDateToggle.addEventListener('click', () => switchMode('byDate'));
  closeModal.addEventListener('click', () => detailsModal.classList.add('hidden'));
  alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

  // Payroll status checking
  async function checkPayrollStatus(attemptAutoLoad = false) {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch('/status-payroll', { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      currentPayrollStage = Number(data?.sun || STAGE_DATA_ENTRY_OPEN);
      updateUIVisibility();

      if (attemptAutoLoad && currentPayrollStage >= STAGE_CHANGES_READY && !hasLoadedOnce) {
        await loadChanges(true, false);
      }

      return data;
    } catch (err) {
      console.error('Error checking payroll status:', err);
      return null;
    }
  }

  window.addEventListener('payrollStatusChanged', function (event) {
    if (event.detail && typeof event.detail.stage === 'number') {
      currentPayrollStage = event.detail.stage;
      if (currentPayrollStage === STAGE_DATA_ENTRY_OPEN) {
        hasLoadedOnce = false;
        allChangesData = null;
        allEmployees = [];
        selectedEmployee = null;
        filteredData = [];
        currentPage = 1;
        filterApplied = false;
      }
      updateUIVisibility();
      if (currentPayrollStage >= STAGE_CHANGES_READY && !hasLoadedOnce) loadChanges(true, false);
    } else {
      checkPayrollStatus(true);
    }
  });

  window.refreshPersonnelChangesUI = function () { checkPayrollStatus(true); };

  function initialize() {
    switchMode('all');
    checkPayrollStatus(true);
  }

  document.addEventListener('DOMContentLoaded', initialize);
  if (document.readyState !== 'loading') initialize();
})();
</script>