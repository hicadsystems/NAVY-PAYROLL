<!-- TABS -->
<div class="p-6">
  <div class="flex flex-wrap justify-between bg-white/50 rounded-xl border border-amber-50 shadow-sm p-2 gap-2">
    <div class="flex flex-wrap justify-start gap-2">
      <button type="button" id="tab-batch" class="px-4 py-2 rounded-md bg-yellow-400 text-grey hover:bg-blue-600">
        Batch Upload
      </button>
    </div>
    <div class="flex flex-wrap justify-end gap-2">
      <button id="tab-personnel" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-600">Personnel</button>
      <button id="tab-nok" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">NOK</button>
      <button id="tab-spouse" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">Spouse</button>
      <button id="tab-children" class="px-4 py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600">Children</button>
    </div>
  </div>
</div>

<!-- BATCH UPLOAD SECTION -->
<div id="section-batch" class="p-6 flex justify-center">
  <div class="w-full max-w-lg rounded-2xl p-6">
    <h3 class="text-2xl font-bold text-blue-800 mb-4">Batch Upload</h3>
    
    <form id="batchUploadForm" class="space-y-6">
      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
        <input type="file" id="batchFile" 
               class="mt-1 block w-full border border-blue-500 bg-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
        <p class="text-xs text-gray-500 mt-2">
          Only .xlsx or .csv files allowed. 
          <a href="sample.csv" download 
             class="text-blue-600 hover:underline ml-2">Download Sample</a>
        </p>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancelBatchBtn"
          class="px-6 py-2 bg-gray-400 hover:bg-gray-500 rounded-lg text-white">Cancel</button>
        <button type="button" id="uploadBatchBtn"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="uploadSuccessPopup" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-96 text-center">
    <h4 class="text-xl font-semibold text-green-600 mb-2">Upload Successful!</h4>
    <p class="text-gray-600 mb-4">Your batch file has been uploaded successfully.</p>
    <button id="closePopupBtn" 
      class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Close</button>
  </div>
</div>

<!-- PERSONNEL SECTION -->
<div id="section-personnel" class="px-6 mb-4">
  <!-- Title -->
  <h3 id="formTitle" class="hidden text-2xl font-bold text-blue-800 mb-4"></h3>

  <!-- Step Buttons + Current Personnel -->
  <div class="flex flex-wrap items-center gap-2 justify-between mb-4">
    <div class=" flex flex-wrap gap-2 items-center">
      <button id="btnStep1" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-blue-600 hover:bg-blue-600 text-white transition-all overflow-hidden group">
        <span class="relative z-10">Step 1: Basic Details</span>
      </button>
      <button id="btnStep2" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600 transition-all overflow-hidden group">
        <span class="relative z-10">Step 2: Official Info</span>
      </button>
      <button id="btnStep3" class="relative px-4 text-sm lg:text-lg py-2 rounded-md bg-yellow-400 text-gray-900 hover:bg-blue-600 transition-all overflow-hidden group">
        <span class="relative z-10">Step 3: Additional Info</span>
      </button>
    </div>

    <button onclick="window.navigation?.navigateToSection ? window.navigation.navigateToSection('current-personnel','Current Personnel') : alert('Hook your navigation here.')"
      class="px-4 text-sm lg:text-lg py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
      Current Personnel
    </button>
  </div>

  <!-- Form -->
  <form id="personnelForm" class="space-y-6">
    <!-- Step 1 (dynamic, with labels) -->
    <div id="step1" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- Step 2 (static, with labels) -->
    <div id="step2" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Joined</label>
        <input type="date" name="DateEmpl" id="DateEmpl" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Commissioned</label>
        <input type="date" name="dateconfirmed" id="dateconfirmed" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Entry Mode</label>
        <input type="text" name="entry_mode" id="entry_mode" placeholder="Entry Mode" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Left</label>
        <input type="date" name="DateLeft" id="DateLeft" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Exit Mode</label>
        <select id="exittype" name="exittype" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Exit Mode</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Taxed ?</label>
        <select name="taxed" id="taxed" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">TaxID No(TIN)</label>
        <input type="text" name="TaxCode" id="TaxCode" placeholder="TaxID N0" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Tax State</label>
        <select id="state" name="state" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Tax State</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">RSA(Pension) Code</label>
        <input type="text" name="NSITFcode" id="NSITFcode" placeholder="RSA(Pension) Code" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Pension Fund Administrator</label>
        <select id="pfa" name="pfacode" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Administrator</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Payroll Process Category</label>
        <select id="payrollProcess" name="payrollclass" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Payroll Process</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Salary Group</label>
        <select id="salarygroup" name="gradetype" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Salary Group</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Salary Grade</label>
        <select id="salarygrade" name="gradelevel" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Salary Grade</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Bank Branch</label>
        <select id="bankbranch" name="bankbranch" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Bank Branch</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Account Number</label>
        <input type="text" name="BankACNumber" id="BankACNumber" placeholder="Account Number" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
    </div>

    <!-- Step 3 (static, with labels) -->
    <div id="step3" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Senority Date</label>
        <input type="date" name="datepmted" id="datepmted" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Ship/Establishment</label>
        <select name="Location" id="step3-ship" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>select</option>
          <option value="SHIP">Ship</option>
          <option value="ESTABLISHMENT">Establishment</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Branch</label>
        <select id="branch" name="Factory" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Branch</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Command</label>
        <select id="command" name="command" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Command</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Specialisation</label>
        <select id="specialisation" name="specialisation" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Specialisation</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Present Appointment</label>
        <input type="text" name="Jobtitle" id="Jobtitle" placeholder="Present Appointment" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Award/Decoration</label>
        <input type="text" name="award" id="award" placeholder="Award/Decoration" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Emolument Form Received?</label>
        <select name="emolumentform" id="emolumentform" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">NHF Code</label>
        <input type="text" name="NHFcode" id="NHFcode" placeholder="NHF Code" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Bank Code</label>
        <select id="bankcode" name="Bankcode" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Bank Code</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">IPPIS NO</label>
        <input type="text" name="InternalACNo" id="InternalACNo" placeholder="IPPIS NO" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Country</label>
        <select id="country" name="Country" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Country</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Accommodation Type</label>
        <select name="accomm_type" id="accomm_type" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select Accommodation Type</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Rent Subsidy</label>
        <select name="rent_subsidy" id="rent_subsidy" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Select</option>
        </select>
      </div>
    </div>

    <!-- Actions -->
    <div class="col-span-full flex justify-end space-x-4 pt-4">
      <button type="button" id="cancelBtn" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 rounded-lg text-white">Cancel</button>
      <button type="button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Submit</button>
    </div>
  </form>
</div>

<!-- NOK SECTION -->
<div id="section-nok" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Next of Kin</h3>
    <button id="nokToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <!-- Form -->
  <div id="nokFormWrap" class="hidden">
    <form id="nokForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
        <input id="nokFirst" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
        <input id="nokLast" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
        <input id="nokDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Address <span class="text-red-500">*</span></label>
        <input id="nokAddress" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Relationship <span class="text-red-500">*</span></label>
        <select id="nokRelationship" required class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="">Select</option>
          <option>Spouse</option><option>Father</option><option>Mother</option>
          <option>Son</option><option>Daughter</option><option>Brother</option>
          <option>Sister</option><option>Uncle</option><option>Aunt</option><option>Friend</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Mobile Number <span class="text-red-500">*</span></label>
        <input id="nokMobile" required type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Home Number</label>
        <input id="nokHome" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
        <input id="nokEmail" required type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Place Of Work</label>
        <input id="nokWork" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Next Of Kin Type</label>
        <select id="nokType" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option>Main</option><option>Alternate</option>
        </select>
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="nokCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="nokSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <!-- List -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Name</th>
          <th class="py-2 px-3 border">Relationship</th>
          <th class="py-2 px-3 border">Mobile</th>
          <th class="py-2 px-3 border">Email</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="nokList" class="text-center">
        <tr id="nokEmpty"><td colspan="4" class="py-4 text-gray-500">No NOKs yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- SPOUSE SECTION -->
<div id="section-spouse" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Spouse</h3>
    <button id="spouseToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <div id="spouseFormWrap" class="hidden">
    <form id="spouseForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name <span class="text-red-500">*</span></label>
        <input id="spouseName" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date Of Birth</label>
        <input id="spouseDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Married</label>
        <input id="spouseDom" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Street</label>
        <input id="spouseStreet" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Town</label>
        <input id="spouseTown" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">State</label>
        <select id="spouseState" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select State</option>
          <!--options would be populated dynamically-->
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Local Government</label>
        <select id="spouseLga" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select LGA</option>
           <!--options would be populated dynamically-->
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input id="spousePhone" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="spouseEmail" type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">P.O Box</label>
        <input id="spousePoBox" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="spouseCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="spouseSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Full Name</th>
          <th class="py-2 px-3 border">Phone</th>
          <th class="py-2 px-3 border">Email</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="spouseList" class="text-center">
        <tr id="spouseEmpty"><td colspan="3" class="py-4 text-gray-500">No spouse records yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CHILDREN SECTION -->
<div id="section-children" class="hidden p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-bold text-blue-800">Children</h3>
    <button id="childToggleBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">+ Add</button>
  </div>

  <div id="childFormWrap" class="hidden">
    <form id="childForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name <span class="text-red-500">*</span></label>
        <input id="childName" required type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Street</label>
        <input id="childStreet" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Town</label>
        <input id="childTown" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">State</label>
        <select id="childState" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select State</option>
          <!--options would be populated dynamically-->
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Local Government</label>
        <select id="childLga" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select LGA</option>
          <!--options would be populated dynamically-->
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input id="childPhone" type="tel" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="childEmail" type="email" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">P.O Box</label>
        <input id="childPoBox" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Sex</label>
        <select id="childSex" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none">
          <option value="">Select</option><option>Male</option><option>Female</option><option>Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
        <input id="childDob" type="date" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">School</label>
        <input id="childSchool" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Office Address</label>
        <input id="childOffice" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
      <div >
        <label class="block text-sm font-medium text-gray-700">Occupation</label>
        <input id="childOccupation" type="text" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-transparent focus:ring-2 focus:ring-yellow-500 focus:outline-none" />
      </div>
    </form>
    <div class="flex justify-end gap-3 mb-6">
      <button id="childCancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="childSave" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="py-2 px-3 border">Full Name</th>
          <th class="py-2 px-3 border">Sex</th>
          <th class="py-2 px-3 border">DOB</th>
          <th class="py-2 px-3 border">Phone</th>
          <th class="py-2 px-3 border">Actions</th>
        </tr>
      </thead>
      <tbody id="childList" class="text-center">
        <tr id="childEmpty"><td colspan="4" class="py-4 text-gray-500">No children yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Action Popup -->
<div id="actionPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-64">
    <div id="popupIcon" class="mx-auto h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
    <p id="popupText" class="mt-4 text-lg font-semibold text-gray-700">Processing...</p>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-xl w-96 p-6">
    <h3 class="text-xl font-semibold text-red-600 mb-4">Confirm Delete</h3>
    <p class="text-gray-700 mb-6">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-3">
      <button id="deleteCancelBtn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="deleteConfirmBtn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
// Complete Personnel Management Script
const API_BASE = '/personnel';
const API_HEADERS = {
  'Content-Type': 'application/json',
  'Authorization': `Bearer ${localStorage.getItem('token')}`
};

// Database Field Mapping - ALL STEPS
const DB_FIELD_MAP = {
  // Step 1
  'Service Number': 'Empl_ID',
  'Rank': 'Title',
  'Surname': 'Surname',
  'OtherName': 'OtherName',
  'Date of Birth': 'Birthdate',
  'State Of Origin': 'StateofOrigin',
  'Local Government': 'LocalGovt',
  'Town': 'town',
  'Residential Address': 'HOMEADDR',
  'Email Address': 'email',
  'GSM Number': 'gsm_number',
  'Sex': 'Sex',
  'Marital Status': 'MaritalStatus',
  'Religion': 'religion',
  'Passport Photograph': 'passport',

  // Step 2
  'DateEmpl': 'DateEmpl',
  'dateconfirmed': 'dateconfirmed',
  'entry_mode': 'entry_mode',
  'DateLeft': 'DateLeft',
  'exittype': 'exittype',
  'taxed': 'taxed',
  'TaxCode': 'TaxCode',
  'state': 'state',
  'NSITFcode': 'NSITFcode',
  'pfacode': 'pfacode',
  'payrollclass': 'payrollclass',
  'gradelevel': 'gradelevel',
  'gradetype': 'gradetype',
  'bankbranch': 'bankbranch',
  'BankACNumber': 'BankACNumber',

  // Step 3
  'datepmted': 'datepmted',
  'Location': 'Location',
  'Factory': 'Factory',
  'command': 'command',
  'specialisation': 'specialisation',
  'Jobtitle': 'Jobtitle',
  'award': 'award',
  'emolumentform': 'emolumentform',
  'NHFcode': 'NHFcode',
  'Bankcode': 'Bankcode',
  'InternalACNo': 'InternalACNo',
  'Country': 'Country',
  'accomm_type': 'accomm_type',
  'rent_subsidy': 'rent_subsidy'
};

// Dropdown Configuration
const dropdownConfig = {
  "Sex": { endpoint: "sex", value: "sex_code", text: "sex_desc" },
  "Marital Status": { endpoint: "marital", value: "MaritalCode", text: "MaritalStatus" },
  "State Of Origin": { endpoint: "state", value: "Statecode", text: "Statename" },
  "Local Government": { endpoint: "lga", value: "Lgcode", text: "Lgname" },
  "Rank": { endpoint: "title", value: "Titlecode", text: "Description" },
  "Religion": { endpoint: "religion", value: "ReligionCode", text: "ReligionName" }
};

async function loadDropdown(endpoint, elementId, valueField, textField, placeholder) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/reference/${endpoint}`, {   
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }
    });
    const data = await response.json();
    const dropdown = document.getElementById(elementId);
    if (!dropdown) return;
    dropdown.innerHTML = `<option value="">${placeholder}</option>`;
    data.forEach(item => {
      const option = document.createElement("option");
      option.value = item[valueField];
      option.textContent = item[textField];
      dropdown.appendChild(option);
    });
    return data;
  } catch (err) {
    console.error(`Failed to load ${endpoint}:`, err);
    return [];
  }
}

async function initializeDropdowns() {
  const promises = Object.keys(dropdownConfig).map(field => {
    const cfg = dropdownConfig[field];
    const elementId = `field-${field.replace(/\s+/g, '-').toLowerCase()}`;
    return loadDropdown(cfg.endpoint, elementId, cfg.value, cfg.text, `Select ${field}`);
  });
  await Promise.all(promises);
}

async function loadAllDropdowns() {
  const promises = [
    loadDropdown("bankbranch", "bankbranch", "branchname", "branchname", "Select Bank Branch"),
    loadDropdown("bankcode", "bankcode", "bankcode", "bankcode", "Select Bank Code"),
    loadDropdown("state", "state", "Statecode", "Statename", "Select State"),
    loadDropdown("country", "country", "countrycode", "Countryname", "Select Country"),
    loadDropdown("command", "command", "navalcmd", "name", "Select Command"),
    loadDropdown("pfa", "pfa", "pfacode", "pfadesc", "Select PFA"),
    loadDropdown("salarygroup", "salarygroup", "groupcode", "grpdesc", "Select Salary Group"),
    loadDropdown("salarygrade", "salarygrade", "grade_no", "grade_desc", "Select Salary Grade"),
    loadDropdown("exittype", "exittype", "Name", "Description", "Select Exit Type"),
    loadDropdown("specialisation", "specialisation", "sp_desc", "sp_desc", "Select Specialisation"),
    //loadDropdown("branch", "branch", "branchcode", "branchname", "Select Branch"),
    //loadDropdown("payrollProcess", "payrollProcess", "payroll_code", "payroll_desc", "Select Payroll Process")

    //spouse and child state/lga dropdowns would be populated dynamically based on selection
    loadDropdown("state", "spouseState", "Statecode", "Statename", "Select State"),
    loadDropdown("state", "childState", "Statecode", "Statename", "Select State"),
    loadDropdown("lga", "spouseLga", "Lgcode", "Lgname", "Select LGA"),
    loadDropdown("lga", "childLga", "Lgcode", "Lgname", "Select LGA")
  ];
  await Promise.all(promises);
}

// Format date from ddmmyyyy to yyyy-mm-dd (for displaying in date inputs)
function formatDateForDisplay(ddmmyyyyDate) {
  if (!ddmmyyyyDate || ddmmyyyyDate.length !== 8) {
    return '';
  }
  
  const day = ddmmyyyyDate.substring(0, 2);
  const month = ddmmyyyyDate.substring(2, 4);
  const year = ddmmyyyyDate.substring(4, 8);
  
  return `${year}-${month}-${day}`;
}

// Format date from ddmmyyyy to readable format (e.g., "15 Mar 2024")
function formatDateReadable(ddmmyyyyDate) {
  if (!ddmmyyyyDate || ddmmyyyyDate.length !== 8) {
    return '';
  }
  
  const day = ddmmyyyyDate.substring(0, 2);
  const month = ddmmyyyyDate.substring(2, 4);
  const year = ddmmyyyyDate.substring(4, 8);
  
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  return `${day} ${monthNames[parseInt(month) - 1]} ${year}`;
}

// Format ISO datetime (2010-10-02T00:00:00.000Z) to yyyy-mm-dd (for date inputs)
function formatISODateForDisplay(isoDate) {
  if (!isoDate) {
    return '';
  }
  
  try {
    const date = new Date(isoDate);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
  } catch (error) {
    console.error('Invalid ISO date:', isoDate);
    return '';
  }
}

// Format ISO datetime (2010-10-02T00:00:00.000Z) to readable format (e.g., "02 Oct 2010")
function formatISODateReadable(isoDate) {
  if (!isoDate) {
    return '';
  }
  
  try {
    const date = new Date(isoDate);
    const day = String(date.getDate()).padStart(2, '0');
    const month = date.getMonth();
    const year = date.getFullYear();
    
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    return `${day} ${monthNames[month]} ${year}`;
  } catch (error) {
    console.error('Invalid ISO date:', isoDate);
    return '';
  }
}

// Format ISO datetime with time (2010-10-02T00:00:00.000Z) to readable format with time
function formatISODateTimeReadable(isoDate) {
  if (!isoDate) {
    return '';
  }
  
  try {
    const date = new Date(isoDate);
    const day = String(date.getDate()).padStart(2, '0');
    const month = date.getMonth();
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    return `${day} ${monthNames[month]} ${year} ${hours}:${minutes}`;
  } catch (error) {
    console.error('Invalid ISO date:', isoDate);
    return '';
  }
}

// Global state
let formMode = 'create';
let currentEmployeeId = localStorage.getItem('editing_employee');
let editingEmployeeData = null;
let pendingFamilyData = { nok: [], spouse: [], children: [] };
let nokCounter = 0;
let spouseCounter = 0;
let childCounter = 0;
const editState = { type: null, id: null, row: null };

// Modify window load event handler
window.addEventListener('load', async () => {
  const editingId = localStorage.getItem('editing_employee');
  if (editingId) {
    console.log('Resuming edit for employee:', editingId);
    await loadEmployeeDataForEdit(editingId);
  }
});

// Helper functions
function val(id) { 
  return (document.getElementById(id)?.value || '').trim(); 
}

function escapeHtml(s) { 
  return String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
  }[m])); 
}

function toggleBlock(el, btn) {
  const isHidden = el.classList.contains('hidden');
  el.classList.toggle('hidden');
  btn.textContent = isHidden ? 'âˆ’' : '+ Add';
}

function showPopup(message, callback) {
  const popup = document.getElementById('actionPopup');
  const icon = document.getElementById('popupIcon');
  const text = document.getElementById('popupText');

  icon.className = "mx-auto h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin";
  text.textContent = message;
  popup.classList.remove('hidden');

  setTimeout(() => {
    icon.className = "mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-green-500 text-white";
    icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                      </svg>`;
    text.textContent = "Success!";
    setTimeout(() => {
      popup.classList.add('hidden');
      icon.innerHTML = "";
      if (callback) callback();
    }, 1000);
  }, 1500);
}

function showError(message) {
  alert(`Error: ${message}`);
}

// API Helper
async function apiRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      ...options,
      headers: { ...API_HEADERS, ...options.headers }
    });
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || `HTTP ${response.status}`);
    }
    return data;
  } catch (error) {
    console.error('API Request failed:', error);
    showError(error.message);
    throw error;
  }
}

function validatePersonnelForm() {
  const requiredFields = [
    { id: 'field-service-number', label: 'Service Number' },
    { id: 'field-surname', label: 'Surname' },
    { id: 'field-othername', label: 'Other Name' }
  ];
  
  const missingFields = [];
  
  requiredFields.forEach(({ id, label }) => {
    const element = document.getElementById(id);
    if (element && !element.value.trim()) {
      missingFields.push(label);
    }
  });
  
  if (missingFields.length > 0) {
    alert(`Please fill in the following required fields:\n${missingFields.join('\n')}`);
    return false;
  }
  
  return true;
}

async function submitPersonnelFormWithValidation() {
  if (!validatePersonnelForm()) return;
  await submitPersonnelForm();
}

function cancelPersonnelForm() {
  try {
    // 1. Check if in edit mode and show confirmation
    if (formMode === 'edit') {
      const confirmed = confirm('Are you sure you want to cancel editing? Any unsaved changes will be lost.');
      if (!confirmed) return;

      // Clear editing state
      localStorage.removeItem('editing_employee');
      setCreateMode();
    }

    // 2. Reset all form data
    document.getElementById("personnelForm")?.reset();

    // 3. Clear all family data
    pendingFamilyData = { nok: [], spouse: [], children: [] };
    clearAllFamilyTables();

    // 4. Reset form UI
    toggleStep(1);
    
    // 5. Reset form title
    const formTitle = document.getElementById('formTitle');
    if (formTitle) {
      formTitle.textContent = 'Add New Personnel';
      formTitle.classList.add('hidden');
    }

    // 6. Reset any file inputs and avatar previews
    const passportInput = document.querySelector('input[name="Passport Photograph"]');
    if (passportInput) {
      passportInput.value = '';
      passportInput.style.display = '';
      const avatarContainer = document.querySelector('.passport-avatar-container');
      if (avatarContainer) {
        avatarContainer.remove();
      }
    }

    // 7. Reset edit state
    editState.type = null;
    editState.row = null;
    editState.id = null;

    // 8. Navigate back if came from current personnel
    const navigatedFromCurrent = localStorage.getItem('navigatedFromCurrentPersonnel') === 'true';
    if (navigatedFromCurrent) {
      localStorage.removeItem('navigatedFromCurrentPersonnel');
      if (window.navigation?.navigateToSection) {
        window.navigation.navigateToSection('current-personnel', 'Current Personnel');
      }
    }

  } catch (error) {
    console.error('Error in cancelPersonnelForm:', error);
    showError('Failed to cancel form properly');
  }
}

function clearAllFamilyTables() {
  const tables = [
    { listId: 'nokList', emptyId: 'nokEmpty', colspan: '5', message: 'No NOKs yet.' },
    { listId: 'spouseList', emptyId: 'spouseEmpty', colspan: '4', message: 'No spouse records yet.' },
    { listId: 'childList', emptyId: 'childEmpty', colspan: '5', message: 'No children yet.' }
  ];
  
  tables.forEach(({ listId, emptyId, colspan, message }) => {
    const list = document.getElementById(listId);
    if (list) {
      list.innerHTML = `<tr id="${emptyId}"><td colspan="${colspan}" class="py-4 text-gray-500">${message}</td></tr>`;
    }
  });
}

// Batch Upload
const uploadBtn = document.getElementById("uploadBatchBtn");
const popup = document.getElementById("uploadSuccessPopup");
const closePopupBtn = document.getElementById("closePopupBtn");
const cancelBatchBtn = document.getElementById("cancelBatchBtn");

uploadBtn?.addEventListener("click", async () => {
  const fileInput = document.getElementById("batchFile");
  if (!fileInput.files.length) {
    alert("Please select a file to upload!");
    return;
  }

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);

  uploadBtn.innerText = "Uploading...";
  uploadBtn.disabled = true;
  
  try {
    const response = await fetch(`${API_BASE}/batch-upload`, {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Upload failed');
    }
    
    popup.classList.remove("hidden");
  } catch (error) {
    showError(error.message);
  } finally {
    uploadBtn.innerText = "Upload";
    uploadBtn.disabled = false;
  }
});

closePopupBtn?.addEventListener("click", () => {
  popup.classList.add("hidden");
  document.getElementById("batchUploadForm")?.reset();
});

cancelBatchBtn?.addEventListener("click", () => {
  document.getElementById("batchUploadForm")?.reset();
});

// Tab functionality
const tabs = ['personnel', 'nok', 'spouse', 'children', 'batch'];

function showTab(name) {
  tabs.forEach(t => {
    const tabBtn = document.getElementById('tab-' + t);
    const section = document.getElementById('section-' + t);
    
    if (tabBtn && section) {
      tabBtn.classList.remove('bg-blue-600', 'text-white');
      tabBtn.classList.add('bg-yellow-400', 'text-gray-900');
      section.classList.add('hidden');
    }
  });
  
  const activeTab = document.getElementById('tab-' + name);
  const activeSection = document.getElementById('section-' + name);
  
  if (activeTab && activeSection) {
    activeTab.classList.add('bg-blue-600', 'text-white');
    activeTab.classList.remove('bg-yellow-400', 'text-gray-900');
    activeSection.classList.remove('hidden');
  }
}

document.getElementById('tab-personnel')?.addEventListener('click', () => showTab('personnel'));
document.getElementById('tab-nok')?.addEventListener('click', () => showTab('nok'));
document.getElementById('tab-spouse')?.addEventListener('click', () => showTab('spouse'));
document.getElementById('tab-children')?.addEventListener('click', () => showTab('children'));
document.getElementById('tab-batch')?.addEventListener('click', () => showTab('batch'));

showTab('personnel');

// Personnel form
const fieldsStep1 = [
  "Service Number", "Rank", "Surname", "OtherName", "Date of Birth", "State Of Origin", "Local Government", "Town", "Residential Address", "Email Address", "GSM Number", "Sex", "Marital Status", "Religion", "Passport Photograph"
];

const step1Container = document.getElementById("step1");
const step2Container = document.getElementById("step2");
const step3Container = document.getElementById("step3");
const btnStep1 = document.getElementById("btnStep1");
const btnStep2 = document.getElementById("btnStep2");
const btnStep3 = document.getElementById("btnStep3");
const formTitleEl = document.getElementById("formTitle");
const personnelCancelBtn = document.getElementById("cancelBtn");

function controlWrap(label, control) {
  return `<div><label class="block text-sm font-medium text-gray-700">${label}</label>${control}</div>`;
}

function renderStep1() {
  if (!step1Container) return;
  
  step1Container.innerHTML = fieldsStep1.map(field => {
    const fieldId = `field-${field.replace(/\s+/g, '-').toLowerCase()}`;
    
    if (["Rank", "Religion", "State Of Origin", "Local Government", "Sex", "Marital Status"].includes(field)) {
      return controlWrap(field,
        `<select id="${fieldId}" name="${field}" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
           <option value="">Select ${field}</option>
         </select>`);
    }
    if (field === "Passport Photograph") {
      return controlWrap(field,
        `<input id="${fieldId}" name="${field}" type="file" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
    }
    if (field === "Date of Birth") {
      return controlWrap(field,
        `<input id="${fieldId}" name="${field}" type="date" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
    }
    return controlWrap(field,
      `<input id="${fieldId}" name="${field}" type="text" placeholder="${field}" class="w-full border border-blue-500 bg-transparent rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>`);
  }).join("");
}

function toggleStep(step) {
  const containers = [step1Container, step2Container, step3Container];
  const buttons = [btnStep1, btnStep2, btnStep3];
  
  containers.forEach((container, i) => {
    if (container) {
      container.classList.toggle('hidden', i !== step - 1);
    }
  });
  
  buttons.forEach((button, i) => {
    if (button) {
      if (i === step - 1) {
        button.classList.add("bg-blue-600", "text-white");
        button.classList.remove("bg-yellow-400", "text-gray-900");
      } else {
        button.classList.add("bg-yellow-400", "text-gray-900");
        button.classList.remove("bg-blue-600", "text-white");
      }
    }
  });
}

// Initialize
if (formTitleEl) formTitleEl.textContent = 'Add New Personnel';
renderStep1();
toggleStep(1);

initializeDropdowns();
loadAllDropdowns();


btnStep1?.addEventListener("click", () => toggleStep(1));
btnStep2?.addEventListener("click", () => toggleStep(2));
btnStep3?.addEventListener("click", () => toggleStep(3));
personnelCancelBtn?.addEventListener("click", cancelPersonnelForm);

const submitBtn = document.querySelector('#personnelForm button[type="button"]:last-child');
submitBtn?.addEventListener('click', submitPersonnelFormWithValidation);

function actionBtns(type, id) {
  return `
    <button onclick="viewFamilyRecord('${type}', ${id})" class="px-2 text-blue-600 hover:underline">View</button>
    <button onclick="editRow('${type}', ${id})" class="px-2 text-green-600 hover:underline">Edit</button>
    <button onclick="deleteRow(this, '${type}', ${id})" class="px-2 text-red-600 hover:underline">Delete</button>
  `;
}

// View Family Record Modal - FULL DATA
window.viewFamilyRecord = async function(type, id) {
  let data;
  
  if (formMode === 'create') {
    if (type === 'NOK') data = pendingFamilyData.nok.find(n => n._tempId === id);
    if (type === 'Spouse') data = pendingFamilyData.spouse.find(s => s._tempId === id);
    if (type === 'Child') data = pendingFamilyData.children.find(c => c._tempId === id);
  } else {
    try {
      let result;
      if (type === 'NOK') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.nextOfKin.find(n => n.nok_id == id);
      } else if (type === 'Spouse') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.spouse.find(s => s.spouse_id == id);
      } else if (type === 'Child') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.children.find(c => c.child_id == id);
      }
    } catch (error) {
      showError('Failed to load record details');
      return;
    }
  }
  
  if (!data) return;
  
  let content = '<div class="space-y-2 max-h-96 overflow-y-auto">';
  Object.entries(data).forEach(([key, value]) => {
    if (!key.startsWith('_') && !key.includes('id') && value) {
      const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      content += `<p><span class="font-medium text-gray-700">${displayKey}:</span> <span class="text-gray-900">${escapeHtml(String(value))}</span></p>`;
    }
  });
  content += '</div>';
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 w-[500px] max-h-[80vh] overflow-y-auto">
      <h3 class="text-lg font-semibold text-blue-800 mb-4">${type} Details</h3>
      ${content}
      <button onclick="this.closest('.fixed').remove()" 
              class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 w-full">
        Close
      </button>
    </div>
  `;
  document.body.appendChild(modal);
};

// Delete functionality
let deleteTargetRow = null;
let deleteTargetType = null;
let deleteTargetId = null;

window.deleteRow = function(btn, type, id) {
  deleteTargetRow = btn.closest('tr');
  deleteTargetType = type;
  deleteTargetId = id;
  document.getElementById('deleteModal').classList.remove('hidden');
};

document.getElementById('deleteCancelBtn').onclick = () => {
  deleteTargetRow = null;
  deleteTargetType = null;
  deleteTargetId = null;
  document.getElementById('deleteModal').classList.add('hidden');
};

document.getElementById('deleteConfirmBtn').onclick = async () => {
  if (!deleteTargetRow || !deleteTargetType || !deleteTargetId) {
    document.getElementById('deleteModal').classList.add('hidden');
    return;
  }

  try {
    if (formMode === 'create') {
      if (deleteTargetType === 'NOK') {
        pendingFamilyData.nok = pendingFamilyData.nok.filter(n => n._tempId !== deleteTargetId);
      } else if (deleteTargetType === 'Spouse') {
        pendingFamilyData.spouse = pendingFamilyData.spouse.filter(s => s._tempId !== deleteTargetId);
      } else if (deleteTargetType === 'Child') {
        pendingFamilyData.children = pendingFamilyData.children.filter(c => c._tempId !== deleteTargetId);
      }
    } else {
      await deleteRecord(deleteTargetType, deleteTargetId);
    }
    
    deleteTargetRow.remove();
    const tableBody = deleteTargetRow.closest('tbody');
    if (tableBody && tableBody.children.length === 0) {
      tableBody.appendChild(getEmptyRow(deleteTargetType));
    }
    showPopup("Record deleted successfully");
  } catch (error) {
    // Error handled
  }
  
  deleteTargetRow = null;
  deleteTargetType = null;
  deleteTargetId = null;
  document.getElementById('deleteModal').classList.add('hidden');
};

function getEmptyRow(type) {
  const row = document.createElement('tr');
  const configs = {
    'NOK': { colspan: '5', message: 'No NOKs yet.', id: 'nokEmpty' },
    'Spouse': { colspan: '4', message: 'No spouse records yet.', id: 'spouseEmpty' },
    'Child': { colspan: '5', message: 'No children yet.', id: 'childEmpty' }
  };
  const cfg = configs[type];
  row.id = cfg.id;
  row.innerHTML = `<td colspan="${cfg.colspan}" class="py-4 text-gray-500">${cfg.message}</td>`;
  return row;
}

async function deleteRecord(type, id) {
  const urls = {
    'NOK': `${API_BASE}/nextofkin/${id}`,
    'Spouse': `${API_BASE}/spouse/${id}`,
    'Child': `${API_BASE}/children/${id}`
  };
  return await apiRequest(urls[type], { method: 'DELETE' });
}

// Edit functionality - FIXED TO USE FULL DATA
window.editRow = async function(type, id) {
  let data;
  
  if (formMode === 'create') {
    if (type === 'NOK') data = pendingFamilyData.nok.find(n => n._tempId === id);
    if (type === 'Spouse') data = pendingFamilyData.spouse.find(s => s._tempId === id);
    if (type === 'Child') data = pendingFamilyData.children.find(c => c._tempId === id);
  } else {
    try {
      let result;
      if (type === 'NOK') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.nextOfKin.find(n => n.nok_id == id);
      } else if (type === 'Spouse') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.spouse.find(s => s.spouse_id == id);
      } else if (type === 'Child') {
        result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`);
        data = result.data.children.find(c => c.child_id == id);
      }
    } catch (error) {
      showError('Failed to load record for editing');
      return;
    }
  }
  
  if (!data) return;
  
  editState.type = type;
  editState.id = id;
  editState.row = document.querySelector(`tr[data-type="${type}"][data-id="${id}"]`);

  // Helper function to format dates
  const formatDate = (value) => {
    if (!value) return '';
    if (typeof value === 'string') {
      // Handle DDMMYYYY format (8 digits)
      if (value.match(/^\d{8}$/)) {
        const day = value.substring(0, 2);
        const month = value.substring(2, 4);
        const year = value.substring(4, 8);
        return `${year}-${month}-${day}`;
      }
      // Handle DD-MM-YYYY format
      if (value.match(/^\d{2}-\d{2}-\d{4}$/)) {
        const [day, month, year] = value.split('-');
        return `${year}-${month}-${day}`;
      }
      // Handle ISO format (2010-10-02T00:00:00.000Z)
      if (value.includes('T')) {
        return value.split('T')[0];
      }
      // Already in yyyy-mm-dd format
      if (value.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return value;
      }
    }
    return value;
  };

  if (type === "NOK") {
    document.getElementById('nokFirst').value = data.FirstName || '';
    document.getElementById('nokLast').value = data.LastName || '';
    document.getElementById('nokRelationship').value = data.RShipcode || '';
    document.getElementById('nokMobile').value = data.MobileNumber || '';
    document.getElementById('nokEmail').value = data.EmailAddress || '';
    document.getElementById('nokDob').value = formatDate(data.dateofbirth || data.DateOfBirth || '');
    document.getElementById('nokAddress').value = data.FullAddress || '';
    document.getElementById('nokHome').value = data.HomeNumber || '';
    document.getElementById('nokWork').value = data.PlaceOfWork || '';
    document.getElementById('nokType').value = data.NextofkinType || 'Main';

    const wrap = document.getElementById('nokFormWrap');
    const btn = document.getElementById('nokToggleBtn');
    if (wrap.classList.contains('hidden')) {
      wrap.classList.remove('hidden');
      btn.textContent = "âˆ’";
    }
  } else if (type === "Spouse") {
    document.getElementById('spouseName').value = data.spname || '';
    document.getElementById('spousePhone').value = data.spphone || '';
    document.getElementById('spouseEmail').value = data.spemail || '';
    document.getElementById('spouseDob').value = formatDate(data.dateofbirth || '');
    document.getElementById('spouseDom').value = formatDate(data.marrieddate || '');
    document.getElementById('spouseStreet').value = data.spstreet || '';
    document.getElementById('spouseTown').value = data.sptown || '';
    document.getElementById('spouseState').value = data.Statecode || '';
    document.getElementById('spouseLga').value = data.Lgcode || '';
    document.getElementById('spousePoBox').value = data.sppobox || '';

    const wrap = document.getElementById('spouseFormWrap');
    const btn = document.getElementById('spouseToggleBtn');
    if (wrap.classList.contains('hidden')) {
      wrap.classList.remove('hidden');
      btn.textContent = "âˆ’";
    }
  } else if (type === "Child") {
    document.getElementById('childName').value = data.chname || '';
    document.getElementById('childSex').value = data.Sex || '';
    document.getElementById('childDob').value = formatDate(data.dateofbirth || '');
    document.getElementById('childPhone').value = data.chphone || '';
    document.getElementById('childEmail').value = data.chemail || '';
    document.getElementById('childStreet').value = data.chstreet || '';
    document.getElementById('childTown').value = data.chtown || '';
    document.getElementById('childState').value = data.Statecode || '';
    document.getElementById('childLga').value = data.Lgcode || '';
    document.getElementById('childPoBox').value = data.chpobox || '';
    document.getElementById('childSchool').value = data.chschool || '';
    document.getElementById('childOffice').value = data.officeaddress || '';
    document.getElementById('childOccupation').value = data.occupation || '';
    
    const wrap = document.getElementById('childFormWrap');
    const btn = document.getElementById('childToggleBtn');
    if (wrap.classList.contains('hidden')) {
      wrap.classList.remove('hidden');
      btn.textContent = 'âˆ’';
    }
  }
};

// NOK functionality
const nokFormWrap = document.getElementById('nokFormWrap');
const nokToggleBtn = document.getElementById('nokToggleBtn');
const nokSaveBtn = document.getElementById('nokSave');
const nokCancelBtn = document.getElementById('nokCancel');

nokToggleBtn?.addEventListener('click', () => toggleBlock(nokFormWrap, nokToggleBtn));

nokCancelBtn?.addEventListener('click', () => {
  document.getElementById('nokForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(nokFormWrap, nokToggleBtn);
});

nokSaveBtn?.addEventListener('click', async () => {
  const first = val('nokFirst');
  const last = val('nokLast');
  const rel = val('nokRelationship');
  const mobile = val('nokMobile');
  const email = val('nokEmail');
  const dob = val('nokDob');
  const address = val('nokAddress');
  const home = val('nokHome');
  const work = val('nokWork');
  const type = val('nokType') || 'Main';

  const nokData = {
    FirstName: first,
    LastName: last,
    NextofkinType: type,
    RShipcode: rel,
    MobileNumber: mobile,
    HomeNumber: home,
    EmailAddress: email,
    dateofbirth: dob,
    FullAddress: address,
    PlaceOfWork: work
  };

  const requiredFields = [
    { field: 'First Name', value: first },
    { field: 'Last Name', value: last },
    { field: 'Relationship', value: rel },
    { field: 'Mobile Number', value: mobile },
    { field: 'Email', value: email },
    { field: 'Date of Birth', value: dob },
    { field: 'Address', value: address },
    { field: 'Type', value: type }
  ];

  let missingFields = requiredFields.filter(f => !f.value).map(f => f.field);
  if (missingFields.length > 0) { 
    alert('Please fill in the following required fields:\n' + missingFields.join('\n'));
    return; 
  }

  try {
    const list = document.getElementById('nokList');
    const empty = document.getElementById('nokEmpty');

    if (editState.type === "NOK" && editState.row && editState.id) {
      if (formMode === 'edit') {
        await apiRequest(`${API_BASE}/nextofkin/${editState.id}`, {
          method: 'PUT',
          body: JSON.stringify(nokData)
        });
      } else {
        const index = pendingFamilyData.nok.findIndex(n => n._tempId === editState.id);
        if (index !== -1) {
          pendingFamilyData.nok[index] = { ...nokData, _tempId: editState.id };
        }
      }

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = `${first} ${last}`;
      cells[1].textContent = rel;
      cells[2].textContent = mobile;
      cells[3].textContent = email;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("NOK updated successfully");
    } else {
      if (formMode === 'edit' && currentEmployeeId) {
        const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/nextofkin`, {
          method: 'POST',
          body: JSON.stringify(nokData)
        });

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="NOK" data-id="${result.nokId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(first)} ${escapeHtml(last)}</td>
            <td class="border px-3 py-2">${escapeHtml(rel)}</td>
            <td class="border px-3 py-2">${escapeHtml(mobile)}</td>
            <td class="border px-3 py-2">${escapeHtml(email)}</td>
            <td class="border px-3 py-2">${actionBtns('NOK', result.nokId)}</td>
          </tr>`);
      } else {
        nokCounter++;
        const tempId = nokCounter;
        nokData._tempId = tempId;
        pendingFamilyData.nok.push(nokData);

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="NOK" data-id="${tempId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(first)} ${escapeHtml(last)}</td>
            <td class="border px-3 py-2">${escapeHtml(rel)}</td>
            <td class="border px-3 py-2">${escapeHtml(mobile)}</td>
            <td class="border px-3 py-2">${escapeHtml(email)}</td>
            <td class="border px-3 py-2">${actionBtns('NOK', tempId)}</td>
          </tr>`);
      }
      showPopup("NOK saved successfully");
    }

    document.getElementById('nokForm')?.reset();
    toggleBlock(nokFormWrap, nokToggleBtn);
  } catch (error) {
    console.error('NOK save failed:', error);
  }
});

// Spouse functionality
const spouseFormWrap = document.getElementById('spouseFormWrap');
const spouseToggleBtn = document.getElementById('spouseToggleBtn');
const spouseSaveBtn = document.getElementById('spouseSave');
const spouseCancelBtn = document.getElementById('spouseCancel');

spouseToggleBtn?.addEventListener('click', () => toggleBlock(spouseFormWrap, spouseToggleBtn));

spouseCancelBtn?.addEventListener('click', () => {
  document.getElementById('spouseForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(spouseFormWrap, spouseToggleBtn);
});

spouseSaveBtn?.addEventListener('click', async () => {
  const name = val('spouseName');
  const phone = val('spousePhone');
  const email = val('spouseEmail');
  const dob = val('spouseDob');
  const dom = val('spouseDom');
  const street = val('spouseStreet');
  const town = val('spouseTown');
  const state = val('spouseState');
  const lga = val('spouseLga');
  const poBox = val('spousePoBox');

  const spouseData = {
    spname: name,
    spphone: phone,
    spemail: email,
    dateofbirth: dob,
    marrieddate: dom,
    spstreet: street,
    sptown: town,
    Statecode: state,
    Lgcode: lga,
    sppobox: poBox
  };

  const requiredFields = [
    { field: 'Full Name', value: name },
    { field: 'Phone Number', value: phone },
    { field: 'Email', value: email },
    { field: 'Date of Birth', value: dob },
    { field: 'Date of Marriage', value: dom },
    { field: 'Town', value: town },
    { field: 'State', value: state },
    { field: 'LGA', value: lga }
  ]; 

  let missingFields = requiredFields.filter(f => !f.value).map(f => f.field);
  if (missingFields.length > 0) {
    alert('Please fill in the required fields: ' + missingFields.join(', '));
    return;
  }

  try {
    const list = document.getElementById('spouseList');
    const empty = document.getElementById('spouseEmpty');

    if (editState.type === "Spouse" && editState.row && editState.id) {
      if (formMode === 'edit') {
        await apiRequest(`${API_BASE}/spouse/${editState.id}`, {
          method: 'PUT',
          body: JSON.stringify(spouseData)
        });
      } else {
        const index = pendingFamilyData.spouse.findIndex(s => s._tempId === editState.id);
        if (index !== -1) {
          pendingFamilyData.spouse[index] = { ...spouseData, _tempId: editState.id };
        }
      }

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = name;
      cells[1].textContent = phone;
      cells[2].textContent = email;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("Spouse updated successfully");
    } else {
      if (formMode === 'edit' && currentEmployeeId) {
        const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/spouse`, {
          method: 'POST',
          body: JSON.stringify(spouseData)
        });

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="Spouse" data-id="${result.spouseId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(name)}</td>
            <td class="border px-3 py-2">${escapeHtml(phone)}</td>
            <td class="border px-3 py-2">${escapeHtml(email)}</td>
            <td class="border px-3 py-2">${actionBtns('Spouse', result.spouseId)}</td>
          </tr>`);
      } else {
        spouseCounter++;
        const tempId = spouseCounter;
        spouseData._tempId = tempId;
        pendingFamilyData.spouse.push(spouseData);

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="Spouse" data-id="${tempId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(name)}</td>
            <td class="border px-3 py-2">${escapeHtml(phone)}</td>
            <td class="border px-3 py-2">${escapeHtml(email)}</td>
            <td class="border px-3 py-2">${actionBtns('Spouse', tempId)}</td>
          </tr>`);
      }
      showPopup("Spouse saved successfully");
    }

    document.getElementById('spouseForm')?.reset();
    toggleBlock(spouseFormWrap, spouseToggleBtn);
  } catch (error) {
    console.error('Spouse save failed:', error);
  }
});

// Children functionality
const childFormWrap = document.getElementById('childFormWrap');
const childToggleBtn = document.getElementById('childToggleBtn');
const childSaveBtn = document.getElementById('childSave');
const childCancelBtn = document.getElementById('childCancel');

childToggleBtn?.addEventListener('click', () => toggleBlock(childFormWrap, childToggleBtn));

childCancelBtn?.addEventListener('click', () => {
  document.getElementById('childForm')?.reset();
  editState.type = null;
  editState.row = null;
  editState.id = null;
  toggleBlock(childFormWrap, childToggleBtn);
});

childSaveBtn?.addEventListener('click', async () => {
  const name = val('childName');
  const sex = val('childSex');
  const dob = val('childDob');
  const phone = val('childPhone');
  const email = val('childEmail');
  const street = val('childStreet');
  const town = val('childTown');
  const state = val('childState');
  const lga = val('childLga');
  const poBox = val('childPoBox');
  const school = val('childSchool');
  const office = val('childOffice');
  const occupation = val('childOccupation');

  const childData = {
    chname: name,
    Sex: sex,
    dateofbirth: dob,
    chphone: phone,
    chemail: email,
    chstreet: street,
    chtown: town,
    Statecode: state,
    Lgcode: lga,
    chpobox: poBox,
    chschool: school,
    officeaddress: office,
    occupation: occupation
  };

  const requiredFields = [
    { field: 'Name', value: name },
    { field: 'Sex', value: sex },
    { field: 'Date of Birth', value: dob },
    { field: 'Phone Number', value: phone },
    { field: 'Email', value: email },
    { field: 'Town', value: town },
    { field: 'State', value: state },
    { field: 'LGA', value: lga }
  ];

  let missingFields = requiredFields.filter(f => !f.value).map(f => f.field);
  if (missingFields.length > 0) {
    alert('Please fill in the required fields: ' + missingFields.join(', '));
    return;
  }

  try {
    const list = document.getElementById('childList');
    const empty = document.getElementById('childEmpty');

    if (editState.type === "Child" && editState.row && editState.id) {
      if (formMode === 'edit') {
        await apiRequest(`${API_BASE}/children/${editState.id}`, {
          method: 'PUT',
          body: JSON.stringify(childData)
        });
      } else {
        const index = pendingFamilyData.children.findIndex(c => c._tempId === editState.id);
        if (index !== -1) {
          pendingFamilyData.children[index] = { ...childData, _tempId: editState.id };
        }
      }

      const cells = editState.row.querySelectorAll('td');
      cells[0].textContent = name;
      cells[1].textContent = sex;
      cells[2].textContent = dob;
      cells[3].textContent = phone;
      
      editState.type = null;
      editState.row = null;
      editState.id = null;
      showPopup("Child updated successfully");
    } else {
      if (formMode === 'edit' && currentEmployeeId) {
        const result = await apiRequest(`${API_BASE}/employees/${currentEmployeeId}/children`, {
          method: 'POST',
          body: JSON.stringify(childData)
        });

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="Child" data-id="${result.childId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(name)}</td>
            <td class="border px-3 py-2">${escapeHtml(sex)}</td>
            <td class="border px-3 py-2">${escapeHtml(dob)}</td>
            <td class="border px-3 py-2">${escapeHtml(phone)}</td>
            <td class="border px-3 py-2">${actionBtns('Child', result.childId)}</td>
          </tr>`);
      } else {
        childCounter++;
        const tempId = childCounter;
        childData._tempId = tempId;
        pendingFamilyData.children.push(childData);

        if (empty) empty.remove();
        
        list.insertAdjacentHTML('beforeend', `
          <tr data-type="Child" data-id="${tempId}" class="hover:bg-yellow-50">
            <td class="border px-3 py-2">${escapeHtml(name)}</td>
            <td class="border px-3 py-2">${escapeHtml(sex)}</td>
            <td class="border px-3 py-2">${escapeHtml(dob)}</td>
            <td class="border px-3 py-2">${escapeHtml(phone)}</td>
            <td class="border px-3 py-2">${actionBtns('Child', tempId)}</td>
          </tr>`);
      }
      showPopup("Child saved successfully");
    }

    document.getElementById('childForm')?.reset();
    toggleBlock(childFormWrap, childToggleBtn);
  } catch (error) {
    console.error('Child save failed:', error);
  }
});

// Mode Management
function setCreateMode() {
  formMode = 'create';
  currentEmployeeId = null;
  editingEmployeeData = null;
  localStorage.removeItem('editing_employee');
  
  const submitBtn = document.querySelector('#personnelForm button[type="button"]:last-child');
  if (submitBtn) submitBtn.textContent = 'Submit';
}

// setEditMode function
function setEditMode(employeeId, employeeData) {
  formMode = 'edit';
  currentEmployeeId = employeeId;
  editingEmployeeData = employeeData;
  localStorage.setItem('editing_employee', employeeId);
  
  const formTitle = document.getElementById('formTitle');
  if (formTitle) {
    formTitle.textContent = `Edit Personnel: ${employeeData.Surname} ${employeeData.OtherName}`;
    formTitle.classList.remove('hidden');
  }
  
  const submitBtn = document.querySelector('#personnelForm button[type="button"]:last-child');
  if (submitBtn) submitBtn.textContent = 'Update Personnel';
}

// Load Employee for Edit
async function loadEmployeeDataForEdit(employeeId) {
  try {
    const result = await apiRequest(`${API_BASE}/employees/${employeeId}`);
    const { employee, children, nextOfKin, spouse } = result.data;
    
    setEditMode(employeeId, employee);
    toggleStep(1);

    await initializeDropdowns();
    await loadAllDropdowns();
    
    setTimeout(() => {
      populatePersonnelForm(employee);
    }, 500);
    
    loadNOKRecords(nextOfKin);
    loadSpouseRecords(spouse);
    loadChildrenRecords(children);

    //console.log("Employee object keys:", Object.keys(employee));
    
    showPopup("Employee data loaded for editing");
  } catch (error) {
    console.error('Failed to load employee:', error);
  }
}

// Populate Form - Step 1 with IDs, Step 2 & 3 with names
function populatePersonnelForm(employee) {
  const reverseMap = {};
  Object.entries(DB_FIELD_MAP).forEach(([formField, dbField]) => {
    reverseMap[dbField] = formField;
  });

  Object.entries(employee).forEach(([dbField, value]) => {
    if (reverseMap[dbField] && value !== null && value !== undefined && value !== "") {
      const formField = reverseMap[dbField];
      let element = null;

      // Step 1 â†’ custom IDs
      if ([
        'Service Number', 'Rank', 'Surname', 'OtherName', 'Date of Birth',
        'State Of Origin', 'Local Government', 'Town', 'Residential Address',
        'Email Address', 'GSM Number', 'Sex', 'Marital Status', 'Religion', 'Passport Photograph'
      ].includes(formField)) {
        const elementId = `field-${formField.replace(/\s+/g, '-').toLowerCase()}`;
        element = document.getElementById(elementId);
      }
      // Step 2 & 3 â†’ use DB field name
      else {
        element = document.querySelector(`[name="${dbField}"]`);
      }

      if (element) {
        // Handle file input - convert to image avatar with change button
        if (element.type === 'file') {
          if (dbField === 'passport' && value) {
            console.log(`ðŸ“· Converting passport input to avatar preview`);
            convertPassportInputToAvatar(element, value);
          }
          return; // Don't set value for file inputs
        }
        
        // Handle date inputs
        if (element.type === 'date') {
          if (typeof value === 'string') {
            // Handle different date formats
            if (value.match(/^\d{8}$/)) {  // DDMMYYYY format
              const day = value.substring(0, 2);
              const month = value.substring(2, 4);
              const year = value.substring(4, 8);
              element.value = `${year}-${month}-${day}`;
            } else if (value.match(/^\d{2}-\d{2}-\d{4}$/)) {  // DD-MM-YYYY format
              const [day, month, year] = value.split('-');
              element.value = `${year}-${month}-${day}`;
            } else if (value.includes('T')) {  // ISO format
              element.value = value.split('T')[0];
            } else {
              console.warn(`Invalid date format for ${dbField}:`, value);
            }
          }
        } else {
          // Handle all other input types (text, select, etc.)
          element.value = value;
        }
        
        //console.log(`âœ… Prefilled [${formField}] (dbField: ${dbField}) with value: ${value}`);
      } else {
        //console.warn(`âš ï¸ No element found for formField: ${formField} (dbField: ${dbField}), value: ${value}`);
      }
    } else {
      //console.warn(`â© Skipped dbField: ${dbField}, value: ${value}, mapped formField: ${reverseMap[dbField] || 'none'}`);
    }
  });
}

// Convert file input to avatar preview with change button
function convertPassportInputToAvatar(fileInput, base64Data) {
  // Hide the original file input
  fileInput.style.display = 'none';
  
  // Store the base64 data as a data attribute for later use
  fileInput.setAttribute('data-current-passport', base64Data);
  
  // Create avatar preview container
  const avatarContainer = document.createElement('div');
  avatarContainer.className = 'passport-avatar-container';
  avatarContainer.innerHTML = `
    <div class="flex items-center gap-4 p-3 border border-blue-500 rounded-md bg-blue-50">
      <img src="data:image/jpeg;base64,${base64Data}" 
           alt="Passport" 
           class="w-20 h-20 object-cover rounded-full border-2 border-blue-600 shadow-md"
           id="passport-avatar-preview"/>
      <div class="flex flex-col gap-2">
        <span class="text-sm font-semibold text-gray-700" id="passport-status-text">Current Passport Photo</span>
        <div class="flex gap-2">
          <button type="button" 
                  onclick="changePassportPhoto()" 
                  class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            Change Photo
          </button>
          <button type="button" 
                  onclick="viewPassportFull(document.getElementById('passport-avatar-preview').src.split(',')[1])" 
                  class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition">
            View Full
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Insert after the hidden file input
  fileInput.parentElement.appendChild(avatarContainer);
}

// Function to change passport photo
window.changePassportPhoto = function() {
  const fileInput = document.querySelector('input[name="Passport Photograph"]');
  const avatarContainer = document.querySelector('.passport-avatar-container');
  
  if (!fileInput) return;
  
  // Create temporary file input
  const tempInput = document.createElement('input');
  tempInput.type = 'file';
  tempInput.accept = 'image/*';
  
  tempInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (file) {
      // Convert to base64
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        
        // Update the avatar preview
        const avatarImg = document.getElementById('passport-avatar-preview');
        if (avatarImg) {
          avatarImg.src = `data:image/jpeg;base64,${base64}`;
        }
        
        // Update the status text
        const statusText = document.getElementById('passport-status-text');
        if (statusText) {
          statusText.textContent = 'New Passport Photo Selected';
          statusText.className = 'text-sm font-semibold text-green-600'; // Change color to green
        }
        
        // Update the border color to indicate change
        const container = avatarContainer.querySelector('div');
        if (container) {
          container.className = 'flex items-center gap-4 p-3 border border-green-500 rounded-md bg-green-50';
        }
        
        // Update avatar border to green
        if (avatarImg) {
          avatarImg.className = 'w-20 h-20 object-cover rounded-full border-2 border-green-600 shadow-md';
        }
        
        // Update the stored data
        fileInput.setAttribute('data-current-passport', base64);
        fileInput.setAttribute('data-passport-changed', 'true');
        
        console.log(' New passport photo selected');
      };
      reader.readAsDataURL(file);
    }
  };
  
  // Trigger file selection
  tempInput.click();
}
// Function to view full-size passport
window.viewPassportFull = function(base64Data) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="relative bg-white p-6 rounded-lg max-w-2xl">
      <button onclick="this.closest('.fixed').remove()" 
              class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-3xl font-bold w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-full">
        Ã—
      </button>
      <h3 class="text-lg font-bold mb-4">Passport Photograph</h3>
      <img src="data:image/jpeg;base64,${base64Data}" 
           alt="Passport Full Size" 
           class="max-w-full max-h-[70vh] rounded shadow-lg mx-auto"/>
    </div>
  `;
  
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  
  document.body.appendChild(modal);
}


// Load Family Records
function loadNOKRecords(nokRecords) {
  const nokList = document.getElementById('nokList');
  nokList.innerHTML = '';
  
  if (nokRecords.length === 0) {
    nokList.innerHTML = '<tr id="nokEmpty"><td colspan="5" class="py-4 text-gray-500">No NOKs yet.</td></tr>';
  } else {
    nokRecords.forEach(nok => {
      nokList.insertAdjacentHTML('beforeend', `
        <tr data-type="NOK" data-id="${nok.nok_id}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(nok.FirstName)} ${escapeHtml(nok.LastName || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(nok.RShipcode || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(nok.MobileNumber || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(nok.EmailAddress || '')}</td>
          <td class="border px-3 py-2">${actionBtns('NOK', nok.nok_id)}</td>
        </tr>`);
    });
  }
}

function loadSpouseRecords(spouseRecords) {
  const spouseList = document.getElementById('spouseList');
  spouseList.innerHTML = '';
  
  if (spouseRecords.length === 0) {
    spouseList.innerHTML = '<tr id="spouseEmpty"><td colspan="4" class="py-4 text-gray-500">No spouse records yet.</td></tr>';
  } else {
    spouseRecords.forEach(spouse => {
      spouseList.insertAdjacentHTML('beforeend', `
        <tr data-type="Spouse" data-id="${spouse.spouse_id}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(spouse.spname || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(spouse.spphone || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(spouse.spemail || '')}</td>
          <td class="border px-3 py-2">${actionBtns('Spouse', spouse.spouse_id)}</td>
        </tr>`);
    });
  }
}

function loadChildrenRecords(childrenRecords) {
  const childList = document.getElementById('childList');
  childList.innerHTML = '';
  
  if (childrenRecords.length === 0) {
    childList.innerHTML = '<tr id="childEmpty"><td colspan="5" class="py-4 text-gray-500">No children yet.</td></tr>';
  } else {
    childrenRecords.forEach(child => {
      childList.insertAdjacentHTML('beforeend', `
        <tr data-type="Child" data-id="${child.child_id}" class="hover:bg-yellow-50">
          <td class="border px-3 py-2">${escapeHtml(child.chname || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(child.Sex || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(child.dateofbirth || '')}</td>
          <td class="border px-3 py-2">${escapeHtml(child.chphone || '')}</td>
          <td class="border px-3 py-2">${actionBtns('Child', child.child_id)}</td>
        </tr>`);
    });
  }
}

// Helper function to clean form data
function cleanFormData(formData) {
  const cleanData = {};
  
  // Convert FormData to object and clean values
  for (let [key, value] of formData.entries()) {
    // Skip empty values unless they should explicitly be null
    if (value === '') {
      cleanData[key] = null;
    } else if (value !== undefined) {
      cleanData[key] = value;
    }
  }
  
  return cleanData;
}

// Form submission - Collect ALL steps
async function submitPersonnelForm() {
  const personnelData = {};
  
  // Handle passport photograph
  let passportBase64 = null;
  const passportInput = document.querySelector('input[name="Passport Photograph"]');
  
  if (passportInput) {
    // Check if in avatar mode (edit mode with existing photo)
    const currentPassport = passportInput.getAttribute('data-current-passport');
    const passportChanged = passportInput.getAttribute('data-passport-changed');
    
    if (currentPassport && !passportChanged) {
      // Use existing passport data
      passportBase64 = currentPassport;
      console.log('Using existing passport photo');
    } else if (currentPassport && passportChanged) {
      // Use updated passport data
      passportBase64 = currentPassport;
      console.log('Using updated passport photo');
    } else if (passportInput.files && passportInput.files[0]) {
      // New upload (create mode)
      console.log('File found:', passportInput.files[0].name, passportInput.files[0].size, 'bytes');
      
      passportBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          console.log('Base64 conversion successful, length:', base64.length);
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(passportInput.files[0]);
      });
    }
  }
  
  // Collect ALL form fields from all 3 steps
  const allInputs = document.querySelectorAll('#step1 input, #step1 select, #step2 input, #step2 select, #step3 input, #step3 select');
  
  allInputs.forEach(input => {
    const fieldName = input.getAttribute('name') || '';
    
    // Skip file input - we handled it separately
    if (input.type === 'file') {
      return;
    }
    
    // Skip hidden fields and disabled fields
    if (input.type === 'hidden' || input.disabled) {
      return;
    }
    
    // Skip checkboxes that are not checked
    if (input.type === 'checkbox' && !input.checked) {
      return;
    }
    
    // Skip radio buttons that are not checked
    if (input.type === 'radio' && !input.checked) {
      return;
    }
    
    const value = input.value?.trim();
    
    // Skip empty values
    if (!value || value === '') {
      return;
    }
    
    // Skip default select placeholder values (common patterns)
    if (input.tagName === 'SELECT') {
      const lowerValue = value.toLowerCase();
      // Skip if it's a placeholder like "select", "select taxed", "choose", etc.
      if (lowerValue === 'select' || 
          lowerValue.startsWith('select ') || 
          lowerValue === 'choose' || 
          lowerValue.startsWith('choose ') ||
          lowerValue === '--' ||
          lowerValue === '---' ||
          value === '') {
        return;
      }
    }
    
    // Only include fields that are mapped
    if (DB_FIELD_MAP[fieldName]) {
      // Format date inputs to ddmmyyyy
      if (input.type === 'date' && value) {
        // Convert from yyyy-mm-dd to ddmmyyyy
        const dateObj = new Date(value);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        personnelData[DB_FIELD_MAP[fieldName]] = `${day}${month}${year}`;
      } else {
        personnelData[DB_FIELD_MAP[fieldName]] = value;
      }
    }
  });

  // Add passport data if exists
  if (passportBase64) {
    personnelData.passport = passportBase64;
    console.log('Passport added to personnelData');
  }
  
  console.log('Final personnelData keys:', Object.keys(personnelData));
  console.log('Passport included?', !!personnelData.passport);
  
  try {
    if (formMode === 'edit' && currentEmployeeId) {
      console.log('Updating employee:', currentEmployeeId);
      
      await apiRequest(`${API_BASE}/employees/${currentEmployeeId}`, {
        method: 'PUT',
        body: JSON.stringify(personnelData)
      });
      
      showPopup("Personnel updated successfully", () => {
      localStorage.removeItem('editing_employee'); // Remove only after successful update
      localStorage.removeItem('navigatedFromCurrentPersonnel');

      if (window.navigation?.navigateToSection) {
        window.navigation.navigateToSection('current-personnel', 'Current Personnel');
      }
    });
    } else {
      const serviceNo = document.getElementById('field-service-number')?.value.trim();
      if (!serviceNo) {
        alert('Service Number is required');
        return;
      }
      
      personnelData.Empl_ID = serviceNo;
      
      console.log('Creating new employee with service number:', serviceNo);
      
      // Create employee first
      await apiRequest(`${API_BASE}/employees`, {
        method: 'POST',
        body: JSON.stringify(personnelData)
      });
      
      // Then create family members
      if (pendingFamilyData.nok.length > 0) {
        for (const nok of pendingFamilyData.nok) {
          delete nok._tempId;
          await apiRequest(`${API_BASE}/employees/${serviceNo}/nextofkin`, {
            method: 'POST',
            body: JSON.stringify(nok)
          });
        }
      }
      
      if (pendingFamilyData.spouse.length > 0) {
        for (const spouse of pendingFamilyData.spouse) {
          delete spouse._tempId;
          await apiRequest(`${API_BASE}/employees/${serviceNo}/spouse`, {
            method: 'POST',
            body: JSON.stringify(spouse)
          });
        }
      }
      
      if (pendingFamilyData.children.length > 0) {
        for (const child of pendingFamilyData.children) {
          delete child._tempId;
          await apiRequest(`${API_BASE}/employees/${serviceNo}/children`, {
            method: 'POST',
            body: JSON.stringify(child)
          });
        }
      }
      
      showPopup("Personnel and family records created successfully", () => {
        if (window.navigation?.navigateToSection) {
          window.navigation.navigateToSection('current-personnel', 'Current Personnel');
          setTimeout(() => {
            if (window.personnelManager?.refresh) {
              window.personnelManager.refresh();
            }
          }, 100);
        }
      });
      
      document.getElementById('personnelForm')?.reset();
      pendingFamilyData = { nok: [], spouse: [], children: [] };
      clearAllFamilyTables();
      toggleStep(1);
    }
    
  } catch (error) {
    console.error('Submit failed:', error);
    alert('Failed to save employee: ' + error.message);
  }
}

// Global API
window.PersonnelAPI = {
  loadEmployeeDataForEdit,
  setCreateMode,
  setEditMode,
  getCurrentEmployee: () => currentEmployeeId,
  getFormMode: () => formMode,
  showTab,
  validateForm: validatePersonnelForm,
  clearAllFamilyTables,
  setNavigatedFromCurrentPersonnel: (value) => {
    navigatedFromCurrentPersonnel = value;
  }
};

document.addEventListener('DOMContentLoaded', () => {
  setCreateMode();
});
</script>