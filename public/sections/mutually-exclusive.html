
<div class="p-6">
<div class="">
<!-- Header -->
<div class="px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
        <h1 class="text-xl font-semibold">PAYMENT TYPES</h1>
    </div>

        <!-- Add Button -->
    <div class="flex justify-end gap-2">
        <button id="showFormBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add New</button>
    </div>
</div>

<div class="p-6">
    <!-- Hidden Form -->
    <div id="paymentTypeForm" class="hidden mb-4 p-6 ">
        <h3 class="text-lg font-semibold text-blue-600 mb-4">Add New Payment Type</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">High Priority Description</label>
                <input type="text" id="description" class="w-full bg-transparent border-2 border-blue-500 rounded px-3 py-2 text-sm focus:border-blue-600 focus:outline-none" placeholder="Enter description">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">High Priority Code</label>
                <input type="text" id="highPriority" class="w-full bg-transparent border-2 border-blue-500 rounded px-3 py-2 text-sm focus:border-blue-600 focus:outline-none" placeholder="enter high priority code">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Lower Priority Code</label>
                <input type="text" id="lowerPriority" class="w-full bg-transparent border-2 border-blue-500 rounded px-3 py-2 text-sm focus:border-blue-600 focus:outline-none" placeholder="enter lower priority code">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Lower Priority Description</label>
                <input type="text" id="detailDescription" class="w-full bg-transparent border-2 border-blue-500 rounded px-3 py-2 text-sm focus:border-blue-600 focus:outline-none" placeholder="Enter description">
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="flex justify-end gap-2">
            <button id="saveBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Save</button>
            <button id="cancelBtn" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">Cancel</button>
        </div>
    </div>

    <!-- Main Table -->
    <div class="overflow-hidden mb-6">
        <div class="p-3 text-center">
            <h2 class="font-bold text-gray-800">MUTUALLY EXCLUSIVE PAY ELEMENT DATA TYPES</h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full border rounded-lg text-sm">
                <thead class="border bg-blue-100 text-blue-900">
                    <tr>
                        <th class="border px-4 py-3 text-left font-semibold">Description</th>
                        <th class="border px-4 py-3 text-left font-semibold">High Priority</th>
                        <th class="border px-4 py-3 text-left font-semibold">Lower Priority</th>
                        <th class="border px-4 py-3 text-left font-semibold">Description</th>
                        <th class="border px-4 py-3 text-center font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="paymentTypesTable">
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
</div>

<!-- Success Modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
<div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
<h3 class="text-lg font-semibold mb-2 text-green-600">Success!</h3>
<p class="mb-4 text-gray-700">Payment type configuration saved successfully!</p>
<button id="closeSuccessModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
</div>
</div>

<!-- View Modal -->
<div id="viewModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
<div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
<div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-blue-600">Payment Type Details</h3>
    <button id="closeViewModal" class="text-gray-400 hover:text-gray-600">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
</div>
<div id="viewContent" class="space-y-3 text-sm"></div>
</div>
</div>

<script>
let editingIndex = null;
let data = [];

const form = document.getElementById("paymentTypeForm");
const showFormBtn = document.getElementById("showFormBtn");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const tableBody = document.getElementById("paymentTypesTable");

const API_URL = "/mutually";
const token = localStorage.getItem("token");

// ==== VIEW ====
window.viewRow = function(index) {
  const item = data[index];
  let html = `
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-blue-50 p-3 rounded">
            <h4 class="font-semibold text-blue-700 mb-2">High Priority:</h4>
            <p class="text-blue-900 font-mono">${item.typeH}</p>
            <p class="text-gray-700">${item.typehdesc}</p>
        </div>
        <div class="bg-orange-50 p-3 rounded">
            <h4 class="font-semibold text-orange-700 mb-2">Lower Priority:</h4>
            <p class="text-orange-900 font-mono">${item.typeL}</p>
            <p class="text-gray-700">${item.typeldesc}</p>
        </div>
    </div>
  `;
  document.getElementById("viewContent").innerHTML = html;
  openModal("viewModal");
};

// ==== EDIT ====
window.editRow = function(index) {
  const item = data[index];
  document.getElementById("highPriority").value = item.typeH;
  document.getElementById("description").value = item.typehdesc;
  document.getElementById("lowerPriority").value = item.typeL;
  document.getElementById("detailDescription").value = item.typeldesc;

  editingIndex = index;
  form.classList.remove("hidden");
};

// ==== DELETE ====
window.deleteRow = async function(index) {
  const item = data[index];
  if (confirm("Are you sure you want to delete this payment type?")) {
    try {
      await fetch(`${API_URL}/${item.typeH}/${item.typeL}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      data.splice(index, 1);
      renderTable();
    } catch (err) {
      console.error("Delete failed:", err);
      alert("Error deleting record.");
    }
  }
};

// ==== RENDER ====
function renderTable() {
  tableBody.innerHTML = data.map((item, index) => {
    const isSelected = index === 0;
    return `
      <tr class="hover:bg-gray-50 ${isSelected ? 'bg-yellow-100' : ''}">
        <td class="border px-4 py-2 text-left">${isSelected ? '▶ ' : ''}${item.typehdesc}</td>
        <td class="border px-4 py-2 text-left">${item.typeH}</td>
        <td class="border px-4 py-2 text-left">${item.typeL}</td>
        <td class="border px-4 py-2 text-left">${item.typeldesc}</td>
        <td class="border px-4 py-2 text-center">
          <button onclick="editRow(${index})" class="text-green-600 hover:text-green-800 mr-2 px-2 py-1 rounded hover:bg-green-50 text-xs">Edit</button>
          <button onclick="deleteRow(${index})" class="text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50 text-xs">Delete</button>
        </td>
      </tr>
    `;
  }).join("");
}

// ==== LOAD DATA ====
async function loadData() {
  try {
    const res = await fetch(API_URL, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Failed to fetch data");
    data = await res.json();
    renderTable();
  } catch (err) {
    console.error("Error loading:", err);
    alert("Failed to load data.");
  }
}



// ==== SAVE ====
saveBtn.addEventListener("click", async () => {
  // Collect values
  const typeH = document.getElementById("highPriority").value.trim().toUpperCase();
  const typehdesc = document.getElementById("description").value.trim().toUpperCase();
  const typeL = document.getElementById("lowerPriority").value.trim().toUpperCase();
  const typeldesc = document.getElementById("detailDescription").value.trim().toUpperCase();

  if (!typeH || !typeL) {
    alert("Please fill in both High and Low Priority codes.");
    return;
  }

  // Ensure payload is uppercase (Option 1 - safety)
  const payload = { typeH, typehdesc, typeL, typeldesc };

  try {
    if (editingIndex !== null) {
      const existing = data[editingIndex];
      await fetch(`${API_URL}/${existing.typeH}/${existing.typeL}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      data[editingIndex] = payload;
      editingIndex = null;
    } else {
      await fetch(`${API_URL}/post`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      data.push(payload);
    }

    renderTable();
    form.classList.add("hidden");
    clearForm();
    openModal("successModal");
  } catch (err) {
    console.error("Save failed:", err);
    alert("Error saving record.");
  }
});

// Force uppercase as user types
["highPriority", "lowerPriority", "description", "detailDescription"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("input", () => {
    el.value = el.value.toUpperCase();
  });
});


// ==== UI HELPERS ====
showFormBtn.addEventListener("click", () => {
  form.classList.remove("hidden");
  editingIndex = null;
  clearForm();
});

cancelBtn.addEventListener("click", () => {
  form.classList.add("hidden");
  editingIndex = null;
  clearForm();
});

function clearForm() {
  document.getElementById("description").value = "";
  document.getElementById("highPriority").value = "";
  document.getElementById("lowerPriority").value = "";
  document.getElementById("detailDescription").value = "";
}

function openModal(id) {
  document.getElementById(id).classList.remove("hidden");
}
function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
}

document.getElementById('closeSuccessModal').addEventListener('click', () => closeModal('successModal'));
document.getElementById('closeViewModal').addEventListener('click', () => closeModal('viewModal'));

document.getElementById('successModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal('successModal');
});
document.getElementById('viewModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal('viewModal');
});

// Add selection highlighting to table rows
tableBody.addEventListener('click', function(e) {
    const row = e.target.closest('tr');
    if (row && !e.target.matches('button')) {
        // Remove previous selection
        document.querySelectorAll('#paymentTypesTable tr').forEach(tr => {
            tr.classList.remove('bg-yellow-100');
            const firstCell = tr.querySelector('td');
            if (firstCell) {
                firstCell.innerHTML = firstCell.innerHTML.replace('▶ ', '');
            }
        });
    
        // Add selection to clicked row
        row.classList.add('bg-yellow-100');
        const firstCell = row.querySelector('td');
        if (firstCell && !firstCell.innerHTML.startsWith('▶')) {
            firstCell.innerHTML = '▶ ' + firstCell.innerHTML;
        }
    }
});


// ==== INITIAL LOAD ====
loadData();
</script>
