<div class="p-6">
  <!-- Department Section Header -->
  <div class="flex flex-wrap gap-2 justify-between mb-6">
    <h3 class="text-xl font-semibold text-gray-800">Department Management</h3>
    <div class="flex flex-wrap gap-2">
      <input type="text" id="searchDept" placeholder="Search by ID or Name" class="border rounded px-3 py-2">
      <button id="addNewDeptBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Department</button>
    </div>
  </div>

  <!-- Hidden Department Form -->
  <form id="deptForm" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Factory Code *</label>
      <input type="text" id="factcode" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Fact Code">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Department Code *</label>
      <input type="text" id="deptcode" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Dept Code">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Factory Name</label>
      <input type="text" id="factname" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Fact Name">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Department Name</label>
      <input type="text" id="deptname" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Department Name">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Coor code</label>
      <input id="coordcode" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter coor code">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Manager</label>
      <input type="text" id="manager" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Manager">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">HOD</label>
      <input type="text" id="hod" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter HOD">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Account</label>
      <input type="text" id="acct" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Account Code">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Misc 1</label>
      <input type="text" id="misc1" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter misc2">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Misc 2</label>
      <input type="text" id="misc2" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter misc2">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Misc 3</label>
      <input type="text" id="misc3" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter misc3">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Address Code</label>
      <input type="text" id="AddressCode" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter Address Code">
    </div>

    <div class="col-span-1 md:col-span-2 lg:col-span-3 flex justify-end gap-2">
      <button type="button" id="saveDeptBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save</button>
      <button type="button" id="cancelDeptBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
    </div>
  </form>

  <!-- Department Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="border px-2 py-3 text-left">Factory Code</th>
          <th class="border px-2 py-3 text-left">Factory Name</th>
          <th class="border px-2 py-3 text-left">Dept Code</th>
          <th class="border px-2 py-3 text-left">Dept Name</th>
          <th class="border px-2 py-3 text-left">Manager</th>
          <th class="border px-2 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="deptTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Success Modal -->
<div id="deptSuccessModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-green-600 mb-2">Success!</h3>
    <p id="deptSuccessMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button id="closeSuccessModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="deptErrorModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
    <p id="deptErrorMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button id="closeErrorModal" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">OK</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="deptConfirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="deptConfirmMessage" class="mb-4 text-gray-700">Are you sure you want to delete this department?</p>
    <div class="flex justify-end gap-2">
      <button id="cancelConfirm" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      <button id="deptConfirmAction" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<!-- View Department Modal -->
<div id="deptViewModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-blue-600">Department Details</h3>
      <button id="closeViewModal" class="text-gray-400 hover:text-gray-600">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div id="deptViewContent" class="space-y-3 text-sm"></div>
  </div>
</div>

<script>
let deptData = [];
let editingDeptIndex = null;
let pendingDeleteDeptIndex = null;
let originaldeptData = null;

const deptForm = document.getElementById("deptForm");
const addNewDeptBtn = document.getElementById("addNewDeptBtn");
const saveDeptBtn = document.getElementById("saveDeptBtn");
const cancelDeptBtn = document.getElementById("cancelDeptBtn");
const deptTableBody = document.getElementById("deptTableBody");
const searchDept = document.getElementById("searchDept");

// Load departments
async function loadDepartments() {
  try {
    const token = localStorage.getItem('token');

    const res = await fetch("/dept/department", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      }
    });

    deptData = await res.json();
    renderDeptTable();
  } catch (err) {
    console.error("Error loading departments:", err);
  }
}


// Render Table
function renderDeptTable(data = deptData) {
  deptTableBody.innerHTML = data.map((d, i) => `
    <tr class="hover:bg-gray-50">
      <td class="border px-2 py-3">${d.factcode}</td>
      <td class="border px-2 py-3">${d.factname}</td>
      <td class="border px-2 py-3">${d.deptcode}</td>
      <td class="border px-2 py-3">${d.deptname || ""}</td>
      <td class="border px-2 py-3">${d.manager || ""}</td>
      <td class="border px-2 py-3">
        <button onclick="viewDept(${i})" class="text-blue-600 mr-2">View</button>
        <button onclick="editDept(${i})" class="text-green-600 mr-2">Edit</button>
        <button onclick="deleteDept(${i})" class="text-red-600">Delete</button>
      </td>
    </tr>
  `).join("");
}


// Add new
addNewDeptBtn.addEventListener("click", () => {
  deptForm.classList.remove("hidden");
  editingDeptIndex = null;
  document.getElementById("factcode").disabled = false; 
  document.getElementById("deptcode").disabled = false; 
  deptForm.reset();
});

//validations
async function checkDepartmentDuplicate(input, field, excludeDeptCode = null) {
  const value = input.value.trim();
  if (!value) {
    input.setCustomValidity("");
    input.reportValidity();
    return;
  }

  // If editing, check if this field value has actually changed
  if (originaldeptData && originaldeptData[field] === value) {
    input.setCustomValidity(""); // Clear any existing validation message
    input.reportValidity();
    return; // Skip duplicate check if value hasn't changed
  }

  try {
    const token = localStorage.getItem("token");
    
    // Build URL with optional excludeDeptCode parameter
    let url = `/dept/department/check/${field}/${encodeURIComponent(value)}`;
    if (excludeDeptCode) {
      url += `?exclude=${excludeDeptCode}`;
    }
    
    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (!res.ok) {
      console.error(`HTTP ${res.status}: ${res.statusText}`);
      return;
    }

    const data = await res.json();
    if (data.exists) {
      input.setCustomValidity(`⚠️ This ${field} already exists.`);
    } else {
      input.setCustomValidity("");
    }
    input.reportValidity();
  } catch (err) {
    console.error(`Error checking ${field}:`, err);
    input.setCustomValidity("");
    input.reportValidity();
  }
}

// Add blur event listeners for the first 5 fields + acct
document.getElementById("factcode")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "factcode", currentDeptCode);
});

document.getElementById("deptcode")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "deptcode", currentDeptCode);
});

document.getElementById("factname")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "factname", currentDeptCode);
});

document.getElementById("deptname")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "deptname", currentDeptCode);
});

document.getElementById("coordcode")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "coordcode", currentDeptCode);
});

document.getElementById("acct")?.addEventListener("blur", function () {
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;
  checkDepartmentDuplicate(this, "acct", currentDeptCode);
});


// Save
saveDeptBtn.addEventListener("click", async () => {
  const item = {
    factcode: document.getElementById("factcode").value.trim(),
    deptcode: document.getElementById("deptcode").value.trim(),
    factname: document.getElementById("factname").value.trim(),
    deptname: document.getElementById("deptname").value.trim(),
    coordcode: document.getElementById("coordcode").value.trim(),
    manager: document.getElementById("manager").value.trim(),
    hod: document.getElementById("hod").value.trim(),
    acct: document.getElementById("acct").value.trim(),
    misc1: document.getElementById("misc1").value.trim(),
    misc2: document.getElementById("misc2").value.trim(),
    misc3: document.getElementById("misc3").value.trim(),
    AddressCode: document.getElementById("AddressCode").value.trim(),
  };

  if (!item.factcode || !item.deptcode || !item.factname || !item.deptname || !item.coordcode || !item.acct) {
    showErrorModal("Factory code, Deptartment code, Factory Name, Department Name, account, and Coor Code are required.");
    return;
  }

  // Check for duplicates before saving
  const factcodeInput = document.getElementById("factcode");
  const deptcodeInput = document.getElementById("deptcode");
  const factnameInput = document.getElementById("factname");
  const deptnameInput = document.getElementById("deptname");
  const coordcodeInput = document.getElementById("coordcode");
  const acctInput = document.getElementById("acct");

  // Get the current deptcode for editing
  const currentDeptCode = editingDeptIndex !== null ? deptData[editingDeptIndex].deptcode : null;

  // Perform duplicate checks only for changed fields
  await checkDepartmentDuplicate(factcodeInput, 'factcode', currentDeptCode);
  await checkDepartmentDuplicate(deptcodeInput, 'deptcode', currentDeptCode);
  await checkDepartmentDuplicate(factnameInput, 'factname', currentDeptCode);
  await checkDepartmentDuplicate(deptnameInput, 'deptname', currentDeptCode);
  await checkDepartmentDuplicate(coordcodeInput, 'coordcode', currentDeptCode);
  await checkDepartmentDuplicate(acctInput, 'acct', currentDeptCode);

  // Check if any validation errors exist
  if (!factcodeInput.checkValidity() || !deptcodeInput.checkValidity() || 
      !factnameInput.checkValidity() || !deptnameInput.checkValidity() || 
      !coordcodeInput.checkValidity() || !acctInput.checkValidity()) {
    showErrorModal("Please fix the validation errors before saving.");
    return;
  }

  try {
    const token = localStorage.getItem('token');

    if (editingDeptIndex !== null) {
      await fetch(`/dept/${deptData[editingDeptIndex].factcode}/${deptData[editingDeptIndex].deptcode}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(item),
      });
      showSuccessModal("Department updated successfully!");
    } else {
      const token = localStorage.getItem("token");

      await fetch("/dept/post-department", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(item),
      });
      showSuccessModal("Department created successfully!");
    }

    await loadDepartments();
    deptForm.classList.add("hidden");
    deptForm.reset();
    editingDeptIndex = null;
    originaldeptData = null;

  } catch (err) {
    showErrorModal("Error saving department:", err);
  }
});

// Cancel
cancelDeptBtn.addEventListener("click", () => {
  deptForm.classList.add("hidden");
  deptForm.reset();
});

// View
window.viewDept = function(index) {
  const item = deptData[index];

  // Format date if present
  let formattedDate = "";
  if (item.datecreated) {
    const dateObj = new Date(item.datecreated);
    formattedDate = dateObj.toLocaleString('en-US', {
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
    });
  }

  let html = `
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Fact Code:</dt><dd class="col-span-2">${item.factcode}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Dept Code:</dt><dd class="col-span-2">${item.deptcode}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Fact Name:</dt><dd class="col-span-2">${item.factname || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Dept Name:</dt><dd class="col-span-2">${item.deptname || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Description:</dt><dd class="col-span-2">${item.coordcode || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Manager:</dt><dd class="col-span-2">${item.manager || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">HOD:</dt><dd class="col-span-2">${item.hod || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Account:</dt><dd class="col-span-2">${item.acct || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Misc:</dt><dd class="col-span-2">${item.misc1 || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Misc 2:</dt><dd class="col-span-2">${item.misc2 || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Misc 3:</dt><dd class="col-span-2">${item.misc3 || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Address Code:</dt><dd class="col-span-2">${item.AddressCode || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Created By:</dt><dd class="col-span-2">${item.createdby || ""}</dd>
    </div>
    <div class="grid grid-cols-3 gap-2 py-2 border-b">
      <dt class="font-medium">Date Created:</dt><dd class="col-span-2">${formattedDate}</dd>
    </div>
  `;
  document.getElementById("deptViewContent").innerHTML = html;
  showModal("deptViewModal");
};

// Edit
window.editDept = function(index) {

  const item = deptData[index];

  // Store original values for comparison
  originaldeptData = {
    factcode: item.factcode,
    deptcode: item.deptcode,
    factname: item.factname,
    deptname: item.deptname,
    coordcode: item.coordcode,
    acct: item.acct
  };

  document.getElementById("factcode").value = item.factcode;
  document.getElementById("deptcode").value = item.deptcode;
  document.getElementById("factname").value = item.factname || "";
  document.getElementById("deptname").value = item.deptname || "";
  document.getElementById("coordcode").value = item.coordcode || "";
  document.getElementById("manager").value = item.manager || "";
  document.getElementById("hod").value = item.hod || "";
  document.getElementById("acct").value = item.acct || "";
  document.getElementById("misc1").value = item.misc1 || "";
  document.getElementById("misc2").value = item.misc2 || "";
  document.getElementById("misc3").value = item.misc3 || "";
  document.getElementById("AddressCode").value = item.AddressCode || "";

  // Clear any existing validation messages
  ["factcode", "deptcode", "factname", "deptname", "coordcode", "acct"].forEach(field => {
    document.getElementById(field).setCustomValidity("");
  });

  editingDeptIndex = index;
  document.getElementById("factcode").disabled = true; 
  document.getElementById("deptcode").disabled = true; 
  deptForm.classList.remove("hidden");
};

// Delete
window.deleteDept = function(index) {
  pendingDeleteDeptIndex = index;
  showConfirmModal("Are you sure you want to delete this department?");
};

document.getElementById("deptConfirmAction").addEventListener("click", async () => {
  if (pendingDeleteDeptIndex !== null) {
    try {
      const token = localStorage.getItem("token");

      await fetch(`/dept/${deptData[pendingDeleteDeptIndex].factcode}/${deptData[pendingDeleteDeptIndex].deptcode}`, {
        method: "DELETE",
        headers:{ 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }        
      });
      showSuccessModal("Department deleted successfully!");
      await loadDepartments();
    } catch (err) {
      showErrorModal("Error deleting department:", err);
    }
    pendingDeleteDeptIndex = null;
  }
  closeModal("deptConfirmModal");
});

//
// Search
//
searchDept.addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = deptData.filter(d =>
    d.factname?.toLowerCase().includes(term) ||
    d.deptname?.toLowerCase().includes(term)
  );
  renderDeptTable(filtered);
});


  function showModal(modalId) {
    document.getElementById(modalId).classList.remove("hidden");
  }
  function closeModal(modalId) {
    document.getElementById(modalId).classList.add("hidden");
  }
  function showSuccessModal(msg) {
    document.getElementById("deptSuccessMessage").textContent = msg;
    showModal("deptSuccessModal");
  }
  function showErrorModal(msg) {
    document.getElementById("deptErrorMessage").textContent = msg;
    showModal("deptErrorModal");
  }

  function showConfirmModal(message) {
    document.getElementById("deptConfirmMessage").textContent = message;
    showModal("deptConfirmModal");
  }

    // Modal event listeners
  document.getElementById("closeSuccessModal").addEventListener("click", () => closeModal("deptSuccessModal"));
  document.getElementById("closeErrorModal").addEventListener("click", () => closeModal("deptErrorModal"));
  document.getElementById("closeViewModal").addEventListener("click", () => closeModal("deptViewModal"));
  document.getElementById("cancelConfirm").addEventListener("click", () => {
    closeModal("deptConfirmModal");
    pendingDeleteDeptIndex = null;
  });

  searchDept.addEventListener("input", () => {
    const query = searchDept.value.toLowerCase();
    const filtered = deptData.filter(item =>
      item.id.toLowerCase().includes(query) || item.name.toLowerCase().includes(query)
    );
    renderDeptTable(filtered);
  });

    // Close modals when clicking outside
  const modals = ['deptSuccessModal', 'deptErrorModal', 'deptConfirmModal', 'deptViewModal'];
  modals.forEach(modalId => {
    document.getElementById(modalId).addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal(modalId);
    });
  });


  renderDeptTable();
  // Initial load
  loadDepartments();
</script>
