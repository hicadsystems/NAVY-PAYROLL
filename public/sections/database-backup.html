<div class="container p-6">
    <!-- Connection Status -->
    <div class="mb-6">
        <div id="connectionStatus">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                    <span id="statusText" class="text-blue-600 font-bold">Connecting to server...</span>
                </div>
                <div>
                  <button onclick="window.navigation.navigateToSection('database-restore', 'Database Restore')"  class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded text-white transition-colors">
                    <i class="fas fa-database text-white mr-2"></i> DB Restore
                  </button>

                  <button id="refreshConnection" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                  </button>
                </div>

            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Backup Configuration -->
        <div class="rounded-lg border border-slate-300">
            <div class="p-6 border-b border-slate-300">
                <h2 class="text-xl text-blue-600 font-semibold flex items-center">
                    <i class="fas fa-cog mr-2 text-black"></i>
                    Backup Configuration
                </h2>
            </div>
            <div class="p-6 space-y-4">
                <!-- Database Selection -->
                <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">Database</label>
                <select id="databaseSelect"
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-700 cursor-not-allowed"
                        disabled>
                    <option id="dbNameOption">Loading...</option>
                </select>
                </div>

                <!-- Backup Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Backup Type</label>
                    <select id="backupType" class="w-full  border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="full">Full Backup</option>
                        <option value="structure">Structure Only</option>
                        <option value="data">Data Only</option>
                    </select>
                </div>

                <!-- Compression -->
                <div class="flex items-center">
                    <input type="checkbox" id="compression" class="w-4 h-4 text-blue-600  border-slate-300 rounded focus:ring-blue-500">
                    <label for="compression" class="ml-2 text-sm text-gray-900">Enable compression (GZIP)</label>
                </div>

                <!-- Schedule -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Schedule</label>
                    <select id="scheduleSelect" class="w-full  border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="manual">Manual</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <!-- Storage Location -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Storage Location</label>
                    <div class="w-fit flex gap-4 items-center bg-white-50 p-1 rounded-lg border border-slate-300">
                        <label class="flex items-center">
                            <input type="radio" name="storage" value="local" class="text-blue-600  border-slate-300 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-900">Local Server</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storage" value="ftp" class="text-blue-600  border-slate-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-900">FTP Server</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storage" value="cloud" class="text-blue-600  border-slate-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-900">Cloud Storage</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button id="startBackup" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Start Backup
                    </button>
                    <button id="scheduleBackup" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-clock mr-2"></i>Schedule
                    </button>
                </div>
            </div>
        </div>

        <!-- Backup History -->
        <div class="rounded-lg border border-slate-300 ">
            <div class="p-6 border-b border-slate-300">
                <h2 class="text-xl font-semibold text-blue-600 flex items-center">
                    <i class="fas fa-history mr-2 text-yellow-500"></i>
                    Backup History
                </h2>
            </div>
            <div class="p-6">
                <div id="backupHistory" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Backup entries will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="fixed flex inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class=" rounded-lg p-6 mx-4 w-full max-w-md border border-slate-300 shadow-xl">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Backup in Progress</h3>
            <div class="space-y-4">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-gray-600 text-sm">Initializing backup...</div>
                <div class="flex justify-end">
                    <button id="cancelBackup" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid md:grid-cols-3 gap-6 mt-6">
        <div class="rounded-lg border border-slate-300  p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-600 rounded-full">
                    <i class="fas fa-check text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Successful Backups</p>
                    <p id="successCount" class="text-2xl font-semibold text-blue-600">0</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg border border-slate-300  p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-600 rounded-full">
                    <i class="fas fa-hdd text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Total Storage Used</p>
                    <p id="storageUsed" class="text-2xl font-semibold text-blue-600">0 MB</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg border border-slate-300  p-6">
            <div class="flex items-center">
                <div class="p-3 bg-black rounded-full">
                    <i class="fas fa-calendar text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Last Backup</p>
                    <p id="lastBackup" class="text-xl font-semibold text-blue-600">Never</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Delete</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to delete this record? This action cannot be undone.</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelDelete" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
            <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
        <div id="loadingSpinner" class="flex justify-center mb-4">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
        </div>
        <div id="successTick" class="hidden flex justify-center mb-4">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>
        <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
    </div>
</div>

<script>
    class DatabaseBackup {
        constructor() {
            this.fetchDatabaseName();
            this.init();
            this.loadBackupHistory();
            this.checkConnection();
            this.updateStatistics();
        }

        init() {
            // Event listeners
            document.getElementById('startBackup').addEventListener('click', () => this.startBackup());
            document.getElementById('scheduleBackup').addEventListener('click', () => this.scheduleBackup());
            document.getElementById('refreshConnection').addEventListener('click', () => this.checkConnection());
            document.getElementById('cancelBackup').addEventListener('click', () => this.cancelBackup());

            // Auto-refresh history every 30 seconds
            setInterval(() => this.loadBackupHistory(), 30000);
        }

        async fetchDatabaseName() {
            try {
                const res = await fetch("/api/backup-db/database");
                const data = await res.json();

                const select = document.getElementById("databaseSelect");
                select.innerHTML = ""; // clear old options

                const option = document.createElement("option");
                option.value = data.database;
                option.textContent = data.database;
                option.selected = true;

                select.appendChild(option);

                this.dbName = data.database; // store for backup use
            } catch (err) {
                console.error("Failed to load DB name:", err);
            }
        }

        async checkConnection() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-500 mr-3';
            statusText.textContent = 'Checking connection...';

            try {
                const response = await fetch('/api/backup-db/health');
                if (response.ok) {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
                    statusText.textContent = 'Connected to server';
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
                statusText.textContent = 'Connection failed';
                console.error('Connection check failed:', error);
            }
        }

        async startBackup() {
            const backupType = document.getElementById('backupType').value;
            const compression = document.getElementById('compression').checked;
            const storage = document.querySelector('input[name="storage"]:checked').value;

            this.showProgressModal();

            try {
                const response = await fetch('/api/backup-db/backup/mysql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        database: this.dbName,
                        backupType,
                        compression,
                        storage
                    })
                });

                this.simulateProgress();

                const result = await response.json();
                
                if (result.success) {
                    this.hideProgressModal();
                    this.showNotification('Backup completed successfully!', 'success');
                    this.loadBackupHistory();
                    this.updateStatistics();
                } else {
                    throw new Error(result.error || 'Backup failed');
                }
            } catch (error) {
                this.hideProgressModal();
                this.showNotification('Backup failed: ' + error.message, 'error');
                console.error('Backup error:', error);
            }
        }

        async scheduleBackup() {
            const schedule = document.getElementById('scheduleSelect').value;
            if (schedule === 'manual') {
                this.showNotification('Please select a schedule option', 'error');
                return;
            }

            try {
                const response = await fetch('/api/backup-db/backup/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule,
                        backupType: document.getElementById('backupType').value,
                        compression: document.getElementById('compression').checked,
                        storage: document.querySelector('input[name="storage"]:checked').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    this.showNotification(`Backup scheduled for ${schedule} execution`, 'success');
                } else {
                    throw new Error(result.error || 'Scheduling failed');
                }
            } catch (error) {
                this.showNotification('Scheduling failed: ' + error.message, 'error');
                console.error('Scheduling error:', error);
            }
        }

        async loadBackupHistory() {
            try {
                const response = await fetch('/api/backup-db/backups');
                const data = await response.json();
                
                const historyContainer = document.getElementById('backupHistory');
                
                if (data.backups && data.backups.length > 0) {
                    //sort by created date (newest first)
                    const sorted = data.backups.sort(
                        (a, b) => new Date(b.created) - new Date(a.created)
                    );

                    historyContainer.innerHTML = sorted.map(backup => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full mr-3">
                                    <i class="fas fa-database text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-sm text-gray-900">${backup.filename}</p>
                                    <p class="text-sm text-gray-500">
                                        ${this.formatFileSize(backup.size)} • ${this.formatDate(backup.created)} 
                                    </p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="download-btn text-blue-600 hover:text-blue-800" 
                                        data-filename="${backup.filename}">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="delete-btn text-red-600 hover:text-red-800" 
                                        data-filename="${backup.filename}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No backups found</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load backup history:', error);
            }

            //event delegation for dynamic buttons
            const backupHistory = document.getElementById('backupHistory');
            if (!backupHistory.dataset.eventsBound) {
                backupHistory.addEventListener('click', (e) => {
                    const downloadBtn = e.target.closest('.download-btn');
                    const deleteBtn = e.target.closest('.delete-btn');

                    if (downloadBtn) {
                        this.downloadBackup(downloadBtn.dataset.filename);
                    }

                    if (deleteBtn) {
                        this.deleteBackup(deleteBtn.dataset.filename);
                    }
                });
                backupHistory.dataset.eventsBound = "true";
            }
        }


        async downloadBackup(filename) {
            try {
                const response = await fetch(`/api/backup-db/backup/download/${filename}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    this.showSuccessModal('Download successful!');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                this.showNotification('Download failed: ' + error.message, 'error');
            }
        }

        async deleteBackup(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

            try {
                const response = await fetch(`/api/backup-db/backup/${filename}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showNotification('Backup deleted successfully', 'success');
                    this.loadBackupHistory();
                    this.updateStatistics();
                } else {
                    throw new Error(result.error || 'Delete failed');
                }
            } catch (error) {
                this.showNotification('Delete failed: ' + error.message, 'error');
            }
        }

        async updateStatistics() {
            try {
                const response = await fetch('/api/backup-db/backup/stats');
                const stats = await response.json();
                
                document.getElementById('successCount').textContent = stats.successfulBackups || 0;
                document.getElementById('storageUsed').textContent = this.formatFileSize(stats.totalStorage || 0);
                document.getElementById('lastBackup').textContent = stats.lastBackup ? 
                    this.formatDate(stats.lastBackup) : 'Never';
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        showProgressModal() {
            const modal = document.getElementById('progressModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        hideProgressModal() {
            const modal = document.getElementById('progressModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Initializing backup...';
        }

        showSuccessModal(message) {
            const modal = document.getElementById('successModal');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successTick = document.getElementById('successTick');
            const successMessage = document.getElementById('successMessage');

            loadingSpinner.classList.remove('hidden');
            successTick.classList.add('hidden');
            successMessage.textContent = 'Processing...';

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                loadingSpinner.classList.add('hidden');
                successTick.classList.remove('hidden');
                successMessage.textContent = message || 'Operation successful!';

                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 1500);
            }, 1500);
        }

        hideSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        showConfirmDelete(filename, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const confirmBtn = document.getElementById('confirmDelete');
            const cancelBtn = document.getElementById('cancelDelete');

            confirmBtn.onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        hideConfirmDelete() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        simulateProgress() {
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const steps = [
                'Connecting to database...',
                'Analyzing database structure...',
                'Exporting data...',
                'Compressing backup...',
                'Finalizing backup...'
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = steps[Math.floor(progress / 20)] || 'Completing backup...';
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 500);
        }

        cancelBackup() {
            this.hideProgressModal();
            this.showNotification('Backup cancelled', 'info');
        }

        showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `
            fixed 
            top-1/2 
            left-1/2 
            transform -translate-x-1/2 -translate-y-1/2
            ${colors[type]} 
            text-white 
            px-6 py-3 
            rounded-lg 
            shadow-lg 
            z-50 
            transition-all duration-300
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    }

    // Initialize
    const backupManager = new DatabaseBackup();
</script>
