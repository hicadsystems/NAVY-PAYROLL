<div class="p-6">
  <!-- Section Command Header -->
  <div class="flex flex-wrap justify-between mb-6">
    <h3 class="text-xl font-semibold text-gray-800">Command Management</h3>
    <div class="flex gap-2">
      <input type="text" id="searchSection" placeholder="Name or UnitCode..." class="border rounded px-3 py-2">
      <button id="addNewSectionBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Command</button>
    </div>
  </div>

  <!-- Hidden Section Command Form -->
  <form id="sectionForm" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Naval Command*</label>
      <input type="text" id="navalcmd" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter command">
    </div>
    <div class="">
      <label class="block text-sm font-medium text-gray-700">Name</label>
      <textarea id="name" class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white" placeholder="Enter name"></textarea>
    </div>
    <div class="col-span-1 md:col-span-2 flex justify-end gap-2">
      <button type="button" id="saveSectionBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save</button>
      <button type="button" id="cancelSectionBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
    </div>
  </form>

  <!-- Section Command Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="border px-2 py-3 text-left">Command</th>
          <th class="border px-2 py-3 text-left">Name</th>
          <th class="border px-2 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="sectionTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Success Modal -->
<div id="sectionSuccessModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-green-600 mb-2">Success!</h3>
    <p id="sectionSuccessMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button id="closeSectionSuccess" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">OK</button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="sectionErrorModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
    <p id="sectionErrorMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button id="closeSectionError" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">OK</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="sectionConfirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="confirmMessage" class="mb-4 text-gray-700">Are you sure you want to delete this section command?</p>
    <div class="flex justify-end gap-2">
      <button id="cancelSectionDelete" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      <button id="sectionConfirmAction" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
  let commandData = [];
  let editingSectionIndex = null;
  let pendingSectionDelete = null;

  function getAuthHeaders() {
    const token = localStorage.getItem("token");
    return {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    };
  }

  const sectionForm = document.getElementById("sectionForm");
  const addNewSectionBtn = document.getElementById("addNewSectionBtn");
  const saveSectionBtn = document.getElementById("saveSectionBtn");
  const cancelSectionBtn = document.getElementById("cancelSectionBtn");
  const sectionTableBody = document.getElementById("sectionTableBody");
  const searchSection = document.getElementById("searchSection");

  // Show form
  addNewSectionBtn.addEventListener("click", () => {
    sectionForm.classList.remove("hidden");
    editingSectionIndex = null;
    resetSectionForm();
  });

  async function loadCommand () {
    try{
      const res = await fetch('/cmd/command', {
      method : "GET",  
      headers: getAuthHeaders() });

      commandData = await res.json();

      renderSectionTable(commandData);

    } catch (err) {
      showSectionError("Error loading sections:", err);
    }
  }

  function renderSectionTable(data = commandData) {
    const tbody = document.getElementById("sectionTableBody");
    tbody.innerHTML = data.map((item, index) => `
      <tr class="hover:bg-gray-50">
        <td class="border px-2 py-3">${item.navalcmd}</td>
        <td class="border px-2 py-3">${item.name}</td>
        <td class="border px-2 py-3">
          <button onclick="editSection(${index})" class="text-green-600 hover:text-green-900 mr-2">Edit</button>
          <button onclick="deleteSection('${index}')" class="text-red-600 hover:text-red-900">Delete</button>
        </td>
      </tr>
    `).join("");
  }

  // Save record
  saveSectionBtn.addEventListener("click", async () => {
    const item = {
      navalcmd: document.getElementById('navalcmd').value.trim(),
      name: document.getElementById('name').value.trim(),
    };

    if (!item.navalcmd || !item.name){
      showSectionError('Naval Command and Name are required.');
      return;
    }

    try{

      if(editingSectionIndex !==null){
        await fetch(`/cmd/${commandData[editingSectionIndex].navalcmd}`, {
          method: "PUT",
          headers: getAuthHeaders(),
          body: JSON.stringify(item)        
        });
        showSectionSuccess("Command updated successfully!");
      } else{
        await fetch('/cmd/post-command', {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(item)        
        });        
        showSectionSuccess("Command created successfully!");
      }

      await loadCommand();
      sectionForm.classList.add("hidden");
      sectionForm.reset();
      editingSectionIndex = null; 

    } catch (err){
      showSectionError("Error saving command:", err);
    }
  });

  cancelSectionBtn.addEventListener("click", () => {
    sectionForm.classList.add("hidden");
    resetSectionForm();
    editingSectionIndex = null;
  });

  function resetSectionForm() {
    sectionForm.querySelectorAll("input, textarea").forEach(el => el.value = "");
  }


  window.editSection = function(index) {
    const item = commandData[index];
    document.getElementById("navalcmd").value = item.navalcmd;
    document.getElementById("name").value = item.name;
    editingSectionIndex = index;
    sectionForm.classList.remove("hidden");
  }

  window.deleteSection = function(index) {
    pendingSectionDelete = index;
     showConfirmModal("Are you sure you want to delete this command?");
  }

  document.getElementById("sectionConfirmAction").addEventListener("click", async () => {
    if (pendingSectionDelete !== null) {
      try {
        await fetch(`/cmd/${commandData[pendingSectionDelete].navalcmd}`, {
          method: "DELETE",
          headers: getAuthHeaders()        
        });
        showSectionSuccess("Command deleted successfully!");
        await loadCommand();
      } catch (err) {
        showSectionError("Error deleting command:", err);
      }
      pendingSectionDelete = null;
    }
    closeModal("sectionConfirmModal");
  });

  document.getElementById("cancelSectionDelete").addEventListener("click", () => {
    closeModal("sectionConfirmModal");
    pendingSectionDelete = null;
  });

  function showModal(modalId) {
    document.getElementById(modalId).classList.remove("hidden");
  }
  function closeModal(modalId) {
    document.getElementById(modalId).classList.add("hidden");
  }
  function showConfirmModal(message) {
    document.getElementById("confirmMessage").textContent = message;
    showModal("sectionConfirmModal");
  }
  function showSectionSuccess(msg) {
    document.getElementById("sectionSuccessMessage").textContent = msg;
    showModal("sectionSuccessModal");
  }
  function showSectionError(msg) {
    document.getElementById("sectionErrorMessage").textContent = msg;
    showModal("sectionErrorModal");
  }

  // close modal buttons
  document.getElementById("closeSectionSuccess").addEventListener("click", () => closeModal("sectionSuccessModal"));
  document.getElementById("closeSectionError").addEventListener("click", () => closeModal("sectionErrorModal"));

  // search
  searchSection.addEventListener("input", () => {
    const query = searchSection.value.toLowerCase();
    const filtered = commandData.filter(item =>
      item.name.toLowerCase().includes(query) || item.navalcmd.toLowerCase().includes(query)
    );
    renderSectionTable(filtered);
  });

  // init
  renderSectionTable();
  loadCommand();
</script>
