<div class="p-6 max-w-4xl mx-auto">
  <h2 class="text-gray-600 font-semibold mb-6 lg:text-lg">
    Select personnel and assign them to a new payroll class.
  </h2>

  <div class="space-y-4">
    <form id="changesForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Personnel select -->
        <div class="relative">
          <input 
            type="text" 
            id="searchInput"
            class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2"
            placeholder="Search by Name or Number..."
            autocomplete="off">
          <input type="hidden" id="hiddenInput">
          <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </span>
          
          <!-- Dropdown List -->
          <div id="dropdownList" class="absolute z-10 w-full mt-1 bg-yellow-50 border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
            <div class="py-1">
              <div class="px-3 py-2 text-center text-gray-500">Click to load employees...</div>
            </div>
          </div>
        </div>

        <!-- New Class select -->
        <select name="newClass" id="newClass"
            class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="">Select Payroll Class</option>
        </select>

        <!-- Empty spacer for alignment -->
        <div></div>

        <!-- Buttons row -->
        <div class="col-span-1 md:col-span-3 flex flex-wrap gap-2 justify-end">
            <button type="button" id="changeButton"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Change Payroll Class
            </button>
            <button type="button" id="clearButton"
            class="px-6 py-2 bg-gray-300 rounded-lg shadow hover:bg-gray-400 transition">
            Clear
            </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Current Selection Display -->
  <div id="selectionDisplay" class="mt-6 p-4 rounded-lg hidden">
    <h3 class="font-semibold text-gray-700 mb-2">Current Selection:</h3>
    <p id="selectionText" class="text-gray-600"></p>
  </div>

  <!-- Payroll Classes Management -->
  <div class="p-6 max-w-4xl mx-auto my-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Payroll Class Statistics</h2>
    <div id="classCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <div class="col-span-full text-center py-8">
        <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-500 mt-2">Loading statistics...</p>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Confirm Database Migration</h2>
    <p id="confirmMessage" class="text-gray-600 mb-4"></p>
    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4">
      <p class="text-sm text-yellow-800">
        <strong>⚠️ Warning:</strong> This will move all personnel data to the new database. This action cannot be undone.
      </p>
    </div>
    <div class="flex justify-end gap-3">
      <button id="cancelConfirm" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
      <button id="okConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Proceed</button>
    </div>
  </div>
</div>

<!-- Migration Progress Modal -->
<div id="migrationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-screen overflow-hidden">
    <!-- Header -->
    <div class="bg-navy text-white px-6 py-4">
      <h2 class="text-xl font-bold">Payroll Class Migration Progress</h2>
      <p class="text-sm text-blue-100 mt-1" id="migrationSubtitle">Migrating personnel between payroll classes...</p>
    </div>

    <!-- Progress Container -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
      <!-- Overall Progress Bar -->
      <div class="mb-6">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span>Overall Progress</span>
          <span id="overallProgress">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="overallProgressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>

      <!-- Migration Steps -->
      <div class="space-y-3" id="migrationSteps">
        <!-- Steps will be dynamically added here -->
      </div>

      <!-- Summary Section (hidden initially) -->
      <div id="migrationSummary" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="font-semibold text-gray-800 mb-3">Migration Summary</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Service No:</span>
            <span class="font-medium" id="summaryEmployeeId">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Personnel Name:</span>
            <span class="font-medium" id="summaryEmployeeName">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">From Payroll Class:</span>
            <span class="font-medium" id="summaryFromDb">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">To Payroll Class:</span>
            <span class="font-medium" id="summaryToDb">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Records Migrated:</span>
            <span class="font-medium" id="summaryRecordCount">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Duration:</span>
            <span class="font-medium" id="summaryDuration">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="flex flex-wrap justify-center items-center border-t border-gray-200 px-6 py-4 bg-gray-50">
      <button id="closeMigration" class="hidden w-fit px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-red-600">Error</h2>
    </div>
    <p id="errorMessage" class="text-gray-600 mb-6"></p>
    <div class="flex justify-end">
      <button id="closeError" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Close</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = '/payroll-change';
  const token = localStorage.getItem('token');

  // State management
  let allEmployees = [];
  let payrollClasses = {};
  let selectedEmployee = null;
  let currentClass = null;
  let newClass = null;
  let isLoading = false;
  let migrationStartTime = null;

  // DOM elements
  const searchInput = document.getElementById('searchInput');
  const hiddenInput = document.getElementById('hiddenInput');
  const dropdownList = document.getElementById('dropdownList');
  const newClassSelect = document.getElementById('newClass');
  const selectionDisplay = document.getElementById('selectionDisplay');
  const selectionText = document.getElementById('selectionText');
  const changeButton = document.getElementById('changeButton');

  // API helper
  async function apiRequest(url, options = {}) {
    try {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || data.message || `HTTP ${response.status}`);
      }

      return data;
    } catch (error) {
      throw error;
    }
  }

  // Show error modal
  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').classList.remove('hidden');
  }

  document.getElementById('closeError').addEventListener('click', () => {
    document.getElementById('errorModal').classList.add('hidden');
  });

  // ==================== MIGRATION PROGRESS FUNCTIONS ====================
  
  function showMigrationModal() {
    migrationStartTime = Date.now();
    document.getElementById('migrationModal').classList.remove('hidden');
    document.getElementById('migrationSteps').innerHTML = '';
    document.getElementById('overallProgressBar').style.width = '0%';
    document.getElementById('overallProgress').textContent = '0%';
    document.getElementById('migrationSummary').classList.add('hidden');
    document.getElementById('closeMigration').classList.add('hidden');
  }

  function addMigrationStep(title, status = 'pending') {
    const step = document.createElement('div');
    step.className = 'flex items-start gap-3 p-3 rounded-lg border transition-all';
    step.id = `step-${Date.now()}-${Math.random()}`;
    
    const icons = {
      pending: '<div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>',
      processing: '<div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>',
      success: '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div>',
      error: '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></div>',
      warning: '<div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>'
    };
    
    const colors = {
      pending: 'border-gray-200 bg-white',
      processing: 'border-blue-200 bg-blue-50',
      success: 'border-green-200 bg-green-50',
      error: 'border-red-200 bg-red-50',
      warning: 'border-yellow-200 bg-yellow-50'
    };
    
    step.className += ` ${colors[status]}`;
    step.innerHTML = `
      <div class="flex-shrink-0 mt-0.5">${icons[status]}</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${title}</p>
        <p class="text-sm text-gray-500 mt-1 step-detail hidden"></p>
      </div>
    `;
    
    document.getElementById('migrationSteps').appendChild(step);
    return step.id;
  }

  function updateMigrationStep(stepId, status, detail = '') {
    const step = document.getElementById(stepId);
    if (!step) return;
    
    const icons = {
      pending: '<div class="w-6 h-6 border-2 border-gray-300 rounded-full"></div>',
      processing: '<div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>',
      success: '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div>',
      error: '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></div>',
      warning: '<div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>'
    };
    
    const colors = {
      pending: 'border-gray-200 bg-white',
      processing: 'border-blue-200 bg-blue-50',
      success: 'border-green-200 bg-green-50',
      error: 'border-red-200 bg-red-50',
      warning: 'border-yellow-200 bg-yellow-50'
    };
    
    step.className = `flex items-start gap-3 p-3 rounded-lg border transition-all ${colors[status]}`;
    step.querySelector('.flex-shrink-0').innerHTML = icons[status];
    
    if (detail) {
      const detailEl = step.querySelector('.step-detail');
      detailEl.textContent = detail;
      detailEl.classList.remove('hidden');
    }
  }

  function updateOverallProgress(percent) {
    document.getElementById('overallProgressBar').style.width = `${percent}%`;
    document.getElementById('overallProgress').textContent = `${Math.round(percent)}%`;
  }

  function showMigrationSummary(data) {
    const duration = ((Date.now() - migrationStartTime) / 1000).toFixed(1);
    
    document.getElementById('summaryEmployeeId').textContent = data.Empl_ID;
    document.getElementById('summaryEmployeeName').textContent = data.Name;
    document.getElementById('summaryFromDb').textContent = data.SourceDatabase; // Already friendly name from backend
    document.getElementById('summaryToDb').textContent = data.TargetDatabase; // Already friendly name from backend
    document.getElementById('summaryRecordCount').textContent = data.RecordsCopied || 'N/A';
    document.getElementById('summaryDuration').textContent = `${duration}s`;
    
    document.getElementById('migrationSummary').classList.remove('hidden');
    document.getElementById('closeMigration').classList.remove('hidden');
  }

  // ==================== LOAD PERSONNEL WITH DROPDOWN ====================
  async function loadPersonnel() {
    if (isLoading) return;
    if (allEmployees.length > 0) return;
    
    isLoading = true;
    
    dropdownList.innerHTML = `
      <div class="py-1">
        <div class="px-3 py-4 text-center text-gray-500">
          <svg class="animate-spin h-5 w-5 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Loading employees...
        </div>
      </div>
    `;
    
    try {
      const result = await apiRequest(`${API_BASE}/active-employees`);
      allEmployees = result.data || result.employees || result.results || (Array.isArray(result) ? result : []);
      
      if (allEmployees.length === 0) {
        dropdownList.innerHTML = `
          <div class="py-1">
            <div class="px-3 py-4 text-center text-gray-500">No employees found</div>
          </div>
        `;
      } else {
        renderDropdown(allEmployees);
      }
      
    } catch (error) {
      console.error('Error fetching employees:', error);
      dropdownList.innerHTML = `
        <div class="py-1">
          <div class="px-3 py-4 text-center text-red-500">
            Failed to load employees<br>
            <span class="text-xs">${error.message}</span>
          </div>
        </div>
      `;
    } finally {
      isLoading = false;
    }
  }

  function renderDropdown(employees) {
    if (!employees || employees.length === 0) {
      dropdownList.innerHTML = `
        <div class="py-1">
          <div class="px-3 py-4 text-center text-gray-500">No employees found</div>
        </div>
      `;
      return;
    }

    const html = employees.map(emp => {
      const id = emp.Empl_ID || emp.EMPL_ID || emp.id || 'N/A';
      const surname = emp.Surname || emp.surname || '';
      const otherName = emp.OtherName || emp.otherName || '';
      const name = `${surname} ${otherName}`.trim() || emp.name || 'Unknown';
      const rank = emp.Title || emp.title || emp.rank || '';
      const payrollClass = emp.payrollclass || emp.PayrollClass || emp.PAYROLLCLASS || '';
      
      return `
        <div class="dropdown-item px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100" 
             data-value="${id}" 
             data-name="${name}"
             data-class="${payrollClass}">
          <span class="font-semibold text-blue-600">${id}</span> - ${name}
          ${rank ? `<span class="text-gray-500 text-sm ml-1">(${rank})</span>` : ''}
        </div>
      `;
    }).join('');

    dropdownList.innerHTML = `<div class="py-1">${html}</div>`;
    attachDropdownHandlers();
  }

  function attachDropdownHandlers() {
    const dropdownItems = dropdownList.querySelectorAll('.dropdown-item');
    
    dropdownItems.forEach(item => {
      item.addEventListener('click', function() {
        const id = this.getAttribute('data-value');
        const name = this.getAttribute('data-name');
        const payrollClass = this.getAttribute('data-class');
        const text = this.textContent.trim();
        
        const employee = allEmployees.find(emp => 
          (emp.Empl_ID || emp.EMPL_ID || emp.id) === id
        );
        
        const actualClass = employee ? (
          employee.payrollclass || 
          employee.PayrollClass || 
          employee.PAYROLLCLASS ||
          employee.payroll_class ||
          payrollClass ||
          null
        ) : payrollClass;
        
        selectedEmployee = {
          Empl_ID: id,
          Fullname: name,
          PayrollClass: actualClass
        };
        
        currentClass = actualClass;
        
        searchInput.value = text;
        hiddenInput.value = id;
        dropdownList.classList.add('hidden');
        
        const currentClassName = getClassName(currentClass);
        selectionDisplay.classList.remove('hidden');
        selectionText.textContent = `Selected personnel ${id} (${name}) is on ${currentClassName}`;
        
        if (currentClass && currentClass !== 'N/A' && currentClass !== '' && currentClass !== null) {
          const matchingOption = Array.from(newClassSelect.options)
            .find(opt => opt.value === currentClass);

          if (matchingOption) {
            newClassSelect.value = currentClass;
          } else {
            newClassSelect.value = '';
          }
        } else {
          newClassSelect.value = '';
        }
      });
    });
  }

  function filterDropdown(searchText) {
    if (allEmployees.length === 0) return;
    
    const searchTerm = searchText.toLowerCase();
    
    if (!searchTerm) {
      renderDropdown(allEmployees);
    } else {
      const filtered = allEmployees.filter(emp => {
        const id = (emp.Empl_ID || emp.EMPL_ID || emp.id || '').toString().toLowerCase();
        const surname = (emp.Surname || emp.surname || '').toLowerCase();
        const otherName = (emp.OtherName || emp.otherName || '').toLowerCase();
        const name = `${surname} ${otherName}`.toLowerCase();
        const rank = (emp.Title || emp.title || emp.rank || '').toLowerCase();
        
        return id.includes(searchTerm) || 
               surname.includes(searchTerm) || 
               otherName.includes(searchTerm) ||
               name.includes(searchTerm) || 
               rank.includes(searchTerm);
      });
      
      renderDropdown(filtered);
    }
    
    dropdownList.classList.remove('hidden');
  }

  async function loadPayrollClasses() {
    try {
      const result = await apiRequest(`/payroll-setup`);
      const classes = result.data || [];

      newClassSelect.innerHTML = '<option value="">Select Payroll Class</option>';

      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.classcode;
        option.textContent = cls.classname 
          ? `${cls.classcode} - ${cls.classname}` 
          : cls.classcode;
        newClassSelect.appendChild(option);

        payrollClasses[cls.classcode] = {
          classname: cls.classname || cls.classcode
        };
      });

    } catch (error) {
      console.error('Error loading payroll classes:', error);
    }
  }

  async function loadClassStatistics() {
    try {
      const result = await apiRequest(`${API_BASE}/payroll-class-stats`);
      const stats = result.data || {};
      
      Object.keys(payrollClasses).forEach(code => {
        if (payrollClasses[code]) {
          payrollClasses[code].count = 0;
        }
      });
      
      Object.entries(stats).forEach(([code, data]) => {
        if (payrollClasses[code]) {
          payrollClasses[code].count = data.count;
        } else {
          payrollClasses[code] = data;
        }
      });
      
      renderClassCards();
    } catch (error) {
      console.error('Error loading class statistics:', error);
      renderClassCards();
    }
  }

  function renderClassCards() {
    const container = document.getElementById('classCards');
    
    if (Object.keys(payrollClasses).length === 0) {
      container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No statistics available</p>';
      return;
    }

    const classesWithPersonnel = Object.entries(payrollClasses).filter(([code, data]) => {
      const count = data.count || 0;
      return count > 0;
    });

    if (classesWithPersonnel.length === 0) {
      container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No personnel assigned to any class</p>';
      return;
    }

    container.innerHTML = classesWithPersonnel.map(([code, data]) => `
      <div class="border border-gray-200 rounded-lg p-4 text-center shadow-sm hover:shadow-md transition">
        <h3 class="font-semibold text-blue-600">${data.classname || code}</h3>
        <p class="text-sm text-gray-600 mt-1">${data.count} Personnel</p>
      </div>
    `).join('');
  }

  function getClassName(code) {
    if (!code || code === 'N/A' || code === '' || code === null) return 'Not Assigned';
    const cls = payrollClasses[code];
    if (!cls) return code;
    return cls.classname || code;
  }

  newClassSelect.addEventListener('change', () => {
    newClass = newClassSelect.value;
    if (selectedEmployee && newClass) {
      const name = selectedEmployee.Fullname || '';
      const fromName = getClassName(currentClass);
      const toName = getClassName(newClass);
      selectionText.textContent = `You want to migrate ${selectedEmployee.Empl_ID} (${name}) from ${fromName} to ${toName}`;
    }
  });

  changeButton.addEventListener('click', () => {
    if (!selectedEmployee || !newClass) {
      showError('Please select both personnel and new payroll class.');
      return;
    }
    if (currentClass === newClass) {
      showError('Personnel is already in the selected class.');
      return;
    }

    const name = selectedEmployee.Fullname || '';
    const fromName = getClassName(currentClass);
    const toName = getClassName(newClass);

    document.getElementById('confirmMessage').textContent =
      `Migrate ${selectedEmployee.Empl_ID} (${name}) from ${fromName} to ${toName}?`;
    document.getElementById('confirmModal').classList.remove('hidden');
  });

  document.getElementById('cancelConfirm').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.add('hidden');
  });

  document.getElementById('okConfirm').addEventListener('click', async () => {
    document.getElementById('confirmModal').classList.add('hidden');
    showMigrationModal();

    const fromDb = currentClass;
    const toDb = newClass;

    try {
      // Step 1: Verify employee
      const step1 = addMigrationStep('Verifying personnel in source payroll class...', 'processing');
      updateOverallProgress(10);
      await new Promise(resolve => setTimeout(resolve, 500));
      updateMigrationStep(step1, 'success', `Personnel ${selectedEmployee.Empl_ID} verified`);

      // Step 2: Check target database
      const step2 = addMigrationStep('Checking target payroll class...', 'processing');
      updateOverallProgress(20);
      await new Promise(resolve => setTimeout(resolve, 500));
      updateMigrationStep(step2, 'success', 'Target payroll class is ready');

      // Step 3: Clearing existing records (if any)
      const step3 = addMigrationStep('Clearing existing records in target payroll class...', 'processing');
      updateOverallProgress(30);
      await new Promise(resolve => setTimeout(resolve, 500));
      updateMigrationStep(step3, 'success', 'No existing records found or cleared successfully');

      // Step 4: Copying employee record
      const step4 = addMigrationStep('Copying personnel record to target payroll class...', 'processing');
      updateOverallProgress(40);
      await new Promise(resolve => setTimeout(resolve, 500));
      updateMigrationStep(step4, 'success', 'Personnel record copied successfully');

      // Step 5: Copying related records
      const step5 = addMigrationStep('Copying related records (payroll, etc.)...', 'processing');
      updateOverallProgress(50);
      
      // Make the actual API call
      const result = await apiRequest(`${API_BASE}/payroll-class`, {
        method: 'POST',
        body: JSON.stringify({
          Empl_ID: selectedEmployee.Empl_ID,
          PayrollClass: newClass
        })
      });

      updateOverallProgress(70);
      
      if (result.success !== false) {
        const recordCount = result.data?.RecordsCopied || 'Multiple';
        updateMigrationStep(step5, 'success', `${recordCount} records copied successfully`);

        // Step 6: Deleting from source
        const step6 = addMigrationStep('Removing records from source payroll class...', 'processing');
        updateOverallProgress(85);
        await new Promise(resolve => setTimeout(resolve, 500));
        updateMigrationStep(step6, 'success', 'All records removed from source payroll class');

        // Step 7: Finalizing
        const step7 = addMigrationStep('Finalizing migration...', 'processing');
        updateOverallProgress(95);
        await new Promise(resolve => setTimeout(resolve, 500));
        updateMigrationStep(step7, 'success', 'Migration completed successfully');

        updateOverallProgress(100);

        // Update local data
        const employeeIndex = allEmployees.findIndex(emp => 
          (emp.Empl_ID || emp.EMPL_ID || emp.id) === selectedEmployee.Empl_ID
        );

        if (employeeIndex !== -1) {
          allEmployees[employeeIndex].payrollclass = newClass;
        }

        selectedEmployee.PayrollClass = newClass;
        currentClass = newClass;

        // Show summary - use data from backend
        showMigrationSummary({
          Empl_ID: result.data.Empl_ID,
          Name: result.data.Name,
          SourceDatabase: result.data.SourceDatabaseName || getClassName(fromDb),
          TargetDatabase: result.data.TargetDatabaseName || getClassName(toDb),
          RecordsCopied: result.data.RecordsCopied
        });

        // Reload statistics
        await loadClassStatistics();
        allEmployees = []; // Clear cache to force reload
        loadPersonnel();

        const currentClassName = getClassName(currentClass);
        selectionText.textContent = 
          `Selected personnel ${selectedEmployee.Empl_ID} (${selectedEmployee.Fullname}) is now on ${currentClassName}`;

        // Update subtitle
        document.getElementById('migrationSubtitle').textContent = '✅ Migration completed successfully!';
        document.getElementById('migrationSubtitle').classList.add('text-green-200');

      } else {
        throw new Error(result.error || 'Migration failed');
      }

    } catch (error) {
      console.error('Migration error:', error);
      
      // Add error step
      const errorStep = addMigrationStep('Migration failed', 'error');
      updateMigrationStep(errorStep, 'error', error.message || 'Unknown error occurred');
      
      document.getElementById('migrationSubtitle').textContent = '❌ Migration failed';
      document.getElementById('migrationSubtitle').classList.add('text-red-200');
      
      // Show close button even on error
      document.getElementById('closeMigration').classList.remove('hidden');
      document.getElementById('closeMigration').textContent = 'Close';
      document.getElementById('closeMigration').classList.remove('bg-green-600', 'hover:bg-green-700');
      document.getElementById('closeMigration').classList.add('bg-red-600', 'hover:bg-red-700');
      
      showError(`Migration failed: ${error.message}`);
    }
  });

  document.getElementById('closeMigration').addEventListener('click', () => {
    document.getElementById('migrationModal').classList.add('hidden');
    // Reset button styling for next use
    document.getElementById('closeMigration').classList.remove('bg-red-600', 'hover:bg-red-700');
    document.getElementById('closeMigration').classList.add('bg-green-600', 'hover:bg-green-700');
    document.getElementById('migrationSubtitle').classList.remove('text-green-200', 'text-red-200');
  });

  document.getElementById('clearButton').addEventListener('click', () => {
    searchInput.value = '';
    hiddenInput.value = '';
    newClassSelect.value = '';
    selectionDisplay.classList.add('hidden');
    selectionText.textContent = '';
    dropdownList.classList.add('hidden');
    
    selectedEmployee = null;
    currentClass = null;
    newClass = null;
  });

  // Event listeners
  searchInput.addEventListener('focus', () => {
    if (allEmployees.length === 0) {
      loadPersonnel();
    }
    dropdownList.classList.remove('hidden');
  });

  searchInput.addEventListener('input', function() {
    const searchText = this.value.toLowerCase();
    
    if (allEmployees.length === 0) {
      loadPersonnel().then(() => {
        filterDropdown(searchText);
      });
    } else {
      filterDropdown(searchText);
    }
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
      dropdownList.classList.add('hidden');
    }
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' || e.key === 'Delete') {
      selectedEmployee = null;
      hiddenInput.value = '';
      currentClass = null;
      selectionDisplay.classList.add('hidden');
    }
  });

  // Initialize
  async function initialize() {
    await loadPayrollClasses();
    await loadClassStatistics();
  }

  initialize();
</script>