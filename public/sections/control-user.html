<div class="p-6">
  <div class="flex items-center justify-between mb-6">
    <h3 id="page-title" class="text-lg font-semibold text-gray-900">Current Users</h3>
    <div class="flex items-center gap-3">
      <input id="personnel-search" placeholder="Search..." class="px-3 py-2 border rounded w-56" />
      <button onclick="window.navigation?.navigateToSection?.('create-user','Create User')"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        Add New User
      </button>
    </div>
  </div>

  <div id="view-root">
    <!-- TABLE VIEW -->
    <div id="table-view">
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th class="border border-gray-300 px-4 py-3 text-left font-medium">User ID</th>
              <th class="border border-gray-300 px-4 py-3 text-left font-medium">Full Name</th>
              <th class="border border-gray-300 px-4 py-3 text-left font-medium">Role</th>
              <th class="border border-gray-300 px-4 py-3 text-left font-medium">Status</th>
              <th class="border border-gray-300 px-4 py-3 text-center font-medium">Actions</th>
            </tr>
          </thead>
          <tbody id="personnel-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- EDIT FORM (replaces table when active) -->
    <div id="edit-view" class="hidden p-6">

      <form id="edit-user-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
            <input type="text" name="user_id" readonly  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
            <input type="text" name="full_name" required  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
            <input type="email" name="email" required  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">User Role *</label>
            <select name="user_role" required  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Role...</option>
              <option value="hicad">HICAD</option>
              <option value="data entry">Data Entry</option>
              <option value="operator">Operator</option>
              <option value="processor">Processor</option>
              <option value="manager">Manager</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select name="status"  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Status...</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
            <input type="tel" name="phone_number"  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
            <input type="date" name="expiry_date"  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button type="submit" id="submit-edit-btn" class="px-4 py-2 bg-green-600 text-white rounded">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="viewEmployeeModal" class="fixed inset-0 hidden flex items-center justify-center z-50">
    <div id="viewEmployeeBackdrop" class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative bg-white rounded-lg shadow-lg w-11/12 max-w-lg p-6 z-10 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start">
        <h3 class="text-lg font-semibold text-blue-600">User Details</h3>
        <button id="close-view-modal" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>

      <div id="viewEmployeeContent" class="mt-4 space-y-2 text-gray-700"></div>

      <div class="flex justify-end mt-6">
        <button id="view-modal-close-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Close</button>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="successPopup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">
    <div class="bg-white p-6 rounded shadow flex items-center space-x-3">
      <div id="successSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
      <span id="successMessage" class="text-gray-700">Processing...</span>
    </div>
  </div>
</div>

<script>
class PersonnelManager {
  constructor() {
    this.personnel = [];
    this.filtered = [];
    this.editingUserId = null;
    this.cache();
    this.bindUI();
    this.load();
  }

  cache() {
    this.tableBody = document.getElementById('personnel-table-body');
    this.tableView = document.getElementById('table-view');
    this.editView = document.getElementById('edit-view');
    this.editForm = document.getElementById('edit-user-form');
    this.search = document.getElementById('personnel-search');
    this.backBtn = document.getElementById('back-to-list');
    this.cancelBtn = document.getElementById('cancel-edit-btn');
    this.submitBtn = document.getElementById('submit-edit-btn');
    this.successPopup = document.getElementById('successPopup');
    this.successSpinner = document.getElementById('successSpinner');
    this.successMessage = document.getElementById('successMessage');

    // view modal elements
    this.viewModal = document.getElementById('viewEmployeeModal');
    this.viewBackdrop = document.getElementById('viewEmployeeBackdrop');
    this.viewContent = document.getElementById('viewEmployeeContent');
    this.viewCloseBtn = document.getElementById('close-view-modal');
    this.viewCloseBtn2 = document.getElementById('view-modal-close-btn');
  }

  bindUI() {
    this.search?.addEventListener('input', () => this.onSearch());
    this.backBtn?.addEventListener('click', () => this.showList());
    this.cancelBtn?.addEventListener('click', () => this.showList());

    // edit form submit - ensure single handler
    if (this.editForm) {
      if (this.editForm._handler) this.editForm.removeEventListener('submit', this.editForm._handler);
      this.editForm._handler = this.onEditSubmit.bind(this);
      this.editForm.addEventListener('submit', this.editForm._handler);
    }

    // view modal handlers
    this.viewBackdrop?.addEventListener('click', () => this.hideViewModal());
    this.viewCloseBtn?.addEventListener('click', () => this.hideViewModal());
    this.viewCloseBtn2?.addEventListener('click', () => this.hideViewModal());
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.hideViewModal(); });
  }

  async load() {
    try {
      const res = await fetch('/api/users');
      const data = await res.json();
      this.personnel = Array.isArray(data) ? data : [];
    } catch (err) {
      console.error('Failed to load users', err);
      this.personnel = [];
    }
    this.filtered = [...this.personnel];
    this.renderTable();
  }

  onSearch() {
    const q = (this.search?.value || '').toLowerCase();
    this.filtered = this.personnel.filter(u =>
      (u.full_name || '').toLowerCase().includes(q) ||
      (u.user_id || '').toLowerCase().includes(q)
    );
    this.renderTable();
  }

  renderTable() {
    if (!this.tableBody) return;

    if (!this.filtered || this.filtered.length === 0) {
      this.tableBody.innerHTML = `
        <tr>
          <td class="px-4 py-6 text-center text-gray-500" colspan="5">No records found</td>
        </tr>`;
      return;
    }

    this.tableBody.innerHTML = this.filtered.map(u => `
      <tr>
        <td class="border border-gray-300 px-4 py-3 text-left">${u.user_id || ''}</td>
        <td class="border border-gray-300 px-4 py-3 text-left font-medium text-navy">${u.full_name || ''}</td>
        <td class="border border-gray-300 px-4 py-3 text-left">${u.user_role || ''}</td>
        <td class="border border-gray-300 px-4 py-3 text-left">
          <span class="inline-block px-2 py-1 text-xs rounded-full ${this.statusClass(u.status)}">
            ${u.status ? (u.status.charAt(0).toUpperCase() + u.status.slice(1)) : ''}
          </span>
        </td>
        <td class="border border-gray-300 px-4 py-3 text-left text-center">
          <button onclick="window.personnelManager.viewUser('${u.user_id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded mr-1">View</button>
          <button onclick="window.personnelManager.startEdit('${u.user_id}')" class="px-2 py-1 bg-green-600 text-white text-xs rounded mr-1">Edit</button>
          <button onclick="window.personnelManager.deleteUser('${u.user_id}')" class="px-2 py-1 bg-red-600 text-white text-xs rounded">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  statusClass(status) {
    switch (status) {
      case 'active': return 'bg-green-100 text-green-800';
      case 'inactive': return 'bg-red-100 text-red-800';
      case 'suspended': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }

  viewUser(id) {
    const u = this.personnel.find(x => x.user_id === id);
    if (!u) {
      // try fetch single user
      fetch(`/api/users/${encodeURIComponent(id)}`).then(r => {
        if (!r.ok) throw r;
        return r.json();
      }).then(data => { this.showUserModal(data); }).catch(()=> alert('User not found'));
      return;
    }
    this.showUserModal(u);
  }

  showUserModal(user) {
    if (!this.viewModal || !this.viewContent) return;
    const rows = [
      ['User ID', user.user_id || ''],
      ['Full name', user.full_name || ''],
      ['Email', user.email || ''],
      ['Role', user.user_role || ''],
      ['Status', user.status || ''],
      ['Phone', user.phone_number || ''],
      ['Expiry Date', user.expiry_date ? new Date(user.expiry_date).toLocaleDateString() : '']
    ];
    this.viewContent.innerHTML = rows.map(r => `<div class="grid grid-cols-3 gap-2 py-2 border-b border-gray-200">
        <dt class="font-medium text-gray-600"><strong class="block text-sm text-gray-700">${r[0]}:</strong></dt>
        <dd class="col-span-2 text-gray-800">${r[1]}</dd>
      </div>`).join('');
    this.viewModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  hideViewModal() {
    if (!this.viewModal) return;
    this.viewModal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  async startEdit(id) {
    let user = this.personnel.find(x => x.user_id === id);
    if (!user) {
      try {
        const res = await fetch(`/api/users/${encodeURIComponent(id)}`);
        if (res.ok) user = await res.json();
      } catch (e) { /* ignore */ }
    }
    if (!user) return alert('User not found');
    this.editingUserId = id;
    this.fillForm(user);
    this.showEdit();
  }

  fillForm(user) {
    if (!this.editForm) return;
    const f = this.editForm;
    f.elements['user_id'].value = user.user_id || '';
    f.elements['full_name'].value = user.full_name || '';
    f.elements['email'].value = user.email || '';
    f.elements['user_role'].value = user.user_role || '';
    f.elements['status'].value = user.status || '';
    f.elements['phone_number'].value = user.phone_number || '';
    f.elements['expiry_date'].value = user.expiry_date ? new Date(user.expiry_date).toISOString().slice(0,10) : '';
    this.submitBtn?.removeAttribute('disabled');
  }

  showEdit() {
    this.tableView.classList.add('hidden');
    this.editView.classList.remove('hidden');
    document.getElementById('page-title').textContent = 'Edit User';
    window.scrollTo({ top: this.editView.offsetTop || 0, behavior: 'smooth' });
  }

  showList() {
    this.editingUserId = null;
    this.editView.classList.add('hidden');
    this.tableView.classList.remove('hidden');
    document.getElementById('page-title').textContent = 'Current Users';
    this.editForm?.reset();
    this.renderTable();
  }

  async onEditSubmit(e) {
    e.preventDefault();
    if (!this.editingUserId) {
      alert('Not in edit mode. Use Create User page to add users.');
      return;
    }
    const btn = this.submitBtn;
    btn.disabled = true;

    const f = this.editForm;

    // build raw values from form
    const raw = {
      full_name: f.elements['full_name'].value.trim(),
      email: f.elements['email'].value.trim(),
      user_role: f.elements['user_role'].value,
      status: f.elements['status'].value,
      phone_number: f.elements['phone_number'].value.trim(),
      expiry_date: f.elements['expiry_date'].value || null,
      // include password only if user filled it (do NOT send empty string or null)
      ...(f.elements['password'] && f.elements['password'].value.trim() ? { password: f.elements['password'].value.trim() } : {})
    };

    // remove keys with empty string or explicit null for fields we don't want to overwrite
    const payload = {};
    Object.entries(raw).forEach(([k, v]) => {
      if (v !== '' && v !== null && typeof v !== 'undefined') payload[k] = v;
    });

    try {
      const res = await fetch(`/api/users/${encodeURIComponent(this.editingUserId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const ct = res.headers.get?.('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : null;

      if (res.ok) {
        const updated = (data && data.user) ? data.user : Object.assign({ user_id: this.editingUserId }, payload);
        const idx = this.personnel.findIndex(p => p.user_id === updated.user_id);
        if (idx > -1) this.personnel[idx] = updated;
        else this.personnel.unshift(updated);
        this.filtered = [...this.personnel];
        this.showSuccess('User Updated Successfully!');
        this.showList();
      } else {
        const msg = (data && (data.error || data.message)) || 'Update failed';
        alert('❌ ' + msg);
      }
    } catch (err) {
      console.error('Edit error', err);
      alert('❌ Server error');
    } finally {
      btn.disabled = false;
    }
  }

  async deleteUser(id) {
    if (!confirm('Are you sure?')) return;
    try {
      const res = await fetch(`/api/users/${encodeURIComponent(id)}`, { method: 'DELETE' });
      if (res.ok) {
        this.personnel = this.personnel.filter(p => p.user_id !== id);
        this.filtered = [...this.personnel];
        this.renderTable();
        this.showSuccess('User deleted');
      } else {
        const txt = await res.json().catch(()=>({error:'Delete failed'}));
        alert('❌ ' + (txt.error || txt.message));
      }
    } catch (err) {
      console.error('Delete user', err);
      alert('❌ Server error');
    }
  }

  showSuccess(message) {
    if (!this.successPopup) return;
    this.successMessage.textContent = message || 'Success';
    this.successSpinner?.classList.remove('hidden');
    this.successPopup.classList.remove('hidden');
    setTimeout(()=> {
      this.successSpinner?.classList.add('hidden');
      this.successMessage.innerHTML = `<span class="text-green-600 font-semibold">✔ ${message}</span>`;
    }, 1000);
    setTimeout(()=> {
      this.successPopup.classList.add('hidden');
      this.successSpinner?.classList.remove('hidden');
      this.successMessage.textContent = 'Processing...';
    }, 3000);
  }
}

window.personnelManager = new PersonnelManager();
</script>