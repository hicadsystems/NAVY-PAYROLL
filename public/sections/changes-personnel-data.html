<div class="p-6">
  <!-- Top Info Bar -->
  <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg no-print">
    <div class="flex items-start">
      <i class="fas fa-info-circle text-blue-500 text-2xl mr-3 mt-1"></i>
      <div>
        <h3 class="text-lg font-semibold text-blue-900 mb-1">Personnel Details Comparison</h3>
        <p class="text-sm text-blue-700">Compare historical personnel records from py_emplhistory with current records from hr_employees. Generate separate reports for previous and current details.</p>
      </div>
    </div>
  </div>

  <!-- Report Type Tabs -->
  <div id="reportTypeTabs" class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 flex flex-wrap gap-2 p-3 mb-6 rounded-xl shadow-sm no-print">
    <button id="previousReportTab" class="flex-1 px-4 py-3 text-sm lg:text-base font-semibold rounded-lg bg-white text-blue-900 shadow-md border-2 border-blue-500 transition-all duration-200">
      <i class="fas fa-history mr-2"></i>Previous Details Report
    </button>
    <button id="currentReportTab" class="flex-1 px-4 py-3 text-sm lg:text-base font-semibold rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">
      <i class="fas fa-file-alt mr-2"></i>Current Details Report
    </button>
  </div>

  <!-- Previous Report Section -->
  <div id="previousReportSection" class="space-y-6">
    <!-- Filter Tabs for Previous Report -->
    <div class="bg-yellow-50/50 border-2 border-yellow-200 flex flex-wrap gap-2 p-2 rounded-lg no-print">
      <button id="prevAllToggle" class="flex-1 px-3 py-2 text-sm lg:text-base font-medium rounded-lg bg-yellow-100 text-gray-900 shadow transition-colors duration-200">
        <i class="fas fa-users mr-2"></i>All Personnel
      </button>
      <button id="prevPersonnelToggle" class="flex-1 px-3 py-2 text-sm lg:text-base font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
        <i class="fas fa-user mr-2"></i>By Personnel
      </button>
    </div>

    <!-- Filter Form for Previous Report -->
    <div id="prevFilterForm" class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-sm no-print">
      <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-filter mr-2 text-blue-600"></i>Filter Options
      </h4>

      <!-- Period Range (Always visible) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="prevStartPeriod" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-calendar-alt mr-1"></i>Start Period <span class="text-red-500">*</span>
          </label>
          <select id="prevStartPeriod" class="w-full border-2 border-gray-300 rounded-lg shadow-sm px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Select Start Period</option>
          </select>
        </div>
        
        <div>
          <label for="prevEndPeriod" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-calendar-check mr-1"></i>End Period
          </label>
          <select id="prevEndPeriod" class="w-full border-2 border-gray-300 rounded-lg shadow-sm px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Select End Period (Optional)</option>
          </select>
        </div>
      </div>

      <!-- Personnel Selection (Hidden by default, shown in "By Personnel" mode) -->
      <div id="prevPersonnelWrapper" class="hidden mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-search mr-1"></i>Select Personnel <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          <input 
            type="text" 
            id="prevSearchInput"
            class="w-full border-2 border-blue-400 focus:border-yellow-500 bg-transparent rounded-lg px-4 py-3 pr-10"
            placeholder="Search by Name or Service Number..."
            autocomplete="off">
          <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400"></i>
        </div>
        <div id="prevDropdownList" class="absolute z-10 w-full mt-1 bg-white border-2 border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
          <div class="py-1" id="prevEmployeeDropdown"></div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button id="prevClearBtn" class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all shadow">
          <i class="fas fa-eraser mr-2"></i>Clear
        </button>
        <button id="prevLoadBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg">
          <i class="fas fa-file-import mr-2"></i>Load Previous Report
        </button>
      </div>
    </div>

    <!-- Previous Report Results -->
    <div id="prevResults" class="hidden">
      <!-- Export Buttons -->
      <div class="flex justify-between items-center mb-4 no-print">
        <h3 class="text-xl font-bold text-navy flex items-center">
          <i class="fas fa-table mr-2"></i>Previous Personnel Details
        </h3>
        <div class="flex gap-2">
          <button id="prevExportExcel" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition shadow">
            <i class="fas fa-file-excel mr-2"></i>Excel
          </button>
          <button id="prevExportPdf" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition shadow">
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
          <button id="prevPrint" class="px-4 py-2 bg-gray-700 text-white text-sm rounded-lg hover:bg-gray-800 transition shadow">
            <i class="fas fa-print mr-2"></i>Print
          </button>
        </div>
      </div>

      <!-- Results Table -->
      <div class="overflow-x-auto rounded-lg border-2 border-gray-200 shadow">
        <table class="min-w-full text-sm">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="border border-blue-500 px-3 py-3 text-left">Period</th>
              <th class="border border-blue-500 px-3 py-3 text-left">Service No</th>
              <th class="border border-blue-500 px-3 py-3 text-left">Full Name</th>
              <th class="border border-blue-500 px-3 py-3 text-left">Location</th>
              <th class="border border-blue-500 px-3 py-3 text-left">Grade Level</th>
              <th class="border border-blue-500 px-3 py-3 text-left">Status</th>
              <th class="border border-blue-500 px-3 py-3 text-left no-print">Action</th>
            </tr>
          </thead>
          <tbody id="prevTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Rows populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="prevPagination" class="flex justify-between items-center mt-4 no-print">
        <div class="text-sm text-gray-600">
          Showing <span id="prevShowingStart">0</span> to <span id="prevShowingEnd">0</span> of <span id="prevTotalRecords">0</span> records
        </div>
        <div class="flex gap-2">
          <button id="prevFirstPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button id="prevPrevPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-left"></i> Prev
          </button>
          <span id="prevPageInfo" class="px-4 py-2 bg-blue-50 text-blue-900 rounded-lg font-medium">Page 1 of 1</span>
          <button id="prevNextPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            Next <i class="fas fa-angle-right"></i>
          </button>
          <button id="prevLastPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Report Section -->
  <div id="currentReportSection" class="hidden space-y-6">
    <!-- Filter Tabs for Current Report -->
    <div class="bg-green-50/50 border-2 border-green-200 flex flex-wrap gap-2 p-2 rounded-lg no-print">
      <button id="currAllToggle" class="flex-1 px-3 py-2 text-sm lg:text-base font-medium rounded-lg bg-green-100 text-gray-900 shadow transition-colors duration-200">
        <i class="fas fa-users mr-2"></i>All Personnel
      </button>
      <button id="currPersonnelToggle" class="flex-1 px-3 py-2 text-sm lg:text-base font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-colors duration-200">
        <i class="fas fa-user mr-2"></i>By Personnel
      </button>
    </div>

    <!-- Filter Form for Current Report -->
    <div id="currFilterForm" class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-sm no-print">
      <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-filter mr-2 text-green-600"></i>Filter Options
      </h4>

      <!-- Personnel Selection (Hidden by default, shown in "By Personnel" mode) -->
      <div id="currPersonnelWrapper" class="hidden mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-search mr-1"></i>Select Personnel <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          <input 
            type="text" 
            id="currSearchInput"
            class="w-full border-2 border-green-400 focus:border-yellow-500 bg-transparent rounded-lg px-4 py-3 pr-10"
            placeholder="Search by Name or Service Number..."
            autocomplete="off">
          <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400"></i>
        </div>
        <div id="currDropdownList" class="absolute z-10 w-full mt-1 bg-white border-2 border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
          <div class="py-1" id="currEmployeeDropdown"></div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button id="currClearBtn" class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all shadow">
          <i class="fas fa-eraser mr-2"></i>Clear
        </button>
        <button id="currLoadBtn" class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-all shadow-lg">
          <i class="fas fa-file-import mr-2"></i>Load Current Report
        </button>
      </div>
    </div>

    <!-- Current Report Results -->
    <div id="currResults" class="hidden">
      <!-- Export Buttons -->
      <div class="flex justify-between items-center mb-4 no-print">
        <h3 class="text-xl font-bold text-navy flex items-center">
          <i class="fas fa-table mr-2"></i>Current Personnel Details
        </h3>
        <div class="flex gap-2">
          <button id="currExportExcel" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition shadow">
            <i class="fas fa-file-excel mr-2"></i>Excel
          </button>
          <button id="currExportPdf" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition shadow">
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
          <button id="currPrint" class="px-4 py-2 bg-gray-700 text-white text-sm rounded-lg hover:bg-gray-800 transition shadow">
            <i class="fas fa-print mr-2"></i>Print
          </button>
        </div>
      </div>

      <!-- Results Table -->
      <div class="overflow-x-auto rounded-lg border-2 border-gray-200 shadow">
        <table class="min-w-full text-sm">
          <thead class="bg-green-600 text-white">
            <tr>
              <th class="border border-green-500 px-3 py-3 text-left">Service No</th>
              <th class="border border-green-500 px-3 py-3 text-left">Full Name</th>
              <th class="border border-green-500 px-3 py-3 text-left">Location</th>
              <th class="border border-green-500 px-3 py-3 text-left">Grade Level</th>
              <th class="border border-green-500 px-3 py-3 text-left">Status</th>
              <th class="border border-green-500 px-3 py-3 text-left">Email</th>
              <th class="border border-green-500 px-3 py-3 text-left no-print">Action</th>
            </tr>
          </thead>
          <tbody id="currTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Rows populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="currPagination" class="flex justify-between items-center mt-4 no-print">
        <div class="text-sm text-gray-600">
          Showing <span id="currShowingStart">0</span> to <span id="currShowingEnd">0</span> of <span id="currTotalRecords">0</span> records
        </div>
        <div class="flex gap-2">
          <button id="currFirstPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button id="currPrevPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-left"></i> Prev
          </button>
          <span id="currPageInfo" class="px-4 py-2 bg-green-50 text-green-900 rounded-lg font-medium">Page 1 of 1</span>
          <button id="currNextPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            Next <i class="fas fa-angle-right"></i>
          </button>
          <button id="currLastPage" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 sticky top-0 z-20 bg-navy text-white rounded-t-xl">
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-bold"><i class="fas fa-user-circle mr-2"></i>Personnel Details</h3>
          <button id="closeModal" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
      </div>
      <div id="modalContent" class="p-6"></div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
      <div class="text-center">
        <div id="alertIcon" class="flex justify-center mb-4">
          <i class="fas fa-exclamation-circle text-red-500 text-6xl"></i>
        </div>
        <h3 id="alertTitle" class="text-xl font-semibold text-gray-900 mb-2">Error</h3>
        <p id="alertMessage" class="text-gray-600 mb-6">An error occurred</p>
        <button id="alertCloseBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all shadow-lg">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
      <div class="text-center">
        <div class="flex justify-center mb-4">
          <div class="w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Loading...</h3>
        <p id="loadingMessage" class="text-gray-600">Please wait while we fetch the data...</p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // API Base
  const API_BASE = '/personneldata';
  
  // Pagination
  const RECORDS_PER_PAGE = 50;
  
  // State for Previous Report
  let prevState = {
    mode: 'all', // 'all' or 'personnel'
    currentPage: 1,
    paginationInfo: null,
    selectedEmployee: null,
    startPeriod: null,
    endPeriod: null,
    allEmployees: [],
    loaded: false
  };
  
  // State for Current Report
  let currState = {
    mode: 'all', // 'all' or 'personnel'
    currentPage: 1,
    paginationInfo: null,
    selectedEmployee: null,
    allEmployees: [],
    loaded: false
  };
  
  // Current active report tab
  let activeReport = 'previous'; // 'previous' or 'current'
  
  // DOM Elements - Report Tabs
  const previousReportTab = document.getElementById('previousReportTab');
  const currentReportTab = document.getElementById('currentReportTab');
  const previousReportSection = document.getElementById('previousReportSection');
  const currentReportSection = document.getElementById('currentReportSection');
  
  // DOM Elements - Previous Report
  const prevAllToggle = document.getElementById('prevAllToggle');
  const prevPersonnelToggle = document.getElementById('prevPersonnelToggle');
  const prevFilterForm = document.getElementById('prevFilterForm');
  const prevPersonnelWrapper = document.getElementById('prevPersonnelWrapper');
  const prevStartPeriod = document.getElementById('prevStartPeriod');
  const prevEndPeriod = document.getElementById('prevEndPeriod');
  const prevSearchInput = document.getElementById('prevSearchInput');
  const prevDropdownList = document.getElementById('prevDropdownList');
  const prevEmployeeDropdown = document.getElementById('prevEmployeeDropdown');
  const prevClearBtn = document.getElementById('prevClearBtn');
  const prevLoadBtn = document.getElementById('prevLoadBtn');
  const prevResults = document.getElementById('prevResults');
  const prevTableBody = document.getElementById('prevTableBody');
  const prevExportExcel = document.getElementById('prevExportExcel');
  const prevExportPdf = document.getElementById('prevExportPdf');
  const prevPrint = document.getElementById('prevPrint');
  
  // DOM Elements - Current Report
  const currAllToggle = document.getElementById('currAllToggle');
  const currPersonnelToggle = document.getElementById('currPersonnelToggle');
  const currFilterForm = document.getElementById('currFilterForm');
  const currPersonnelWrapper = document.getElementById('currPersonnelWrapper');
  const currSearchInput = document.getElementById('currSearchInput');
  const currDropdownList = document.getElementById('currDropdownList');
  const currEmployeeDropdown = document.getElementById('currEmployeeDropdown');
  const currClearBtn = document.getElementById('currClearBtn');
  const currLoadBtn = document.getElementById('currLoadBtn');
  const currResults = document.getElementById('currResults');
  const currTableBody = document.getElementById('currTableBody');
  const currExportExcel = document.getElementById('currExportExcel');
  const currExportPdf = document.getElementById('currExportPdf');
  const currPrint = document.getElementById('currPrint');
  
  // DOM Elements - Modals
  const detailsModal = document.getElementById('detailsModal');
  const modalContent = document.getElementById('modalContent');
  const closeModal = document.getElementById('closeModal');
  const alertModal = document.getElementById('alertModal');
  const alertIcon = document.getElementById('alertIcon');
  const alertTitle = document.getElementById('alertTitle');
  const alertMessage = document.getElementById('alertMessage');
  const alertCloseBtn = document.getElementById('alertCloseBtn');
  const loadingModal = document.getElementById('loadingModal');
  const loadingMessage = document.getElementById('loadingMessage');
  
  // DOM Elements - Pagination (Previous)
  const prevFirstPage = document.getElementById('prevFirstPage');
  const prevPrevPage = document.getElementById('prevPrevPage');
  const prevNextPage = document.getElementById('prevNextPage');
  const prevLastPage = document.getElementById('prevLastPage');
  const prevPageInfo = document.getElementById('prevPageInfo');
  const prevShowingStart = document.getElementById('prevShowingStart');
  const prevShowingEnd = document.getElementById('prevShowingEnd');
  const prevTotalRecords = document.getElementById('prevTotalRecords');
  
  // DOM Elements - Pagination (Current)
  const currFirstPage = document.getElementById('currFirstPage');
  const currPrevPage = document.getElementById('currPrevPage');
  const currNextPage = document.getElementById('currNextPage');
  const currLastPage = document.getElementById('currLastPage');
  const currPageInfo = document.getElementById('currPageInfo');
  const currShowingStart = document.getElementById('currShowingStart');
  const currShowingEnd = document.getElementById('currShowingEnd');
  const currTotalRecords = document.getElementById('currTotalRecords');
  
  // Helper: Show Alert
  function showAlert(title, message, type = 'error') {
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    const iconClass = type === 'success' ? 'fa-check-circle text-green-500' : 
                      type === 'warning' ? 'fa-exclamation-triangle text-yellow-500' : 
                      'fa-exclamation-circle text-red-500';
    alertIcon.innerHTML = `<i class="fas ${iconClass} text-6xl"></i>`;
    alertModal.classList.remove('hidden');
  }
  
  // Helper: Show/Hide Loading
  function showLoading(message = 'Loading...') {
    loadingMessage.textContent = message;
    loadingModal.classList.remove('hidden');
  }
  
  function hideLoading() {
    loadingModal.classList.add('hidden');
  }
  
  // Switch Report Tab
  function switchReportTab(tab) {
    activeReport = tab;
    
    if (tab === 'previous') {
      previousReportTab.classList.add('bg-white', 'text-blue-900', 'shadow-md', 'border-2', 'border-blue-500');
      previousReportTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
      currentReportTab.classList.remove('bg-white', 'text-blue-900', 'shadow-md', 'border-2', 'border-blue-500');
      currentReportTab.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
      previousReportSection.classList.remove('hidden');
      currentReportSection.classList.add('hidden');
    } else {
      currentReportTab.classList.add('bg-white', 'text-blue-900', 'shadow-md', 'border-2', 'border-green-500');
      currentReportTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
      previousReportTab.classList.remove('bg-white', 'text-blue-900', 'shadow-md', 'border-2', 'border-blue-500');
      previousReportTab.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
      currentReportSection.classList.remove('hidden');
      previousReportSection.classList.add('hidden');
    }
  }
  
  // Switch Previous Report Mode
  function switchPrevMode(mode) {
    prevState.mode = mode;
    prevState.loaded = false;
    prevResults.classList.add('hidden');
    
    // Update toggle buttons
    if (mode === 'all') {
      prevAllToggle.classList.add('bg-yellow-100', 'text-gray-900', 'shadow');
      prevAllToggle.classList.remove('text-gray-500');
      prevPersonnelToggle.classList.remove('bg-yellow-100', 'text-gray-900', 'shadow');
      prevPersonnelToggle.classList.add('text-gray-500');
      prevPersonnelWrapper.classList.add('hidden');
    } else {
      prevPersonnelToggle.classList.add('bg-yellow-100', 'text-gray-900', 'shadow');
      prevPersonnelToggle.classList.remove('text-gray-500');
      prevAllToggle.classList.remove('bg-yellow-100', 'text-gray-900', 'shadow');
      prevAllToggle.classList.add('text-gray-500');
      prevPersonnelWrapper.classList.remove('hidden');
    }
  }
  
  // Switch Current Report Mode
  function switchCurrMode(mode) {
    currState.mode = mode;
    currState.loaded = false;
    currResults.classList.add('hidden');
    
    // Update toggle buttons
    if (mode === 'all') {
      currAllToggle.classList.add('bg-green-100', 'text-gray-900', 'shadow');
      currAllToggle.classList.remove('text-gray-500');
      currPersonnelToggle.classList.remove('bg-green-100', 'text-gray-900', 'shadow');
      currPersonnelToggle.classList.add('text-gray-500');
      currPersonnelWrapper.classList.add('hidden');
    } else {
      currPersonnelToggle.classList.add('bg-green-100', 'text-gray-900', 'shadow');
      currPersonnelToggle.classList.remove('text-gray-500');
      currAllToggle.classList.remove('bg-green-100', 'text-gray-900', 'shadow');
      currAllToggle.classList.add('text-gray-500');
      currPersonnelWrapper.classList.remove('hidden');
    }
  }
  
  // Fetch Available Periods
  async function fetchAvailablePeriods() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/periods`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) throw new Error('Failed to fetch periods');
      
      const data = await res.json();
      
      if (data.status === 'SUCCESS' && data.periods) {
        // Populate period dropdowns
        prevStartPeriod.innerHTML = '<option value="">Select Start Period</option>' +
          data.periods.map(p => `<option value="${p}">${p}</option>`).join('');
        prevEndPeriod.innerHTML = '<option value="">Select End Period (Optional)</option>' +
          data.periods.map(p => `<option value="${p}">${p}</option>`).join('');
      }
    } catch (err) {
      console.error('Error fetching periods:', err);
    }
  }
  
  // Fetch Employees List
  async function fetchEmployeesList() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/employees`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) throw new Error('Failed to fetch employees');
      
      const data = await res.json();
      
      if (data.status === 'SUCCESS' && data.employees) {
        prevState.allEmployees = data.employees;
        currState.allEmployees = data.employees;
        populatePrevEmployeeDropdown();
        populateCurrEmployeeDropdown();
      }
    } catch (err) {
      console.error('Error fetching employees:', err);
    }
  }
  
  // Populate Previous Report Employee Dropdown
  function populatePrevEmployeeDropdown() {
    prevEmployeeDropdown.innerHTML = prevState.allEmployees.map(emp => `
      <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.Empl_ID}">
        <span class="font-semibold text-blue-600">${emp.full_name}</span>
        <span class="text-xs text-gray-500 ml-2">(${emp.Empl_ID})</span>
      </div>
    `).join('');
    
    prevEmployeeDropdown.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        prevState.selectedEmployee = item.getAttribute('data-id');
        prevSearchInput.value = item.querySelector('.font-semibold').textContent;
        prevDropdownList.classList.add('hidden');
      });
    });
  }
  
  // Populate Current Report Employee Dropdown
  function populateCurrEmployeeDropdown() {
    currEmployeeDropdown.innerHTML = currState.allEmployees.map(emp => `
      <div class="px-4 py-2 hover:bg-green-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.Empl_ID}">
        <span class="font-semibold text-green-600">${emp.full_name}</span>
        <span class="text-xs text-gray-500 ml-2">(${emp.Empl_ID})</span>
      </div>
    `).join('');
    
    currEmployeeDropdown.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        currState.selectedEmployee = item.getAttribute('data-id');
        currSearchInput.value = item.querySelector('.font-semibold').textContent;
        currDropdownList.classList.add('hidden');
      });
    });
  }
  
  // Search Handler for Previous Report
  prevSearchInput.addEventListener('input', () => {
    const q = prevSearchInput.value.trim().toLowerCase();
    if (!q) {
      prevDropdownList.classList.add('hidden');
      prevState.selectedEmployee = null;
      return;
    }
    
    const filtered = prevState.allEmployees.filter(emp => 
      (emp.full_name || '').toLowerCase().includes(q) || 
      (emp.Empl_ID || '').toLowerCase().includes(q)
    );
    
    prevEmployeeDropdown.innerHTML = filtered.map(emp => `
      <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.Empl_ID}">
        <span class="font-semibold text-blue-600">${emp.full_name}</span>
        <span class="text-xs text-gray-500 ml-2">(${emp.Empl_ID})</span>
      </div>
    `).join('');
    
    prevDropdownList.classList.remove('hidden');
    
    prevEmployeeDropdown.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        prevState.selectedEmployee = item.getAttribute('data-id');
        prevSearchInput.value = item.querySelector('.font-semibold').textContent;
        prevDropdownList.classList.add('hidden');
      });
    });
  });
  
  // Search Handler for Current Report
  currSearchInput.addEventListener('input', () => {
    const q = currSearchInput.value.trim().toLowerCase();
    if (!q) {
      currDropdownList.classList.add('hidden');
      currState.selectedEmployee = null;
      return;
    }
    
    const filtered = currState.allEmployees.filter(emp => 
      (emp.full_name || '').toLowerCase().includes(q) || 
      (emp.Empl_ID || '').toLowerCase().includes(q)
    );
    
    currEmployeeDropdown.innerHTML = filtered.map(emp => `
      <div class="px-4 py-2 hover:bg-green-50 cursor-pointer transition border-b border-gray-100" data-id="${emp.Empl_ID}">
        <span class="font-semibold text-green-600">${emp.full_name}</span>
        <span class="text-xs text-gray-500 ml-2">(${emp.Empl_ID})</span>
      </div>
    `).join('');
    
    currDropdownList.classList.remove('hidden');
    
    currEmployeeDropdown.querySelectorAll('div[data-id]').forEach(item => {
      item.addEventListener('click', () => {
        currState.selectedEmployee = item.getAttribute('data-id');
        currSearchInput.value = item.querySelector('.font-semibold').textContent;
        currDropdownList.classList.add('hidden');
      });
    });
  });
  
  // Load Previous Report
  async function loadPreviousReport(page = 1) {
    try {
      // Validation
      if (!prevStartPeriod.value) {
        return showAlert('Validation Error', 'Please select at least a Start Period', 'warning');
      }
      
      if (prevState.mode === 'personnel' && !prevState.selectedEmployee) {
        return showAlert('Validation Error', 'Please select a personnel', 'warning');
      }
      
      showLoading('Loading previous personnel details...');
      
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        page: page.toString(),
        limit: RECORDS_PER_PAGE.toString(),
        startPeriod: prevStartPeriod.value,
        ...(prevEndPeriod.value && { endPeriod: prevEndPeriod.value }),
        ...(prevState.mode === 'personnel' && prevState.selectedEmployee && { employeeId: prevState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/previous?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || errData.message || `HTTP ${res.status}`);
      }
      
      const data = await res.json();
      
      if (data.status === 'SUCCESS') {
        prevState.paginationInfo = data.pagination;
        prevState.currentPage = page;
        prevState.loaded = true;
        
        renderPrevTable(data.records);
        updatePrevPagination();
        prevResults.classList.remove('hidden');
      } else {
        throw new Error(data.error || data.message || 'Failed to load data');
      }
    } catch (err) {
      hideLoading();
      console.error('Error loading previous report:', err);
      showAlert('Error', err.message || 'Failed to load previous report', 'error');
    }
  }
  
  // Load Current Report
  async function loadCurrentReport(page = 1) {
    try {
      if (currState.mode === 'personnel' && !currState.selectedEmployee) {
        return showAlert('Validation Error', 'Please select a personnel', 'warning');
      }
      
      showLoading('Loading current personnel details...');
      
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        page: page.toString(),
        limit: RECORDS_PER_PAGE.toString(),
        ...(currState.mode === 'personnel' && currState.selectedEmployee && { employeeId: currState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/current?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || errData.message || `HTTP ${res.status}`);
      }
      
      const data = await res.json();
      
      if (data.status === 'SUCCESS') {
        currState.paginationInfo = data.pagination;
        currState.currentPage = page;
        currState.loaded = true;
        
        renderCurrTable(data.records);
        updateCurrPagination();
        currResults.classList.remove('hidden');
      } else {
        throw new Error(data.error || data.message || 'Failed to load data');
      }
    } catch (err) {
      hideLoading();
      console.error('Error loading current report:', err);
      showAlert('Error', err.message || 'Failed to load current report', 'error');
    }
  }
  
  // Render Previous Report Table
  function renderPrevTable(records) {
    prevTableBody.innerHTML = '';
    
    if (!records || records.length === 0) {
      prevTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-12 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <br><span class="text-lg font-medium">No records found</span>
          </td>
        </tr>
      `;
      return;
    }
    
    records.forEach(record => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-blue-50 transition';
      row.innerHTML = `
        <td class="border px-3 py-3">${record.period || 'N/A'}</td>
        <td class="border px-3 py-3 font-semibold">${record.Empl_ID || 'N/A'}</td>
        <td class="border px-3 py-3">${record.Surname || ''} ${record.OtherName || ''}</td>
        <td class="border px-3 py-3">${record.Location || 'N/A'}</td>
        <td class="border px-3 py-3">${record.gradelevel || 'N/A'}</td>
        <td class="border px-3 py-3">
          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${
            record.Status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
          }">
            ${record.Status || 'N/A'}
          </span>
        </td>
        <td class="border px-3 py-3 no-print">
          <button class="text-blue-600 hover:text-blue-800 font-semibold transition view-details" data-record='${JSON.stringify(record)}'>
            <i class="fas fa-eye mr-1"></i>View
          </button>
        </td>
      `;
      prevTableBody.appendChild(row);
    });
    
    // Add event listeners to view buttons
    prevTableBody.querySelectorAll('.view-details').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const record = JSON.parse(e.currentTarget.getAttribute('data-record'));
        showDetailsModal(record, 'previous');
      });
    });
  }
  
  // Render Current Report Table
  function renderCurrTable(records) {
    currTableBody.innerHTML = '';
    
    if (!records || records.length === 0) {
      currTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-12 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <br><span class="text-lg font-medium">No records found</span>
          </td>
        </tr>
      `;
      return;
    }
    
    records.forEach(record => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-green-50 transition';
      row.innerHTML = `
        <td class="border px-3 py-3 font-semibold">${record.Empl_ID || 'N/A'}</td>
        <td class="border px-3 py-3">${record.Surname || ''} ${record.OtherName || ''}</td>
        <td class="border px-3 py-3">${record.Location || 'N/A'}</td>
        <td class="border px-3 py-3">${record.gradelevel || 'N/A'}</td>
        <td class="border px-3 py-3">
          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${
            record.Status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
          }">
            ${record.Status || 'N/A'}
          </span>
        </td>
        <td class="border px-3 py-3 text-xs">${record.email || 'N/A'}</td>
        <td class="border px-3 py-3 no-print">
          <button class="text-green-600 hover:text-green-800 font-semibold transition view-details" data-record='${JSON.stringify(record)}'>
            <i class="fas fa-eye mr-1"></i>View
          </button>
        </td>
      `;
      currTableBody.appendChild(row);
    });
    
    // Add event listeners to view buttons
    currTableBody.querySelectorAll('.view-details').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const record = JSON.parse(e.currentTarget.getAttribute('data-record'));
        showDetailsModal(record, 'current');
      });
    });
  }
  
  // Show Details Modal
  function showDetailsModal(record, type) {
    const fields = [
      { label: 'Employee ID', key: 'Empl_ID' },
      { label: 'Surname', key: 'Surname' },
      { label: 'Other Name', key: 'OtherName' },
      { label: 'Title', key: 'Title' },
      { label: 'Sex', key: 'Sex' },
      { label: 'Job Title', key: 'Jobtitle' },
      { label: 'Marital Status', key: 'MaritalStatus' },
      { label: 'Factory', key: 'Factory' },
      { label: 'Location', key: 'Location' },
      { label: 'Birth Date', key: 'Birthdate' },
      { label: 'Date Employed', key: 'DateEmpl' },
      { label: 'Date Left', key: 'DateLeft' },
      { label: 'Telephone', key: 'TELEPHONE' },
      { label: 'Home Address', key: 'HOMEADDR' },
      { label: 'NOK Name', key: 'nok_name' },
      { label: 'Bank Code', key: 'Bankcode' },
      { label: 'Bank Branch', key: 'bankbranch' },
      { label: 'Bank Account', key: 'BankACNumber' },
      { label: 'State of Origin', key: 'StateofOrigin' },
      { label: 'Local Govt', key: 'LocalGovt' },
      { label: 'Status', key: 'Status' },
      { label: 'Grade Level', key: 'gradelevel' },
      { label: 'Email', key: 'email' },
      { label: 'PFA Code', key: 'pfacode' },
      { label: 'Command', key: 'command' }
    ];
    
    if (type === 'previous') {
      fields.unshift({ label: 'Period', key: 'period' });
    } else {
      fields.push({ label: 'GSM Number', key: 'gsm_number' });
      fields.push({ label: 'Religion', key: 'religion' });
    }
    
    modalContent.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${fields.map(field => `
          <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="text-xs font-semibold text-gray-500 uppercase mb-1">${field.label}</div>
            <div class="text-sm font-medium text-gray-900">${record[field.key] || 'N/A'}</div>
          </div>
        `).join('')}
      </div>
    `;
    
    detailsModal.classList.remove('hidden');
  }
  
  // Update Previous Report Pagination
  function updatePrevPagination() {
    if (!prevState.paginationInfo) return;
    
    const { currentPage, totalPages, totalRecords, recordsPerPage } = prevState.paginationInfo;
    const start = (currentPage - 1) * recordsPerPage + 1;
    const end = Math.min(currentPage * recordsPerPage, totalRecords);
    
    prevShowingStart.textContent = totalRecords > 0 ? start : 0;
    prevShowingEnd.textContent = end;
    prevTotalRecords.textContent = totalRecords;
    prevPageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
    
    prevFirstPage.disabled = currentPage === 1;
    prevPrevPage.disabled = currentPage === 1;
    prevNextPage.disabled = currentPage >= totalPages;
    prevLastPage.disabled = currentPage >= totalPages;
  }
  
  // Update Current Report Pagination
  function updateCurrPagination() {
    if (!currState.paginationInfo) return;
    
    const { currentPage, totalPages, totalRecords, recordsPerPage } = currState.paginationInfo;
    const start = (currentPage - 1) * recordsPerPage + 1;
    const end = Math.min(currentPage * recordsPerPage, totalRecords);
    
    currShowingStart.textContent = totalRecords > 0 ? start : 0;
    currShowingEnd.textContent = end;
    currTotalRecords.textContent = totalRecords;
    currPageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
    
    currFirstPage.disabled = currentPage === 1;
    currPrevPage.disabled = currentPage === 1;
    currNextPage.disabled = currentPage >= totalPages;
    currLastPage.disabled = currentPage >= totalPages;
  }
  
  // Export Previous Report Excel
  prevExportExcel.addEventListener('click', async () => {
    try {
      showLoading('Generating Excel file...');
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        startPeriod: prevStartPeriod.value,
        ...(prevEndPeriod.value && { endPeriod: prevEndPeriod.value }),
        ...(prevState.mode === 'personnel' && prevState.selectedEmployee && { employeeId: prevState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/export/excel-prev?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) throw new Error('Export failed');
      
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `previous_personnel_details_${new Date().toISOString().split('T')[0]}.xlsx`;
      a.click();
      
      showAlert('Success', 'Excel file downloaded successfully', 'success');
    } catch (err) {
      hideLoading();
      showAlert('Export Failed', err.message, 'error');
    }
  });
  
  // Export Previous Report PDF
  prevExportPdf.addEventListener('click', async () => {
    try {
      showLoading('Generating PDF file...');
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        startPeriod: prevStartPeriod.value,
        ...(prevEndPeriod.value && { endPeriod: prevEndPeriod.value }),
        ...(prevState.mode === 'personnel' && prevState.selectedEmployee && { employeeId: prevState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/export/pdf-prev?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) throw new Error('Export failed');
      
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `previous_personnel_details_${new Date().toISOString().split('T')[0]}.pdf`;
      a.click();
      
      showAlert('Success', 'PDF file downloaded successfully', 'success');
    } catch (err) {
      hideLoading();
      showAlert('Export Failed', err.message, 'error');
    }
  });
  
  // Export Current Report Excel
  currExportExcel.addEventListener('click', async () => {
    try {
      showLoading('Generating Excel file...');
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        ...(currState.mode === 'personnel' && currState.selectedEmployee && { employeeId: currState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/export/excel-cur?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) throw new Error('Export failed');
      
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `current_personnel_details_${new Date().toISOString().split('T')[0]}.xlsx`;
      a.click();
      
      showAlert('Success', 'Excel file downloaded successfully', 'success');
    } catch (err) {
      hideLoading();
      showAlert('Export Failed', err.message, 'error');
    }
  });
  
  // Export Current Report PDF
  currExportPdf.addEventListener('click', async () => {
    try {
      showLoading('Generating PDF file...');
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        ...(currState.mode === 'personnel' && currState.selectedEmployee && { employeeId: currState.selectedEmployee })
      });
      
      const res = await fetch(`${API_BASE}/export/pdf-cur?${params.toString()}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      hideLoading();
      
      if (!res.ok) throw new Error('Export failed');
      
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `current_personnel_details_${new Date().toISOString().split('T')[0]}.pdf`;
      a.click();
      
      showAlert('Success', 'PDF file downloaded successfully', 'success');
    } catch (err) {
      hideLoading();
      showAlert('Export Failed', err.message, 'error');
    }
  });
  
  // Event Listeners - Report Tabs
  previousReportTab.addEventListener('click', () => switchReportTab('previous'));
  currentReportTab.addEventListener('click', () => switchReportTab('current'));
  
  // Event Listeners - Previous Report
  prevAllToggle.addEventListener('click', () => switchPrevMode('all'));
  prevPersonnelToggle.addEventListener('click', () => switchPrevMode('personnel'));
  prevLoadBtn.addEventListener('click', () => loadPreviousReport(1));
  prevClearBtn.addEventListener('click', () => {
    prevStartPeriod.value = '';
    prevEndPeriod.value = '';
    prevSearchInput.value = '';
    prevState.selectedEmployee = null;
    prevDropdownList.classList.add('hidden');
    prevResults.classList.add('hidden');
  });
  prevPrint.addEventListener('click', () => window.print());
  
  // Event Listeners - Current Report
  currAllToggle.addEventListener('click', () => switchCurrMode('all'));
  currPersonnelToggle.addEventListener('click', () => switchCurrMode('personnel'));
  currLoadBtn.addEventListener('click', () => loadCurrentReport(1));
  currClearBtn.addEventListener('click', () => {
    currSearchInput.value = '';
    currState.selectedEmployee = null;
    currDropdownList.classList.add('hidden');
    currResults.classList.add('hidden');
  });
  currPrint.addEventListener('click', () => window.print());
  
  // Event Listeners - Pagination (Previous)
  prevFirstPage.addEventListener('click', () => loadPreviousReport(1));
  prevPrevPage.addEventListener('click', () => loadPreviousReport(prevState.currentPage - 1));
  prevNextPage.addEventListener('click', () => loadPreviousReport(prevState.currentPage + 1));
  prevLastPage.addEventListener('click', () => {
    if (prevState.paginationInfo) loadPreviousReport(prevState.paginationInfo.totalPages);
  });
  
  // Event Listeners - Pagination (Current)
  currFirstPage.addEventListener('click', () => loadCurrentReport(1));
  currPrevPage.addEventListener('click', () => loadCurrentReport(currState.currentPage - 1));
  currNextPage.addEventListener('click', () => loadCurrentReport(currState.currentPage + 1));
  currLastPage.addEventListener('click', () => {
    if (currState.paginationInfo) loadCurrentReport(currState.paginationInfo.totalPages);
  });
  
  // Event Listeners - Modals
  closeModal.addEventListener('click', () => detailsModal.classList.add('hidden'));
  alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
  
  // Initialize
  function initialize() {
    fetchAvailablePeriods();
    fetchEmployeesList();
    switchReportTab('previous');
    switchPrevMode('all');
    switchCurrMode('all');
  }
  
  document.addEventListener('DOMContentLoaded', initialize);
  if (document.readyState !== 'loading') initialize();
})();
</script>