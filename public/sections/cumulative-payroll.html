<!-- Cumulative Management -->
<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-grey-800">Cumulative Management</h2>
        <div class="space-x-2">
            <button id="createCumulativeBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Create New</button>
            <button id="generateReportBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Generate Report</button>
        </div>
    </div>

    <!-- Create/Edit Form (hidden by default) -->
    <div id="cumulativeForm" class="my-8 hidden">
        <h3 id="formTitle" class="text-xl font-semibold text-grey-700 mb-4">Create Cumulative</h3>
        <form id="cumulativeFormElement" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Name & Number</label>
                <div class="relative col-span-1">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2"
                            placeholder="Search ID or Name..."
                            autocomplete="off">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </span>
                    </div>

                    <div id="dropdownList" class="absolute z-10 w-full mt-1 bg-yellow-50 border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                        <div id="employeeDropdownItems" class="py-1">
                            <!-- Employee items will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="taxableDate" class="block text-sm font-medium text-gray-700 mb-1">Taxable to Date</label>
                <input id="taxableDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="taxDate" class="block text-sm font-medium text-gray-700 mb-1">Tax to Date</label>
                <input id="taxDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="grossDate" class="block text-sm font-medium text-gray-700 mb-1">Gross to Date</label>
                <input id="grossDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="netDate" class="block text-sm font-medium text-gray-700 mb-1">Net to Date</label>
                <input id="netDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div class="col-span-full flex justify-end mt-2 space-x-4">
                <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save</button>
                <button type="button" id="cancelCumulativeBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-lg">
            <thead class="bg-blue-100 text-blue-900">
                <tr>
                    <th class="py-2 px-4 border">Service No.</th>
                    <th class="py-2 px-4 border">Taxable To Date</th>
                    <th class="py-2 px-4 border">Tax To Date</th>
                    <th class="py-2 px-4 border">Gross To Date</th>
                    <th class="py-2 px-4 border">Net To Date</th>
                    <th class="py-2 px-4 border">Action</th>
                </tr>
            </thead>
            <tbody id="cumulativeTableBody" class="text-center text-sm">
                <tr>
                    <td colspan="6" class="py-4 text-gray-500">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
        <div class="text-sm text-gray-600">
            Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-records">0</span> records
        </div>
        <div class="flex space-x-2">
            <button id="prev-page" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <button id="next-page" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Delete</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to delete this record? This action cannot be undone.</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelDelete" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
            <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
        <div id="loadingSpinner" class="flex justify-center mb-4">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
        </div>
        <div id="successTick" class="hidden flex justify-center mb-4">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>
        <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
    </div>
</div>

<script>
(function () {
    // ============================================
    // DOM ELEMENTS
    // ============================================
    const formWrapper = document.getElementById("cumulativeForm");
    const form = document.getElementById("cumulativeFormElement");
    const formTitle = document.getElementById("formTitle");
    const tableBody = document.getElementById("cumulativeTableBody");
    const saveBtn = document.getElementById("saveBtn");
    
    // Modals
    const confirmModal = document.getElementById("confirmModal");
    const successModal = document.getElementById("successModal");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const successTick = document.getElementById("successTick");
    const successMessage = document.getElementById("successMessage");

    // Buttons
    const createBtn = document.getElementById("createCumulativeBtn");
    const cancelBtn = document.getElementById("cancelCumulativeBtn");
    const reportBtn = document.getElementById("generateReportBtn");
    const cancelDelete = document.getElementById("cancelDelete");
    const confirmDelete = document.getElementById("confirmDelete");

    // Dropdown elements
    const searchInput = document.getElementById('searchInput');
    const dropdownList = document.getElementById('dropdownList');
    const employeeDropdownItems = document.getElementById('employeeDropdownItems');

    // Inputs
    const taxableInput = document.getElementById("taxableDate");
    const taxInput = document.getElementById("taxDate");
    const grossInput = document.getElementById("grossDate");
    const netInput = document.getElementById("netDate");

    // Add hidden input to store the selected employee ID
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'emplId';
    hiddenInput.id = 'emplId';
    form.appendChild(hiddenInput);

    // ============================================
    // STATE VARIABLES
    // ============================================
    let isEditing = false;
    let currentEditEmplId = null;
    let rowToDelete = null;
    let allEmployees = [];
    let allCumulatives = [];
    let currentPage = 1;
    let recordsPerPage = 10;
    let totalRecords = 0;

    // ============================================
    // API FUNCTIONS
    // ============================================
    const API_BASE = '/cumulative';

    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }

    async function fetchEmployees() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/personnel/employees-current', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const result = await response.json();
            
            if (result.success) {
                allEmployees = result.data;
                renderEmployeeDropdown(allEmployees);
            }
        } catch (error) {
            console.error('Error fetching employees:', error);
            showErrorAlert('Failed to load employees');
        }
    }

    async function fetchCumulatives() {
        try {
            const response = await fetch(API_BASE, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            const data = await response.json();
            allCumulatives = Array.isArray(data) ? data : [];
            totalRecords = allCumulatives.length;
            renderTable();
        } catch (error) {
            console.error('Error fetching cumulatives:', error);
            tableBody.innerHTML = '<tr><td colspan="6" class="py-4 text-red-500">Failed to load data</td></tr>';
        }
    }

    async function createCumulative(data) {
        try {
            const response = await fetch(`${API_BASE}/create`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to create cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error creating cumulative:', error);
            throw error;
        }
    }

    async function updateCumulative(emplId, data) {
        try {
            const response = await fetch(`${API_BASE}/${emplId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to update cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error updating cumulative:', error);
            throw error;
        }
    }

    async function deleteCumulative(emplId) {
        try {
            const response = await fetch(`${API_BASE}/${emplId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to delete cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error deleting cumulative:', error);
            throw error;
        }
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderEmployeeDropdown(employees) {
        employeeDropdownItems.innerHTML = '';
        
        if (employees.length === 0) {
            employeeDropdownItems.innerHTML = '<div class="px-3 py-2 text-gray-500">No employees found</div>';
            return;
        }
        
        employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = 'dropdown-item px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100';
            div.setAttribute('data-value', emp.Empl_ID);
            div.innerHTML = `
                <span class="font-semibold text-blue-600">${emp.Empl_ID}</span> - ${emp.Surname} ${emp.OtherName || ''}
            `;
            
            div.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const text = this.textContent.trim();
                
                searchInput.value = text;
                hiddenInput.value = value;
                dropdownList.classList.add('hidden');
            });
            
            employeeDropdownItems.appendChild(div);
        });
    }

    function renderTable() {
        // Calculate pagination
        const startIndex = (currentPage - 1) * recordsPerPage;
        const endIndex = startIndex + recordsPerPage;
        const paginatedData = allCumulatives.slice(startIndex, endIndex);

        if (allCumulatives.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="py-4 text-gray-500">No records found</td></tr>';
            updatePaginationInfo();
            return;
        }

        tableBody.innerHTML = paginatedData.map(item => {
            return `
                <tr class="hover:bg-yellow-50">
                    <td class="py-2 px-4 border">${displayName}</td>
                    <td class="py-2 px-4 border">₦${Number(item.taxabletodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.taxtodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.grosstodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.nettodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">
                        <button onclick="window.editCumulative('${item.Empl_ID}')" class="text-blue-600 hover:underline">Edit</button> |
                        <button onclick="window.deleteCumulativeRow('${item.Empl_ID}')" class="text-red-600 hover:underline">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');

        updatePaginationInfo();
    }

    function updatePaginationInfo() {
        const start = allCumulatives.length > 0 ? (currentPage - 1) * recordsPerPage + 1 : 0;
        const end = Math.min(currentPage * recordsPerPage, totalRecords);
        
        document.getElementById('showing-start').textContent = start;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-records').textContent = totalRecords;

        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= Math.ceil(totalRecords / recordsPerPage);
    }

    function nextPage() {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    }

    // ============================================
    // UI HELPER FUNCTIONS
    // ============================================
    function toggleForm() {
        formWrapper.classList.toggle("hidden");
    }

    function clearForm() {
        form.reset();
        searchInput.value = '';
        hiddenInput.value = '';
        isEditing = false;
        currentEditEmplId = null;
        formTitle.textContent = "Create Cumulative";
        saveBtn.textContent = "Save";
    }

    function showSuccessModal(message) {
        successMessage.textContent = "Processing...";
        loadingSpinner.classList.remove("hidden");
        successTick.classList.add("hidden");
        successModal.classList.remove("hidden");

        setTimeout(() => {
            loadingSpinner.classList.add("hidden");
            successTick.classList.remove("hidden");
            successMessage.textContent = message;
            
            setTimeout(() => {
                successModal.classList.add("hidden");
            }, 2000);
        }, 1000);
    }

    function showErrorAlert(message) {
        alert('Error: ' + message);
    }

    // ============================================
    // DROPDOWN FUNCTIONALITY
    // ============================================
    searchInput.addEventListener('focus', () => {
        dropdownList.classList.remove('hidden');
    });

    searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        const items = employeeDropdownItems.querySelectorAll('.dropdown-item');
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            const shouldShow = text.includes(searchText);
            item.style.display = shouldShow ? 'block' : 'none';
        });
        
        dropdownList.classList.remove('hidden');
    });

    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.classList.add('hidden');
        }
    });

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            dropdownList.classList.add('hidden');
            this.blur();
        }
    });

    // ============================================
    // FORM HANDLERS
    // ============================================
    async function saveCumulative(e) {
        e.preventDefault();

        const emplId = hiddenInput.value.trim();
        const taxabletodate = taxableInput.value;
        const taxtodate = taxInput.value;
        const grosstodate = grossInput.value;
        const nettodate = netInput.value;

        if (!emplId || !taxabletodate || !taxtodate || !grosstodate || !nettodate) {
            showErrorAlert("Please fill all fields");
            return;
        }

        const data = {
            Empl_ID: emplId,
            taxabletodate: parseFloat(taxabletodate),
            taxtodate: parseFloat(taxtodate),
            grosstodate: parseFloat(grosstodate),
            nettodate: parseFloat(nettodate)
        };

        try {
            if (isEditing) {
                await updateCumulative(currentEditEmplId, data);
                showSuccessModal("Record updated successfully!");
            } else {
                await createCumulative(data);
                showSuccessModal("Record created successfully!");
            }

            clearForm();
            toggleForm();
            await fetchCumulatives();
            currentPage = 1; // Reset to first page after save
        } catch (error) {
            showErrorAlert(error.message);
        }
    }

    // ============================================
    // GLOBAL FUNCTIONS FOR EDIT & DELETE
    // ============================================
    window.editCumulative = function(emplId) {
        const cumulative = allCumulatives.find(c => c.Empl_ID === emplId);
        if (!cumulative) return;

        const employee = allEmployees.find(emp => emp.Empl_ID === emplId);
        const displayName = employee ? `${emplId} - ${employee.Surname} ${employee.OtherName || ''}` : emplId;
        
        // Populate form
        searchInput.value = displayName;
        hiddenInput.value = emplId;
        taxableInput.value = cumulative.taxabletodate || 0;
        taxInput.value = cumulative.taxtodate || 0;
        grossInput.value = cumulative.grosstodate || 0;
        netInput.value = cumulative.nettodate || 0;
        
        // Set edit mode
        isEditing = true;
        currentEditEmplId = emplId;
        formTitle.textContent = "Edit Cumulative";
        saveBtn.textContent = "Update";
        
        // Show form
        formWrapper.classList.remove("hidden");
    };

    window.deleteCumulativeRow = function(emplId) {
        rowToDelete = emplId;
        confirmModal.classList.remove("hidden");
    };

    // ============================================
    // EVENT LISTENERS
    // ============================================
    createBtn.addEventListener("click", () => {
        clearForm();
        toggleForm();
    });
    
    cancelBtn.addEventListener("click", () => {
        clearForm();
        toggleForm();
    });
    
    form.addEventListener("submit", saveCumulative);
    
    reportBtn.addEventListener("click", () => {
        showSuccessModal("Report generation feature coming soon!");
    });
    
    cancelDelete.addEventListener("click", () => {
        confirmModal.classList.add("hidden");
        rowToDelete = null;
    });
    
    confirmDelete.addEventListener("click", async () => {
        if (rowToDelete) {
            try {
                await deleteCumulative(rowToDelete);
                showSuccessModal("Record deleted successfully!");
                
                // Adjust page if current page becomes empty after deletion
                const totalPages = Math.ceil((totalRecords - 1) / recordsPerPage);
                if (currentPage > totalPages && currentPage > 1) {
                    currentPage = totalPages;
                }
                
                await fetchCumulatives();
            } catch (error) {
                showErrorAlert(error.message);
            }
        }
        confirmModal.classList.add("hidden");
        rowToDelete = null;
    });

    // Pagination button listeners
    document.getElementById('prev-page').addEventListener('click', prevPage);
    document.getElementById('next-page').addEventListener('click', nextPage);

    // Close modals when clicking outside
    confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
            confirmModal.classList.add("hidden");
            rowToDelete = null;
        }
    });

    successModal.addEventListener("click", (e) => {
        if (e.target === successModal) {
            successModal.classList.add("hidden");
        }
    });

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
        await fetchEmployees();
        await fetchCumulatives();
    }

    // Initialize on load
    init();
})();
</script>