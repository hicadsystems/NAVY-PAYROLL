<div class="container p-6">
    <!-- Connection Status -->
    <div class="mb-6">
        <div id="connectionStatus">
            <div class="flex items-center flex-wrap gap-2 justify-between">
                <div class="flex items-center">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                    <span id="statusText" class="text-blue-600 font-bold">Connecting to server...</span>
                </div>
                <div class="flex gap-2 items-center">
                  <button onclick="window.navigation.navigateToSection('database-backup', 'Database Backup')"  class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded text-white transition-colors">
                    <i class="fas fa-database text-white mr-2"></i> DB Backup
                  </button>

                  <button id="refreshConnection" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                  </button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Restore Configuration -->
        <div class="rounded-lg border border-slate-700">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl text-blue-600 font-semibold flex items-center">
                    <i class="fas fa-cog mr-2 text-black"></i>
                    Restore Configuration
                </h2>
            </div>
            <div class="p-6 space-y-4">
                <!-- Database Selection -->
                <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">Database</label>
                <select id="restoreDatabaseSelect"
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-700 cursor-not-allowed"
                        disabled>
                    <option id="dbNameOption">Loading...</option>
                </select>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Backup File</label>
                    <input type="file" id="backupFileInput" accept=".sql', '.dump', '.bak', '.gz', '.zip" class="w-full p-1 text-sm text-gray-900 border border-slate-600 rounded-lg cursor-pointer bg-transparent focus:outline-none">
                </div>

                <!-- Restore Mode -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Restore Mode</label>
                    <select id="restoreMode" class="w-full bg-transparent border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="overwrite">Overwrite Existing Data</option>
                        <option value="merge">Merge with Existing Data</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button id="startRestore" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-upload mr-2"></i>Start Restore
                    </button>
                    <button id="cancelRestore" class="flex-1 bg-amber-100/25 hover:bg-amber-50 text-red-600 font-medium py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Restore History -->
        <div class="rounded-lg border border-slate-700">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl font-semibold text-blue-600 flex items-center">
                    <i class="fas fa-history mr-2 text-yellow-500"></i>
                    Restore History
                </h2>
            </div>
            <div class="p-6">
                <div id="restoreHistory" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Restore entries will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="restoreProgressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-lg p-6 mx-4 w-full max-w-md border border-slate-700">
            <h3 class="text-lg font-semibold text-white mb-4">Restore in Progress</h3>
            <div class="space-y-4">
                <div class="bg-slate-700 rounded-full h-2">
                    <div id="restoreProgressBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="restoreProgressText" class="text-slate-300 text-sm">Initializing restore...</div>
                <div class="flex justify-end">
                    <button id="cancelRestoreProgress" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid md:grid-cols-3 gap-6 mt-6">
        <div class="rounded-lg border border-slate-700 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-600 rounded-full">
                    <i class="fas fa-check text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Successful Restores</p>
                    <p id="restoreSuccessCount" class="text-2xl font-semibold text-blue-600">0</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg border border-slate-700 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-600 rounded-full">
                    <i class="fas fa-exclamation-triangle text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Failed Restores</p>
                    <p id="restoreFailedCount" class="text-2xl font-semibold text-blue-600">0</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg border border-slate-700 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-black rounded-full">
                    <i class="fas fa-calendar text-lg text-white"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-900 font-bold text-sm">Last Restore</p>
                    <p id="lastRestore" class="text-xl font-semibold text-blue-600">Never</p>
                </div>
            </div>
        </div>
    </div>
</div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Delete</h3>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this record? This action cannot be undone.</p>
          <div class="flex justify-end space-x-4">
              <button id="cancelDelete" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
              <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
          </div>
      </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
          <div id="loadingSpinner" class="flex justify-center mb-4">
              <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
          </div>
          <div id="successTick" class="hidden flex justify-center mb-4">
              <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
              </div>
          </div>
          <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
      </div>
  </div>

<script>
class databaseRestore {
    constructor() {
        this.historyContainer = document.getElementById("restoreHistory");
        this.successCount = document.getElementById("restoreSuccessCount");
        this.failedCount = document.getElementById("restoreFailedCount");
        this.lastRestore = document.getElementById("lastRestore");

        this.progressModal = document.getElementById("restoreProgressModal");
        this.progressBar = document.getElementById("restoreProgressBar");
        this.progressText = document.getElementById("restoreProgressText");

        // bind UI actions
        document.getElementById("refreshConnection")
            .addEventListener("click", () => this.checkConnection());

        document.getElementById("startRestore")
            .addEventListener("click", () => this.startRestore());

        document.getElementById("cancelRestore")
            .addEventListener("click", () => this.resetForm());

        document.getElementById("cancelRestoreProgress")
            .addEventListener("click", () => this.hideProgress());

        // initialize
        this.checkConnection();
        this.loadHistory();
        this.loadStats();
        this.fetchDatabaseName();
    }

    async fetchDatabaseName() {
        try {
            const token = localStorage.getItem("token");

            const res = await fetch("/api/restore-db/database",{
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }            
            });
            const data = await res.json();

            const select = document.getElementById("restoreDatabaseSelect");
            select.innerHTML = ""; // clear old options

            const option = document.createElement("option");
            option.value = data.database;
            option.textContent = data.class_name;
            option.selected = true;

            select.appendChild(option);

            this.dbName = data.database; // store for restore use
        } catch (err) {
            console.error("Failed to load DB name:", err);
        }
    }

    async checkConnection() {
        const indicator = document.getElementById("statusIndicator");
        const text = document.getElementById("statusText");

        try {
            const token = localStorage.getItem("token");

            const res = await fetch("/api/restore-db/status",{   
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }
            });

            const data = await res.json();

            if (data.status === "connected") {
                indicator.className = "w-3 h-3 rounded-full bg-green-500 mr-3";
                text.textContent = `Connected (${data.engine})`;
                text.className = "text-green-600 font-bold";
            } else {
                indicator.className = "w-3 h-3 rounded-full bg-red-500 mr-3";
                text.textContent = "Disconnected";
                text.className = "text-red-600 font-bold";
            }
        } catch (err) {
            indicator.className = "w-3 h-3 rounded-full bg-red-500 mr-3";
            text.textContent = "Connection error";
            text.className = "text-red-600 font-bold";
        }
    }

    async startRestore() {
        const database = document.getElementById("restoreDatabaseSelect").value;
        const fileInput = document.getElementById("backupFileInput");
        const mode = document.getElementById("restoreMode").value;

        if (!database || !fileInput.files.length) {
            alert("Please select database and file.");
            return;
        }

        const formData = new FormData();
        formData.append("database", database);
        formData.append("mode", mode);
        formData.append("file", fileInput.files[0]);

        this.showProgress();

        try {
            const token = localStorage.getItem("token");

            const res = await fetch("/api/restore-db/restore", {
                method: "POST",
                headers: {
                "Authorization": `Bearer ${token}` 
                },
                body: formData
            });

            const result = await res.json();

            if (!result.success) {
                this.showProgress(0, "❌ Restore failed: " + (result.error || "Unknown error"));
                this.incrementFailedRestores();
                setTimeout(() => this.hideProgress(), 3000);
                return;
            }

            // ✅ only update if success
            this.showProgress(100, "✅ Restore completed successfully!");
            this.incrementSuccessfulRestores();
            this.updateLastRestore(new Date().toISOString());
            
            // Refresh history and stats
            setTimeout(() => {
                this.hideProgress();
                this.loadHistory();
                this.loadStats();
                this.resetForm();
            }, 2000);

        } catch (err) {
            console.error("Restore error:", err);
            this.showProgress(0, "❌ Restore failed: " + err.message);
            this.incrementFailedRestores();
            setTimeout(() => this.hideProgress(), 3000);
        }
    }

    async loadHistory() {
        try {
            const token = localStorage.getItem("token");

            const res = await fetch("/api/restore-db/history",{   
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }
            });
            const data = await res.json();

            if (data.history && data.history.length > 0) {
                const sorted = data.history.sort(
                    (a, b) => new Date(b.date) - new Date(a.date)
                );

                this.historyContainer.innerHTML = sorted.map(entry => `
                    <div class="flex items-center gap-2 justify-between p-3 bg-gray-50 rounded-lg border">
                        <div class="flex items-center">
                            <div class="p-2 rounded-full mr-3">
                                <i class="fas fa-database text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-sm text-gray-900">${entry.filename}</p>
                                <p class="text-[13px] text-gray-500">
                                    ${entry.class_name} • ${new Date(entry.date).toLocaleString()} • 
                                    <span class="${entry.status === "Success" ? "text-success" : "text-red-600"}">
                                        ${entry.status}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="delete-btn text-red-600 hover:text-red-800" 
                                    data-filename="${entry.filename}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join("");
                
                // Bind delete buttons after creating the HTML
                this.bindDeleteButtons();
            } else {
                this.historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <p>No restore history found</p>
                    </div>
                `;
            }
        } catch (err) {
            console.error("Failed to load restore history:", err);
        }
    }

    bindDeleteButtons() {
        // Remove existing event listeners to prevent duplicates
        const deleteButtons = this.historyContainer.querySelectorAll('.delete-btn');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.deleteRestoreEntry(btn.dataset.filename);
            });
        });
    }

    async deleteRestoreEntry(filename) {
        if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

        try {
            const token = localStorage.getItem("token");

            const response = await fetch(`/api/restore-db/restore/${encodeURIComponent(filename)}`, {
                method: 'DELETE',
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showNotification('File deleted successfully', 'success');
                this.loadHistory();
                this.loadStats();
            } else {
                throw new Error(result.error || 'Delete failed');
            }
        } catch (error) {
            this.showNotification('Delete failed: ' + error.message, 'error');
        }
    }

    async loadStats() {
        try {
            const token = localStorage.getItem("token");

            const res = await fetch("/api/restore-db/stats",{   
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                }
            });
            
            const stats = await res.json();

            this.successCount.textContent = stats.successful || 0;
            this.failedCount.textContent = stats.failed || 0;
            this.lastRestore.textContent = stats.lastRestore
                ? new Date(stats.lastRestore).toLocaleString()
                : "Never";
        } catch (err) {
            console.error("Failed to load restore stats:", err);
        }
    }

    showProgress(progress = 0, message = "Initializing restore...") {
        this.progressModal.classList.remove("hidden");
        this.progressBar.style.width = progress + "%";
        this.progressText.textContent = message;

        // Only start animation if not explicitly setting progress
        if (progress === 0 && message === "Initializing restore...") {
            let currentProgress = 0;
            this.progressInterval = setInterval(() => {
                if (currentProgress < 90) {
                    currentProgress += 10;
                    this.progressBar.style.width = currentProgress + "%";
                    this.progressText.textContent = `Restoring... ${currentProgress}%`;
                } else {
                    clearInterval(this.progressInterval);
                }
            }, 500);
        }
    }

    hideProgress() {
        this.progressModal.classList.add("hidden");
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
        }
    }

    resetForm() {
        const databaseSelect = document.getElementById("restoreDatabaseSelect");
        const fileInput = document.getElementById("backupFileInput");
        const modeSelect = document.getElementById("restoreMode");
        
        if (fileInput) fileInput.value = "";
        if (modeSelect) modeSelect.value = "overwrite";
        // Don't reset database select as it should maintain the current database
    }

    incrementSuccessfulRestores() {
        const el = document.getElementById("restoreSuccessCount");
        if (el) {
            el.textContent = parseInt(el.textContent || 0) + 1;
        }
    }

    incrementFailedRestores() {
        const el = document.getElementById("restoreFailedCount");
        if (el) {
            el.textContent = parseInt(el.textContent || 0) + 1;
        }
    }

    updateLastRestore(timestamp) {
        const el = document.getElementById("lastRestore");
        if (el) {
            el.textContent = new Date(timestamp).toLocaleString();
        }
    }

    showNotification(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const notification = document.createElement('div');
        notification.className = `
        fixed 
        top-1/2 
        left-1/2 
        transform -translate-x-1/2 -translate-y-1/2
        ${colors[type]} 
        text-white 
        px-6 py-3 
        rounded-lg 
        shadow-lg 
        z-50 
        transition-all duration-300
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.restoreManager = new databaseRestore();
    });
} else {
    window.restoreManager = new databaseRestore();
}
</script>