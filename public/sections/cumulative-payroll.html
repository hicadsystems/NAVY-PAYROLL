<!-- Cumulative Management -->
<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-grey-800">Cumulative Management</h2>
        <div class="flex flex-wrap gap-2 justify-end">
            <!-- Search Bar -->
                <div class="relative">
                    <input 
                        type="text" 
                        id="cumulativeSearchInput" 
                        placeholder="Search by Service No ..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            <button id="createCumulativeBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Create New</button>
            <button id="generateReportBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
        <i class="fas fa-file-alt mr-2"></i>Generate Report</button>
        </div>
    </div>

    <!-- Create/Edit Form (hidden by default) -->
    <div id="cumulativeForm" class="my-8 hidden">
        <h3 id="formTitle" class="text-xl font-semibold text-grey-700 mb-4">Create Cumulative</h3>
        <form id="cumulativeFormElement" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Name & Number</label>
                <div class="relative col-span-1">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2"
                            placeholder="Search ID or Name..."
                            autocomplete="off">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </span>
                    </div>

                    <div id="dropdownList" class="absolute z-10 w-full mt-1 bg-yellow-50 border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                        <div id="employeeDropdownItems" class="py-1">
                            <!-- Employee items will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="taxableDate" class="block text-sm font-medium text-gray-700 mb-1">Taxable to Date</label>
                <input id="taxableDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="taxDate" class="block text-sm font-medium text-gray-700 mb-1">Tax to Date</label>
                <input id="taxDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="grossDate" class="block text-sm font-medium text-gray-700 mb-1">Gross to Date</label>
                <input id="grossDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div>
                <label for="netDate" class="block text-sm font-medium text-gray-700 mb-1">Net to Date</label>
                <input id="netDate" type="number" step="0.01"
                    class="w-full border border-blue-500 focus:border-yellow-500 bg-transparent rounded-md px-3 py-2" 
                    placeholder="0.00" />
            </div>

            <div class="col-span-full flex justify-end mt-2 space-x-4">
                <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save</button>
                <button type="button" id="cancelCumulativeBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-lg">
            <thead class="bg-blue-100 text-blue-900">
                <tr>
                    <th class="py-2 px-4 border">Service No.</th>
                    <th class="py-2 px-4 border">Taxable To Date</th>
                    <th class="py-2 px-4 border">Tax To Date</th>
                    <th class="py-2 px-4 border">Gross To Date</th>
                    <th class="py-2 px-4 border">Net To Date</th>
                    <th class="py-2 px-4 border">Action</th>
                </tr>
            </thead>
            <tbody id="cumulativeTableBody" class="text-center text-sm">
                <tr>
                    <td colspan="6" class="py-4 text-gray-500">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
            Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-records">0</span> records
        </div>
        <div class="flex items-center space-x-2">
        <select id="recordsPerPage" class="border border-gray-300 rounded px-2 py-1 text-sm">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
        </select>
        <button id="prev-page" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 disabled:opacity-50">
            Previous
        </button>
        <span class="text-sm">
            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button id="next-page" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 disabled:opacity-50">
            Next
        </button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Delete</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to delete this record? This action cannot be undone.</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelDelete" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
            <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
        <div id="loadingSpinner" class="flex justify-center mb-4">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
        </div>
        <div id="successTick" class="hidden flex justify-center mb-4">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>
        <p id="successMessage" class="text-gray-700 font-medium">Processing...</p>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
    <!-- Red X Icon -->
    <div class="flex justify-center mb-4">
      <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </div>
    </div>
    <p id="errorMessage" class="text-gray-700 font-medium mb-4">An error occurred.</p>
    <button id="closeErrorModal" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Close</button>
  </div>
</div>

<script>
(function () {
    // ============================================
    // DOM ELEMENTS
    // ============================================
    const formWrapper = document.getElementById("cumulativeForm");
    const form = document.getElementById("cumulativeFormElement");
    const formTitle = document.getElementById("formTitle");
    const tableBody = document.getElementById("cumulativeTableBody");
    const saveBtn = document.getElementById("saveBtn");
    
    // Modals
    const confirmModal = document.getElementById("confirmModal");
    const successModal = document.getElementById("successModal");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const successTick = document.getElementById("successTick");
    const successMessage = document.getElementById("successMessage");
    const errorModal = document.getElementById("errorModal");
    const errorMessage = document.getElementById("errorMessage");
    const closeErrorModal = document.getElementById("closeErrorModal");

    // Buttons
    const createBtn = document.getElementById("createCumulativeBtn");
    const cancelBtn = document.getElementById("cancelCumulativeBtn");
    //const reportBtn = document.getElementById("generateReportBtn");
    const cancelDelete = document.getElementById("cancelDelete");
    const confirmDelete = document.getElementById("confirmDelete");

    // Dropdown elements
    const searchInput = document.getElementById('searchInput');
    const dropdownList = document.getElementById('dropdownList');
    const employeeDropdownItems = document.getElementById('employeeDropdownItems');

    // Inputs
    const taxableInput = document.getElementById("taxableDate");
    const taxInput = document.getElementById("taxDate");
    const grossInput = document.getElementById("grossDate");
    const netInput = document.getElementById("netDate");

    // Add hidden input to store the selected employee ID
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'EmpL_ID';
    hiddenInput.id = 'EmpL_ID';
    form.appendChild(hiddenInput);

    // ============================================
    // STATE VARIABLES
    // ============================================
    let cumData = [];
    let isEditing = false;
    let currentEditEmpL_ID = null;
    let rowToDelete = null;
    let allEmployees = [];
    let allCumulatives = [];
    let filteredCumulatives = [];
    let currentPage = 1;
    let recordsPerPage = 10;
    let totalRecords = 0;
    let searchTimeout;

    // ============================================
    // API FUNCTIONS
    // ============================================
    const API_BASE = '/cumulative';

    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }

    async function fetchEmployees() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/personnel/employees-current', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const result = await response.json();
            
            if (result.success) {
                allEmployees = result.data;
                renderEmployeeDropdown(allEmployees);
            }
        } catch (error) {
            console.error('Error fetching employees:', error);
            showErrorAlert('Failed to load employees');
        }
    }

    async function fetchCumulatives() {
        try {
            const response = await fetch(API_BASE, {
            method: 'GET',
            headers: getAuthHeaders()
            });

            const data = await response.json();
            console.log('Raw cumulative data:', data);

            // Works with both API shapes
            cumData = Array.isArray(data)
            ? data
            : Array.isArray(data.data)
                ? data.data
                : [];

            allCumulatives = cumData;
            filteredCumulatives = [...allCumulatives];
            totalRecords = filteredCumulatives.length;

            renderTable();
        } catch (error) {
            console.error('Error fetching cumulatives:', error);
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="py-4 text-red-500">Failed to load data</td>
            </tr>
            `;
        }
    }

    async function createCumulative(data) {
        try {
            const response = await fetch(`${API_BASE}/create`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to create cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error creating cumulative:', error);
            throw error;
        }
    }

    async function updateCumulative(EmpL_ID, data) {
        try {
            // Handle the slash in employee ID for URL
            const pathSegment = `${EmpL_ID}`;
            const encodedId = encodeURIComponent(pathSegment);
            
            const response = await fetch(`${API_BASE}/${encodedId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to update cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error updating cumulative:', error);
            throw error;
        }
    }

    async function deleteCumulative(EmpL_ID) {
        try {
            // Handle the slash in employee ID for URL
            const pathSegment = `${EmpL_ID}`;
            const encodedId = encodeURIComponent(pathSegment);
            
            const response = await fetch(`${API_BASE}/${encodedId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to delete cumulative');
            }

            return result;
        } catch (error) {
            console.error('Error deleting cumulative:', error);
            throw error;
        }
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderEmployeeDropdown(employees) {
        employeeDropdownItems.innerHTML = '';
        
        if (employees.length === 0) {
            employeeDropdownItems.innerHTML = '<div class="px-3 py-2 text-gray-500">No employees found</div>';
            return;
        }
        
        employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = 'dropdown-item px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100';
            div.setAttribute('data-value', emp.Empl_ID);
            div.innerHTML = `
                <span class="font-semibold text-blue-600">${emp.Empl_ID}</span> - ${emp.Surname} ${emp.OtherName || ''}
            `;
            
            div.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const text = this.textContent.trim();
                
                searchInput.value = text;
                hiddenInput.value = value;
                dropdownList.classList.add('hidden');
            });
            
            employeeDropdownItems.appendChild(div);
        });
    }

    function renderTable() {
        // Calculate pagination
        const startIndex = (currentPage - 1) * recordsPerPage;
        const endIndex = startIndex + recordsPerPage;
        const paginatedData = filteredCumulatives.slice(startIndex, endIndex);

        if (filteredCumulatives.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="py-4 text-gray-500">No records found</td></tr>';
            updatePaginationInfo();
            return;
        }

        tableBody.innerHTML = paginatedData.map(item => {
            return `
                <tr class="hover:bg-yellow-50">
                    <td class="py-2 px-4 border">${item.EmpL_ID}</td>
                    <td class="py-2 px-4 border">₦${Number(item.taxabletodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.taxtodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.grosstodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">₦${Number(item.nettodate || 0).toLocaleString()}</td>
                    <td class="py-2 px-4 border">
                        <button onclick="window.editCumulative('${item.EmpL_ID}')" class="text-blue-600 hover:underline">Edit</button> |
                        <button onclick="window.deleteCumulativeRow('${item.EmpL_ID}')" class="text-red-600 hover:underline">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');

        updatePaginationInfo();
    }

    function updatePaginationInfo() {
        const start = filteredCumulatives.length > 0 ? (currentPage - 1) * recordsPerPage + 1 : 0;
        const end = Math.min(currentPage * recordsPerPage, totalRecords);
            
        document.getElementById('showing-start').textContent = start;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-records').textContent = totalRecords;

        //  Update page numbers
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = Math.max(1, Math.ceil(totalRecords / recordsPerPage));

        // Existing enable/disable logic
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage >= Math.ceil(totalRecords / recordsPerPage);
        prevBtn.disabled = isFirstPage;
        nextBtn.disabled = isLastPage;
    }

    function nextPage() {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    }

    // ============================================
    // SEARCH FUNCTIONALITY
    // ============================================
    function performSearch() {
        const searchTerm = document.getElementById('cumulativeSearchInput').value.toLowerCase().trim();
        
        if (!searchTerm) {
            filteredCumulatives = [...allCumulatives];
        } else {
            filteredCumulatives = allCumulatives.filter(item => {
                const EmpL_ID = (item.EmpL_ID || item.Empl_ID || '').toLowerCase();
                return EmpL_ID.includes(searchTerm);
            });
        }
        
        totalRecords = filteredCumulatives.length;
        currentPage = 1; // Reset to first page on search
        renderTable();
    }

    // Records per page change handler
    function changeRecordsPerPage() {
        const selectElement = document.getElementById('recordsPerPage');
        recordsPerPage = parseInt(selectElement.value);
        currentPage = 1; // Reset to first page
        renderTable();
    }
    
    // Debounce search
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    }

    // ============================================
    // UI HELPER FUNCTIONS
    // ============================================
    function toggleForm() {
        formWrapper.classList.toggle("hidden");
    }

    function clearForm() {
        form.reset();
        searchInput.value = '';
        hiddenInput.value = '';
        isEditing = false;
        currentEditEmpL_ID = null;
        formTitle.textContent = "Create Cumulative";
        saveBtn.textContent = "Save";
    }

    function showSuccessModal(message) {
        successMessage.textContent = "Processing...";
        loadingSpinner.classList.remove("hidden");
        successTick.classList.add("hidden");
        successModal.classList.remove("hidden");

        setTimeout(() => {
            loadingSpinner.classList.add("hidden");
            successTick.classList.remove("hidden");
            successMessage.textContent = message;
            
            setTimeout(() => {
                successModal.classList.add("hidden");
            }, 2000);
        }, 1000);
    }

    function showErrorAlert(message) {
        errorMessage.textContent = message || "An unexpected error occurred.";
        errorModal.classList.remove("hidden");

        // Auto-close after 3 seconds (optional)
        setTimeout(() => {
            if (!errorModal.classList.contains("hidden")) {
                errorModal.classList.add("hidden");
            }
        }, 5000);
    }

    // ============================================
    // DROPDOWN FUNCTIONALITY
    // ============================================
    searchInput.addEventListener('focus', () => {
        dropdownList.classList.remove('hidden');
    });

    searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        const items = employeeDropdownItems.querySelectorAll('.dropdown-item');
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            const shouldShow = text.includes(searchText);
            item.style.display = shouldShow ? 'block' : 'none';
        });
        
        dropdownList.classList.remove('hidden');
    });

    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.classList.add('hidden');
        }
    });

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            dropdownList.classList.add('hidden');
            this.blur();
        }
    });

    // ============================================
    // FORM HANDLERS
    // ============================================
    async function saveCumulative(e) {
        e.preventDefault();

        const EmpL_ID = hiddenInput.value.trim();
        const taxabletodate = taxableInput.value;
        const taxtodate = taxInput.value;
        const grosstodate = grossInput.value;
        const nettodate = netInput.value;

        if (!EmpL_ID || !taxabletodate || !taxtodate || !grosstodate || !nettodate) {
            showErrorAlert("Please fill all fields");
            return;
        }

        const data = {
            EmpL_ID: EmpL_ID,
            taxabletodate: parseFloat(taxabletodate),
            taxtodate: parseFloat(taxtodate),
            grosstodate: parseFloat(grosstodate),
            nettodate: parseFloat(nettodate)
        };

        try {
            if (isEditing) {
                await updateCumulative(currentEditEmpL_ID, data);
                showSuccessModal("Record updated successfully!");
            } else {
                await createCumulative(data);
                showSuccessModal("Record created successfully!");
            }

            clearForm();
            toggleForm();
            await fetchCumulatives();
            await fetchCumulatives();

            // Reapply active search filter if any
            const activeSearch = document.getElementById('cumulativeSearchInput').value.trim();
            if (activeSearch) {
                performSearch(); // keeps filtered results visible
            } else {
                renderTable();   // fallback to full table
            }
            currentPage = 1; // Reset to first page after save
        } catch (error) {
            showErrorAlert(error.message);
        }
    }

    // ============================================
    // GLOBAL FUNCTIONS FOR EDIT & DELETE
    // ============================================
    window.editCumulative = function(EmpL_ID) {
        const cumulative = allCumulatives.find(c => (c.EmpL_ID || c.Empl_ID) === EmpL_ID);
        if (!cumulative) {
            console.error('Cumulative not found for:', EmpL_ID);
            return;
        }

        // Populate form with just the ID
        searchInput.value = EmpL_ID;
        hiddenInput.value = EmpL_ID;
        taxableInput.value = cumulative.taxabletodate || 0;
        taxInput.value = cumulative.taxtodate || 0;
        grossInput.value = cumulative.grosstodate || 0;
        netInput.value = cumulative.nettodate || 0;
        
        // Set edit mode
        isEditing = true;
        currentEditEmpL_ID = EmpL_ID;
        formTitle.textContent = "Edit Cumulative";
        saveBtn.textContent = "Update";
        
        // Show form
        formWrapper.classList.remove("hidden");
    };

    window.deleteCumulativeRow = function(EmpL_ID) {
        rowToDelete = EmpL_ID;
        confirmModal.classList.remove("hidden");
    };

    // ============================================
    // EVENT LISTENERS
    // ============================================
    createBtn.addEventListener("click", () => {
        clearForm();
        toggleForm();
    });
    
    cancelBtn.addEventListener("click", () => {
        clearForm();
        toggleForm();
    });
    
    form.addEventListener("submit", saveCumulative);
    
    cancelDelete.addEventListener("click", () => {
        confirmModal.classList.add("hidden");
        rowToDelete = null;
    });
    
    confirmDelete.addEventListener("click", async () => {
        if (rowToDelete) {
            try {
                await deleteCumulative(rowToDelete);
                showSuccessModal("Record deleted successfully!");
                
                // Adjust page if current page becomes empty after deletion
                const totalPages = Math.ceil((totalRecords - 1) / recordsPerPage);
                if (currentPage > totalPages && currentPage > 1) {
                    currentPage = totalPages;
                }
                
                await fetchCumulatives();
                await fetchCumulatives();

                // Reapply active search filter if any
                const activeSearch = document.getElementById('cumulativeSearchInput').value.trim();
                if (activeSearch) {
                    performSearch(); // keeps filtered results visible
                } else {
                    renderTable();   // fallback to full table
                }
            } catch (error) {
                showErrorAlert(error.message);
            }
        }
        confirmModal.classList.add("hidden");
        rowToDelete = null;
    });

    // Pagination button listeners
    document.getElementById('prev-page').addEventListener('click', prevPage);
    document.getElementById('next-page').addEventListener('click', nextPage);

    // Records per page listener
    document.getElementById('recordsPerPage').addEventListener('change', changeRecordsPerPage);

    // Search input listener
    document.getElementById('cumulativeSearchInput').addEventListener('input', debounceSearch);
    
    const prevBtnMobile = document.getElementById('prev-page-mobile');
    const nextBtnMobile = document.getElementById('next-page-mobile');
    if (prevBtnMobile) prevBtnMobile.addEventListener('click', prevPage);
    if (nextBtnMobile) nextBtnMobile.addEventListener('click', nextPage);

    // Search input listener
    document.getElementById('cumulativeSearchInput').addEventListener('input', debounceSearch);

    // Close modals when clicking outside
    confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
            confirmModal.classList.add("hidden");
            rowToDelete = null;
        }
    });

    successModal.addEventListener("click", (e) => {
        if (e.target === successModal) {
            successModal.classList.add("hidden");
        }
    });

    closeErrorModal.addEventListener("click", () => {
        errorModal.classList.add("hidden");
    });


    errorModal.addEventListener("click", (e) => {
        if (e.target === errorModal) {
            errorModal.classList.add("hidden");
        }
    });


    //generate reports functionality
    function generateReport() {
        const now = new Date();
        const dateStr = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
        const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        const printWindow = window.open('', '_blank');
        
        const formatCurrency = (amount) => {
        if (!amount) return '-';
        return new Intl.NumberFormat('en-NG', {
            style: 'currency',
            currency: 'NGN'
        }).format(amount);
        };

        const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Cumulative Payroll Report</title>
            <style>
            body { 
                font-family: Arial, sans-serif;
                margin: 20px;
                color: #333;
            }
            .report-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #1a56db;
            }
            .report-title {
                font-size: 24px;
                color: #1a56db;
                margin: 10px 0;
            }
            .date-time {
                font-size: 14px;
                color: #666;
                margin: 10px 0;
            }
            .element-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
                font-size: 11px;
            }
            .element-table th {
                background-color: #f3f4f6;
                padding: 6px;
                text-align: left;
                border: 1px solid #e5e7eb;
            }
            .element-table td {
                padding: 6px;
                border: 1px solid #e5e7eb;
            }
            .amount {
                text-align: right;
            }
            .report-footer {
                margin-top: 20px;
                text-align: center;
                font-size: 12px;
                color: #666;
                border-top: 1px solid #e5e7eb;
                padding-top: 15px;
            }
            .status-active {
                color: green;
                font-weight: bold;
            }
            .status-inactive {
                color: red;
                font-weight: bold;
            }
            @media print {
                .element-table th {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                }
                .sn-column {
                width: 40px;
                text-align: center;
                font-weight: bold;
                background-color: #f3f4f6;
                vertical-align: middle;
                border-right: 2px solid #1a56db;
                }
                .element-section {
                margin-bottom: 30px;
                padding-bottom: 10px;
                border-bottom: 1px dashed #e5e7eb;
                }
                .combined-tables {
                border: 1px solid #e5e7eb;
                margin-bottom: 20px;
                }
                .element-table {
                margin-bottom: 0;
                border: none;
                }
                .element-table:first-child {
                border-bottom: 2px solid #e5e7eb;
                }
            </style>
        </head>
        <body>
            <div class="report-header">
            <div class="report-title">Cumulative Payroll Report</div>
            <div class="date-time">Generated on: ${dateStr} at ${timeStr}</div>
            </div>


        ${cumData.map((item, index) => `
            <div class="combined-tables">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                <td class="sn-column" rowspan="4" style="width: 40px;">
                    ${index + 1}
                </td>
                <td style="padding: 0;">
                    <!-- First table -->
                    <table class="element-table" style="width: 100%;">
                    <thead>
                        <tr>
                        <th>Service No</th>
                        <th>Taxable To Date</th>
                        <th>Tax To Date</th>
                        <th>Gross To Date</th>
                        <th>Net To Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="py-2 px-4 border">${item.EmpL_ID}</td>
                            <td class="py-2 px-4 border">₦${Number(item.taxabletodate || 0).toLocaleString()}</td>
                            <td class="py-2 px-4 border">₦${Number(item.taxtodate || 0).toLocaleString()}</td>
                            <td class="py-2 px-4 border">₦${Number(item.grosstodate || 0).toLocaleString()}</td>
                            <td class="py-2 px-4 border">₦${Number(item.nettodate || 0).toLocaleString()}</td>
                        </tr>
                    </tbody>
                    </table>
                </td>
                </tr>
            </table>
            </div>
        `).join('')}

        <div class="report-footer">
            <p>Total Records: ${cumData.length}</p>
            <p>Generated by: ${localStorage.getItem('full_name') || 'System User'}</p>
            <p>*** End of Report ***</p>
        </div>
        </body>
        </html>
    `;

        printWindow.document.write(printContent);
        printWindow.document.close();

        printWindow.onload = function() {
        printWindow.print();
        };
    }

    // Add event listener to generate report button
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
        await fetchEmployees();
        await fetchCumulatives();
    }

    // Initialize on load
    init();
})();
</script>