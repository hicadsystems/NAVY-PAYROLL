<!-- ================================================
  PAYROLL CLASS MODAL — Standalone file
  Save as: pages/payroll-modal.html
  Loaded on dashboard init via user-dashboard.js
  ================================================ -->

<!-- ── Payroll Modal Styles ──────────────────── -->
<style>
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(4, 12, 28, 0.82);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .modal-box {
    background: #0f2340;
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;
    padding: 44px 48px 40px;
    width: 100%;
    max-width: 420px;
    text-align: center;
    transform: translateY(20px) scale(0.97);
    transition: transform 0.35s cubic-bezier(0.22,1,0.36,1);
    box-shadow: 0 24px 60px rgba(0,0,0,0.5);
  }
  .modal-overlay.open .modal-box {
    transform: translateY(0) scale(1);
  }
  .modal-icon {
    width: 52px;
    height: 52px;
    background: rgba(245, 200, 66, 0.12);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    border: 1px solid rgba(245, 200, 66, 0.25);
  }
  .modal-icon svg {
    width: 24px;
    height: 24px;
    stroke: #f5c842;
    fill: none;
    stroke-width: 1.8;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .modal-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 26px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 8px;
  }
  .modal-sub {
    font-size: 13px;
    color: rgba(200, 220, 255, 0.50);
    margin-bottom: 28px;
    line-height: 1.6;
  }
  .modal-select {
    width: 100%;
    padding: 13px 16px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 8px;
    color: #e8f0fe;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    cursor: pointer;
    margin-bottom: 24px;
    transition: border-color 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(200,220,255,0.5)' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }
  .modal-select:focus { border-color: rgba(245, 200, 66, 0.50); }
  .modal-select option { background: #0f2340; color: #e8f0fe; }
  .modal-actions { display: flex; gap: 12px; }
  .modal-btn-cancel {
    flex: 1;
    padding: 13px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    background: rgba(255,255,255,0.06);
    color: rgba(200,220,255,0.7);
    border: 1px solid rgba(255,255,255,0.10);
    transition: all 0.2s;
  }
  .modal-btn-cancel:hover { background: rgba(255,255,255,0.11); color: #fff; }
  .modal-btn-confirm {
    flex: 2;
    padding: 13px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    background: #f5c842;
    color: #0d1f35;
    border: none;
    transition: all 0.22s;
    letter-spacing: 0.4px;
  }
  .modal-btn-confirm:hover {
    background: #f0bb20;
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(245,200,66,0.35);
  }
  .modal-btn-confirm:disabled {
    opacity: 0.40;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
</style>

<!-- ── Payroll Modal HTML ───────────────────── -->
<div class="modal-overlay" id="payrollClassModal">
  <div class="modal-box">
    <div class="modal-icon">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="16" rx="2"/>
        <path d="M7 8h10M7 12h6"/>
        <circle cx="17" cy="15" r="2.5"/>
        <path d="M19 17.5L21 19.5"/>
      </svg>
    </div>
    <p class="modal-title">Select Payroll Class</p>
    <p class="modal-sub">
      Select the payroll class you want to access.<br>
      You can only access your assigned class.
    </p>
    <select class="modal-select" id="modalPayrollClass">
      <option value="">— Select your class —</option>
    </select>
    <div class="modal-actions">
      <button class="modal-btn-cancel" id="modalCancelBtn">Cancel</button>
      <button class="modal-btn-confirm" id="modalConfirmBtn" disabled>Continue to Payroll</button>
    </div>
  </div>
</div>

<!-- ── Payroll Modal Script ──────────────────── -->
<script>
(function () {
  var modal         = document.getElementById('payrollClassModal');
  var selectEl      = document.getElementById('modalPayrollClass');
  var confirmBtn    = document.getElementById('modalConfirmBtn');
  var cancelBtn     = document.getElementById('modalCancelBtn');
  var classesLoaded = false;

  // ── Expose openPayrollModal globally ─────────
  // user-dashboard.js calls this from the payroll nav click
  // and from the logout return auto-open check
  window.openPayrollModal = function() {
    modal.classList.add('open');
    if (!classesLoaded) loadPayrollClasses();
  };

  function closePayrollModal() {
    modal.classList.remove('open');
    selectEl.value       = '';
    confirmBtn.disabled  = true;
  }

  // Enable confirm only when a class is chosen
  selectEl.addEventListener('change', function() {
    confirmBtn.disabled = !this.value;
  });

  cancelBtn.addEventListener('click', closePayrollModal);

  // Close on backdrop click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closePayrollModal();
  });

  // ── On confirm: call /api/users/login ─────────
  confirmBtn.addEventListener('click', async function() {
    var chosen = selectEl.value;
    if (!chosen) return;

    var encUid = sessionStorage.getItem('_pid');
    var encPwd = sessionStorage.getItem('_ppwd');

    if (!encUid || !encPwd) {
      DashAlertModal.show('Session expired. Please log in again.');
      setTimeout(function() {
        window.location.href = 'personnel-user-login.html';
      }, 2000);
      return;
    }

    // Decrypt before sending to backend
    var uid = decryptVal(encUid);
    var pwd = decryptVal(encPwd);

    confirmBtn.disabled     = true;
    confirmBtn.textContent  = 'Please wait...';

    try {
      const res  = await fetch('/api/users/login', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ user_id: uid, password: pwd, payroll_class: chosen })
      });

      const data = await res.json();

      if (res.ok) {
        // Keep _pid and _ppwd in sessionStorage intentionally —
        // logout.js preserves them so modal works on next return

        // Save everything exactly like Login 2
        localStorage.setItem('token',         data.token);
        localStorage.setItem('user_id',       data.user.user_id);
        localStorage.setItem('full_name',     data.user.full_name);
        localStorage.setItem('role',          data.user.role);
        localStorage.setItem('class',         data.user.primary_class);
        localStorage.setItem('current_class', data.user.current_class);

        closePayrollModal();
        window.location.href = '/dashboard.html';
      } else {
        confirmBtn.disabled    = false;
        confirmBtn.textContent = 'Continue to Payroll';
        DashAlertModal.show(data.error || 'Login failed. Please try again.');
      }
    } catch (err) {
      console.error('Modal login error:', err);
      confirmBtn.disabled    = false;
      confirmBtn.textContent = 'Continue to Payroll';
      DashAlertModal.show('Server not responding. Please try again.');
    }
  });

  // ── Fetch payroll classes ─────────────────────
  function loadPayrollClasses() {
    fetch('/classes')
      .then(function(res) { return res.json(); })
      .then(function(classes) {
        classes.forEach(function(cls) {
          var opt         = document.createElement('option');
          opt.value       = cls.id;
          opt.textContent = cls.name;
          selectEl.appendChild(opt);
        });
        classesLoaded = true;
      })
      .catch(function(err) {
        console.error('Failed to load payroll classes:', err);
        var opt         = document.createElement('option');
        opt.disabled    = true;
        opt.textContent = 'Could not load classes — please refresh';
        selectEl.appendChild(opt);
      });
  }

})();
</script>