<div class="p-6">
  <!-- PFA Section Header -->
  <div class="flex flex-wrap gap-2 justify-between mb-6">
    <h3 class="text-xl font-semibold text-gray-800">PFA Management</h3>
    <div class="flex flex-wrap gap-2">
      <input
        type="text"
        id="searchPFA"
        placeholder="PFA code or description"
        class="border rounded px-3 py-2"
      />
      <button
        id="addNewPFABtn"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        + Add New PFA
      </button>
      <button
        id="generateReportBtn"
        class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
      >
        <i class="fas fa-file-alt mr-2"></i>Generate Report
      </button>
    </div>
  </div>

  <!-- Add/Edit Form -->
  <form
    id="pfaForm"
    class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 p-4 rounded mb-6"
  >
    <div>
      <label for="pfacode" class="block text-sm font-medium text-gray-700"
        >PFA Code *</label
      >
      <input
        type="text"
        id="pfacode"
        name="pfacode"
        required
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
      />
    </div>

    <div>
      <label for="pfadesc" class="block text-sm font-medium text-gray-700"
        >Description</label
      >
      <input
        type="text"
        id="pfadesc"
        name="pfadesc"
        maxlength="40"
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
      />
    </div>

    <div>
      <label for="pfapfcname" class="block text-sm font-medium text-gray-700"
        >PFC Name</label
      >
      <input
        type="text"
        id="pfapfcname"
        name="pfapfcname"
        maxlength="40"
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
      />
    </div>

    <div>
      <label for="pfapfc" class="block text-sm font-medium text-gray-700"
        >PFC Code</label
      >
      <input
        type="text"
        id="pfapfc"
        name="pfapfc"
        maxlength="20"
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
      />
    </div>

    <div class="md:col-span-3 flex justify-end gap-2">
      <button
        type="submit"
        id="submitBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition duration-200"
      >
        Save
      </button>
      <button
        type="button"
        id="cancelBtn"
        class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500"
      >
        Cancel
      </button>
    </div>
  </form>

  <!-- PFA List -->
  <div class="rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800">PFA List</h2>
    </div>
    <div class="p-6 overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-blue-100 text-blue-900">
          <tr>
            <th class="border px-2 py-3 text-left">PFA Code</th>
            <th class="border px-2 py-3 text-left">Description</th>
            <th class="border px-2 py-3 text-left">PFC Name</th>
            <th class="border px-2 py-3 text-left">PFC Code</th>
            <th class="border px-2 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="pfaTableBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div
      class="px-6 py-4 border-t border-gray-200 flex flex-wrap items-center justify-between gap-4"
    >
      <div class="flex items-center gap-2">
        <label for="recordsPerPage" class="text-sm text-gray-600"
          >Records per page:</label
        >
        <select id="recordsPerPage" class="border rounded px-2 py-1 text-sm">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>

      <div class="text-sm text-gray-600">
        Showing <span id="startRecord">0</span> to
        <span id="endRecord">0</span> of
        <span id="totalRecords">0</span> records
      </div>

      <div class="flex items-center gap-2">
        <button
          id="prevPage"
          class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Previous
        </button>
        <span class="text-sm text-gray-600">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button
          id="nextPage"
          class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div
  id="messageContainer"
  class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none"
>
  <div class="space-y-3 w-full max-w-md px-4" id="messageInner">
    <!-- Toast messages will be injected here -->
  </div>
</div>

<script>
  const auth = window.authService;
  class PFAManager {
    constructor() {
      this.apiUrl = "/pfa";
      this.token = localStorage.getItem("token");
      this.isEditing = false;
      this.editingCode = null;
      this.validationTimers = {};

      // Pagination state
      this.currentPage = 1;
      this.recordsPerPage = 10;
      this.allPFAs = [];
      this.filteredData = [];
      this.currentSearchTerm = "";

      this.initializeElements();
      this.bindEvents();
      this.loadPFAs();
      this.bindCapitalization();
      this.bindValidation();
    }

    getHeaders() {
      return {
        "Content-Type": "application/json",
        Authorization: `Bearer ${this.token}`,
      };
    }

    initializeElements() {
      this.form = document.getElementById("pfaForm");
      this.addNewBtn = document.getElementById("addNewPFABtn");
      this.submitBtn = document.getElementById("submitBtn");
      this.cancelBtn = document.getElementById("cancelBtn");
      this.tableBody = document.getElementById("pfaTableBody");
      this.messageContainer = document.getElementById("messageContainer");
      this.searchInput = document.getElementById("searchPFA");

      // Pagination elements
      this.prevPageBtn = document.getElementById("prevPage");
      this.nextPageBtn = document.getElementById("nextPage");
      this.currentPageSpan = document.getElementById("currentPage");
      this.totalPagesSpan = document.getElementById("totalPages");
      this.recordsPerPageSelect = document.getElementById("recordsPerPage");
      this.startRecordSpan = document.getElementById("startRecord");
      this.endRecordSpan = document.getElementById("endRecord");
      this.totalRecordsSpan = document.getElementById("totalRecords");
    }

    bindEvents() {
      this.form.addEventListener("submit", (e) => this.handleSubmit(e));
      this.addNewBtn.addEventListener("click", () => this.showForm());
      this.cancelBtn.addEventListener("click", () => this.hideForm());
      this.searchInput.addEventListener("input", (e) =>
        this.filterPFAs(e.target.value)
      );
      document
        .getElementById("generateReportBtn")
        .addEventListener("click", () => this.generateReport());

      // Pagination events
      if (this.prevPageBtn) {
        this.prevPageBtn.addEventListener("click", () => {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.renderWithPagination();
          }
        });
      }

      if (this.nextPageBtn) {
        this.nextPageBtn.addEventListener("click", () => {
          const { totalPages } = this.getPaginationData();
          if (this.currentPage < totalPages) {
            this.currentPage++;
            this.renderWithPagination();
          }
        });
      }

      if (this.recordsPerPageSelect) {
        this.recordsPerPageSelect.addEventListener("change", (e) => {
          this.recordsPerPage = parseInt(e.target.value);
          this.currentPage = 1;
          this.renderWithPagination();
        });
      }
    }

    // Pagination functions
    getPaginationData() {
      const totalRecords = this.filteredData.length;
      const totalPages = Math.ceil(totalRecords / this.recordsPerPage) || 1;
      const startIndex = (this.currentPage - 1) * this.recordsPerPage;
      const endIndex = startIndex + this.recordsPerPage;
      const currentData = this.filteredData.slice(startIndex, endIndex);
      const startRecord = totalRecords === 0 ? 0 : startIndex + 1;
      const endRecord = Math.min(endIndex, totalRecords);

      return { totalRecords, totalPages, currentData, startRecord, endRecord };
    }

    updatePaginationUI() {
      const { totalRecords, totalPages, startRecord, endRecord } =
        this.getPaginationData();

      if (this.currentPageSpan)
        this.currentPageSpan.textContent = this.currentPage;
      if (this.totalPagesSpan) this.totalPagesSpan.textContent = totalPages;
      if (this.startRecordSpan) this.startRecordSpan.textContent = startRecord;
      if (this.endRecordSpan) this.endRecordSpan.textContent = endRecord;
      if (this.totalRecordsSpan)
        this.totalRecordsSpan.textContent = totalRecords;

      if (this.prevPageBtn) this.prevPageBtn.disabled = this.currentPage <= 1;
      if (this.nextPageBtn)
        this.nextPageBtn.disabled = this.currentPage >= totalPages;
    }

    renderWithPagination() {
      this.renderTable();
      this.updatePaginationUI();
    }

    applySearch(term) {
      this.currentSearchTerm = term;
      if (term) {
        this.filteredData = this.allPFAs.filter(
          (pfa) =>
            pfa.pfacode.toLowerCase().includes(term) ||
            (pfa.pfadesc && pfa.pfadesc.toLowerCase().includes(term)) ||
            (pfa.pfapfcname && pfa.pfapfcname.toLowerCase().includes(term)) ||
            (pfa.pfapfc && pfa.pfapfc.toLowerCase().includes(term))
        );
      } else {
        this.filteredData = [...this.allPFAs];
      }
    }

    async validateField(field, value) {
      if (!value || !value.trim()) {
        this.clearValidationMessage(field);
        return true;
      }

      try {
        let url = `${this.apiUrl}/check/${field}/${encodeURIComponent(value)}`;

        if (this.isEditing && this.editingCode) {
          url += `?exclude=${encodeURIComponent(this.editingCode)}`;
        }

        const response = await auth.fetchWithAuth(url, {
          headers: this.getHeaders(),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.exists) {
          this.showValidationMessage(
            field,
            `This ${field} already exists`,
            "error"
          );
          return false;
        } else {
          this.clearValidationMessage(field);
          return true;
        }
      } catch (error) {
        console.error(`Validation error for ${field}:`, error);
        this.clearValidationMessage(field);
        return true;
      }
    }

    showValidationMessage(field, message, type) {
      const inputElement = document.getElementById(field);
      if (!inputElement) return;

      this.clearValidationMessage(field);

      const messageElement = document.createElement("div");
      messageElement.className = `validation-message text-sm mt-1 ${
        type === "error" ? "text-red-600" : "text-green-600"
      }`;
      messageElement.textContent = message;
      messageElement.id = `${field}-validation`;

      inputElement.parentNode.insertBefore(
        messageElement,
        inputElement.nextSibling
      );

      if (type === "error") {
        inputElement.classList.add("border-red-500");
        inputElement.classList.remove("border-green-500");
      } else {
        inputElement.classList.add("border-green-500");
        inputElement.classList.remove("border-red-500");
      }
    }

    clearValidationMessage(field) {
      const messageElement = document.getElementById(`${field}-validation`);
      if (messageElement) {
        messageElement.remove();
      }

      const inputElement = document.getElementById(field);
      if (inputElement) {
        inputElement.classList.remove("border-red-500", "border-green-500");
      }
    }

    bindValidation() {
      const validationFields = ["pfacode"];

      validationFields.forEach((field) => {
        const element = document.getElementById(field);
        if (element) {
          element.addEventListener("input", (e) => {
            const value = e.target.value.trim();

            if (this.validationTimers[field]) {
              clearTimeout(this.validationTimers[field]);
            }

            this.validationTimers[field] = setTimeout(() => {
              if (value) {
                this.validateField(field, value);
              } else {
                this.clearValidationMessage(field);
              }
            }, 500);
          });

          element.addEventListener("blur", (e) => {
            const value = e.target.value.trim();
            if (value) {
              if (this.validationTimers[field]) {
                clearTimeout(this.validationTimers[field]);
              }
              this.validateField(field, value);
            }
          });
        }
      });
    }

    async loadPFAs(preserveState = false) {
      try {
        const response = await auth.fetchWithAuth(this.apiUrl, {
          headers: this.getHeaders(),
        });
        const pfas = await response.json();
        this.allPFAs = pfas;

        if (preserveState) {
          this.applySearch(this.currentSearchTerm);
          const totalPages =
            Math.ceil(this.filteredData.length / this.recordsPerPage) || 1;
          if (this.currentPage > totalPages) {
            this.currentPage = totalPages;
          }
        } else {
          this.filteredData = [...this.allPFAs];
          this.currentPage = 1;
          this.currentSearchTerm = "";
        }

        this.renderWithPagination();
      } catch (error) {
        this.showMessage("Error loading PFAs", "error");
      }
    }

    filterPFAs(searchTerm) {
      const term = searchTerm.toLowerCase();
      this.applySearch(term);
      this.currentPage = 1;
      this.renderWithPagination();
    }

    showForm() {
      this.form.classList.remove("hidden");
      this.addNewBtn.style.display = "none";
    }

    hideForm() {
      this.form.classList.add("hidden");
      this.addNewBtn.style.display = "block";
      this.resetForm();
    }

    renderTable() {
      const { currentData } = this.getPaginationData();

      this.tableBody.innerHTML = "";

      if (currentData.length === 0) {
        this.tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="border px-2 py-8 text-center text-gray-500">No records found</td>
                    </tr>
                `;
        return;
      }

      currentData.forEach((pfa) => {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50";
        row.innerHTML = `
                    <td class="border px-2 py-1 text-left">${pfa.pfacode}</td>
                    <td class="border px-2 py-1 text-left">${
                      pfa.pfadesc || ""
                    }</td>
                    <td class="border px-2 py-1 text-left">${
                      pfa.pfapfcname || ""
                    }</td>
                    <td class="border px-2 py-1 text-left">${
                      pfa.pfapfc || ""
                    }</td>
                    <td class="border px-2 py-1 text-left">
                        <button onclick="pfaManager.editPFA('${pfa.pfacode}')" 
                            class="text-blue-600 hover:text-blue-900 px-2 py-1 rounded hover:bg-blue-50">Edit</button>
                        <button onclick="pfaManager.deletePFA('${
                          pfa.pfacode
                        }')" 
                            class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">Delete</button>
                    </td>
                `;
        this.tableBody.appendChild(row);
      });
    }

    async handleSubmit(e) {
      e.preventDefault();

      const formData = new FormData(this.form);
      const data = Object.fromEntries(formData);

      const validationPromises = [];
      const validationFields = ["pfacode", "pfadesc", "pfapfcname", "pfapfc"];

      validationFields.forEach((field) => {
        if (data[field] && data[field].trim()) {
          validationPromises.push(
            this.validateField(field, data[field].trim())
          );
        }
      });

      try {
        const validationResults = await Promise.all(validationPromises);
        const hasValidationErrors = validationResults.some(
          (result) => result === false
        );

        if (hasValidationErrors) {
          this.showMessage(
            "Please fix validation errors before submitting",
            "error"
          );
          return;
        }

        const url = this.isEditing
          ? `${this.apiUrl}/${this.editingCode}`
          : `${this.apiUrl}/post`;
        const method = this.isEditing ? "PUT" : "POST";

        const response = await auth.fetchWithAuth(url, {
          method,
          headers: this.getHeaders(),
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          this.showMessage(
            `PFA ${this.isEditing ? "updated" : "created"} successfully`,
            "success"
          );
          this.hideForm();
          await this.loadPFAs(true); // Preserve state
        } else {
          this.showMessage(result.error, "error");
        }
      } catch (error) {
        this.showMessage("Network error occurred", "error");
      }
    }

    async editPFA(pfacode) {
      try {
        const response = await auth.fetchWithAuth(`${this.apiUrl}/${pfacode}`, {
          headers: this.getHeaders(),
        });
        const pfa = await response.json();

        this.form.pfacode.value = pfa.pfacode;
        this.form.pfadesc.value = pfa.pfadesc || "";
        this.form.pfapfcname.value = pfa.pfapfcname || "";
        this.form.pfapfc.value = pfa.pfapfc || "";

        this.form.pfacode.disabled = true;
        this.isEditing = true;
        this.editingCode = pfacode;

        this.submitBtn.textContent = "Update PFA";
        this.showForm();

        ["pfacode", "pfadesc", "pfapfcname", "pfapfc"].forEach((field) => {
          this.clearValidationMessage(field);
        });
      } catch (error) {
        this.showMessage("Error loading PFA data", "error");
      }
    }

    async deletePFA(pfacode) {
      if (!confirm(`Are you sure you want to delete PFA ${pfacode}?`)) return;

      try {
        const response = await auth.fetchWithAuth(`${this.apiUrl}/${pfacode}`, {
          method: "DELETE",
          headers: this.getHeaders(),
        });

        const result = await response.json();

        if (response.ok) {
          this.showMessage("PFA deleted successfully", "success");
          await this.loadPFAs(true); // Preserve state
        } else {
          this.showMessage(result.error, "error");
        }
      } catch (error) {
        this.showMessage("Network error occurred", "error");
      }
    }

    resetForm() {
      this.form.reset();
      this.form.pfacode.disabled = false;
      this.isEditing = false;
      this.editingCode = null;

      this.submitBtn.textContent = "Add PFA";

      ["pfacode", "pfadesc", "pfapfcname", "pfapfc"].forEach((field) => {
        this.clearValidationMessage(field);
        if (this.validationTimers[field]) {
          clearTimeout(this.validationTimers[field]);
          delete this.validationTimers[field];
        }
      });
    }

    showMessage(message, type) {
      const messageElement = document.createElement("div");
      messageElement.className = `p-4 rounded-md mb-4 pointer-events-auto ${
        type === "success"
          ? "bg-green-100 text-green-700 border border-green-300"
          : "bg-red-100 text-red-700 border border-red-300"
      }`;
      messageElement.textContent = message;

      const messageInner = document.getElementById("messageInner");
      messageInner.appendChild(messageElement);

      setTimeout(() => {
        messageElement.remove();
      }, 5000);
    }

    capitalizeWords(str) {
      return str
        ? str
            .toLowerCase()
            .split(" ")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ")
        : "";
    }

    bindCapitalization() {
      ["pfadesc", "pfapfcname"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", () => {
            el.value = this.capitalizeWords(el.value);
          });
        }
      });

      ["pfacode", "pfapfc"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", () => {
            el.value = el.value.toUpperCase();
          });
        }
      });
    }

    generateReport() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, "0");
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const year = now.getFullYear();
      const dateStr = `${day}-${month}-${year}`;

      const printWindow = window.open("", "_blank");

      const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PFA Management Report</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif;
                            margin: 40px;
                            color: #333;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #1a56db;
                            padding-bottom: 10px;
                        }
                        .date-generated {
                            color: #666;
                            font-size: 14px;
                            margin: 10px 0 20px;
                        }
                        .report-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        .report-table th {
                            background-color: #f3f4f6;
                            color: #1f2937;
                            padding: 12px;
                            text-align: left;
                            border: 1px solid #e5e7eb;
                        }
                        .report-table td {
                            padding: 10px;
                            border: 1px solid #e5e7eb;
                        }
                        .report-footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                            border-top: 1px solid #e5e7eb;
                            padding-top: 20px;
                        }
                        @media print {
                            .report-table th {
                                background-color: #f3f4f6 !important;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>PFA Management Report</h1>
                        <p class="date-generated">Generated on: ${dateStr}</p>
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>PFA Code</th>
                                <th>Description</th>
                                <th>PFC Name</th>
                                <th>PFC Code</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.allPFAs
                              .map(
                                (pfa, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${pfa.pfacode}</td>
                                    <td>${pfa.pfadesc || ""}</td>
                                    <td>${pfa.pfapfcname || ""}</td>
                                    <td>${pfa.pfapfc || ""}</td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                    
                    <div class="report-footer">
                        <p>Total Records: ${this.allPFAs.length}</p>
                        <p>Generated by: ${
                          localStorage.getItem("full_name") || "System User"
                        }</p>
                        <p>*** End of Report ***</p>
                    </div>
                </body>
                </html>
            `;

      printWindow.document.write(printContent);
      printWindow.document.close();

      printWindow.onload = function () {
        printWindow.print();
      };
    }
  }

  window.pfaManager = new PFAManager();
</script>
