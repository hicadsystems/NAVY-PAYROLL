<div class="p-6">
  <!-- Section Command Header -->
  <div class="flex flex-wrap justify-between mb-6">
    <h3 class="text-xl font-semibold text-gray-800">Command Management</h3>
    <div class="flex flex-wrap gap-2">
      <input
        type="text"
        id="searchSection"
        placeholder="Name or UnitCode..."
        class="border rounded px-3 py-2"
      />
      <button
        id="addNewSectionBtn"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        + Add Command
      </button>
      <button
        id="generateReportBtn"
        class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
      >
        <i class="fas fa-file-alt mr-2"></i>Generate Report
      </button>
    </div>
  </div>

  <!-- Hidden Section Command Form -->
  <form
    id="sectionForm"
    class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 p-4"
  >
    <div>
      <label class="block text-sm font-medium text-gray-700"
        >Naval Command*</label
      >
      <input
        type="text"
        id="navalcmd"
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
        placeholder="Enter command"
      />
    </div>
    <div class="">
      <label class="block text-sm font-medium text-gray-700">Name</label>
      <textarea
        id="name"
        class="w-full border border-blue-500 rounded-md px-3 py-2 bg-white"
        placeholder="Enter name"
      ></textarea>
    </div>
    <div class="col-span-1 md:col-span-2 flex justify-end gap-2">
      <button
        type="button"
        id="saveSectionBtn"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        Save
      </button>
      <button
        type="button"
        id="cancelSectionBtn"
        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
      >
        Cancel
      </button>
    </div>
  </form>

  <!-- Section Command Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="border px-2 py-3 text-left">Command</th>
          <th class="border px-2 py-3 text-left">Name</th>
          <th class="border px-2 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="sectionTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Success Modal -->
<div
  id="sectionSuccessModal"
  class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-green-600 mb-2">Success!</h3>
    <p id="sectionSuccessMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button
        id="closeSectionSuccess"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        OK
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div
  id="sectionErrorModal"
  class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
    <p id="sectionErrorMessage" class="mb-4 text-gray-700"></p>
    <div class="flex justify-end">
      <button
        id="closeSectionError"
        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
      >
        OK
      </button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div
  id="sectionConfirmModal"
  class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-yellow-600 mb-2">Confirm Delete</h3>
    <p id="confirmMessage" class="mb-4 text-gray-700">
      Are you sure you want to delete this section command?
    </p>
    <div class="flex justify-end gap-2">
      <button
        id="cancelSectionDelete"
        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
      >
        Cancel
      </button>
      <button
        id="sectionConfirmAction"
        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<script>
  const auth = window.authService;
  let commandData = [];
  let originalCommandData = null;
  let editingSectionIndex = null;
  let pendingSectionDelete = null;

  function getAuthHeaders() {
    const token = localStorage.getItem("token");
    return {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    };
  }

  const sectionForm = document.getElementById("sectionForm");
  const addNewSectionBtn = document.getElementById("addNewSectionBtn");
  const saveSectionBtn = document.getElementById("saveSectionBtn");
  const cancelSectionBtn = document.getElementById("cancelSectionBtn");
  const sectionTableBody = document.getElementById("sectionTableBody");
  const searchSection = document.getElementById("searchSection");

  // Show form
  addNewSectionBtn.addEventListener("click", () => {
    sectionForm.classList.remove("hidden");
    editingSectionIndex = null;
    document.getElementById("navalcmd").disabled = false;
    resetSectionForm();
  });

  async function loadCommand() {
    try {
      const res = await auth.fetchWithAuth("/cmd/command", {
        method: "GET",
        headers: getAuthHeaders(),
      });

      commandData = await res.json();

      renderSectionTable(commandData);
    } catch (err) {
      showSectionError("Error loading sections:", err);
    }
  }

  function renderSectionTable(data = commandData, isFiltered = false) {
    const tbody = document.getElementById("sectionTableBody");
    tbody.innerHTML = data
      .map((item, index) => {
        // If filtered, use _originalIndex; otherwise, fall back to index
        const realIndex = isFiltered ? item._originalIndex : index;

        return `
        <tr class="hover:bg-gray-50">
          <td class="border px-2 py-3">${item.navalcmd}</td>
          <td class="border px-2 py-3">${item.name}</td>
          <td class="border px-2 py-3">
            <button onclick="editSection(${realIndex})" class="text-green-600 hover:text-green-900 mr-2">Edit</button>
            <button onclick="deleteSection(${realIndex})" class="text-red-600 hover:text-red-900">Delete</button>
          </td>
        </tr>
      `;
      })
      .join("");
  }

  // Save record
  saveSectionBtn.addEventListener("click", async (e) => {
    // Prevent multiple clicks during processing
    if (saveSectionBtn.disabled) return;

    saveSectionBtn.disabled = true;

    try {
      const item = {
        navalcmd: document.getElementById("navalcmd").value.trim(),
        name: document.getElementById("name").value.trim(),
      };

      const requiredFields = ["navalcmd", "name"];
      let missingFields = requiredFields.filter((field) => !item[field]);

      if (missingFields.length > 0) {
        showSectionError(
          `Please fill in all required fields: ${missingFields.join(", ")}`
        );
        return;
      }

      // Check for duplicates before saving
      const navalcmdInput = document.getElementById("navalcmd");
      const nameInput = document.getElementById("name");

      // Get the current navalcmd for editing
      const currentNavalcmd =
        editingSectionIndex !== null
          ? commandData[editingSectionIndex].navalcmd
          : null;

      // Perform duplicate checks only for changed fields
      await checkDuplicate(navalcmdInput, "navalcmd", currentNavalcmd);
      await checkDuplicate(nameInput, "name", currentNavalcmd);

      // Check if any validation errors exist
      if (!navalcmdInput.checkValidity() || !nameInput.checkValidity()) {
        showSectionError("Please fix the validation errors before saving.");
        return;
      }

      if (editingSectionIndex !== null) {
        await auth.fetchWithAuth(
          `/cmd/${commandData[editingSectionIndex].navalcmd}`,
          {
            method: "PUT",
            headers: getAuthHeaders(),
            body: JSON.stringify(item),
          }
        );
        showSectionSuccess("Command updated successfully!");
      } else {
        await auth.fetchWithAuth("/cmd/post-command", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(item),
        });
        showSectionSuccess("Command created successfully!");
      }

      await loadCommand();
      sectionForm.classList.add("hidden");
      sectionForm.reset();
      editingSectionIndex = null;
      originalCommandData = null; // Clear original data
    } catch (err) {
      showSectionError("Error saving command:", err);
    } finally {
      saveSectionBtn.disabled = false; // Re-enable button
    }
  });

  //validation
  async function checkDuplicate(input, field, excludeNavalcmd = null) {
    const value = input.value.trim();
    if (!value) {
      input.setCustomValidity("");
      input.reportValidity();
      return;
    }

    // If editing, check if this field value has actually changed
    if (originalCommandData && originalCommandData[field] === value) {
      input.setCustomValidity(""); // Clear any existing validation message
      input.reportValidity();
      return; // Skip duplicate check if value hasn't changed
    }

    try {
      const token = localStorage.getItem("token");

      // Build URL with optional excludeNavalcmd parameter
      let url = `/cmd/post-command/check/${field}/${encodeURIComponent(value)}`;
      if (excludeNavalcmd) {
        url += `?exclude=${excludeNavalcmd}`;
      }

      const res = await auth.fetchWithAuth(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await res.json();
      if (data.exists) {
        input.setCustomValidity(`⚠️ This ${field} already exists.`);
      } else {
        input.setCustomValidity("");
      }
      input.reportValidity();
    } catch (err) {
      console.error(`Error checking ${field}:`, err);
    }
  }

  // Updated blur event listeners to pass exclude parameter
  document.getElementById("navalcmd")?.addEventListener("blur", function () {
    const currentNavalcmd =
      editingSectionIndex !== null
        ? commandData[editingSectionIndex].navalcmd
        : null;
    checkDuplicate(this, "navalcmd", currentNavalcmd);
  });

  document.getElementById("name")?.addEventListener("blur", function () {
    const currentNavalcmd =
      editingSectionIndex !== null
        ? commandData[editingSectionIndex].navalcmd
        : null;
    checkDuplicate(this, "name", currentNavalcmd);
  });

  cancelSectionBtn.addEventListener("click", () => {
    sectionForm.classList.add("hidden");
    resetSectionForm();
    editingSectionIndex = null;
  });

  function resetSectionForm() {
    sectionForm
      .querySelectorAll("input, textarea")
      .forEach((el) => (el.value = ""));
  }

  window.editSection = function (index) {
    const item = commandData[index];

    // Store original values for comparison
    originalCommandData = {
      navalcmd: item.navalcmd,
      name: item.name,
    };

    // Populate form fields
    document.getElementById("navalcmd").value = item.navalcmd;
    document.getElementById("name").value = item.name;

    // Clear any existing validation messages
    document.getElementById("navalcmd").setCustomValidity("");
    document.getElementById("name").setCustomValidity("");

    editingSectionIndex = index;
    document.getElementById("navalcmd").disabled = true;
    sectionForm.classList.remove("hidden");
  };

  window.deleteSection = function (index) {
    pendingSectionDelete = index;
    showConfirmModal("Are you sure you want to delete this command?");
  };

  document
    .getElementById("sectionConfirmAction")
    .addEventListener("click", async () => {
      if (pendingSectionDelete !== null) {
        try {
          await auth.fetchWithAuth(
            `/cmd/${commandData[pendingSectionDelete].navalcmd}`,
            {
              method: "DELETE",
              headers: getAuthHeaders(),
            }
          );
          showSectionSuccess("Command deleted successfully!");
          await loadCommand();
        } catch (err) {
          showSectionError("Error deleting command:", err);
        }
        pendingSectionDelete = null;
      }
      closeModal("sectionConfirmModal");
    });

  document
    .getElementById("cancelSectionDelete")
    .addEventListener("click", () => {
      closeModal("sectionConfirmModal");
      pendingSectionDelete = null;
    });

  function showModal(modalId) {
    document.getElementById(modalId).classList.remove("hidden");
  }
  function closeModal(modalId) {
    document.getElementById(modalId).classList.add("hidden");
  }
  function showConfirmModal(message) {
    document.getElementById("confirmMessage").textContent = message;
    showModal("sectionConfirmModal");
  }
  function showSectionSuccess(msg) {
    document.getElementById("sectionSuccessMessage").textContent = msg;
    showModal("sectionSuccessModal");
  }
  function showSectionError(msg) {
    document.getElementById("sectionErrorMessage").textContent = msg;
    showModal("sectionErrorModal");
  }

  // close modal buttons
  document
    .getElementById("closeSectionSuccess")
    .addEventListener("click", () => closeModal("sectionSuccessModal"));
  document
    .getElementById("closeSectionError")
    .addEventListener("click", () => closeModal("sectionErrorModal"));

  // search
  searchSection.addEventListener("input", () => {
    const query = searchSection.value.toLowerCase();

    const filtered = commandData
      .map((item, index) => ({ ...item, _originalIndex: index })) // attach original index
      .filter(
        (item) =>
          item.name.toLowerCase().includes(query) ||
          item.navalcmd.toLowerCase().includes(query)
      );

    renderSectionTable(filtered, true); // pass flag to tell table we're using filtered data
  });

  // Force uppercase as user types
  ["navalcmd", "name"].forEach((id) => {
    const el = document.getElementById(id);
    el.addEventListener("input", () => {
      el.value = el.value.toUpperCase();
    });
  });

  //generate reports
  function generateReport() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, "0");
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const year = now.getFullYear();
    const dateStr = `${day}-${month}-${year}`;

    // Create a new window for printing
    const printWindow = window.open("", "_blank");

    // Generate HTML content
    const printContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Commands Report</title>
        <style>
          body { 
            font-family: Arial, sans-serif;
            margin: 40px; 
          }
          .print-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 20px; 
          }
          .print-table th { 
            background-color: #f3f4f6; 
            color: #1f2937;
            padding: 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
          }
          .print-table td { 
            padding: 12px;
            border: 1px solid #e5e7eb;
          }
          .print-header { 
            text-align: center; 
            margin-bottom: 20px; 
          }
          .date-generated {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
          }
          .print-footer { 
            text-align: center; 
            margin-top: 20px; 
            font-size: 12px;
            border-top: 1px solid #eee;
            padding-top: 20px;
          }
        </style>
      </head>
      <body>
        <div class="print-header">
          <h1>Commands Report</h1>
          <p class="date-generated">Generated on: ${dateStr}</p>
        </div>
        
        <table class="print-table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Command</th>
              <th>Name</th>
            </tr>
          </thead>
          <tbody>
            ${commandData
              .map(
                (item, index) => `
              <tr>
                <td>${index + 1}</td>
                <td>${item.navalcmd}</td>
                <td>${item.name}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
        
        <div class="print-footer">
          <p>Total Records: ${commandData.length}</p>
          <p>Generated by: ${
            localStorage.getItem("full_name") || "System User"
          }</p>
          <p>*** End of Report ***</p>
        </div>
      </body>
      </html>
    `;

    // Write content to new window
    printWindow.document.write(printContent);
    printWindow.document.close();

    // Wait for content to load then print
    printWindow.onload = function () {
      printWindow.print();
    };
  }

  // Add event listener to generate report button
  document
    .getElementById("generateReportBtn")
    .addEventListener("click", generateReport);

  // init
  renderSectionTable();
  loadCommand();
</script>
